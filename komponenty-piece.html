<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konfigurator kotłów — Ferroli / PEREKO / LAZAR / DEFRO</title>
<style>
:root{
  --bg1:#0a0f1e; --bg2:#0c1230; --panel:#11183a; --ink:#e8edff; --muted:#aeb8da; --line:#2b3a77;
  --chip:#14204a; --accent:#4cc9f0; --accent-2:#67a1ff; --accent-soft:rgba(103,161,255,.25);
  --danger:#ff6b6b; --warn:#ffb84d;
}
*{box-sizing:border-box}
body{margin:0;color:var(--ink);background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--bg1));font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:18px auto 48px;padding:0 16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:16px;background:#11183a;border:1px solid var(--line);border-radius:14px}
h1{font-size:22px;margin:0}
.sub{font-size:12px;color:var(--muted)}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75;background:#172142}
nav a:hover{background:#223160}
.panel{background:linear-gradient(180deg,#10173c,#111b48);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
.panel h3{margin:0 0 8px;font-size:16px}
.btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px dashed #3a4ca3}
.btn.warn{background:#3a1f2a;border-color:#7b3341}
.btn.alt{background:#0e2a4e;border-color:#365caa}
.btn:focus{outline:none;box-shadow:0 0 0 3px var(--accent-soft)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
select,input[type=text],input[type=number]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0d1530;color:var(--ink)}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft);outline:none}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:1060px){.grid{grid-template-columns:1fr .95fr}}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col{grid-column:span 12}
@media(min-width:720px){.col{grid-column:span 4}.col.wide{grid-column:span 8}}
.muted{color:var(--muted)} .sep{height:1px;background:var(--line);margin:10px 0}
.card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1636}
.card h4{margin:0 0 8px;font-size:15px}
ul.clean{margin:6px 0 0;padding-left:18px}ul.clean li{margin:3px 0}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid var(--line);padding:8px 10px} thead th{background:#101a46;text-align:left;color:#cfe1ff}
.right{text-align:right;white-space:nowrap}
.price-preview{font-weight:800;font-size:18px;margin-top:6px}
.mini{font-size:12px;color:var(--muted)} .hint{font-size:12px;color:#aee1ff}
.inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.inline .cell{display:flex;flex-direction:column;min-width:140px}
.cell.minwide{min-width:220px}
@media print{header,.btn,nav,.hint,.mini{display:none!important} body{background:#fff;color:#000}
.panel{background:#fff;border-color:#ddd} .wrap{max-width:none;margin:0;padding:0}
h1{color:#000} thead th{background:#f2f2f2;color:#000;border-color:#ddd} th,td{border-bottom:1px solid #ddd}}

/* === FIX KONTRASTU: wymuś jasny kolor tekstu === */
body, h1, h2, h3, h4, h5, h6,
p, span, a, li, label, small, strong, b, i, em,
table, thead th, tbody td, tfoot td, th, td,
button, .btn, .card, .panel,
.price-preview, .muted, .mini, .hint { color: var(--ink) !important; }
input[type=text], input[type=number], select, textarea {
  color: var(--ink) !important; background: #0d1530 !important; caret-color: var(--ink); border-color: var(--line);
}
select option { color: var(--ink) !important; background: #0d1530 !important; }
::placeholder,::-webkit-input-placeholder{ color: #cfd6f5 !important; }
input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus{
  -webkit-text-fill-color: var(--ink) !important;
  -webkit-box-shadow: 0 0 0px 1000px #0d1530 inset !important;
          box-shadow: 0 0 0px 1000px #0d1530 inset !important;
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Konfigurator kotłów — Ferroli / PEREKO / LAZAR / DEFRO</h1>
      <div class="sub">
        Kocioł: <b>cena NETTO</b>. Pozostałe pozycje (komponenty/usługi, w tym zasobnik CWU): <b>ceny BRUTTO</b> (przeliczane do NETTO i z powrotem do BRUTTO wg wybranego VAT 8%/23%).<br>
        Grzejniki — montaż: <b>750 PLN/szt. (netto → brutto wg VAT)</b> • Wkład kominowy „do 10 m”: <b>3 000 PLN (brutto)</b>.
      </div>
      <nav><a href="index.html">Pulpit</a></nav>
    </div>
    <div class="bar">
      <button class="btn" id="exportXLSX">Eksport (XLSX)</button>
      <button class="btn ghost" id="printBtn">Drukuj / PDF</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <h3>Dobierz kocioł i wariant</h3>
      <div class="row">
        <div class="col">
          <label>Marka / typ</label>
          <select id="brand">
            <option value="FERROLI_PELLET">Ferroli — pellet</option>
            <option value="FERROLI_WOOD">Ferroli — zgazowujący (drewno)</option>
            <option value="PEREKO_PELLET">PEREKO — pellet</option>
            <option value="PEREKO_WOOD">PEREKO — zgazowujący (drewno)</option>
            <option value="LAZAR_PELLET">LAZAR — pellet</option>
            <option value="DEFRO_PELLET">DEFRO — pellet</option>
            <option value="DEFRO_WOOD">DEFRO — kotły zasypowe (drewno)</option>
          </select>
        </div>

        <div class="col">
          <label>Model kotła</label>
          <select id="boiler"></select>
        </div>

        <div class="col">
          <label>Moc [kW]</label>
          <input id="power" type="text" readonly>
        </div>

        <div class="col">
          <label>Wariant</label>
          <select id="variant">
            <option value="bez">Bez dotacji</option>
            <option value="dotacja">Z dotacją (zestaw rozszerzony)</option>
          </select>
          <div class="mini">„Z dotacją” automatycznie dolicza: wkład 10 m, 3 pompki CWU i bojler-lato.</div>
        </div>

        <div class="col">
          <label>VAT do podsumowania</label>
          <select id="vat">
            <option value="0.08">8%</option>
            <option value="0.23">23%</option>
          </select>
        </div>

        <!-- Zasobnik CWU -->
        <div class="col">
          <label>Zasobnik CWU (wężownica)</label>
          <select id="tank">
            <option value="0">— bez zasobnika —</option>
          </select>
          <div class="mini">Ceny zasobników: BRUTTO 23% (przeliczane).</div>
        </div>

        <div class="col">
          <label>Propozycja bufora (zgazowujące)</label>
          <div class="inline">
            <div class="cell">
              <select id="bufRule">
                <option value="40">40 l/kW</option>
                <option value="50" selected>50 l/kW</option>
                <option value="60">60 l/kW</option>
                <option value="80">80 l/kW</option>
                <option value="100">100 l/kW</option>
              </select>
              <span class="mini">Reguła obliczeń</span>
            </div>
            <div class="cell">
              <input id="bufNeed" type="text" readonly placeholder="—">
              <span class="mini">Zalecane [l]</span>
            </div>
            <div class="cell">
              <select id="bufferSize">
                <option value="0">— bez bufora —</option>
                <option value="300">Bufor 300 l</option>
                <option value="500">Bufor 500 l</option>
                <option value="800">Bufor 800 l</option>
                <option value="1000">Bufor 1000 l</option>
              </select>
              <span class="mini">Wybór do koszyka</span>
            </div>
          </div>
          <div class="hint" id="bufHint">Dla zgazowujących bufor wymagany — dobiorę najbliższy ≥ zalecanego.</div>
        </div>

        <div class="col wide">
          <label>Dobór mocy z powierzchni</label>
          <div class="inline">
            <div class="cell">
              <input id="houseArea" type="number" min="20" step="1" value="120" placeholder="m²">
              <span class="mini">Powierzchnia [m²]</span>
            </div>
            <div class="cell">
              <select id="buildingStd">
                <option value="35">A+/A (35 W/m²)</option>
                <option value="50" selected>Dobrze ocieplony (50 W/m²)</option>
                <option value="70">Modernizowany (70 W/m²)</option>
                <option value="90">Stary, nieocieplony (90 W/m²)</option>
                <option value="120">Bardzo zimny (120 W/m²)</option>
              </select>
              <span class="mini">Standard budynku</span>
            </div>
            <div class="cell">
              <input id="suggestedKW" type="text" readonly placeholder="—">
              <span class="mini">Proponowana moc [kW] (+15%)</span>
            </div>
            <div class="cell minwide">
              <div id="suggestedModel" class="hint">—</div>
              <span class="mini">Proponowany model</span>
            </div>
            <div class="cell"><button class="btn alt" id="applySuggested">Dopasuj model</button></div>
          </div>
        </div>

        <div class="col wide">
          <div class="muted">Podgląd ceny bieżącego zestawu:</div>
          <div id="pricePreview" class="price-preview">—</div>
          <div class="mini">Pokażę tu <b>NETTO</b> i <b>BRUTTO</b> całego zestawu przy wybranym VAT.</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Skład zestawu</h3>
      <div class="row">
        <div class="col">
          <label class="mini"><input type="checkbox" id="addChimney"> Dolicz wkład kominowy (do 10 m): 3 000 PLN (brutto)</label>
          <label class="mini"><input type="checkbox" id="addPumps"> Dolicz 3 pompki CWU: 4 000 PLN (brutto)</label>
          <label class="mini"><input type="checkbox" id="addSummerBoiler"> Dolicz bojler lato z grzałką: 2 500 PLN (brutto)</label>
        </div>
        <div class="col">
          <label>Liczba grzejników (montaż)</label>
          <input id="rads" type="number" min="0" step="1" value="0">
          <div class="mini">750 PLN/szt. (netto → brutto wg VAT)</div>
        </div>
        <div class="col">
          <label>Opis zestawu</label>
          <div id="mustHave" class="card">Wybierz markę i model — pokażę skład.</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Koszyk</h3>
      <table id="basket">
        <thead><tr><th>Pozycja</th><th>Ilość</th><th class="right">Cena (brutto)</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row">
        <div class="col"><span class="mini">Suma pozycji (NETTO)</span><div id="sumNet" class="price-preview"></div></div>
        <div class="col"><span class="mini">Razem (NETTO)</span><div id="sumFinal" class="price-preview"></div></div>
        <div class="col"><span class="mini">Razem (BRUTTO)</span><div id="sumBrutto" class="price-preview"></div></div>
        <div class="col">
          <button class="btn" id="addPack">Dodaj: Zestaw (kocioł + montaż + opcje)</button>
          <button class="btn warn" id="addBoilerOnly">Dodaj: Sam kocioł</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
'use strict';

/* ===== format/ VAT ===== */
const INT2 = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmt = n => INT2.format(Number(n)||0);
const toGross = (net, vat)=> +(Number(net||0)*(1+vat)).toFixed(2);
const toNetFromGross = (gross, vat)=> +(Number(gross||0)/(1+vat)).toFixed(2);

/* ===== stałe usług/komponentów (BRUTTO, bazowo 23%) ===== */
const VAT23=0.23, VAT8=0.08;
const COMPONENTS_GROSS23 = {
  rury: 5000, wkład10m: 3000, pompyCWU_3szt: 4000, bojlerLato: 2500,
  zawory: 1000, montaż: 6500, uszczelki: 500
};
const RAD_NET = 750; // netto/szt.

/* ===== Bufory (brutto 23%) — znane + rozszerzenie (szacunki dla 800/1000 l) ===== */
const BUFFERS_GROSS23 = {
  300: 3991.35,
  500: 5659.23,
  800: +( (5659.23/500)*800 ).toFixed(2),
  1000: +( (5659.23/500)*1000 ).toFixed(2)
};

/* ===== Zasobniki CWU (brutto 23%) ===== */
const TANKS_GROSS23 = { 120: 2100, 150: 2450, 200: 2900, 300: 3800 };

/* ===== MODELE — ceny KOTŁÓW jako NETTO (już po korekcie) ===== */
const MODELS = {
  FERROLI_PELLET: [
    {model:'Ferroli Biopellet PRO 8',  power:8,  fuel:'pellet', priceNet:12159.5},
    {model:'Ferroli Biopellet PRO 12', power:12, fuel:'pellet', priceNet:12609.5},
    {model:'Ferroli Biopellet PRO 18', power:18, fuel:'pellet', priceNet:13039.5},
    {model:'Ferroli Biopellet PRO 24', power:24, fuel:'pellet', priceNet:13394.5},
    {model:'Ferroli Biopellet PRO 30', power:30, fuel:'pellet', priceNet:14264.5},
    {model:'Ferroli Biopellet PRO 40', power:40, fuel:'pellet', priceNet:15949.5},
    {model:'Ferroli Biopellet TOP 8',  power:8,  fuel:'pellet', priceNet:13304.5},
    {model:'Ferroli Biopellet TOP 12', power:12, fuel:'pellet', priceNet:13824.5},
    {model:'Ferroli Biopellet TOP 18', power:18, fuel:'pellet', priceNet:14329.5},
    {model:'Ferroli Biopellet TOP 24', power:24, fuel:'pellet', priceNet:14744.5},
    {model:'Ferroli Biopellet TOP 30', power:30, fuel:'pellet', priceNet:15749.5},
    {model:'Ferroli Biopellet COMPACT 40', power:40, fuel:'pellet', priceNet:17249.5},
    {model:'Ferroli Biopellet COMPACT 50', power:50, fuel:'pellet', priceNet:18499.5},
  ],
  FERROLI_WOOD: [
    {model:'Ferroli CGF PRO 12', power:12, fuel:'drewno', priceNet:12224.5},
    {model:'Ferroli CGF PRO 16', power:16, fuel:'drewno', priceNet:12524.5},
    {model:'Ferroli CGF PRO 22', power:22, fuel:'drewno', priceNet:12874.5},
    {model:'Ferroli CGF PRO 32', power:32, fuel:'drewno', priceNet:13494.5},
    {model:'Ferroli CGF PRO 40', power:40, fuel:'drewno', priceNet:14524.5},
    {model:'Ferroli CGF PRO 50', power:50, fuel:'drewno', priceNet:15934.5},
  ],
  PEREKO_PELLET: [
    {model:'PEREKO QMPELL EVO 8',  power:8,  fuel:'pellet', priceNet:12992},
    {model:'PEREKO QMPELL EVO 12', power:12, fuel:'pellet', priceNet:13448},
    {model:'PEREKO QMPELL EVO 18', power:18, fuel:'pellet', priceNet:14256},
    {model:'PEREKO COMFORT-PELL 10', power:10, fuel:'pellet', priceNet:17656},
    {model:'PEREKO COMFORT-PELL 15', power:15, fuel:'pellet', priceNet:18344},
    {model:'PEREKO COMFORT-PELL 20', power:20, fuel:'pellet', priceNet:19840},
    {model:'PEREKO COMFORT-PELL 25', power:25, fuel:'pellet', priceNet:20272},
    {model:'PEREKO COMFORT-PELL 30', power:30, fuel:'pellet', priceNet:23696},
    {model:'PEREKO SPARK EVO 12', power:12, fuel:'pellet', priceNet:20920},
    {model:'PEREKO SPARK EVO 14', power:14, fuel:'pellet', priceNet:22520},
    {model:'PEREKO SPARK EVO 18', power:18, fuel:'pellet', priceNet:23320},
    {model:'PEREKO SPARK EVO 22', power:22, fuel:'pellet', priceNet:24120},
    {model:'PEREKO SPARK EVO 29', power:29, fuel:'pellet', priceNet:25720},
    {model:'PEREKO PELL-STAR 18', power:18, fuel:'pellet', priceNet:19320},
    {model:'PEREKO PELL-STAR PRO 130', power:130, fuel:'pellet', priceNet:63520},
    {model:'PEREKO PELL-STAR PRO 160', power:160, fuel:'pellet', priceNet:68320},
  ],
  PEREKO_WOOD: [
    {model:'PEREKO π 3.2', power:3.2, fuel:'drewno', priceNet:15392},
    {model:'PEREKO π 10',   power:10,  fuel:'drewno', priceNet:22736},
    {model:'PEREKO π 21',   power:21,  fuel:'drewno', priceNet:25936},
  ],
  LAZAR_PELLET: [
    {model:'LAZAR PelletFocus PF20/310', power:20, fuel:'pellet', priceNet:22900},
    {model:'LAZAR PelletFocus PF20/470', power:20, fuel:'pellet', priceNet:23900},
  ],
  DEFRO_WOOD: [
    {model:'DEFRO Optima Komfort Eko 9',  power:9,  fuel:'drewno', priceNet: 5130+5000},
    {model:'DEFRO Optima Komfort Eko 12', power:12, fuel:'drewno', priceNet: 5280+5000},
    {model:'DEFRO Optima Komfort Eko 14', power:14, fuel:'drewno', priceNet: 5437.5+5000},
    {model:'DEFRO Optima Komfort Eko 17', power:17, fuel:'drewno', priceNet: 5505+5000},
    {model:'DEFRO Optima Komfort Eko 19', power:19, fuel:'drewno', priceNet: 5850+5000},
    {model:'DEFRO Optima Komfort Eko 22', power:22, fuel:'drewno', priceNet: 5910+5000},
    {model:'DEFRO Optima Komfort Eko 24', power:24, fuel:'drewno', priceNet: 6892.5+5000},
    {model:'DEFRO Optima Komfort Eko 28', power:28, fuel:'drewno', priceNet: 7035+5000},
    {model:'DEFRO Optima Komfort Eko 35', power:35, fuel:'drewno', priceNet: 7995+5000},
    {model:'DEFRO Optima Komfort Eko 45', power:45, fuel:'drewno', priceNet: 9187.5+5000},
  ],
  /* DEFRO_PELLET zostanie dopisane poniżej */
};

/* ===== DEFRO pellet — baza NETTO (katalog), +5000 NETTO na sztukę ===== */
const DEFRO_PELLET_BASE = [
  // Hydropell
  { model: 'DEFRO Hydropell',       power: 8,  baseNet:  9340 },
  { model: 'DEFRO Hydropell',       power: 12, baseNet:  9930 },
  { model: 'DEFRO Hydropell',       power: 18, baseNet: 10740 },
  { model: 'DEFRO Hydropell',       power: 24, baseNet: 11430 },

  // Komfort Eko Mini
  { model: 'DEFRO Komfort Eko Mini', power: 11, baseNet: 10820 },
  { model: 'DEFRO Komfort Eko Mini', power: 12, baseNet: 11320 },
  { model: 'DEFRO Komfort Eko Mini', power: 15, baseNet: 12600 },
  { model: 'DEFRO Komfort Eko Mini', power: 20, baseNet: 13310 },
  { model: 'DEFRO Komfort Eko Mini', power: 24, baseNet: 14670 },

  // Komfort Eko Lux
  { model: 'DEFRO Komfort Eko Lux', power: 12, baseNet: 12570 },
  { model: 'DEFRO Komfort Eko Lux', power: 13, baseNet: 13000 },
  { model: 'DEFRO Komfort Eko Lux', power: 14, baseNet: 13670 },
  { model: 'DEFRO Komfort Eko Lux', power: 15, baseNet: 15010 },
  { model: 'DEFRO Komfort Eko Lux', power: 17, baseNet: 15740 },
  { model: 'DEFRO Komfort Eko Lux', power: 20, baseNet: 18550 },

  // Delta EkoPell
  { model: 'DEFRO Delta EkoPell',   power: 10, baseNet: 15400 },

  // Evopell
  { model: 'DEFRO Evopell',         power: 11, baseNet: 12500 },
  { model: 'DEFRO Evopell',         power: 14, baseNet: 13490 },

  // Smart Ekopell
  { model: 'DEFRO Smart Ekopell',   power: 12, baseNet: 17800 },
  { model: 'DEFRO Smart Ekopell',   power: 20, baseNet: 18860 },
  { model: 'DEFRO Smart Ekopell',   power: 24, baseNet: 19450 },
  { model: 'DEFRO Smart Ekopell',   power: 28, baseNet: 20790 },
  { model: 'DEFRO Smart Ekopell',   power: 38, baseNet: 23320 },

  // Gamma
  { model: 'DEFRO Gamma',           power: 12, baseNet: 15920 },
  { model: 'DEFRO Gamma',           power: 24, baseNet: 16310 },
  { model: 'DEFRO Gamma',           power: 30, baseNet: 17190 },
  { model: 'DEFRO Gamma',           power: 36, baseNet: 17880 },
  { model: 'DEFRO Gamma',           power: 40, baseNet: 19140 },
  { model: 'DEFRO Gamma',           power: 56, baseNet: 21760 },
];
const DEFRO_PELLET = DEFRO_PELLET_BASE.map(d => ({
  model: d.model,
  power: d.power,
  fuel: 'pellet',
  // + dopłata stała 5000 NETTO do urządzenia
  priceNet: +(d.baseNet * 0.75 + 5000).toFixed(2),
}));
// dopisz gałąź do MODELS
MODELS.DEFRO_PELLET = DEFRO_PELLET;

/* ===== Stan ===== */
const state = {
  brand:'FERROLI_PELLET',
  vat:VAT8,
  variant:'bez', // bez/dotacja
  selected:null,
  rads:0,
  addChimney:false, addPumps:true, addSummerBoiler:false, // pompki domyślnie WŁĄCZONE także bez dotacji
  bufRule:50, bufNeed:0, bufferSize:0,
  tankLiters:0,
};
const basket = [];

/* ===== UKRYTE DOPŁATY (BRUTTO) ===== */
const HIDDEN_PACK_MARGIN_GROSS = 2000;          // +2000 PLN do każdego zestawu
const HIDDEN_DOTACJA_EXTRA_GROSS = 1000;        // +1000 PLN dodatkowo dla „z dotacją” (tylko pellet)

/* ===== pomocnicze ===== */
const q = s=>document.querySelector(s);
const fuelOf = brand => (brand.includes('WOOD')?'drewno':'pellet');
const requiresBuffer = () => fuelOf(state.brand)==='drewno';

/* ===== UI fill ===== */
function fillBoilers(){
  const list = MODELS[state.brand]||[];
  const s = q('#boiler');
  s.innerHTML = list.map((b,i)=>`<option value="${i}">${b.model} • ${b.power} kW</option>`).join('');
  s.value='0';
  state.selected = list[0]||null;
  applyBoiler();
}
function fillTanks(){
  const s=q('#tank'); s.innerHTML = '<option value="0">— bez zasobnika —</option>';
  Object.keys(TANKS_GROSS23).map(Number).sort((a,b)=>a-b).forEach(L=>{
    s.innerHTML += `<option value="${L}">${L} l • ${fmt(TANKS_GROSS23[L])} PLN</option>`;
  });
  s.value='0'; state.tankLiters=0;
}
function applyBoiler(){
  const b = state.selected; if(!b) return;
  q('#power').value = b.power ? (b.power+' kW') : '';

  const pellet = (b.fuel==='pellet');
  q('#variant').disabled = !pellet;
  if(!pellet && state.variant==='dotacja'){ state.variant='bez'; q('#variant').value='bez'; }

  // auto: POMPKI zaznaczone ZAWSZE; pozostałe auto tylko przy dotacji
  q('#addPumps').checked = true; state.addPumps = true;
  if(state.variant==='dotacja' && pellet){
    q('#addChimney').checked = true; state.addChimney = true;
    q('#addSummerBoiler').checked = true; state.addSummerBoiler = true;
  }else{
    q('#addChimney').checked = false; state.addChimney = false;
    q('#addSummerBoiler').checked = false; state.addSummerBoiler = false;
  }

  updateBufferCalc();
  renderMustHave(); renderPreview();
}
function renderMustHave(){
  const b = state.selected; if(!b){ q('#mustHave').textContent='Wybierz kocioł'; return; }
  const lines = [];
  lines.push(`Kocioł — ${b.model} (${b.power} kW) • ${b.fuel}`);
  if(state.tankLiters>0) lines.push(`Zasobnik CWU — ${state.tankLiters} l`);
  lines.push('Montaż instalacji, uruchomienie, konfiguracja sterowania');
  lines.push('Zawory/odpowietrzniki/naczynie');
  lines.push('Uszczelki/izolacje');
  if(state.addChimney) lines.push('Wkład kominowy (do 10 m)');
  if(state.addPumps)   lines.push('Pompy obiegowe CWU (3 szt.)');
  if(state.addSummerBoiler) lines.push('Bojler z grzałką — tryb lato');
  if(requiresBuffer()){
    if(state.bufferSize>0) lines.push(`Bufor ciepła ${state.bufferSize} l (zalecane ≥ ${Math.ceil(state.bufNeed)} l)`);
    else lines.push(`Bufor ciepła — wymagany (zalecane ≥ ${Math.ceil(state.bufNeed)} l)`);
  }
  const r = Number(state.rads)||0; if(r>0) lines.push(`Montaż grzejników: ${r} × (stawka netto 750 PLN)`);
  q('#mustHave').innerHTML = '<ul class="clean">'+lines.map(x=>`<li>${x}</li>`).join('')+'</ul>';
}

/* ===== Bufor kalkulator ===== */
function updateBufferCalc(){
  const b = state.selected; if(!b) return;
  const need = (Number(b.power)||0) * (Number(state.bufRule)||50);
  state.bufNeed = need;
  q('#bufNeed').value = fmt(need);
  q('#bufHint').style.display = requiresBuffer() ? '' : 'none';
  if(requiresBuffer()){
    let pick = 0;
    if(need<=300) pick=300;
    else if(need<=500) pick=500;
    else if(need<=800) pick=800;
    else pick=1000;
    state.bufferSize = pick;
    q('#bufferSize').value = String(pick);
  }else{
    state.bufferSize = 0; q('#bufferSize').value='0';
  }
}

/* ===== przeliczenia ===== */
function componentsNetFromGross23(g){ return toNetFromGross(g, VAT23); }
function packNet(){
  const b = state.selected; if(!b) return 0;
  let net = Number(b.priceNet)||0; // kocioł NETTO

  // komponenty „brutto 23%” -> NETTO
  const addGross23 = [];
  addGross23.push(COMPONENTS_GROSS23.montaż);
  addGross23.push(COMPONENTS_GROSS23.zawory);
  addGross23.push(COMPONENTS_GROSS23.uszczelki);
  addGross23.push(COMPONENTS_GROSS23.rury);
  if(state.tankLiters>0) addGross23.push(TANKS_GROSS23[state.tankLiters]||0);
  if(state.addChimney) addGross23.push(COMPONENTS_GROSS23.wkład10m);
  if(state.addPumps) addGross23.push(COMPONENTS_GROSS23.pompyCWU_3szt);
  if(state.addSummerBoiler) addGross23.push(COMPONENTS_GROSS23.bojlerLato);
  if(requiresBuffer() && state.bufferSize>0){ addGross23.push(BUFFERS_GROSS23[state.bufferSize]||0); }

  const compNet = addGross23.reduce((a,g)=> a + componentsNetFromGross23(g), 0);
  const radsNet = (Number(state.rads)||0) * RAD_NET;

  // === UKRYTE DOPŁATY (dodawane jako BRUTTO, przeliczone na NETTO wg bieżącego VAT) ===
  const vat = Number(q('#vat').value) || VAT8;
  const hiddenBaseNet = toNetFromGross(HIDDEN_PACK_MARGIN_GROSS, vat);
  const hiddenDotacjaNet = (state.variant==='dotacja' && b.fuel==='pellet')
    ? toNetFromGross(HIDDEN_DOTACJA_EXTRA_GROSS, vat) : 0;

  return net + compNet + radsNet + hiddenBaseNet + hiddenDotacjaNet;
}
function renderPreview(){
  const vat = Number(q('#vat').value)||VAT8;
  const net = packNet();
  const gross = toGross(net, vat);
  q('#pricePreview').textContent = `NETTO: ${fmt(net)} PLN  |  BRUTTO: ${fmt(gross)} PLN (VAT ${Math.round(vat*100)}%)`;
}

/* ===== koszyk ===== */
function renderBasket(){
  const tb = q('#basket tbody'); tb.innerHTML='';
  let sumNet=0; const vat = Number(q('#vat').value)||VAT8;

  basket.forEach((it,i)=>{
    sumNet += it.net*it.qty;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td><input type="number" min="1" value="${it.qty}" data-ix="${i}" style="width:70px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;"></td>
      <td class="right">${fmt(toGross(it.net, vat))} PLN</td>
      <td class="right"><button class="btn warn" data-del="${i}">Usuń</button></td>`;
    tb.appendChild(tr);
  });
  q('#sumNet').textContent = fmt(sumNet)+' PLN';
  q('#sumFinal').textContent = fmt(sumNet)+' PLN';
  q('#sumBrutto').textContent = fmt(toGross(sumNet, vat))+' PLN';
}
function addToBasket(name, net, qty=1){
  basket.push({name, net:Number(net)||0, qty:Number(qty)||1}); renderBasket();
}

/* ===== zdarzenia ===== */
q('#brand').addEventListener('change', ()=>{ state.brand = q('#brand').value; fillBoilers(); });
q('#boiler').addEventListener('change', ()=>{ const i=Number(q('#boiler').value)||0; state.selected=(MODELS[state.brand]||[])[i]||null; applyBoiler(); });
q('#variant').addEventListener('change', ()=>{ state.variant=q('#variant').value; applyBoiler(); });
['addChimney','addPumps','addSummerBoiler'].forEach(id=>{
  q('#'+id).addEventListener('change', e=>{ state[id]=e.target.checked; renderMustHave(); renderPreview(); });
});
q('#rads').addEventListener('input', e=>{ state.rads=Math.max(0,Number(e.target.value)||0); renderMustHave(); renderPreview(); });
q('#vat').addEventListener('change', renderPreview);
q('#bufRule').addEventListener('change', e=>{ state.bufRule=Number(e.target.value)||50; updateBufferCalc(); renderMustHave(); renderPreview(); });
q('#bufferSize').addEventListener('change', e=>{ state.bufferSize=Number(e.target.value)||0; renderMustHave(); renderPreview(); });
q('#tank').addEventListener('change', e=>{ state.tankLiters=Number(e.target.value)||0; renderMustHave(); renderPreview(); });

document.addEventListener('input', (e)=>{
  if(e.target.matches('[data-ix]')){
    const i=Number(e.target.getAttribute('data-ix')); basket[i].qty=Math.max(1,Number(e.target.value)||1); renderBasket();
  }
});
document.addEventListener('click', (e)=>{
  if(e.target.matches('[data-del]')){ const i=Number(e.target.getAttribute('data-del')); basket.splice(i,1); renderBasket(); }
});

q('#addPack').addEventListener('click', ()=>{
  const b = state.selected; if(!b) return alert('Wybierz kocioł');
  if(requiresBuffer() && state.bufferSize===0) return alert('Dla kotłów zgazowujących wymagany jest bufor.');
  const net = packNet();
  const tags = [];
  if(state.tankLiters>0) tags.push(`CWU ${state.tankLiters} l`);
  if(state.addChimney) tags.push('wkład 10 m');
  if(state.addPumps) tags.push('3 pompki CWU');
  if(state.addSummerBoiler) tags.push('bojler lato');
  if(state.bufferSize>0) tags.push(`bufor ${state.bufferSize} l`);
  const r = Number(state.rads)||0; if(r>0) tags.push(`grzejniki x${r}`);
  addToBasket(`Zestaw: ${b.model}${tags.length? ' ['+tags.join(', ')+']':''}`, net, 1);
});
q('#addBoilerOnly').addEventListener('click', ()=>{
  const b = state.selected; if(!b) return alert('Wybierz kocioł');
  addToBasket(`Kocioł: ${b.model} — tylko urządzenie`, Number(b.priceNet)||0, 1);
});
q('#exportXLSX').addEventListener('click', ()=>{
  const vat = Number(q('#vat').value)||VAT8;
  const rows = basket.map(it => ({Pozycja:it.name, Ilość:it.qty, Netto_PLN:it.net, Brutto_PLN:toGross(it.net, vat)}));
  const sumNet = basket.reduce((a,b)=>a+b.net*b.qty,0);
  rows.push({Pozycja:'',Ilość:'',Netto_PLN:'',Brutto_PLN:''});
  rows.push({Pozycja:'Razem (NETTO)',Ilość:'',Netto_PLN:sumNet,Brutto_PLN:''});
  rows.push({Pozycja:`Razem (BRUTTO, VAT ${Math.round(vat*100)}%)`,Ilość:'',Netto_PLN:'',Brutto_PLN:toGross(sumNet, vat)});
  const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Oferta');
  XLSX.writeFile(wb, 'Oferta_kotly.xlsx');
});
q('#printBtn').addEventListener('click', ()=>window.print());

/* ===== Dobór mocy ===== */
function calcSuggested(){
  const A = Math.max(0, Number(q('#houseArea').value)||0);
  const W = Math.max(10, Number(q('#buildingStd').value)||50);
  const kw = A*W/1000 * 1.15;
  q('#suggestedKW').value = fmt(kw);
  const pick = pickModelForKW(kw); q('#suggestedModel').textContent = pick ? `${pick.model} (${pick.power} kW)` : '—';
  return kw;
}
function pickModelForKW(kw){
  const list = (MODELS[state.brand]||[]).slice().sort((a,b)=>a.power-b.power);
  return list.find(x=>x.power>=kw) || list[list.length-1] || null;
}
q('#houseArea').addEventListener('input', calcSuggested);
q('#buildingStd').addEventListener('change', calcSuggested);
q('#applySuggested').addEventListener('click', ()=>{
  const pick = pickModelForKW(calcSuggested()); if(!pick) return;
  const list = MODELS[state.brand]||[]; const idx = list.findIndex(m => m.model===pick.model && m.power===pick.power);
  if(idx>=0){ q('#boiler').value=String(idx); state.selected=list[idx]; applyBoiler(); }
});

/* ===== init ===== */
function init(){
  fillBoilers();
  fillTanks();
  // start: pompki zaznaczone także dla "bez", dotacja automatycznie dopełnia resztę opcji
  q('#addPumps').checked = true; state.addPumps = true;
  if(fuelOf(state.brand)==='pellet'){ state.variant='dotacja'; q('#variant').value='dotacja'; }
  applyBoiler();
  renderBasket();
  calcSuggested();
}
init();
</script>
</body>
</html>



