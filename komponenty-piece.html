<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komponenty ‚Ä¢ Piece / Kot≈Çy</title>
<meta name="description" content="Katalog kot≈Ç√≥w (gaz, pellet, drewno, olej, elektryczne) z mostkiem do konfigurator√≥w, kalkulatorem mocy i wymaganiami zestawu.">
<style>
  :root{
    --bg:#0b1020; --ink:#e8edff; --muted:#aeb8da; --line:#263168; --card:#0f1636;
    --chip:#1a244d; --accent:#4cc9f0; --ok:#2fbf71; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,#10173c,#111b48);border:1px solid #2b3a77;border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end;margin-left:auto}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:#2f9e44}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:#aeb8da;font-size:13px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .tab{padding:6px 10px;border-radius:999px;border:1px solid #2a3a75;cursor:pointer}
  .tab[aria-selected="true"]{background:#1b2550;border-color:#67a1ff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;border-bottom:1px solid #2a3a77;text-align:left;vertical-align:top}
  th{font-size:12px;color:#aeb8da}
  .scroll{overflow:auto}
  .chip{display:inline-block;background:var(--chip);border:1px solid #2b3a77;border-radius:999px;padding:4px 8px;font-size:12px}
  .price{white-space:nowrap}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .wide{min-width:200px}
  .sticky-foot{position:sticky;bottom:0;background:#0f1636;border-top:1px solid #2b3a77;padding:10px;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  @media (max-width:1100px){ .hide-sm{display:none} }
  @media print{ nav,.toolbar,.sticky-foot{display:none!important} }

  /* Bridge (mostek) + kalkulator mocy + wymagania */
  .bridge{display:grid;grid-template-columns:1.2fr 1.8fr 1.2fr;gap:14px}
  @media (max-width:1280px){ .bridge{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg,#0f1636,#0f1a44);border:1px solid #2b3a77;border-radius:12px;padding:12px}
  .panel h3{margin:0 0 8px;font-size:16px}
  .list{max-height:360px;overflow:auto;border:1px solid #2b3a77;border-radius:10px}
  .list table{width:100%;border-collapse:collapse}
  .list th,.list td{border-bottom:1px solid #243167;padding:8px 10px}
  .list tr:hover{background:#152056}
  .list tr[aria-selected="true"]{background:#19286a}
  .tip{font-size:12px;color:#aeb8da}
  .okBadge{display:inline-block;padding:2px 6px;border-radius:6px;background:#133a2b;border:1px solid #2f9e44;color:#c8ffd8;font-size:11px;margin-left:6px}
  .req-list{margin:8px 0 0 16px}
  .req-list li{margin:4px 0}
</style>
</head>
<body>

<header>
  <h1>Komponenty ‚Ä¢ Piece / Kot≈Çy</h1>
  <div class="muted">Gaz ‚Ä¢ Kondensacyjne ‚Ä¢ Na pellet ‚Ä¢ Na drewno (w tym zgazowujƒÖce) ‚Ä¢ Olejowe ‚Ä¢ Elektryczne ‚Äî katalog + mostek do konfigurator√≥w + kalkulator mocy + wymagania zestawu.</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="klienci.html">Klienci</a>
  <a href="kalkulator.html">Kalkulator</a>
  <a href="komponenty-pompy.html">Pompy ciep≈Ça</a>
  <a href="komponenty-piece.html" aria-current="page">Piece</a>
  <a href="komponenty-fotowoltaika.html">Fotowoltaika</a>
  <a href="komponenty-ocieplenie.html">Ocieplenie</a>
  <a href="komponenty-stolarka.html">Stolarka</a>
  <a href="dokumenty.html">Dokumenty</a>
  <a href="upload.html">Przesy≈Ç plik√≥w</a>
  <a href="chat.html">Komunikator</a>
  <a href="ustawienia.html">Ustawienia</a>
  <a href="lidy.html">Lidy</a>
</nav>

<div class="wrap">
  <!-- ===== MOSTEK + KALKULATOR + WYMAGANIA ===== -->
  <div class="card">
    <div class="bridge">
      <!-- 1) Mostek z wyborem modeli -->
      <div class="panel">
        <h3>Mostek do konfigurator√≥w</h3>
        <div class="row">
          <select id="brBrand" title="Marka">
            <option value="Ferroli">Ferroli (gaz-kondens.)</option>
            <option value="DEFRO">DEFRO (pellet)</option>
            <option value="Stalmark">Stalmark (pellet)</option>
            <option value="LAZAR">LAZAR (drewno / zgazowujƒÖcy)</option>
          </select>
          <input id="brQ" placeholder="Szukaj modelu‚Ä¶" style="min-width:220px">
          <input id="brPmin" type="number" step="0.1" placeholder="Moc min [kW]" style="width:130px">
          <input id="brPmax" type="number" step="0.1" placeholder="Moc max [kW]" style="width:130px">
          <select id="brSort" title="Sortowanie">
            <option value="power">Sortuj: moc</option>
            <option value="price">Sortuj: cena</option>
            <option value="model">Sortuj: model</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="brSend">Wy≈õlij model do konfiguratora</button>
          <button class="btn ghost" id="brOpen">Otw√≥rz sam konfigurator</button>
          <span class="pill">Wybrane ID: <b id="brSel">‚Äî</b></span>
        </div>
        <div class="tip" style="margin-top:6px">
          Dwuklik w wiersz wysy≈Ça model i otwiera odpowiedni konfigurator.  
          U≈ºywane klucze: <code>arkon_components_boilers_v2</code>, <code>arkon_selected_boiler_id</code>, <code>arkon_pref_brand</code>, <code>arkon_pref_fuel</code>, <code>arkon_return_to</code>, <code>arkon_boilers_updated</code>.
        </div>
        <div id="brandStats" class="row" style="margin-top:8px">
          <span class="pill">Ferroli: <b id="cntFerroli">0</b></span>
          <span class="pill">DEFRO: <b id="cntDEFRO">0</b></span>
          <span class="pill">Stalmark: <b id="cntStalmark">0</b></span>
          <span class="pill">LAZAR: <b id="cntLazar">0</b></span>
        </div>
        <div class="list" style="margin-top:8px">
          <table>
            <thead><tr><th>Model</th><th>Moc [kW]</th><th>Typ</th><th class="price">Cena</th><th>ID</th></tr></thead>
            <tbody id="brList"></tbody>
          </table>
        </div>
      </div>

      <!-- 2) Kalkulator proponowanej mocy -->
      <div class="panel">
        <h3>Dob√≥r mocy budynku</h3>
        <div class="row">
          <input id="calcArea" type="number" min="30" step="1" placeholder="Powierzchnia [m¬≤]" style="width:160px">
          <select id="calcInsul" title="Izolacja">
            <option value="new">Nowy/energooszczƒôdny</option>
            <option value="std" selected>≈örednia izolacja</option>
            <option value="old">Stary/s≈Çaba izolacja</option>
          </select>
          <select id="calcZone" title="Strefa klimatyczna">
            <option value="mild">≈Åagodna</option>
            <option value="normal" selected>Typowa</option>
            <option value="cold">Ch≈Çodna</option>
          </select>
          <input id="calcCWU" type="number" min="0" step="1" placeholder="Os√≥b CWU" style="width:120px">
          <input id="calcMargin" type="number" min="0" step="1" value="15" placeholder="Margines [%]" style="width:130px">
        </div>
        <div class="row" style="margin-top:6px">
          <span class="pill">Proponowana moc: <b id="calcOut">‚Äî kW</b></span>
          <button class="btn ghost" id="calcApply">Zastosuj do filtr√≥w</button>
        </div>
        <div class="tip">Algorytm orientacyjny (straty ciep≈Ça √ó strefa + CWU + margines). U≈ºyj jako punkt startowy.</div>
      </div>

      <!-- 3) Wymagania zestawu (auto, z uwzglƒôdnieniem zgazowujƒÖcych) -->
      <div class="panel">
        <h3>Wymagania zestawu (auto)</h3>
        <div class="tip">Wybierz model w mostku lub zaznacz w tabeli poni≈ºej ‚Äî poka≈ºƒô ‚Äûmust-have‚Äù: zbiorniki, komin, bufor (dla zgazowujƒÖcych), armaturƒô itd. Je≈õli konfigurator danej marki zapisa≈Ç domy≈õlne mapy do <code>arkon_cfg_defaults</code>, u≈ºyjƒô ich.</div>
        <div id="reqSummary" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- ===== TOOLBAR ===== -->
  <div class="card">
    <div class="row toolbar">
      <button id="add" class="btn ok">+ Dodaj kocio≈Ç</button>
      <button id="dupSel" class="btn">Duplikuj zaznaczone</button>
      <button id="delSel" class="btn bad">Usu≈Ñ zaznaczone</button>
      <span class="pill">Razem: <b id="countAll">0</b></span>
      <span class="pill">Widocznych: <b id="countVis">0</b></span>
      <span class="pill">Zaznaczonych: <b id="countSel">0</b></span>
      <div class="right">
        <button id="expJSON" class="btn ghost">Eksport JSON</button>
        <label class="btn ghost">Import JSON <input id="impJSON" type="file" accept="application/json" hidden></label>
        <button id="expCSV" class="btn ghost">Eksport CSV</button>
      </div>
    </div>
  </div>

  <!-- ===== FILTRY ===== -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="üîé Szukaj: marka, model, cecha‚Ä¶" class="wide">
      <select id="fFuel">
        <option value="">Paliwo / typ</option>
        <option>gaz</option><option>gaz-kondensacyjny</option>
        <option>pellet</option><option>drewno</option><option>olej</option><option>elektryczny</option>
      </select>
      <select id="fPhase">
        <option value="">Zasilanie (fazy)</option>
        <option value="1F">1F</option><option value="3F">3F</option>
      </select>
      <select id="fChimney">
        <option value="">Wym√≥g komina</option>
        <option value="TAK">TAK</option><option value="NIE">NIE</option>
      </select>
      <input id="fPowMin" type="number" step="0.1" placeholder="Moc min [kW]" style="width:130px">
      <input id="fPowMax" type="number" step="0.1" placeholder="Moc max [kW]" style="width:130px">
      <input id="fCenaMin" type="number" step="1" placeholder="Cena min [z≈Ç]" style="width:130px">
      <input id="fCenaMax" type="number" step="1" placeholder="Cena max [z≈Ç]" style="width:130px">
      <label class="pill"><input id="fCond" type="checkbox" style="margin-right:6px">Kondensacyjny</label>
      <button id="clearFilters" class="btn ghost">Wyczy≈õƒá filtry</button>
      <span class="right"><span class="muted">Skr√≥ty: <span class="kbd">Alt+N</span> nowy ‚Ä¢ <span class="kbd">/</span> szukaj</span></span>
    </div>
    <div class="tabs" role="tablist" aria-label="Kategorie paliw">
      <button class="tab" data-tab="" aria-selected="true">Wszystkie</button>
      <button class="tab" data-tab="gaz">Gaz</button>
      <button class="tab" data-tab="gaz-kondensacyjny">Gaz (kondens.)</button>
      <button class="tab" data-tab="pellet">Pellet</button>
      <button class="tab" data-tab="drewno">Drewno</button>
      <button class="tab" data-tab="olej">Olej</button>
      <button class="tab" data-tab="elektryczny">Elektryczne</button>
    </div>
  </div>

  <!-- ===== TABELA ===== -->
  <div class="card" style="padding:0">
    <div class="scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th class="hide-sm"><input type="checkbox" id="chkAll"></th>
            <th>Marka</th>
            <th>Model</th>
            <th>Typ/paliwo</th>
            <th>Moc [kW] (min‚Äìmax)</th>
            <th>Sprawno≈õƒá</th>
            <th>Modulacja</th>
            <th>Klasa emisji</th>
            <th>Zasobnik [l]</th>
            <th>Sterowanie</th>
            <th>Zasilanie</th>
            <th>Ha≈Ças [dB]</th>
            <th>Wymiary [mm]</th>
            <th>Waga [kg]</th>
            <th>Gwarancja [lata]</th>
            <th>Komin</th>
            <th>Spalin √ò [mm]</th>
            <th>Akcesoria</th>
            <th class="price">Cena [z≈Ç]</th>
            <th class="price">Monta≈º [z≈Ç]</th>
            <th class="price">Serwis [z≈Ç]</th>
            <th class="wide">Uwagi</th>
            <th>Akcje</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="sticky-foot row">
      <div class="muted">Kliknij kom√≥rkƒô by edytowaƒá. Enter ‚Äî potwierd≈∫, Esc ‚Äî anuluj. Dwuklik w wierszu otwiera w≈Ça≈õciwy konfigurator i wysy≈Ça model.</div>
      <div class="right">
        <button id="seed" class="btn ghost">Za≈Çaduj przyk≈Çadowe</button>
        <button id="wipe" class="btn bad">Wyczy≈õƒá wszystko</button>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT0 = new Intl.NumberFormat('pl-PL', {maximumFractionDigits:0});
const INT2 = new Intl.NumberFormat('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2});
const esc = s => (s==null?'':String(s)).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
function toNum(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
function csvEsc(v){ let s=(v==null?'':String(v)); if(/[;\\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; }
const UID = ()=>'PC_'+Math.random().toString(36).slice(2)+'_'+Date.now().toString(36);

/* ===== storage & bridge keys ===== */
const LS_KEY='arkon_components_boilers_v2';
const PING_KEY='arkon_boilers_updated';
const SEL_KEY='arkon_selected_boiler_id';
const PREF_BRAND='arkon_pref_brand';
const PREF_FUEL='arkon_pref_fuel';
const RETURN_KEY='arkon_return_to';
const CFG_DEFAULTS_KEY='arkon_cfg_defaults'; // opcjonalne domy≈õlne mapy z konfigurator√≥w

/* ===== mapowanie marek ‚Üí pliki konfigurator√≥w ===== */
const BRAND_FILES = JSON.parse(localStorage.getItem('arkon_brand_files')||'{}');
function confFile(brand){
  const b=(brand||'').toLowerCase();
  return BRAND_FILES[b] ||
    (b==='ferroli' ? 'ferroli_konfigurator.html' :
     b==='defro'   ? 'defro_piece.html' :
     b==='stalmark'? 'stalmark_pellet.html' :
     b==='lazar'   ? 'lazar_zgazowujace.html' : 'ferroli_konfigurator.html');
}
function brandFuel(brand){
  const b=(brand||'').toLowerCase();
  if(b==='defro'||b==='stalmark') return 'pellet';
  if(b==='lazar') return 'drewno';
  return 'gaz-kondensacyjny';
}
function openConfigurator(brand){
  try{
    localStorage.setItem(RETURN_KEY, location.href);
    localStorage.setItem(PREF_BRAND, brand);
    localStorage.setItem(PREF_FUEL, brandFuel(brand));
  }catch{}
  window.open(confFile(brand), '_blank', 'noopener');
}
function sendToConfigurator(id, brand){
  if(!id){ alert('Wybierz model.'); return; }
  try{
    localStorage.setItem(SEL_KEY, id);
    localStorage.setItem(PREF_BRAND, brand);
    localStorage.setItem(PREF_FUEL, brandFuel(brand));
    localStorage.setItem(RETURN_KEY, location.href);
    localStorage.setItem(PING_KEY, String(Date.now()));
  }catch{}
  openConfigurator(brand);
}

/* ===== stan ===== */
let rows = loadRows();
let filter = { q:'', fuel:'', phase:'', chimney:'', powMin:'', powMax:'', priceMin:'', priceMax:'', cond:false };
let selected = new Set();
let brSelectedId = null;
let proposedKW = null;

function loadRows(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
function saveRows(){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); localStorage.setItem(PING_KEY, String(Date.now())); render(); fillBridgeList(); updateReqPanel(); updateBrandStats(); }

/* ===== kalkulator mocy ===== */
function calcKW(area, insul, zone, cwu, margin){
  const qWm2 =
    insul==='new'? 35 :
    insul==='old'? 70 : 50; // std
  const zoneK =
    zone==='mild'? 0.9 :
    zone==='cold'? 1.15 : 1.0;
  const base = area*qWm2*zoneK; // W
  const baseKW = base/1000;
  const cwuKW = Math.min(6, Math.max(0, (cwu||0)*0.25)); // ~0.25 kW/os. (orientacyjnie, cap 6 kW)
  const out = (baseKW + cwuKW)*(1+(margin||0)/100);
  return Math.max(3, Math.round(out*10)/10); // min 3 kW, 0.1
}

/* ===== domy≈õlne mapy (fallback) + ewentualne nadpisania z konfigurator√≥w ===== */
const FALLBACK_CFG = {
  common: {
    tanks: {'120':2100,'150':2450,'200':2900,'300':3800},
    radPrice:750, chimneyPrice:650, packInstall:18000
  },
  LAZAR: { bufferPerKW_min:50, bufferPerKW_rec:70 },
  DEFRO: {},
  Stalmark: {},
  Ferroli: {}
};
function cfgBrand(brand){
  let cfg={...FALLBACK_CFG.common};
  try{
    const raw = JSON.parse(localStorage.getItem(CFG_DEFAULTS_KEY)||'{}');
    if(raw && raw.common){ cfg = {...cfg, ...raw.common}; }
    if(raw && raw[brand]){ cfg = {...cfg, ...raw[brand]}; }
  }catch{}
  return cfg;
}

/* ===== panel wymaga≈Ñ ===== */
function asKW(r){ const lo=Number(r.powMin)||0, hi=Number(r.powMax)||0; return hi||lo||null; }
function reqFor(row){
  if(!row) return {title:'‚Äî', items:[], notes:[]};
  const brand=row.brand||'';
  const fuel=(row.fuel||'').toLowerCase();
  const cfg=cfgBrand(brand);
  const kw=asKW(row);
  const items=[], notes=[];
  // wsp√≥lne
  if(fuel.includes('pellet')){
    items.push('Zasobnik pelletu + podajnik (zgodnie z modelem)');
    items.push('Zapalarka + automatyczne czyszczenie (je≈õli w modelu)');
  }
  items.push('Grupa bezpiecze≈Ñstwa CO 3 bar');
  items.push('Pompa obiegowa CO + filtr siatkowy + separator magnetyczny');
  items.push('Naczynie przeponowe CO (dob√≥r do instalacji)');
  // komin i ≈õrednica
  if(String(row.chimney||'').toUpperCase()==='TAK'){
    const fl = row.flue ? ` ‚Ä¢ zalec. √ò ${row.flue} mm` : '';
    items.push(`Wk≈Çad kominowy (stal kwasoodporna): ${cfg.chimneyPrice||FALLBACK_CFG.common.chimneyPrice} PLN/mb${fl}`);
  }else{
    notes.push('Model nie wymaga tradycyjnego komina (sprawd≈∫ system pow.-spalinowy).');
  }
  // CWU
  items.push('Zasobnik CWU: 120/150/200/300 l (wg doboru)');
  // zgazowujƒÖce drewno ‚Üí bufor
  if(fuel.includes('drewno')){
    const minL = kw ? Math.ceil((kw*(cfg.bufferPerKW_min||50))/100)*100 : null;
    const recL = kw ? Math.ceil((kw*(cfg.bufferPerKW_rec||70))/100)*100 : null;
    items.push(`Bufor ciep≈Ça: min ~${minL?INT0.format(minL):'50¬∑l/kW'}, rekom. ~${recL?INT0.format(recL):'70¬∑l/kW'}`);
    items.push('Zaw√≥r mieszajƒÖcy ochrony powrotu / uk≈Çad typu Laddomat');
    items.push('Zaw√≥r bezpiecze≈Ñstwa termiczny (wƒô≈ºownica sch≈ÇadzajƒÖca, je≈ºeli wymagana)');
    notes.push('Bufor jest wymagany przy kot≈Çach zgazowujƒÖcych ‚Äî poprawia sprawno≈õƒá i bezpiecze≈Ñstwo.');
  }
  // dopiski wg sterowania
  if((row.ctrl||'').toLowerCase().includes('opentherm')) items.push('Sterownik pokojowy OpenTherm / pogodowy');
  return {
    title:`${row.brand||''} ${row.model||''} ${kw?`‚Ä¢ ${kw} kW`:''}`,
    kw, items, notes,
    tanks: cfg.tanks || FALLBACK_CFG.common.tanks,
    radPrice: cfg.radPrice || FALLBACK_CFG.common.radPrice,
    chimneyPrice: cfg.chimneyPrice || FALLBACK_CFG.common.chimneyPrice
  };
}
function renderReqBox(data){
  const box = $('#reqSummary');
  if(!data || !data.title){ box.innerHTML = '<div class="muted">Wybierz model w mostku albo zaznacz w tabeli.</div>'; return; }
  const tankList = Object.keys(data.tanks||{}).map(s=>`${s} l ‚Äî ${INT2.format((data.tanks||{})[s])} PLN`).join(', ');
  box.innerHTML = `
    <div><b>${esc(data.title)}</b></div>
    ${data.kw?`<div class="muted" style="margin-top:4px">Moc bazowa do wymaga≈Ñ: ${INT2.format(data.kw)} kW</div>`:''}
    <ul class="req-list">
      ${data.items.map(it=>`<li>${esc(it)}</li>`).join('')}
    </ul>
    <div class="muted" style="margin-top:6px">Przyk≈Çadowe ceny: grzejnik (monta≈º) ~ ${INT0.format(data.radPrice)} PLN/szt., wk≈Çad kominowy ~ ${INT0.format(data.chimneyPrice)} PLN/mb.</div>
    <div class="muted">Zasobniki CWU: ${tankList||'‚Äî'}</div>
    ${data.notes?.length? `<div class="tip" style="margin-top:6px">${data.notes.map(n=>`‚Ä¢ ${esc(n)}`).join('<br>')}</div>`:''}
  `;
}
function currentRowById(id){ return rows.find(r=>r.id===id); }
function updateReqPanel(){
  const src = brSelectedId ? currentRowById(brSelectedId)
             : (selected.size ? currentRowById(Array.from(selected)[0]) : null);
  renderReqBox(reqFor(src));
}

/* ===== seed (przyk≈Çady) ===== */
function seed(){
  rows = [
    // FERROLI ‚Äî gaz-kondensacyjny
    {id:UID(),brand:'Ferroli',model:'Divacondens E 24 (2F)',fuel:'gaz-kondensacyjny',powMin:3.0,powMax:24,eff:0.98,mod:'1:8',emiss:'ErP A',tank:0,ctrl:'OpenTherm,pogodowe',phase:'1F',noise:47,dim:'700√ó400√ó330',weight:33,warr:5,chimney:'NIE',flue:60,acc:'czujnik zewn.,modu≈Ç internetowy',price:8800,install:2800,service:450,notes:'Model 2F'},
    {id:UID(),brand:'Ferroli',model:'Bluehelix Tech RRT 24C (2F)',fuel:'gaz-kondensacyjny',powMin:3.0,powMax:24,eff:0.99,mod:'1:10',emiss:'ErP A',tank:0,ctrl:'OpenTherm,Wi-Fi',phase:'1F',noise:46,dim:'740√ó420√ó330',weight:34,warr:5,chimney:'NIE',flue:60,acc:'zestaw monta≈ºowy',price:9800,install:3000,service:500,notes:''},
    // DEFRO ‚Äî pellet
    {id:UID(),brand:'DEFRO',model:'Delta EkoPell 16',fuel:'pellet',powMin:4,powMax:16,eff:0.91,mod:'PID',emiss:'Klasa 5/Ecodesign',tank:150,ctrl:'PID,pogodowe',phase:'1F',noise:52,dim:'1300√ó600√ó900',weight:210,warr:5,chimney:'TAK',flue:130,acc:'podajnik,zapalarka',price:20900,install:4200,service:650,notes:'Autom. czyszczenie wymiennika'},
    // STALMARK ‚Äî pellet
    {id:UID(),brand:'Stalmark',model:'Eko Silver 20',fuel:'pellet',powMin:5,powMax:20,eff:0.91,mod:'PID',emiss:'Klasa 5',tank:150,ctrl:'ecoMAX,pogodowe',phase:'1F',noise:53,dim:'1250√ó560√ó960',weight:210,warr:4,chimney:'TAK',flue:130,acc:'‚Äî',price:19900,install:4300,service:650,notes:''},
    // LAZAR ‚Äî zgazowujƒÖce drewno (wa≈ºne do bufora)
    {id:UID(),brand:'LAZAR',model:'Holz Master 20',fuel:'drewno',powMin:6,powMax:20,eff:0.89,mod:'‚Äî',emiss:'Ecodesign',tank:0,ctrl:'mechaniczny',phase:'1F',noise:55,dim:'1210√ó580√ó1050',weight:220,warr:3,chimney:'TAK',flue:150,acc:'wentylator',price:20358,install:3800,service:600,notes:'Zalecany bufor 1000l'}
  ];
  saveRows();
}

/* ===== kolumny ===== */
const COLS = [
  {key:'brand',label:'Marka',type:'text'},
  {key:'model',label:'Model',type:'text'},
  {key:'fuel',label:'Typ/paliwo',type:'select',opts:['gaz','gaz-kondensacyjny','pellet','drewno','ekogroszek','olej','elektryczny']},
  {key:'powMin',label:'Moc min [kW]',type:'number',step:'0.1'},
  {key:'powMax',label:'Moc max [kW]',type:'number',step:'0.1'},
  {key:'eff',label:'Sprawno≈õƒá',type:'number',step:'0.01'},
  {key:'mod',label:'Modulacja',type:'text'},
  {key:'emiss',label:'Klasa emisji',type:'text'},
  {key:'tank',label:'Zasobnik [l]',type:'number'},
  {key:'ctrl',label:'Sterowanie',type:'text'},
  {key:'phase',label:'Zasilanie',type:'select',opts:['1F','3F']},
  {key:'noise',label:'Ha≈Ças [dB]',type:'number'},
  {key:'dim',label:'Wymiary [mm]',type:'text'},
  {key:'weight',label:'Waga [kg]',type:'number'},
  {key:'warr',label:'Gwarancja [lata]',type:'number'},
  {key:'chimney',label:'Komin',type:'select',opts:['TAK','NIE']},
  {key:'flue',label:'Spalin √ò [mm]',type:'number'},
  {key:'acc',label:'Akcesoria',type:'text'},
  {key:'price',label:'Cena [z≈Ç]',type:'number'},
  {key:'install',label:'Monta≈º [z≈Ç]',type:'number'},
  {key:'service',label:'Serwis [z≈Ç]',type:'number'},
  {key:'notes',label:'Uwagi',type:'text'},
];

/* ===== render tabeli ===== */
function render(){
  const qtxt=(filter.q||'').toLowerCase();
  let data=rows.filter(r=>{
    if(filter.fuel && r.fuel!==filter.fuel) return false;
    if(filter.phase && r.phase!==filter.phase) return false;
    if(filter.chimney && r.chimney!==filter.chimney) return false;
    if(filter.cond && r.fuel!=='gaz-kondensacyjny') return false;
    if(filter.powMin!=='' && Number(r.powMax)<Number(filter.powMin)) return false;
    if(filter.powMax!=='' && Number(r.powMin)>Number(filter.powMax)) return false;
    if(filter.priceMin!=='' && Number(r.price)<Number(filter.priceMin)) return false;
    if(filter.priceMax!=='' && Number(r.price)>Number(filter.priceMax)) return false;
    if(qtxt){
      const hay=[r.brand,r.model,r.fuel,r.mod,r.emiss,r.ctrl,r.dim,r.acc,r.notes].join(' ').toLowerCase();
      if(!hay.includes(qtxt)) return false;
    }
    return true;
  });

  $('#countAll').textContent=rows.length;
  $('#countVis').textContent=data.length;
  $('#countSel').textContent=selected.size;

  const tb=$('#tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    const kwOk = matchProposedKW(r);
    tr.innerHTML = `
      <td class="hide-sm"><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
      <td data-k="brand">${esc(r.brand||'')}</td>
      <td data-k="model">${esc(r.model||'')}${kwOk?'<span class="okBadge">pasuje do mocy</span>':''}</td>
      <td data-k="fuel">${esc(r.fuel||'')}</td>
      <td data-k="powMin">${esc(r.powMin)} ‚Äì <span data-k="powMax">${esc(r.powMax)}</span></td>
      <td data-k="eff">${esc(r.eff)}</td>
      <td data-k="mod">${esc(r.mod||'')}</td>
      <td data-k="emiss">${esc(r.emiss||'')}</td>
      <td data-k="tank">${esc(r.tank||0)}</td>
      <td data-k="ctrl">${esc(r.ctrl||'')}</td>
      <td data-k="phase">${esc(r.phase||'')}</td>
      <td data-k="noise">${esc(r.noise||'')}</td>
      <td data-k="dim">${esc(r.dim||'')}</td>
      <td data-k="weight">${esc(r.weight||'')}</td>
      <td data-k="warr">${esc(r.warr||'')}</td>
      <td data-k="chimney">${esc(r.chimney||'')}</td>
      <td data-k="flue">${esc(r.flue||'')}</td>
      <td data-k="acc" class="wide">${esc(r.acc||'')}</td>
      <td data-k="price" class="price">${INT0.format(r.price||0)}</td>
      <td data-k="install" class="price">${INT0.format(r.install||0)}</td>
      <td data-k="service" class="price">${INT0.format(r.service||0)}</td>
      <td data-k="notes" class="wide">${esc(r.notes||'')}</td>
      <td>
        <button class="btn" data-conf="${r.id}">Konfigurator</button>
        <button class="btn ghost" data-sendrow="${r.id}">Wy≈õlij</button>
        <button class="btn bad" data-act="del" data-id="${r.id}">Usu≈Ñ</button>
      </td>
    `;
    // dwuklik -> wejd≈∫ do konfiguratora + ustaw brSelectedId
    tr.addEventListener('dblclick', ()=>{
      try{
        localStorage.setItem(SEL_KEY, r.id);
        localStorage.setItem(PREF_BRAND, r.brand||'');
        localStorage.setItem(PREF_FUEL, brandFuel(r.brand||''));
        localStorage.setItem(RETURN_KEY, location.href);
        localStorage.setItem(PING_KEY, String(Date.now()));
      }catch{}
      brSelectedId = r.id; updateReqPanel();
      openConfigurator(r.brand||'');
    });

    tr.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        if(chk.checked) selected.add(r.id); else selected.delete(r.id);
        $('#countSel').textContent=selected.size;
        updateReqPanel();
      });
    });
    tr.querySelectorAll('[data-act="del"]').forEach(b=>{
      b.addEventListener('click', ()=>{ if(confirm('UsunƒÖƒá?')){ rows=rows.filter(x=>x.id!==r.id); saveRows(); }});
    });
    tr.querySelectorAll('[data-conf]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const row=rows.find(x=>x.id===b.dataset.conf); if(!row) return;
        brSelectedId=row.id; updateReqPanel();
        sendToConfigurator(row.id, row.brand||'');
      });
    });
    tr.querySelectorAll('[data-sendrow]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const row=rows.find(x=>x.id===b.dataset.sendrow); if(!row) return;
        brSelectedId=row.id; updateReqPanel();
        sendToConfigurator(row.id, row.brand||'');
      });
    });

    tb.appendChild(tr);
  });
}

/* ===== bridge list ===== */
function fillBridgeList(){
  const brand = $('#brBrand').value || 'Ferroli';
  const qtxt = ($('#brQ').value||'').toLowerCase();
  const pmin = Number($('#brPmin').value)||null;
  const pmax = Number($('#brPmax').value)||null;
  const sort = $('#brSort').value||'power';

  let list = rows.filter(r => (r.brand||'').toLowerCase()===brand.toLowerCase());
  list = list.filter(r=>{
    if(qtxt){
      const hay=[r.model,r.fuel,r.notes].join(' ').toLowerCase();
      if(!hay.includes(qtxt)) return false;
    }
    const lo=Number(r.powMin)||0, hi=Number(r.powMax)||lo;
    if(pmin!=null && pmin>0 && hi<pmin) return false;
    if(pmax!=null && pmax>0 && lo>pmax) return false;
    return true;
  });
  list.sort((a,b)=>{
    if(sort==='price') return (a.price||0)-(b.price||0);
    if(sort==='model') return String(a.model||'').localeCompare(b.model||'','pl',{sensitivity:'base'});
    // power
    return ((a.powMax||a.powMin||0)-(b.powMax||b.powMin||0));
  });

  const tb=$('#brList'); tb.innerHTML='';
  list.forEach(r=>{
    const kwOk = matchProposedKW(r);
    const tr=document.createElement('tr');
    tr.setAttribute('data-id', r.id);
    tr.setAttribute('tabindex','0');
    tr.innerHTML = `
      <td>${esc(r.model||'')}${kwOk?'<span class="okBadge">pasuje</span>':''}</td>
      <td>${esc(r.powMin)}‚Äì${esc(r.powMax||r.powMin)}</td>
      <td>${esc(r.fuel||'')}</td>
      <td class="price">${INT0.format(r.price||0)}</td>
      <td class="muted">${esc(r.id.slice(0,10))}‚Ä¶</td>
    `;
    tr.addEventListener('click', ()=>{
      brSelectedId = r.id;
      $('#brSel').textContent = r.id;
      tb.querySelectorAll('tr').forEach(x=>x.removeAttribute('aria-selected'));
      tr.setAttribute('aria-selected','true');
      updateReqPanel();
    });
    tr.addEventListener('dblclick', ()=>{
      brSelectedId = r.id;
      $('#brSel').textContent = r.id;
      updateReqPanel();
      sendToConfigurator(r.id, r.brand||'');
    });
    tb.appendChild(tr);
  });

  updateBrandStats();
  // je≈õli obecny wyb√≥r nie istnieje w aktualnym filtrze
  if(brSelectedId && !rows.find(x=>x.id===brSelectedId)) { brSelectedId=null; $('#brSel').textContent='‚Äî'; updateReqPanel(); }
}
function updateBrandStats(){
  const cnt = (b)=> rows.filter(r=>(r.brand||'').toLowerCase()===b.toLowerCase()).length;
  $('#cntFerroli').textContent = cnt('Ferroli');
  $('#cntDEFRO').textContent   = cnt('DEFRO');
  $('#cntStalmark').textContent= cnt('Stalmark');
  $('#cntLazar').textContent   = cnt('LAZAR');
}

/* ===== proponowana moc ‚Üí highlight modeli ===== */
function matchProposedKW(r){
  if(!proposedKW) return false;
  const lo = Number(r.powMin)||0, hi=Number(r.powMax)||lo;
  const band = {min: proposedKW*0.8, max: proposedKW*1.2};
  return hi>=band.min && lo<=band.max;
}

/* ===== edycja in-line ===== */
function editorFor(col,val){
  if(col.type==='select'){
    const sel=document.createElement('select');
    (col.opts||[]).forEach(o=>{const op=document.createElement('option');op.value=o;op.textContent=o;if(o===val)op.selected=true;sel.appendChild(op);});
    return sel;
  }
  const inp=document.createElement('input');
  inp.type=col.type||'text'; if(col.step) inp.step=col.step;
  inp.value=val==null?'':val; inp.style.width='100%'; return inp;
}
function editCell(id,key,cell){
  const col=COLS.find(c=>c.key===key);
  if(key==='powMin' || key==='powMax'){
    const row=rows.find(x=>x.id===id); const valMin=row.powMin??''; const valMax=row.powMax??'';
    const wrap=document.createElement('div');
    wrap.innerHTML=`<div class="card" style="position:absolute;z-index:5;padding:10px;transform:translateY(-10px)">
      <div class="row"><input type="number" step="0.1" id="edMin" value="${valMin}" style="width:120px">
      <input type="number" step="0.1" id="edMax" value="${valMax}" style="width:120px">
      <button id="ok" class="btn ok">OK</button><button id="cx" class="btn ghost">Anuluj</button></div></div>`;
    cell.appendChild(wrap);
    const done=(apply)=>{ if(apply){ row.powMin=toNum(wrap.querySelector('#edMin').value); row.powMax=toNum(wrap.querySelector('#edMax').value); saveRows(); } cell.removeChild(wrap); };
    wrap.querySelector('#ok').onclick=()=>done(true); wrap.querySelector('#cx').onclick=()=>done(false);
    return;
  }
  const row=rows.find(x=>x.id===id); const start=row[key];
  const ed=editorFor(col||{type:'text'},start); const orig=cell.innerHTML;
  cell.innerHTML=''; cell.appendChild(ed); ed.focus(); if(ed.select) ed.select();
  const commit=(apply)=>{ if(apply){ let v=ed.value; if((col||{}).type==='number') v=toNum(v); row[key]=v; saveRows(); } else { cell.innerHTML=orig; } };
  ed.addEventListener('keydown',e=>{ if(e.key==='Enter') commit(true); if(e.key==='Escape') commit(false); });
  ed.addEventListener('blur',()=>commit(true));
}

/* ===== toolbar actions ===== */
$('#add').addEventListener('click', ()=>{
  const blank={id:UID(),brand:'',model:'',fuel:'gaz',powMin:0,powMax:0,eff:0.9,mod:'',emiss:'',tank:0,ctrl:'',phase:'1F',noise:0,dim:'',weight:0,warr:2,chimney:'NIE',flue:60,acc:'',price:0,install:0,service:0,notes:''};
  rows.unshift(blank); saveRows();
});
$('#dupSel').addEventListener('click', ()=>{
  if(!selected.size) return;
  Array.from(selected).forEach(id=>{ const s=rows.find(x=>x.id===id); if(!s) return; const c=JSON.parse(JSON.stringify(s)); c.id=UID(); c.model=(c.model||'')+' (kopia)'; rows.unshift(c); });
  saveRows();
});
$('#delSel').addEventListener('click', ()=>{
  if(!selected.size) return;
  if(confirm('UsunƒÖƒá zaznaczone pozycje?')){ rows=rows.filter(r=>!selected.has(r.id)); selected.clear(); saveRows(); }
});
$('#expJSON').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='komponenty_piece.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#impJSON').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const txt=await f.text(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw 0; rows=arr.map(r=>({id:r.id||UID(),...r})); saveRows(); }
  catch{ alert('Z≈Çy plik JSON'); } e.target.value='';
});
$('#expCSV').addEventListener('click', ()=>{
  const cols=COLS.map(c=>c.key); const head=cols.join(';');
  const body=rows.map(r=>cols.map(k=>csvEsc(r[k])).join(';')).join('\n');
  const blob=new Blob([head+'\n'+body],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='komponenty_piece.csv'; a.click(); URL.revokeObjectURL(a.href);
});
$('#seed').addEventListener('click', ()=>{ if(confirm('Za≈Çadowaƒá przyk≈Çadowe pozycje?')) seed(); });
$('#wipe').addEventListener('click', ()=>{ if(confirm('Wyczy≈õciƒá wszystkie pozycje?')){ rows=[]; saveRows(); }});

/* ===== filtry ===== */
$('#q').addEventListener('input', e=>{ filter.q=e.target.value.trim(); render(); fillBridgeList(); });
$('#fFuel').addEventListener('change', e=>{ filter.fuel=e.target.value; render(); fillBridgeList(); });
$('#fPhase').addEventListener('change', e=>{ filter.phase=e.target.value; render(); });
$('#fChimney').addEventListener('change', e=>{ filter.chimney=e.target.value; render(); });
$('#fPowMin').addEventListener('input', e=>{ filter.powMin=e.target.value; render(); fillBridgeList(); });
$('#fPowMax').addEventListener('input', e=>{ filter.powMax=e.target.value; render(); fillBridgeList(); });
$('#fCenaMin').addEventListener('input', e=>{ filter.priceMin=e.target.value; render(); });
$('#fCenaMax').addEventListener('input', e=>{ filter.priceMax=e.target.value; render(); });
$('#fCond').addEventListener('change', e=>{ filter.cond=e.target.checked; render(); });

/* tabs -> skr√≥t do filtra paliwa */
$$('.tab').forEach(b=> b.addEventListener('click', ()=>{
  $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
  b.setAttribute('aria-selected','true');
  const v=b.dataset.tab||''; $('#fFuel').value=v; filter.fuel=v; render(); fillBridgeList();
}));

/* ===== bridge bindy ===== */
['brBrand','brQ','brPmin','brPmax','brSort'].forEach(id=>{
  document.getElementById(id).addEventListener('input', fillBridgeList);
  document.getElementById(id).addEventListener('change', fillBridgeList);
});
$('#brOpen').addEventListener('click', ()=> openConfigurator($('#brBrand').value||''));
$('#brSend').addEventListener('click', ()=>{
  if(!brSelectedId){ alert('Wybierz model z listy.'); return; }
  const row=currentRowById(brSelectedId); if(!row){ alert('Model nie istnieje.'); return; }
  sendToConfigurator(brSelectedId, row.brand||'');
});

/* ===== kalkulator mocy ‚Üí podpowied≈∫ + filtry ===== */
function updateCalc(){
  const area=toNum($('#calcArea').value)||0;
  const insu=$('#calcInsul').value||'std';
  const zone=$('#calcZone').value||'normal';
  const cwu=toNum($('#calcCWU').value)||0;
  const margin=toNum($('#calcMargin').value)||15;
  if(area>0){
    proposedKW = calcKW(area,insu,zone,cwu,margin);
    $('#calcOut').textContent = INT2.format(proposedKW)+' kW';
  }else{
    proposedKW = null;
    $('#calcOut').textContent = '‚Äî kW';
  }
  render(); fillBridgeList();
}
['calcArea','calcInsul','calcZone','calcCWU','calcMargin'].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateCalc);
  document.getElementById(id).addEventListener('change', updateCalc);
});
$('#calcApply').addEventListener('click', ()=>{
  if(!proposedKW) return;
  const mn = Math.round(proposedKW*0.8*10)/10;
  const mx = Math.round(proposedKW*1.2*10)/10;
  $('#fPowMin').value = mn; $('#fPowMax').value = mx;
  filter.powMin=String(mn); filter.powMax=String(mx);
  render(); fillBridgeList();
});

/* ===== skr√≥ty ===== */
window.addEventListener('keydown', (e)=>{
  if(e.altKey && (e.key==='n'||e.key==='N')){ e.preventDefault(); $('#add').click(); }
  if(e.key==='/'){ e.preventDefault(); $('#q').focus(); }
});

/* ===== checkbox ‚Äûselect all‚Äù ===== */
$('#chkAll').addEventListener('change', (e)=>{
  const on=e.target.checked; selected.clear(); if(on) rows.forEach(r=>selected.add(r.id)); render(); updateReqPanel();
});

/* ===== nas≈Çuch z innych kart ===== */
window.addEventListener('storage', (e)=>{
  if(e.key===LS_KEY || e.key===PING_KEY){
    rows = loadRows(); render(); fillBridgeList(); updateReqPanel(); updateBrandStats();
  }
  if(e.key===CFG_DEFAULTS_KEY){
    // od≈õwie≈º wymagania, bo mog≈Çy wpa≈õƒá nowe mapy (np. TANKS, ceny)
    updateReqPanel();
  }
});

/* ===== init ===== */
(function init(){
  if(!rows.length) seed();
  render(); fillBridgeList(); updateReqPanel(); updateBrandStats();
})();
</script>
</body>
</html>

