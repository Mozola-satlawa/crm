<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konfigurator pieców — Ferroli / DEFRO / Stalmark / LAZAR</title>
  <style>
    /* ======== GRANATOWY MOTYW (jak pierwowzór) ======== */
    :root{
      --bg1:#0a0f1e; --bg2:#0c1230;
      --panel:#11183a; --ink:#e8edff; --muted:#aeb8da; --line:#2b3a77;
      --chip:#14204a; --accent:#4cc9f0; --accent-2:#67a1ff; --accent-soft:rgba(103,161,255,.25);
      --danger:#ff6b6b; --warn:#ffb84d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--bg1));
      font:15px/1.5 system-ui,Segoe UI,Roboto,Arial;
    }
    .wrap{max-width:1100px;margin:18px auto 48px;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:16px; background:#11183a; border:1px solid var(--line); border-radius:14px}
    h1{font-size:22px;margin:0}
    .sub{font-size:12px;color:var(--muted)}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75;background:#172142}
    nav a:hover{background:#223160}
    .panel{background:linear-gradient(180deg,#10173c,#111b48);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .panel h3{margin:0 0 8px;font-size:16px}
    .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
    .btn.warn{background:#3a1f2a;border-color:#7b3341}
    .btn.alt{background:#0e2a4e;border-color:#365caa}
    .btn:focus{outline:none;box-shadow:0 0 0 3px var(--accent-soft)}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type=text],input[type=number]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0d1530;color:var(--ink)
    }
    select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft);outline:none}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1060px){.grid{grid-template-columns:1fr .95fr}}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col{grid-column:span 12}
    @media(min-width:720px){.col{grid-column:span 4}.col.wide{grid-column:span 8}}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .bundle-grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:960px){.bundle-grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1636}
    .card h4{margin:0 0 8px;font-size:15px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0d1530;border:1px dashed var(--line);font-size:11px;font-weight:800;margin-right:6px;color:#cfe1ff}
    ul.clean{margin:6px 0 0;padding-left:18px}ul.clean li{margin:3px 0}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px}
    thead th{background:#101a46;text-align:left;color:#cfe1ff}
    .right{text-align:right;white-space:nowrap}
    .price-preview{font-weight:800;font-size:18px;margin-top:6px}
    .bridge-note{background:#0e1b40;border:1px dashed var(--line);padding:8px;border-radius:12px;margin-top:8px;color:#cfe1ff}
    .mini{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:#aee1ff}

    /* Sekcja doboru z powierzchni (wygląd kompaktowy) */
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .inline .cell{display:flex;flex-direction:column;min-width:140px}
    .inline strong{color:#aee1ff}

    /* ======== ŁADNY WYDRUK ======== */
    @media print{
      body{background:#fff;color:#000}
      header,.btn,nav,.bridge-note,.hint,.mini{display:none!important}
      .panel{background:#fff;border-color:#ddd}
      .wrap{max-width:none;margin:0;padding:0}
      h1{color:#000}
      thead th{background:#f2f2f2;color:#000;border-color:#ddd}
      th,td{border-bottom:1px solid #ddd}
      .print-header{display:block!important}
      a:link,a:visited{color:#000;text-decoration:none}
    }
    .print-header{display:none;border-bottom:2px solid #ddd;margin-bottom:12px;padding-bottom:8px}
    .print-header h2{margin:0 0 6px 0;color:#000}
    .print-meta{font-size:12px;color:#333}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Konfigurator pieców — Ferroli / DEFRO / Stalmark / LAZAR</h1>
        <div class="sub">
          Zestaw = kocioł + zasobnik CWU + montaż (+ opcje). Grzejniki (montaż): <b>750 PLN/szt.</b> • Wkład kominowy: <b>650 PLN/mb</b>.<br>
          Dostępne marki: <b>Ferroli</b> (gaz/kondens.), <b>DEFRO</b> (pellet), <b>Stalmark</b> (pellet), <b>LAZAR</b> (zgazowujące drewno).
        </div>
        <nav>
          <a href="index.html">Pulpit</a>
          <a href="komponenty-piece.html" target="_blank" id="goArkon">Komponenty • Piece</a>
          <a href="ferroli_konfigurator.html" target="_blank">Ferroli — konfigurator</a>
          <a href="defro_piece.html" target="_blank">DEFRO (pellet) — konfigurator</a>
          <a href="stalmark_pellet.html" target="_blank">Stalmark (pellet) — konfigurator</a>
          <a href="lazar_zgazowujace.html" target="_blank">LAZAR (zgazowujące) — konfigurator</a>
        </nav>
      </div>
      <div class="bar">
        <button class="btn" id="exportQuote">Eksport koszyka (XLSX)</button>
        <button class="btn ghost" id="copyQuote">Kopiuj ofertę</button>
        <button class="btn ghost" id="print">Drukuj / PDF</button>
      </div>
    </header>

    <!-- Nagłówek wydruku -->
    <div class="print-header" id="printHeader">
      <h2>Oferta — konfigurator pieców</h2>
      <div class="print-meta" id="printMeta"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Dobierz parametry</h3>
        <div class="row">
          <div class="col">
            <label>Marka</label>
            <select id="brand">
              <option value="Ferroli">Ferroli (gaz/kondens.)</option>
              <option value="DEFRO">DEFRO (pellet)</option>
              <option value="Stalmark">Stalmark (pellet)</option>
              <option value="LAZAR">LAZAR (zgazowujące drewno)</option>
            </select>
          </div>
          <div class="col wide">
            <label>Model kotła (lokalna lista dla wybranej marki)</label>
            <select id="boiler"></select>
          </div>
          <div class="col">
            <label>Moc [kW]</label>
            <input id="power" type="text" readonly>
          </div>
          <div class="col">
            <label>Typ/paliwo</label>
            <input id="type" type="text" readonly>
          </div>
          <div class="col">
            <label>Cena kotła [PLN]</label>
            <input id="boilerPrice" type="text" readonly>
          </div>
          <div class="col">
            <label>Zasobnik CWU [l]</label>
            <select id="tank"></select>
          </div>
          <div class="col">
            <label>Cena zbiornika [PLN]</label>
            <input id="tankPrice" type="text" readonly>
          </div>

          <!-- Bufor ciepła: wymagany dla drewna; dla pellet/gaz — opcjonalny -->
          <div class="col" id="bufferOptWrap" style="display:none">
            <label>Bufor ciepła (opcjonalnie)</label>
            <label class="pill" style="display:inline-flex;align-items:center;gap:8px">
              <input type="checkbox" id="bufferOpt"> Dodaj bufor do zestawu
            </label>
          </div>
          <div class="col" id="bufferWrap" style="display:none">
            <label id="bufferLabel">Bufor ciepła [l]</label>
            <select id="buffer"></select>
            <div class="mini" id="bufferHint">—</div>
          </div>
          <div class="col" id="bufferPriceWrap" style="display:none">
            <label>Cena bufora [PLN]</label>
            <input id="bufferPrice" type="text" readonly>
          </div>

          <div class="col">
            <label>Liczba grzejników (montaż)</label>
            <input id="rads" type="number" min="0" step="1" value="0">
            <div class="mini">750 PLN/szt.</div>
          </div>
          <div class="col">
            <label>Wkład kominowy [m]</label>
            <input id="chimneyM" type="number" min="0" step="0.1" value="0">
            <div class="mini">650 PLN/mb</div>
          </div>
          <div class="col">
            <label>VAT</label>
            <select id="vat">
              <option value="0.08">8%</option>
              <option value="0.23">23%</option>
            </select>
          </div>

          <!-- Dobór mocy z powierzchni -->
          <div class="col wide">
            <label>Dobór mocy z powierzchni</label>
            <div class="inline">
              <div class="cell">
                <span class="mini">Powierzchnia domu [m²]</span>
                <input id="houseArea" type="number" min="20" step="1" value="120">
              </div>
              <div class="cell">
                <span class="mini">Standard budynku</span>
                <select id="buildingStd">
                  <option value="35">Nowy A+/A (35 W/m²)</option>
                  <option value="50" selected>Dobrze ocieplony (50 W/m²)</option>
                  <option value="70">Modernizowany (70 W/m²)</option>
                  <option value="90">Stary, nieocieplony (90 W/m²)</option>
                </select>
              </div>
              <div class="cell">
                <span class="mini">Proponowana moc [kW] (z rezerwą 15%)</span>
                <input id="suggestedKW" type="text" readonly>
              </div>
              <div class="cell" style="min-width:220px">
                <span class="mini">Proponowany model</span>
                <div id="suggestedModel" class="hint">—</div>
              </div>
              <button class="btn alt" id="applySuggested">Dopasuj model</button>
            </div>
          </div>

          <div class="col wide">
            <div class="muted">Aktualna cena zestawu (wg wyboru):</div>
            <div id="pricePreview" class="price-preview">—</div>
          </div>
        </div>

        <!-- ▼▼▼ MOSTEK: ARKON — Komponenty • Piece (ograniczony do Ferroli/DEFRO/Stalmark/LAZAR) ▼▼▼ -->
        <div class="sep"></div>
        <h3 style="margin-top:0">Mostek ARKON — Komponenty • Piece</h3>
        <div class="row">
          <div class="col">
            <label>Marka (z katalogu)</label>
            <select id="arkonBrand"></select>
          </div>
          <div class="col">
            <label>Paliwo / typ</label>
            <select id="arkonFuel">
              <option value="">— dowolne —</option>
              <option value="gaz">gaz</option>
              <option value="gaz-kondensacyjny">gaz-kondensacyjny</option>
              <option value="pellet">pellet</option>
              <option value="drewno">drewno</option>
            </select>
          </div>
          <div class="col">
            <label>Min moc [kW]</label>
            <input id="arkonMin" type="number" step="0.1" placeholder="np. 10">
          </div>
          <div class="col">
            <label>Max moc [kW]</label>
            <input id="arkonMax" type="number" step="0.1" placeholder="np. 25">
          </div>
          <div class="col wide">
            <label>Model (z „Komponenty • Piece”)</label>
            <select id="arkonModel" disabled></select>
          </div>
          <div class="col">
            <label>Akcje</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn ghost" id="useArkon">Użyj tego kotła</button>
              <button class="btn ghost" id="openArkon">Otwórz katalog (nowa karta)</button>
            </div>
          </div>
          <div class="col wide">
            <div id="arkonPreview" class="bridge-note">Brak wyboru z katalogu. Ograniczamy do Ferroli / DEFRO / Stalmark / LAZAR.</div>
          </div>
        </div>
        <div class="sub">
          Źródło: <code>localStorage["arkon_components_boilers_v2"]</code>. Filtrujemy tylko: <b>Ferroli</b>, <b>DEFRO</b>, <b>Stalmark</b>, <b>LAZAR</b>.<br>
          Preferencje przez <code>arkon_return_to</code>, <code>arkon_pref_brand</code>, <code>arkon_pref_fuel</code>.
          Wybór: <code>arkon_selected_boiler_id</code> lub <code>postMessage</code> (<code>type:"ARKON_BOILER_SELECTED"</code>).
        </div>
        <!-- ▲▲▲ KONIEC MOSTKA ▲▲▲ -->

        <div class="sep"></div>
        <div class="row">
          <div class="col"><button class="btn" id="addPack">Dodaj: Zestaw (kocioł + CWU + montaż)</button></div>
          <div class="col"><button class="btn warn" id="addBoilerOnly">Dodaj: Sam kocioł</button></div>
        </div>
      </div>

      <div class="panel" id="mustHavePanel">
        <h3>Skład zestawu (must-have)</h3>
        <div id="mustHaveList" class="muted">Wybierz markę, model i zasobnik — pokażę skład.</div>
      </div>

      <div class="panel">
        <h3>Koszyk</h3>
        <table id="basket">
          <thead><tr><th>Pozycja</th><th>Ilość</th><th class="right">Cena</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="sep"></div>
        <div class="row">
          <div class="col"><span class="muted">Suma końcowa</span><div id="sumFinal" style="font-weight:800;font-size:22px;"></div></div>
          <div class="col"><span class="muted">Brutto (z VAT)</span><div id="sumBrutto" style="font-weight:800;font-size:22px;"></div></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Akcesoria (opcjonalnie)</h3>
      <div class="bundle-grid" id="addons"></div>
      <div class="sep"></div>
      <button class="btn ghost" id="addSelectedAddons">Dodaj wybrane</button>
      <div class="sub" style="margin-top:6px">Grzejniki i wkład kominowy wliczasz polami powyżej.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    'use strict';

    /* ================== MODELE „NA SZTYWNO” — tylko nasze marki ================== */
    const FERROLI = [
      { model:'Divacondens E 20 (2F)',             power:20, fuel:'gaz-kondensacyjny', type:'2F', price: 8400 },
      { model:'Divacondens E 24 (2F)',             power:24, fuel:'gaz-kondensacyjny', type:'2F', price: 8800 },
      { model:'Bluehelix Tech RRT 14C (2F)',       power:14, fuel:'gaz-kondensacyjny', type:'2F', price: 9200 },
      { model:'Bluehelix Tech RRT 18C (2F)',       power:18, fuel:'gaz-kondensacyjny', type:'2F', price: 9600 },
      { model:'Bluehelix Tech RRT 24S (1F)',       power:24, fuel:'gaz-kondensacyjny', type:'1F', price: 9200 },
      { model:'Bluehelix Tech RRT 24C (2F)',       power:24, fuel:'gaz-kondensacyjny', type:'2F', price: 9800 },
      { model:'Bluehelix Tech RRT 28C (2F)',       power:28, fuel:'gaz-kondensacyjny', type:'2F', price:10500 },
      { model:'Bluehelix Maxima 30C (2F)',         power:30, fuel:'gaz-kondensacyjny', type:'2F', price:14500 }
    ];
    const DEFRO = [
      { model:'Delta EkoPell 10 kW',   power:10, fuel:'pellet', price:21632.00 },
      { model:'Delta EkoPell 12 kW',   power:12, fuel:'pellet', price:21890.00 },
      { model:'Delta EkoPell 15 kW',   power:15, fuel:'pellet', price:21078.55 },
      { model:'Delta EkoPell 20 kW',   power:20, fuel:'pellet', price:22290.00 },
      { model:'Delta EkoPell 25 kW',   power:25, fuel:'pellet', price:23990.00 },
      { model:'Smart EkoPell 12 kW',   power:12, fuel:'pellet', price:22515.20 },
      { model:'Komfort EkoPell 14 kW', power:14, fuel:'pellet', price:18498.99 },
      { model:'Komfort EkoPell 20 kW', power:20, fuel:'pellet', price:18745.25 },
      { model:'Komfort EkoPell 25 kW', power:25, fuel:'pellet', price:19993.99 },
      { model:'SIGMA E 35 kW',         power:35, fuel:'pellet', price:27550.79 },
      { model:'SIGMA E 48 kW',         power:48, fuel:'pellet', price:29550.79 }
    ];
    const STALMARK = [
      { model:'Eko Silver 12 kW',   power:12, fuel:'pellet', price:19300 },
      { model:'Eko Silver 16 kW',   power:16, fuel:'pellet', price:20400 },
      { model:'Eko Silver 20 kW',   power:20, fuel:'pellet', price:21900 },
      { model:'Eko Silver 24 kW',   power:24, fuel:'pellet', price:23400 },
      { model:'Eko Silver 30 kW',   power:30, fuel:'pellet', price:25700 }
    ];
    const LAZAR = [
      { model:'Holz Master 20 kW', power:20, fuel:'drewno', price:20358.02 },
      { model:'Holz Master 30 kW', power:30, fuel:'drewno', price:23290.00 },
      { model:'DS 10 kW',          power:10, fuel:'drewno', price:15947.00 },
      { model:'DS 20 kW',          power:20, fuel:'drewno', price:16137.02 },
      { model:'DS 30 kW',          power:30, fuel:'drewno', price:18990.00 },
      { model:'DSpell 20 kW',      power:20, fuel:'drewno', price:26279.00 },
      { model:'DSpell 30 kW',      power:30, fuel:'drewno', price:28990.00 }
    ];

    // Zasobniki i akcesoria
    const TANKS = { '120':2100, '150':2450, '200':2900, '300':3800 };
    const ACCESSORY_BASE = {
      "Zawór 3-drogowy przełączający 1\"":470,
      "Grupa bezpieczeństwa CO 3 bar":150,
      "Filtr siatkowy Y 1\"":180,
      "Separator magnetyczny / odmulacz 5/4\"":840,
      "Naczynie przeponowe CO 18 l":460,
      "Pompa obiegowa CO 25-60":1440
    };

    /* ===== Bufory ciepła ===== */
    const BUFFERS = { '500':2600, '800':3200, '1000':3800, '1200':4200, '1500':4900, '2000':6200, '3000':9200 };
    const BUFFER_MIN_L_PER_KW = 50; // drewno (zgazowujące)

    // Stałe biznesowe
    const RAD_PRICE = 750;
    const CHIMNEY_PRICE = 650;
    const BOILER_ONLY_SURCHARGES = { 'Ferroli': 5000, 'DEFRO': 0, 'Stalmark': 0, 'LAZAR': 0 };
    const INSTALL_BASE = {
      'gaz': 15000, 'gaz-kondensacyjny': 15000,
      'pellet': 18000,
      'drewno': 18000
    };

    const state = {
      brand:'Ferroli',
      vat:0.08, basket:[],
      selectedBoiler:null, selectedTank:null,
      rads:0, chimneyM:0,
      bufferLiters:0, bufferPrice:0, bufferSelected:false,
      arkon:{ list:[], byBrand:{}, selected:null }
    };

    const q = s=>document.querySelector(s);
    const INT2 = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
    const INT0 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
    const fmt = n => INT2.format(Number(n)||0);

    /* ===== Helpers ===== */
    function modelsForBrand(b){
      if(b==='Ferroli') return FERROLI;
      if(b==='DEFRO') return DEFRO;
      if(b==='Stalmark') return STALMARK;
      if(b==='LAZAR') return LAZAR;
      return [];
    }
    function fuelOfBrand(b){
      if(b==='Ferroli') return 'gaz-kondensacyjny';
      if(b==='DEFRO') return 'pellet';
      if(b==='Stalmark') return 'pellet';
      if(b==='LAZAR') return 'drewno';
      return '';
    }
    function requiresBuffer(boiler){
      const fuel = (boiler?.fuel || fuelOfBrand(state.brand) || '').toLowerCase();
      return fuel.includes('drewno'); // zgazowujące drewno -> wymagany bufor
    }
    function minBufferLiters(power){
      const p = Number(power)||0;
      return Math.ceil((p * BUFFER_MIN_L_PER_KW)/100)*100; // zaokrąglij do 100 l
    }
    function nearestBufferSize(minL){
      const sizes = Object.keys(BUFFERS).map(Number).sort((a,b)=>a-b);
      for(const s of sizes){ if(s>=minL) return s; }
      return sizes[sizes.length-1];
    }
    function pricePack(boiler, tank, rads, chimneyM, bufferPrice){
      const fuel = (boiler && boiler.fuel) ? boiler.fuel : fuelOfBrand(state.brand);
      const base = INSTALL_BASE[fuel] || 0;
      return (Number(boiler?.price)||0)
           + (Number(tank)||0)
           + (Number(bufferPrice)||0)
           + base
           + (Number(rads)||0)*RAD_PRICE
           + (Number(chimneyM)||0)*CHIMNEY_PRICE;
    }
    function addToBasket(name, finalPrice, qty=1){
      const i = state.basket.findIndex(x=>x.name===name && Math.abs(x.final-finalPrice)<0.01);
      if(i>=0) state.basket[i].qty += qty; else state.basket.push({name, final:finalPrice, qty});
      renderBasket();
    }
    function renderBasket(){
      const tb=q('#basket tbody'); tb.innerHTML=''; let sum=0;
      state.basket.forEach((it,i)=>{
        sum += it.final*it.qty;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td><input type="number" data-qty-basket="${i}" value="${it.qty}" min="1" style="width:70px; padding:6px 8px; border:1px solid var(--line); border-radius:10px;"></td>
          <td class="right">${fmt(it.final)} PLN</td>
          <td class="right"><button class="btn warn" data-del="${i}">Usuń</button></td>`;
        tb.appendChild(tr);
      });
      q('#sumFinal').textContent  = fmt(sum) + ' PLN';
      q('#sumBrutto').textContent = fmt(sum*(1+state.vat)) + ' PLN';
    }

    function activeBoiler(){
      if(state.arkon.selected){
        return {
          model: `${state.arkon.selected.brand} ${state.arkon.selected.model}`,
          power: state.arkon.selected.powMax || state.arkon.selected.powMin || '',
          fuel:  (state.arkon.selected.fuel || '').toLowerCase(),
          type:  state.arkon.selected.type || '',
          price: Number(state.arkon.selected.price)||0,
          flue:  state.arkon.selected.flue || ''
        };
      }
      return state.selectedBoiler;
    }

    function renderMustHave(){
      const box=q('#mustHaveList');
      const b=activeBoiler(), t=state.selectedTank;
      if(!b||!t){ box.textContent='Wybierz markę, model i zasobnik — pokażę skład.'; return; }
      const items = [];
      const labelFuel = (b.fuel||fuelOfBrand(state.brand));
      items.push(`Kocioł — ${b.model}${b.power? ` (${b.power} kW)` : ''} • ${labelFuel}`);
      items.push(`Zasobnik CWU — ${t} l`);
      if(requiresBuffer(b) || state.bufferSelected){
        items.push(`Bufor ciepła — ${state.bufferLiters} l${requiresBuffer(b)?' (wymagany)':' (opcjonalnie)'}`);
      }
      items.push('Armatura: zawór 3D CWU/CO, grupa bezpieczeństwa CO, zawór zwrotny');
      items.push('Pompa obiegowa CO + filtr siatkowy + separator magnetyczny');
      items.push('Naczynie przeponowe CO, odpowietrzniki automatyczne');
      const r = Number(state.rads)||0; if(r>0) items.push(`Montaż grzejników: ${r} × ${INT0.format(RAD_PRICE)} PLN/szt.`);
      const m = Number(state.chimneyM)||0; if(m>0) items.push(`Wkład kominowy: ${m} m × ${INT0.format(CHIMNEY_PRICE)} PLN/mb${b.flue? ` • zalec. Ø ${b.flue} mm` : ''}`);
      items.push('Montaż, uruchomienie, konfiguracja sterowania');
      box.innerHTML = '<ul class="clean">' + items.map(t=>`<li>${t}</li>`).join('') + '</ul>';
    }

    function renderPreview(){
      const b = activeBoiler();
      const t = state.selectedTank;
      const r = Number(state.rads)||0;
      const m = Number(state.chimneyM)||0;
      if(!b || !t){ q('#pricePreview').textContent='—'; return; }
      const sum = pricePack(b, TANKS[t], r, m, (requiresBuffer(b) || state.bufferSelected) ? state.bufferPrice : 0);
      q('#pricePreview').textContent = `${fmt(sum)} PLN netto (brutto: ${fmt(sum*(1+state.vat))} PLN)`;
    }

    /* ====== Bufor — UI ====== */
    function updateBufferUI(){
      const b = activeBoiler();
      const optWrap = q('#bufferOptWrap');
      const wrap = q('#bufferWrap'); 
      const wrapP = q('#bufferPriceWrap');
      const label = q('#bufferLabel');
      const hint = q('#bufferHint');
      const cb = q('#bufferOpt');

      if(!b){ 
        optWrap.style.display='none'; wrap.style.display='none'; wrapP.style.display='none';
        state.bufferSelected=false; state.bufferLiters=0; state.bufferPrice=0; 
        return; 
      }

      const req = requiresBuffer(b);
      const sel = q('#buffer');
      const sizes = Object.keys(BUFFERS).map(Number).sort((a,b)=>a-b);
      sel.innerHTML = sizes.map(v=>`<option value="${v}">${v} l • ${fmt(BUFFERS[v])} PLN</option>`).join('');

      if(req){
        // wymagany dla drewna
        optWrap.style.display='none';
        wrap.style.display=''; wrapP.style.display='';
        label.innerHTML = 'Bufor ciepła [l] <span class="mini">(wymagany dla kotłów zgazowujących)</span>';
        const minL = minBufferLiters(b.power||0);
        hint.textContent = `Min. zalecane: ok. ${INT0.format(minL)} l (≈ ${BUFFER_MIN_L_PER_KW} l/kW)`;
        const def = nearestBufferSize(minL);
        sel.value = String(def);
        state.bufferLiters = def;
        state.bufferPrice = BUFFERS[def];
        state.bufferSelected = true;
        q('#bufferPrice').value = fmt(state.bufferPrice) + ' PLN';
      }else{
        // opcjonalny dla pellet/gaz
        optWrap.style.display=''; // pokaż przełącznik
        label.textContent = 'Bufor ciepła [l]';
        hint.textContent = 'Opcjonalnie — wybierz pojemność (np. 500–1000 l), jeśli inwestor oczekuje zwiększenia komfortu/pojemności cieplnej.';
        // zwiąż zdarzenie (raz)
        if(!cb.dataset.bound){
          cb.addEventListener('change', ()=>{
            state.bufferSelected = cb.checked;
            if(!state.bufferSelected){
              wrap.style.display='none'; wrapP.style.display='none';
              state.bufferLiters=0; state.bufferPrice=0; q('#bufferPrice').value = '';
              renderPreview(); renderMustHave();
            }else{
              // ustaw domyślnie 500 l
              sel.value = '500';
              state.bufferLiters = 500;
              state.bufferPrice = BUFFERS['500'];
              wrap.style.display=''; wrapP.style.display='';
              q('#bufferPrice').value = fmt(state.bufferPrice) + ' PLN';
              renderPreview(); renderMustHave();
            }
          });
          cb.dataset.bound='1';
        }
        // pokaż/ukryj zależnie od checkboxa
        if(cb.checked || state.bufferSelected){
          wrap.style.display=''; wrapP.style.display='';
          if(!state.bufferLiters){ sel.value='500'; state.bufferLiters=500; state.bufferPrice=BUFFERS['500']; }
          q('#bufferPrice').value = fmt(state.bufferPrice) + ' PLN';
          state.bufferSelected = true;
          cb.checked = true;
        }else{
          wrap.style.display='none'; wrapP.style.display='none';
          state.bufferSelected = false;
          state.bufferLiters=0; state.bufferPrice=0; q('#bufferPrice').value='';
        }
      }
      // reaguj na zmianę pojemności
      sel.onchange = ()=>{
        state.bufferLiters = Number(sel.value)||0;
        state.bufferPrice = BUFFERS[sel.value]||0;
        q('#bufferPrice').value = fmt(state.bufferPrice) + ' PLN';
        renderPreview(); renderMustHave();
      };

      renderPreview(); renderMustHave();
    }

    /* ====== Dobór mocy z powierzchni ====== */
    function calcSuggestedKW(){
      const area = Math.max(0, Number(q('#houseArea').value)||0);
      const spec = Math.max(10, Number(q('#buildingStd').value)||50); // W/m²
      if(!area) { q('#suggestedKW').value='—'; q('#suggestedModel').textContent='—'; return null; }
      const kw = area*spec/1000 * 1.15; // +15% rezerwy
      q('#suggestedKW').value = INT2.format(kw);
      const list = modelsForBrand(state.brand).slice().sort((a,b)=>a.power-b.power);
      let pick = list.find(x=>x.power >= kw) || list[list.length-1];
      if(pick){
        q('#suggestedModel').textContent = `${state.brand} ${pick.model} (${pick.power} kW)`;
        return pick;
      }
      q('#suggestedModel').textContent='—';
      return null;
    }
    function applySuggestedModel(){
      const pick = calcSuggestedKW();
      if(!pick) return;
      const list = modelsForBrand(state.brand).slice().sort((a,b)=> a.power-b.power || a.price-b.price );
      const idx = list.findIndex(x=>x.model===pick.model && x.power===pick.power);
      if(idx>=0){
        const s = q('#boiler');
        s.value = String(idx);
        state.selectedBoiler = normalizeLocalModel(list[idx]);
        applyBoilerToUi();
      }
    }

    /* ====== UI fill ====== */
    function fillBrands(){
      const brandSel = q('#brand'); brandSel.value = state.brand;
      brandSel.addEventListener('change', ()=>{
        state.brand = brandSel.value; state.arkon.selected=null;
        // reset bufora przy zmianie marki
        state.bufferSelected=false; state.bufferLiters=0; state.bufferPrice=0;
        const cb = q('#bufferOpt'); if(cb){ cb.checked=false; }
        fillBoilers(); fillTanks(); updateBufferUI();
        renderPreview(); renderMustHave(); fillArkonDefaults(); calcSuggestedKW();
      });
    }
    function normalizeLocalModel(b){
      if(!b) return null;
      return {
        model: `${state.brand} ${b.model}`,
        power: b.power || '',
        fuel: b.fuel || fuelOfBrand(state.brand),
        type: b.type || '',
        price: Number(b.price)||0
      };
    }
    function applyBoilerToUi(){
      const b=activeBoiler(); if(!b) return;
      q('#power').value = b.power? (b.power+' kW') : '';
      q('#type').value  = b.type? b.type : (b.fuel||'');
      q('#boilerPrice').value = fmt(b.price) + ' PLN';
      updateBufferUI();
      renderPreview(); renderMustHave();
    }
    function fillBoilers(){
      const s=q('#boiler'); const list=modelsForBrand(state.brand).slice().sort((a,b)=> a.power-b.power || a.price-b.price );
      s.innerHTML = list.map((b,i)=>`<option value="${i}">${b.model} • ${b.power} kW • ${fmt(b.price)} PLN</option>`).join('');
      s.value="0"; state.selectedBoiler = normalizeLocalModel(list[0]);
      applyBoilerToUi();
      s.onchange = ()=>{
        const idx=Number(s.value)||0; state.selectedBoiler=normalizeLocalModel(list[idx]); applyBoilerToUi();
      };
    }
    function fillTanks(){
      const s=q('#tank'); const sizes=Object.keys(TANKS).map(Number).sort((a,b)=>a-b);
      s.innerHTML = sizes.map(v=>`<option value="${v}">${v} l • ${fmt(TANKS[v])} PLN</option>`).join('');
      s.value=String(sizes[0]); state.selectedTank=s.value;
      q('#tankPrice').value = fmt(TANKS[state.selectedTank]) + ' PLN';
      s.onchange = ()=>{ state.selectedTank=s.value; q('#tankPrice').value=fmt(TANKS[state.selectedTank])+' PLN'; renderPreview(); renderMustHave(); };
    }
    function fillAddons(){
      const box=q('#addons'); box.innerHTML='';
      Object.keys(ACCESSORY_BASE).forEach((name,i)=>{
        const price=ACCESSORY_BASE[name];
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `
          <h4>${name}</h4>
          <div class="muted">Cena: ${fmt(price)} PLN</div>
          <div style="margin-top:8px;">
            <label>Ilość</label>
            <input type="number" min="1" step="1" value="1" data-qty="${i}">
          </div>
          <div style="margin-top:10px;"><button class="btn ghost" data-addon="${i}">Dodaj</button></div>`;
        box.appendChild(card);
      });
    }

    /* ====== MOSTEK ARKON: tylko 4 nasze marki ====== */
    const ARKON_LS_KEY = 'arkon_components_boilers_v2';
    const ARKON_PING_KEY = 'arkon_boilers_updated';
    const ARKON_SELECTED_KEY = 'arkon_selected_boiler_id';
    const ARKON_RETURN_KEY = 'arkon_return_to';
    const ARKON_PREF_BRAND = 'arkon_pref_brand';
    const ARKON_PREF_FUEL  = 'arkon_pref_fuel';
    const ALLOWED_BRANDS = ['Ferroli','DEFRO','Stalmark','LAZAR'];

    function loadArkon(){
      try{
        const raw = localStorage.getItem(ARKON_LS_KEY); if(!raw) return;
        const list = JSON.parse(raw); if(!Array.isArray(list)) return;
        state.arkon.list = list
          .filter(r => ALLOWED_BRANDS.includes(String(r.brand||'').trim()))
          .map(r=>({
            id:r.id, brand:r.brand||'', model:r.model||'',
            price:Number(r.price)||0,
            powMin:Number(r.powMin)||null, powMax:Number(r.powMax)||null,
            fuel:(r.fuel||r.type||'').toString().toLowerCase(),
            type:r.type||'',
            flue:r.flue || r['Spalin Ø [mm]'] || ''
          }));
        state.arkon.byBrand = state.arkon.list.reduce((a,b)=>{ (a[b.brand]??=[]).push(b); return a; },{});
      }catch{}
    }
    function fillArkonDefaults(){
      try{
        localStorage.setItem(ARKON_RETURN_KEY, location.href);
        localStorage.setItem(ARKON_PREF_BRAND, state.brand);
        localStorage.setItem(ARKON_PREF_FUEL,  fuelOfBrand(state.brand));
      }catch{}
      fillArkonBrands(); fillArkonModels();
    }
    function fillArkonBrands(){
      const sel=q('#arkonBrand');
      const brands=Object.keys(state.arkon.byBrand).filter(b=>ALLOWED_BRANDS.includes(b)).sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
      sel.innerHTML = brands.length
        ? brands.map(b=>`<option ${b===state.brand?'selected':''}>${b}</option>`).join('')
        : '<option value="">— brak danych —</option>';
      q('#arkonFuel').value = fuelOfBrand(state.brand) || '';
    }
    function currentArkonFiltered(){
      const brand=q('#arkonBrand').value;
      const fuel=(q('#arkonFuel').value||'').toLowerCase();
      const mn=Number(q('#arkonMin').value), mx=Number(q('#arkonMax').value);
      let list = (state.arkon.byBrand[brand]||[]).slice();
      if(fuel) list = list.filter(x=> (x.fuel||'').includes(fuel));
      return list.filter(x=>{
        const lo = Number(x.powMin||x.power||0) || 0;
        const hi = Number(x.powMax||x.power||0) || lo;
        if(!isNaN(mn) && mn>0 && hi < mn) return false;
        if(!isNaN(mx) && mx>0 && lo > mx) return false;
        return true;
      }).sort((a,b)=> (a.powMax||a.powMin||0) - (b.powMax||b.powMin||0) );
    }
    function fillArkonModels(){
      const ms=q('#arkonModel'); const list=currentArkonFiltered();
      ms.disabled = list.length===0;
      ms.innerHTML = list.length? '<option value="">— wybierz model —</option>' : '<option value="">— brak modeli —</option>';
      if(!list.length){ q('#arkonPreview').textContent='Brak modeli dla filtrów.'; return; }
      ms.innerHTML += list.map(x=>`<option value="${x.id}">${x.model}${x.powMax||x.powMin? ` • ${x.powMin||''}-${x.powMax||''} kW` : ''} • ${fmt(x.price)} PLN</option>`).join('');
      q('#arkonPreview').textContent='Wybierz model, aby zobaczyć szczegóły.';
    }
    function renderArkonPreview(){
      const p=state.arkon.selected, box=q('#arkonPreview');
      if(!p){ box.textContent='Brak wyboru z katalogu.'; return; }
      const pow = (p.powMin||'') + (p.powMax? `–${p.powMax}` : '');
      box.innerHTML = `<b>${p.brand} ${p.model}</b><br>
        Moc: ${pow||'—'} kW • Paliwo: ${p.fuel||'—'} • Cena: <b>${fmt(p.price)} PLN</b>${p.flue?` • Spalin Ø: ${p.flue} mm` : ''}`;
    }
    function selectArkonById(id){
      if(!id) return;
      loadArkon();
      const found = (state.arkon.list||[]).find(x=>x.id===id);
      if(!found) return;
      const bSel = q('#arkonBrand'); if(bSel){ bSel.value = found.brand || ''; }
      q('#arkonFuel').value = found.fuel || '';
      fillArkonModels();
      const mSel = q('#arkonModel'); if(mSel){ mSel.value = found.id; }
      state.arkon.selected = found;
      renderArkonPreview();
      // wpisz do pól głównych
      state.selectedBoiler = {
        model: `${found.brand} ${found.model}`,
        power:found.powMax||found.powMin||'',
        fuel:found.fuel||'',
        type:found.type||'',
        price:Number(found.price)||0,
        flue:found.flue||''
      };
      applyBoilerToUi();
    }

    document.addEventListener('change', (e)=>{
      if(e.target.id==='arkonBrand' || e.target.id==='arkonFuel' || e.target.id==='arkonMin' || e.target.id==='arkonMax'){
        state.arkon.selected=null; fillArkonModels(); renderArkonPreview(); renderPreview();
      }
      if(e.target.id==='arkonModel'){
        const id=e.target.value;
        state.arkon.selected = (state.arkon.list||[]).find(x=>x.id===id) || null;
        if(state.arkon.selected){
          state.selectedBoiler = {
            model: `${state.arkon.selected.brand} ${state.arkon.selected.model}`,
            power:state.arkon.selected.powMax||state.arkon.selected.powMin||'',
            fuel:state.arkon.selected.fuel||'',
            type:state.arkon.selected.type||'',
            price:Number(state.arkon.selected.price)||0,
            flue:state.arkon.selected.flue||''
          };
          applyBoilerToUi();
        }
        renderArkonPreview(); renderPreview(); renderMustHave();
      }
      if(e.target.id==='rads'){ state.rads=Math.max(0, Number(e.target.value)||0); renderPreview(); renderMustHave(); }
      if(e.target.id==='chimneyM'){ state.chimneyM=Math.max(0, Number(e.target.value)||0); renderPreview(); renderMustHave(); }
      if(e.target.id==='vat'){ state.vat=Number(e.target.value)||0.08; renderPreview(); renderBasket(); }
    });

    document.addEventListener('input', (e)=>{
      if(e.target.matches('[data-qty-basket]')){
        const i=Number(e.target.getAttribute('data-qty-basket'));
        state.basket[i].qty=Math.max(1, Number(e.target.value)||1); renderBasket();
      }
      if(e.target.id==='houseArea' || e.target.id==='buildingStd'){ calcSuggestedKW(); }
    });

    document.getElementById('applySuggested').addEventListener('click', applySuggestedModel);

    document.addEventListener('click', (e)=>{
      const del=e.target.getAttribute('data-del');
      if(del!=null){ state.basket.splice(Number(del),1); renderBasket(); return; }

      const addId=e.target.getAttribute('data-addon');
      if(addId!=null){
        const i=Number(addId); const name=Object.keys(ACCESSORY_BASE)[i];
        const qty=Math.max(1, Number(document.querySelector(`[data-qty="${i}"]`)?.value)||1);
        addToBasket(name, ACCESSORY_BASE[name], qty); return;
      }

      if(e.target.id==='addPack'){
        const b=activeBoiler(), t=state.selectedTank; 
        if(!b||!t) return alert('Wybierz kocioł i zasobnik.');
        if(requiresBuffer(b) && (!state.bufferLiters || !state.bufferPrice)){
          return alert('Dla kotłów zgazowujących (drewno) wymagany jest bufor ciepła — wybierz pojemność.');
        }
        const price = pricePack(
          b, TANKS[t], Number(state.rads)||0, Number(state.chimneyM)||0,
          (requiresBuffer(b) || state.bufferSelected) ? state.bufferPrice : 0
        );
        const rlabel = state.rads?` + grzejniki x${state.rads}`:'';
        const mlabel = (Number(state.chimneyM)||0)>0 ? ` + wkład ${state.chimneyM} m` : '';
        const blabel = (requiresBuffer(b) || state.bufferSelected)?` + bufor ${state.bufferLiters} l`:'';
        addToBasket(`Zestaw: ${b.model} + CWU ${t} l${blabel} + montaż${rlabel}${mlabel}`, price, 1); return;
      }

      if(e.target.id==='addBoilerOnly'){
        const b=activeBoiler(); if(!b) return alert('Wybierz kocioł.');
        const surcharge = BOILER_ONLY_SURCHARGES[state.brand]||0;
        addToBasket(`Kocioł: ${b.model} — tylko urządzenie`, (Number(b.price)||0)+surcharge, 1); return;
      }
    });

    // Eksport / kopiuj / drukuj
    document.getElementById('exportQuote').addEventListener('click', ()=>{
      const ws = XLSX.utils.json_to_sheet(state.basket.map(it => ({ Pozycja: it.name, Ilość: it.qty, Cena: it.final })));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Koszyk');
      XLSX.writeFile(wb, 'Koszyk_piece_master.xlsx');
    });
    document.getElementById('copyQuote').addEventListener('click', ()=>{
      const vat=Number(document.getElementById('vat').value)||0.08;
      const sum=state.basket.reduce((a,b)=>a+b.final*b.qty,0);
      let txt='Oferta — Konfigurator pieców (master)\n\n';
      state.basket.forEach(it=>{ txt+=`• ${it.name} x ${it.qty} | Cena: ${fmt(it.final)} PLN\n`; });
      txt += `\nRazem: ${fmt(sum)} netto, ${fmt(sum*(1+vat))} brutto (VAT ${Math.round(vat*100)}%)`;
      navigator.clipboard.writeText(txt); alert('Skopiowano do schowka');
    });
    document.getElementById('print').addEventListener('click', ()=>{
      const b = activeBoiler();
      const tank = state.selectedTank ? `${state.selectedTank} l` : '—';
      const buf = (requiresBuffer(b) || state.bufferSelected) && state.bufferLiters ? ` | Bufor: ${state.bufferLiters} l${requiresBuffer(b)?' (wym.)':''}` : '';
      const meta = [
        `Data: ${new Date().toLocaleString('pl-PL')}`,
        `Marka/Model: ${b?b.model:'—'}`,
        `Moc: ${b?.power?b.power+' kW':'—'} | Paliwo: ${b?.fuel||'—'}${buf}`,
        `Zasobnik: ${tank} | VAT: ${Math.round((state.vat||0)*100)}%`,
        `Podgląd ceny zestawu (netto): ${q('#pricePreview').textContent.replace('netto','').split('(')[0].trim()}`
      ].join(' | ');
      q('#printMeta').textContent = meta;
      window.print();
    });

    // Linki/mostek
    document.getElementById('openArkon').addEventListener('click', ()=>{
      try{
        localStorage.setItem('arkon_return_to', location.href);
        localStorage.setItem('arkon_pref_brand', state.brand);
        localStorage.setItem('arkon_pref_fuel',  fuelOfBrand(state.brand));
      }catch{}
      window.open('komponenty-piece.html', '_blank', 'noopener');
    });
    document.getElementById('goArkon').addEventListener('click', ()=>{
      try{
        localStorage.setItem('arkon_return_to', location.href);
        localStorage.setItem('arkon_pref_brand', state.brand);
        localStorage.setItem('arkon_pref_fuel',  fuelOfBrand(state.brand));
      }catch{}
    });
    window.addEventListener('storage', (e)=>{
      if(e.key==='arkon_boilers_updated' || e.key==='arkon_components_boilers_v2'){
        const curId = state.arkon.selected?.id;
        loadArkon(); fillArkonDefaults();
        if(curId) selectArkonById(curId); else { state.arkon.selected=null; renderArkonPreview(); renderPreview(); renderMustHave(); }
      }
      if(e.key==='arkon_selected_boiler_id' && e.newValue){
        selectArkonById(e.newValue);
      }
    });
    window.addEventListener('message', (ev)=>{
      if(ev.data && ev.data.type==='ARKON_BOILER_SELECTED'){ selectArkonById(ev.data.id); }
    });
    window.addEventListener('focus', ()=>{
      try{ const selId = localStorage.getItem('arkon_selected_boiler_id'); if(selId) selectArkonById(selId); }catch{}
    });

    // INIT
    function init(){
      fillBrands(); fillBoilers(); fillTanks(); fillAddons();
      loadArkon(); fillArkonDefaults();
      renderArkonPreview(); renderMustHave(); renderPreview(); renderBasket();
      calcSuggestedKW(); updateBufferUI();
    }
    init();
  </script>
</body>
</html>
