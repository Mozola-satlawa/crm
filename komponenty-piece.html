
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komponenty ‚Ä¢ Piece / Kot≈Çy</title>
<meta name="description" content="Rozbudowany katalog komponent√≥w: piece i kot≈Çy (gaz, pellet, drewno, olej, elektryczne). Filtrowanie, edycja, import/eksport, autosave.">
<style>
  :root{
    --bg:#0b1020; --ink:#e8edff; --muted:#aeb8da; --line:#263168; --card:#0f1636;
    --chip:#1a244d; --accent:#4cc9f0; --ok:#2fbf71; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,#10173c,#111b48);border:1px solid #2b3a77;border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end;margin-left:auto}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:#2f9e44}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .tab{padding:6px 10px;border-radius:999px;border:1px solid #2a3a75;cursor:pointer}
  .tab[aria-selected="true"]{background:#1b2550;border-color:#67a1ff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;border-bottom:1px solid #2a3a77;text-align:left;vertical-align:top}
  th{font-size:12px;color:#aeb8da}
  .scroll{overflow:auto}
  .chip{display:inline-block;background:var(--chip);border:1px solid #2b3a77;border-radius:999px;padding:4px 8px;font-size:12px}
  .price{white-space:nowrap}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .wide{min-width:200px}
  .sticky-foot{position:sticky;bottom:0;background:#0f1636;border-top:1px solid #2b3a77;padding:10px;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  @media (max-width:1100px){ .hide-sm{display:none} }
  @media print{ nav,.toolbar,.sticky-foot{display:none!important} }
  .brand-card{display:flex;flex-direction:column;gap:8px;min-width:240px;background:linear-gradient(180deg,#0f1636,#0f1a44);border:1px solid #2b3a77;border-radius:12px;padding:12px}
  .brand-card h4{margin:0;font-size:16px}
  .hint{font-size:12px;color:#aeb8da}
</style>
</head>
<body>

<header>
  <h1>Komponenty ‚Ä¢ Piece / Kot≈Çy</h1>
  <div class="muted">Gaz ‚Ä¢ Kondensacyjne ‚Ä¢ Na pellet ‚Ä¢ Na drewno ‚Ä¢ Olejowe ‚Ä¢ Elektryczne ‚Äî jeden katalog z rozbudowanymi filtrami i eksportem danych.</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="klienci.html">Klienci</a>
  <a href="kalkulator.html">Kalkulator</a>
  <a href="komponenty-pompy.html">Pompy ciep≈Ça</a>
  <a href="komponenty-piece.html" aria-current="page">Piece</a>
  <a href="komponenty-fotowoltaika.html">Fotowoltaika</a>
  <a href="komponenty-ocieplenie.html">Ocieplenie</a>
  <a href="komponenty-stolarka.html">Stolarka</a>
  <a href="dokumenty.html">Dokumenty</a>
  <a href="upload.html">Przesy≈Ç plik√≥w</a>
  <a href="chat.html">Komunikator</a>
  <a href="ustawienia.html">Ustawienia</a>
  <a href="lidy.html">Lidy</a>
</nav>

<div class="wrap">
  <!-- MOSTEK do konfigurator√≥w -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="brand-card">
        <h4>Ferroli (gaz/kond.)</h4>
        <div class="chip">Dostƒôpnych: <b id="cntFerroli">0</b></div>
        <div class="row">
          <button class="btn" data-open="Ferroli">Otw√≥rz konfigurator</button>
          <button class="btn ghost" data-send="Ferroli">Wy≈õlij zaznaczony</button>
        </div>
        <div class="hint">Dwuklik w wiersz z markƒÖ Ferroli te≈º otworzy konfigurator.</div>
      </div>
      <div class="brand-card">
        <h4>DEFRO (pellet)</h4>
        <div class="chip">Dostƒôpnych: <b id="cntDEFRO">0</b></div>
        <div class="row">
          <button class="btn" data-open="DEFRO">Otw√≥rz konfigurator</button>
          <button class="btn ghost" data-send="DEFRO">Wy≈õlij zaznaczony</button>
        </div>
        <div class="hint">Prze≈õlij model z tej tabeli lub wybierz na miejscu.</div>
      </div>
      <div class="brand-card">
        <h4>Stalmark (pellet)</h4>
        <div class="chip">Dostƒôpnych: <b id="cntStalmark">0</b></div>
        <div class="row">
          <button class="btn" data-open="Stalmark">Otw√≥rz konfigurator</button>
          <button class="btn ghost" data-send="Stalmark">Wy≈õlij zaznaczony</button>
        </div>
        <div class="hint">Je≈õli nie dzia≈Ça≈Ço wcze≈õniej ‚Äî teraz przej≈õcie jest sp√≥jne.</div>
      </div>
      <div class="brand-card">
        <h4>LAZAR (zgazowujƒÖce)</h4>
        <div class="chip">Dostƒôpnych: <b id="cntLazar">0</b></div>
        <div class="row">
          <button class="btn" data-open="Lazar">Otw√≥rz konfigurator</button>
          <button class="btn ghost" data-send="Lazar">Wy≈õlij zaznaczony</button>
        </div>
        <div class="hint">Wysy≈Çamy te≈º preferencje paliwa: drewno.</div>
      </div>
    </div>
    <div class="hint" style="margin-top:8px">
      Mostek u≈ºywa localStorage: <code>arkon_components_boilers_v2</code> (ta tabela), <code>arkon_selected_boiler_id</code> (wyb√≥r), <code>arkon_boilers_updated</code> (ping), <code>arkon_pref_brand</code>/<code>arkon_pref_fuel</code> (pref.).
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="card">
    <div class="row toolbar">
      <button id="add" class="btn ok">+ Dodaj kocio≈Ç</button>
      <button id="dupSel" class="btn">Duplikuj zaznaczone</button>
      <button id="delSel" class="btn bad">Usu≈Ñ zaznaczone</button>
      <span class="pill">Razem: <b id="countAll">0</b></span>
      <span class="pill">Widocznych: <b id="countVis">0</b></span>
      <span class="pill">Zaznaczonych: <b id="countSel">0</b></span>
      <div class="right">
        <button id="expJSON" class="btn ghost">Eksport JSON</button>
        <label class="btn ghost">Import JSON <input id="impJSON" type="file" accept="application/json" hidden></label>
        <button id="expCSV" class="btn ghost">Eksport CSV</button>
      </div>
    </div>
  </div>

  <!-- FILTRY -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="üîé Szukaj: marka, model, cecha‚Ä¶" class="wide">
      <select id="fFuel">
        <option value="">Paliwo / typ</option>
        <option>gaz</option><option>gaz-kondensacyjny</option>
        <option>pellet</option><option>drewno</option><option>olej</option><option>elektryczny</option>
      </select>
      <select id="fPhase">
        <option value="">Zasilanie (fazy)</option>
        <option value="1F">1F</option><option value="3F">3F</option>
      </select>
      <select id="fChimney">
        <option value="">Wym√≥g komina</option>
        <option value="TAK">TAK</option><option value="NIE">NIE</option>
      </select>
      <input id="fPowMin" type="number" step="0.1" placeholder="Moc min [kW]" style="width:130px">
      <input id="fPowMax" type="number" step="0.1" placeholder="Moc max [kW]" style="width:130px">
      <input id="fCenaMin" type="number" step="1" placeholder="Cena min [z≈Ç]" style="width:130px">
      <input id="fCenaMax" type="number" step="1" placeholder="Cena max [z≈Ç]" style="width:130px">
      <label class="pill"><input id="fCond" type="checkbox" style="margin-right:6px">Kondensacyjny</label>
      <button id="clearFilters" class="btn ghost">Wyczy≈õƒá filtry</button>
      <span class="right"><span class="muted">Skr√≥ty: <span class="kbd">Alt+N</span> nowy ‚Ä¢ <span class="kbd">/</span> szukaj</span></span>
    </div>
    <div class="tabs" role="tablist" aria-label="Kategorie paliw">
      <button class="tab" data-tab="" aria-selected="true">Wszystkie</button>
      <button class="tab" data-tab="gaz">Gaz</button>
      <button class="tab" data-tab="gaz-kondensacyjny">Gaz (kondens.)</button>
      <button class="tab" data-tab="pellet">Pellet</button>
      <button class="tab" data-tab="drewno">Drewno</button>
      <button class="tab" data-tab="olej">Olej</button>
      <button class="tab" data-tab="elektryczny">Elektryczne</button>
    </div>
  </div>

  <!-- TABELA -->
  <div class="card" style="padding:0">
    <div class="scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th class="hide-sm"><input type="checkbox" id="chkAll"></th>
            <th>Marka</th>
            <th>Model</th>
            <th>Typ/paliwo</th>
            <th>Moc [kW] (min‚Äìmax)</th>
            <th>Sprawno≈õƒá</th>
            <th>Modulacja</th>
            <th>Klasa emisji</th>
            <th>Zasobnik [l]</th>
            <th>Sterowanie</th>
            <th>Zasilanie</th>
            <th>Ha≈Ças [dB]</th>
            <th>Wymiary [mm]</th>
            <th>Waga [kg]</th>
            <th>Gwarancja [lata]</th>
            <th>Komin</th>
            <th>Spalin √ò [mm]</th>
            <th>Akcesoria</th>
            <th class="price">Cena [z≈Ç]</th>
            <th class="price">Monta≈º [z≈Ç]</th>
            <th class="price">Serwis [z≈Ç]</th>
            <th class="wide">Uwagi</th>
            <th>Akcje</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="sticky-foot row">
      <div class="muted">Kliknij kom√≥rkƒô by edytowaƒá. Enter ‚Äî potwierd≈∫, Esc ‚Äî anuluj. Dwuklik w wierszu otwiera odpowiedni konfigurator.</div>
      <div class="right">
        <button id="seed" class="btn ghost">Za≈Çaduj przyk≈Çadowe</button>
        <button id="wipe" class="btn bad">Wyczy≈õƒá wszystko</button>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT0 = new Intl.NumberFormat('pl-PL', {maximumFractionDigits:0});
const esc = s => (s==null?'':String(s)).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
function toNum(v){ const n = Number(v); return Number.isFinite(n)? n : 0; }
function csvEsc(v){ let s=(v==null?'':String(v)); if(/[;\\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; }
const UID = ()=>'PC_'+Math.random().toString(36).slice(2)+'_'+Date.now().toString(36);

/* ===== storage & bridge keys ===== */
const LS_KEY = 'arkon_components_boilers_v2';
const PING_KEY = 'arkon_boilers_updated';
const SEL_KEY = 'arkon_selected_boiler_id';
const PREF_BRAND = 'arkon_pref_brand';
const PREF_FUEL  = 'arkon_pref_fuel';
const RETURN_KEY = 'arkon_return_to';

let rows = load();
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
function ping(){ try{ localStorage.setItem(PING_KEY, String(Date.now())); }catch{} }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); ping(); render(); updateBridge(); }

/* ===== brand -> file mapping (konfiguratory) ===== */
const BRAND_FILES = {
  'ferroli':'ferroli_konfigurator.html',
  'defro':'defro_piece.html',
  'stalmark':'stalmark_pellet.html',
  'lazar':'lazar_zgazowujace.html'
};
function brandFile(brand){
  const b=(brand||'').toLowerCase();
  if(BRAND_FILES[b]) return BRAND_FILES[b];
  // fallback: Ferroli
  return BRAND_FILES['ferroli'];
}
function brandFuel(brand){
  const b=(brand||'').toLowerCase();
  if(b==='defro' || b==='stalmark') return 'pellet';
  if(b==='lazar') return 'drewno';
  return 'gaz-kondensacyjny'; // Ferroli domy≈õlnie
}
function openConfigurator(brand){
  try{
    localStorage.setItem(RETURN_KEY, location.href);
    localStorage.setItem(PREF_BRAND, brand);
    localStorage.setItem(PREF_FUEL, brandFuel(brand));
  }catch{}
  window.open(brandFile(brand), '_blank', 'noopener');
}
function sendToConfigurator(id, brand){
  if(!id){ alert('Zaznacz wiersz albo u≈ºyj przycisku ‚ÄûWy≈õlij‚Äù w wierszu.'); return; }
  try{
    localStorage.setItem(SEL_KEY, id);
    localStorage.setItem(PREF_BRAND, brand);
    localStorage.setItem(PREF_FUEL, brandFuel(brand));
    localStorage.setItem(RETURN_KEY, location.href);
    ping();
  }catch{}
  openConfigurator(brand);
}

/* ===== state & filters ===== */
let filter = { q:'', fuel:'', phase:'', chimney:'', powMin:'', powMax:'', priceMin:'', priceMax:'', cond:false };
let selected = new Set();

/* ===== seed sample data (poszerzone: Ferroli/DEFRO/Stalmark/LAZAR) ===== */
function seed(){
  rows = [
    // FERROLI ‚Äî gaz-kondensacyjny
    {id:UID(),brand:'Ferroli',model:'Divacondens E 24 (2F)',fuel:'gaz-kondensacyjny',powMin:3.0,powMax:24,eff:0.98,mod:'1:8',emiss:'ErP A',tank:0,ctrl:'OpenTherm,pogodowe',phase:'1F',noise:47,dim:'700√ó400√ó330',weight:33,warr:5,chimney:'NIE',flue:60,acc:'czujnik zewn.,modu≈Ç internetowy',price:8800,install:2800,service:450,notes:'Model 2F'},
    {id:UID(),brand:'Ferroli',model:'Bluehelix Tech RRT 24C (2F)',fuel:'gaz-kondensacyjny',powMin:3.0,powMax:24,eff:0.99,mod:'1:10',emiss:'ErP A',tank:0,ctrl:'OpenTherm,Wi-Fi',phase:'1F',noise:46,dim:'740√ó420√ó330',weight:34,warr:5,chimney:'NIE',flue:60,acc:'zestaw monta≈ºowy',price:9800,install:3000,service:500,notes:''},
    {id:UID(),brand:'Ferroli',model:'Bluehelix Tech RRT 28C (2F)',fuel:'gaz-kondensacyjny',powMin:3.2,powMax:28,eff:0.99,mod:'1:10',emiss:'ErP A',tank:0,ctrl:'OpenTherm,Wi-Fi',phase:'1F',noise:46,dim:'740√ó420√ó330',weight:35,warr:5,chimney:'NIE',flue:60,acc:'‚Äî',price:10500,install:3100,service:500,notes:''},

    // DEFRO ‚Äî pellet
    {id:UID(),brand:'DEFRO',model:'Delta EkoPell 16',fuel:'pellet',powMin:4,powMax:16,eff:0.91,mod:'PID',emiss:'Klasa 5/Ecodesign',tank:150,ctrl:'PID,pogodowe',phase:'1F',noise:52,dim:'1300√ó600√ó900',weight:210,warr:5,chimney:'TAK',flue:130,acc:'podajnik,zapalarka',price:20900,install:4200,service:650,notes:'Autom. czyszczenie wymiennika'},
    {id:UID(),brand:'DEFRO',model:'Smart EkoPell 12',fuel:'pellet',powMin:3,powMax:12,eff:0.90,mod:'PID',emiss:'Klasa 5/Ecodesign',tank:130,ctrl:'internet,pogodowe',phase:'1F',noise:51,dim:'1200√ó550√ó900',weight:190,warr:5,chimney:'TAK',flue:120,acc:'zapalarka',price:22500,install:4200,service:650,notes:''},

    // STALMARK ‚Äî pellet (przyk≈Çadowe)
    {id:UID(),brand:'Stalmark',model:'Eko Silver 12',fuel:'pellet',powMin:3,powMax:12,eff:0.90,mod:'PID',emiss:'Klasa 5',tank:120,ctrl:'sterownik ecoMAX',phase:'1F',noise:52,dim:'1180√ó520√ó900',weight:180,warr:4,chimney:'TAK',flue:120,acc:'podajnik,zapalarka',price:18900,install:4100,service:640,notes:''},
    {id:UID(),brand:'Stalmark',model:'Eko Silver 20',fuel:'pellet',powMin:5,powMax:20,eff:0.91,mod:'PID',emiss:'Klasa 5',tank:150,ctrl:'ecoMAX,pogodowe',phase:'1F',noise:53,dim:'1250√ó560√ó960',weight:210,warr:4,chimney:'TAK',flue:130,acc:'‚Äî',price:19900,install:4300,service:650,notes:''},

    // LAZAR ‚Äî zgazowujƒÖce drewno (przyk≈Çadowe)
    {id:UID(),brand:'Lazar',model:'Holz Master 20',fuel:'drewno',powMin:6,powMax:20,eff:0.89,mod:'‚Äî',emiss:'Ecodesign',tank:0,ctrl:'mechaniczny',phase:'1F',noise:55,dim:'1210√ó580√ó1050',weight:220,warr:3,chimney:'TAK',flue:150,acc:'wentylator',price:20358,install:3800,service:600,notes:'Zalecany bufor 1000l'},

    // Inne ‚Äî ≈ºeby by≈Çy pe≈Çne filtry
    {id:UID(),brand:'Viessmann',model:'Vitodens 100-W B1KF',fuel:'gaz-kondensacyjny',powMin:3.2,powMax:25,eff:0.98,mod:'1:10',emiss:'ErP A',tank:0,ctrl:'OpenTherm,pogodowe,Wi-Fi',phase:'1F',noise:45,dim:'700√ó400√ó350',weight:36,warr:5,chimney:'NIE',flue:60,acc:'czujnik zewn.,modu≈Ç internetowy',price:8200,install:2800,service:450,notes:'Zabudowa wiszƒÖca, wbud. pompa, naczynie 8l'},
    {id:UID(),brand:'ATMOS',model:'DC 25S',fuel:'drewno',powMin:8,powMax:25,eff:0.89,mod:'‚Äî',emiss:'Ecodesign',tank:0,ctrl:'termostatyczny',phase:'1F',noise:54,dim:'1210√ó580√ó1050',weight:220,warr:3,chimney:'TAK',flue:150,acc:'wentylator wyciƒÖgowy',price:10400,install:3800,service:600,notes:'Zalecany bufor ciep≈Ça 1000l'}
  ];
  save();
}

/* ===== columns (schema) ===== */
const COLS = [
  {key:'brand',     label:'Marka',            type:'text'},
  {key:'model',     label:'Model',            type:'text'},
  {key:'fuel',      label:'Typ/paliwo',       type:'select', opts:['gaz','gaz-kondensacyjny','pellet','drewno','ekogroszek','olej','elektryczny']},
  {key:'powMin',    label:'Moc min [kW]',     type:'number', step:'0.1'},
  {key:'powMax',    label:'Moc max [kW]',     type:'number', step:'0.1'},
  {key:'eff',       label:'Sprawno≈õƒá',        type:'number', step:'0.01'},
  {key:'mod',       label:'Modulacja',        type:'text'},
  {key:'emiss',     label:'Klasa emisji',     type:'text'},
  {key:'tank',      label:'Zasobnik [l]',     type:'number'},
  {key:'ctrl',      label:'Sterowanie',       type:'text'},
  {key:'phase',     label:'Zasilanie',        type:'select', opts:['1F','3F']},
  {key:'noise',     label:'Ha≈Ças [dB]',       type:'number'},
  {key:'dim',       label:'Wymiary [mm]',     type:'text'},
  {key:'weight',    label:'Waga [kg]',        type:'number'},
  {key:'warr',      label:'Gwarancja [lata]', type:'number'},
  {key:'chimney',   label:'Komin',            type:'select', opts:['TAK','NIE']},
  {key:'flue',      label:'Spalin √ò [mm]',    type:'number'},
  {key:'acc',       label:'Akcesoria',        type:'text'},
  {key:'price',     label:'Cena [z≈Ç]',        type:'number'},
  {key:'install',   label:'Monta≈º [z≈Ç]',      type:'number'},
  {key:'service',   label:'Serwis [z≈Ç]',      type:'number'},
  {key:'notes',     label:'Uwagi',            type:'text'},
];

/* ===== render ===== */
function render(){
  // filters
  const qtxt = (filter.q||'').toLowerCase();
  let data = rows.filter(r=>{
    if(filter.fuel && r.fuel!==filter.fuel) return false;
    if(filter.phase && r.phase!==filter.phase) return false;
    if(filter.chimney && r.chimney!==filter.chimney) return false;
    if(filter.cond && r.fuel!=='gaz-kondensacyjny') return false;
    if(filter.powMin!=='' && Number(r.powMax)<Number(filter.powMin)) return false;
    if(filter.powMax!=='' && Number(r.powMin)>Number(filter.powMax)) return false;
    if(filter.priceMin!=='' && Number(r.price)<Number(filter.priceMin)) return false;
    if(filter.priceMax!=='' && Number(r.price)>Number(filter.priceMax)) return false;
    if(qtxt){
      const hay = [r.brand,r.model,r.fuel,r.mod,r.emiss,r.ctrl,r.dim,r.acc,r.notes].join(' ').toLowerCase();
      if(!hay.includes(qtxt)) return false;
    }
    return true;
  });

  $('#countAll').textContent = rows.length;
  $('#countVis').textContent = data.length;
  $('#countSel').textContent = selected.size;

  const tb = $('#tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="hide-sm"><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
      <td data-k="brand">${esc(r.brand||'')}</td>
      <td data-k="model">${esc(r.model||'')}</td>
      <td data-k="fuel">${esc(r.fuel||'')}</td>
      <td data-k="powMin" title="min">${esc(r.powMin)} ‚Äì <span data-k="powMax" title="max">${esc(r.powMax)}</span></td>
      <td data-k="eff">${esc(r.eff)}</td>
      <td data-k="mod">${esc(r.mod||'')}</td>
      <td data-k="emiss">${esc(r.emiss||'')}</td>
      <td data-k="tank">${esc(r.tank||0)}</td>
      <td data-k="ctrl">${esc(r.ctrl||'')}</td>
      <td data-k="phase">${esc(r.phase||'')}</td>
      <td data-k="noise">${esc(r.noise||'')}</td>
      <td data-k="dim">${esc(r.dim||'')}</td>
      <td data-k="weight">${esc(r.weight||'')}</td>
      <td data-k="warr">${esc(r.warr||'')}</td>
      <td data-k="chimney">${esc(r.chimney||'')}</td>
      <td data-k="flue">${esc(r.flue||'')}</td>
      <td data-k="acc" class="wide">${esc(r.acc||'')}</td>
      <td data-k="price" class="price">${INT0.format(r.price||0)}</td>
      <td data-k="install" class="price">${INT0.format(r.install||0)}</td>
      <td data-k="service" class="price">${INT0.format(r.service||0)}</td>
      <td data-k="notes" class="wide">${esc(r.notes||'')}</td>
      <td>
        <button class="btn" data-conf="${r.id}">Konfigurator</button>
        <button class="btn ghost" data-sendrow="${r.id}">Wy≈õlij</button>
        <button class="btn bad" data-act="del" data-id="${r.id}">Usu≈Ñ</button>
      </td>
    `;
    // inline edit
    tr.querySelectorAll('[data-k]').forEach(cell=>{
      cell.addEventListener('dblclick', (ev)=>{
        // Dwuklik w kom√≥rkƒô: je≈õli to nie jest input ‚Äî i mamy markƒô, otw√≥rz odpowiedni konfigurator
        if(cell.dataset.k!=='acc' && cell.dataset.k!=='notes'){
          const row = rows.find(x=>x.id===r.id);
          if(row?.brand){ try{
            localStorage.setItem(SEL_KEY, r.id);
            localStorage.setItem(PREF_BRAND, row.brand);
            localStorage.setItem(PREF_FUEL, brandFuel(row.brand));
            localStorage.setItem(RETURN_KEY, location.href);
            ping();
          }catch{} openConfigurator(row.brand); return; }
        }
        editCell(r.id, cell.dataset.k, cell);
      });
    });
    // select
    tr.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        if(chk.checked) selected.add(r.id); else selected.delete(r.id);
        $('#countSel').textContent = selected.size;
      });
    });
    // actions
    tr.querySelectorAll('[data-act="del"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        if(confirm('UsunƒÖƒá?')){ rows = rows.filter(x=>x.id!==r.id); save(); }
      });
    });
    tr.querySelectorAll('[data-conf]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===b.dataset.conf);
        if(!row) return;
        try{
          localStorage.setItem(SEL_KEY, row.id);
          localStorage.setItem(PREF_BRAND, row.brand);
          localStorage.setItem(PREF_FUEL, brandFuel(row.brand));
          localStorage.setItem(RETURN_KEY, location.href);
          ping();
        }catch{}
        openConfigurator(row.brand);
      });
    });
    tr.querySelectorAll('[data-sendrow]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===b.dataset.sendrow);
        if(!row) return;
        sendToConfigurator(row.id, row.brand);
      });
    });

    tb.appendChild(tr);
  });
}

/* ===== inline editor ===== */
function editorFor(col, val){
  if(col.type==='select'){
    const sel = document.createElement('select');
    (col.opts||[]).forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; sel.appendChild(op); });
    return sel;
  }
  const inp = document.createElement('input');
  inp.type = col.type || 'text';
  if(col.step) inp.step = col.step;
  inp.value = val==null?'':val;
  inp.style.width = '100%';
  return inp;
}
function editCell(id, key, cell){
  const col = COLS.find(c=>c.key===key);
  if(key==='powMin' || key==='powMax'){
    const row = rows.find(x=>x.id===id);
    const valMin = row.powMin ?? ''; const valMax=row.powMax ?? '';
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div class="card" style="position:absolute; z-index:5; padding:10px; transform:translateY(-10px)">
      <div class="row">
        <input type="number" step="0.1" id="edMin" value="${valMin}" style="width:120px">
        <input type="number" step="0.1" id="edMax" value="${valMax}" style="width:120px">
        <button id="ok" class="btn ok">OK</button>
        <button id="cx" class="btn ghost">Anuluj</button>
      </div></div>`;
    cell.appendChild(wrap);
    const done = (apply)=>{
      if(apply){
        row.powMin = toNum(wrap.querySelector('#edMin').value);
        row.powMax = toNum(wrap.querySelector('#edMax').value);
        save();
      }
      cell.removeChild(wrap);
    };
    wrap.querySelector('#ok').onclick=()=>done(true);
    wrap.querySelector('#cx').onclick=()=>done(false);
    return;
  }
  const row = rows.find(x=>x.id===id);
  const start = row[key];
  const ed = editorFor(col || {type:'text'}, start);
  const origHTML = cell.innerHTML;
  cell.innerHTML=''; cell.appendChild(ed); ed.focus(); if(ed.select) ed.select();
  const commit = (apply)=>{
    if(apply){
      let v = ed.value;
      if((col||{}).type==='number') v = toNum(v);
      row[key] = v;
      save();
    }else{
      cell.innerHTML = origHTML;
    }
  };
  ed.addEventListener('keydown', e=>{
    if(e.key==='Enter') commit(true);
    if(e.key==='Escape') commit(false);
  });
  ed.addEventListener('blur', ()=> commit(true));
}

/* ===== toolbar actions ===== */
$('#add').addEventListener('click', ()=>{
  const blank = {id:UID(),brand:'',model:'',fuel:'gaz',powMin:0,powMax:0,eff:0.9,mod:'',emiss:'',tank:0,ctrl:'',phase:'1F',noise:0,dim:'',weight:0,warr:2,chimney:'NIE',flue:60,acc:'',price:0,install:0,service:0,notes:''};
  rows.unshift(blank); save();
});
$('#dupSel').addEventListener('click', ()=>{
  if(!selected.size) return;
  const ids = Array.from(selected);
  ids.forEach(id=>{ const s=rows.find(x=>x.id===id); if(!s) return; const c=JSON.parse(JSON.stringify(s)); c.id=UID(); c.model=(c.model||'')+' (kopia)'; rows.unshift(c); });
  save();
});
$('#delSel').addEventListener('click', ()=>{
  if(!selected.size) return;
  if(confirm('UsunƒÖƒá zaznaczone pozycje?')){
    rows = rows.filter(r=>!selected.has(r.id)); selected.clear(); save();
  }
});
$('#expJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='komponenty_piece.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#impJSON').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; try{
    const txt = await f.text(); const arr = JSON.parse(txt); if(!Array.isArray(arr)) throw 0;
    rows = arr.map(r=>({id:r.id||UID(), ...r})); save();
  }catch{ alert('Z≈Çy plik JSON'); } e.target.value='';
});
$('#expCSV').addEventListener('click', ()=>{
  const cols = COLS.map(c=>c.key);
  const head = cols.join(';');
  const body = rows.map(r=> cols.map(k=>csvEsc(r[k])).join(';')).join('\n');
  const blob = new Blob([head+'\n'+body], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='komponenty_piece.csv'; a.click(); URL.revokeObjectURL(a.href);
});
$('#seed').addEventListener('click', ()=>{ if(confirm('Za≈Çadowaƒá przyk≈Çadowe pozycje?')) seed(); });
$('#wipe').addEventListener('click', ()=>{ if(confirm('Wyczy≈õciƒá wszystkie pozycje?')){ rows=[]; save(); }});

/* ===== filters bind ===== */
$('#q').addEventListener('input', e=>{ filter.q=e.target.value.trim(); render(); });
$('#fFuel').addEventListener('change', e=>{ filter.fuel=e.target.value; render(); });
$('#fPhase').addEventListener('change', e=>{ filter.phase=e.target.value; render(); });
$('#fChimney').addEventListener('change', e=>{ filter.chimney=e.target.value; render(); });
$('#fPowMin').addEventListener('input', e=>{ filter.powMin=e.target.value; render(); });
$('#fPowMax').addEventListener('input', e=>{ filter.powMax=e.target.value; render(); });
$('#fCenaMin').addEventListener('input', e=>{ filter.priceMin=e.target.value; render(); });
$('#fCenaMax').addEventListener('input', e=>{ filter.priceMax=e.target.value; render(); });
$('#fCond').addEventListener('change', e=>{ filter.cond=e.target.checked; render(); });
$('#clearFilters').addEventListener('click', ()=>{
  filter={ q:'', fuel:'', phase:'', chimney:'', powMin:'', powMax:'', priceMin:'', priceMax:'', cond:false };
  $('#q').value=''; $('#fFuel').value=''; $('#fPhase').value=''; $('#fChimney').value='';
  $('#fPowMin').value=''; $('#fPowMax').value=''; $('#fCenaMin').value=''; $('#fCenaMax').value=''; $('#fCond').checked=false; render();
});

/* tabs -> shortcut to fuel filter */
$$('.tab').forEach(b=> b.addEventListener('click', ()=>{
  $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
  b.setAttribute('aria-selected','true');
  const v=b.dataset.tab||''; $('#fFuel').value=v; filter.fuel=v; render();
}));

/* ===== bridge stats & controls ===== */
function updateBridge(){
  const cnt = (brand)=> rows.filter(r=> (r.brand||'').toLowerCase()===brand.toLowerCase()).length;
  $('#cntFerroli').textContent = cnt('Ferroli');
  $('#cntDEFRO').textContent   = cnt('DEFRO');
  $('#cntStalmark').textContent= cnt('Stalmark');
  $('#cntLazar').textContent   = cnt('Lazar');
}
document.addEventListener('click', (e)=>{
  const open = e.target.getAttribute('data-open');
  if(open){ openConfigurator(open); }
  const brSend = e.target.getAttribute('data-send');
  if(brSend){
    // wybierz pierwszy zaznaczony z tej marki
    const ids = Array.from(selected);
    const row = rows.find(r=> ids.includes(r.id) && (r.brand||'').toLowerCase()===brSend.toLowerCase());
    if(!row){ alert('Zaznacz wiersz tej marki, aby wys≈Çaƒá.'); return; }
    sendToConfigurator(row.id, row.brand);
  }
});

/* ===== shortcuts ===== */
window.addEventListener('keydown', (e)=>{
  if(e.altKey && (e.key==='n' || e.key==='N')){ e.preventDefault(); $('#add').click(); }
  if(e.key==='/'){ e.preventDefault(); $('#q').focus(); }
});

/* ===== apply incoming prefs (when wracamy z konfiguratora) ===== */
(function applyIncomingPrefs(){
  try{
    // Restore selected id from configurator if present
    const sel = localStorage.getItem(SEL_KEY);
    if(sel){
      selected = new Set([sel]);
      // Defer checking the checkbox until after initial render
      setTimeout(()=> {
        render();
        const chk = document.querySelector(`#tbody input[type="checkbox"][data-id="${sel}"]`);
        if(chk){
          chk.checked = true;
          $('#countSel').textContent = selected.size;
          chk.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 0);
    }

    // Apply preferred fuel/brand to filters/UI if present
    const prefFuel = localStorage.getItem(PREF_FUEL) || '';
    if(prefFuel){
      $('#fFuel').value = prefFuel;
      filter.fuel = prefFuel;
    }
    // prefBrand is not bound to a specific input but saved for configurator usage

  }catch(e){
    // ignore any errors while reading prefs
  }

  // Initial render and bridge update
  render();
  updateBridge();
})();
