<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konfigurator pieców — Ferroli / DEFRO / Stalmark / LAZAR</title>
  <style>
    :root{--bg:#f6fff7;--panel:#fff;--line:#d9f5df;--text:#083c1c;--muted:#3e7a52;--accent:#22c55e;--accent-2:#16a34a;--accent-soft:#d9fbe5;--chip-bg:#eafcf1;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:18px auto 48px;padding:0 16px}header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:0}.sub{font-size:12px;color:var(--muted)}.panel{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:12px}.panel h3{margin:0 0 8px;font-size:16px}
    .btn{background:var(--accent);color:#052e16;border:1px solid var(--accent-2);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}.btn.ghost{background:var(--chip-bg);border:1px dashed var(--line);color:var(--text)}
    .btn.warn{background:#fff4d7;border-color:#fcd34d;color:#7a4a00}.btn.danger{background:#ffe5e5;border-color:#fecaca;color:#7a0000}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:1060px){.grid{grid-template-columns:1fr .95fr}}label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type=text],input[type=number]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fbfffc}select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}.col{grid-column:span 12}@media(min-width:720px){.col{grid-column:span 4}.col.wide{grid-column:span 8}}
    .muted{color:var(--muted)}.sep{height:1px;background:var(--line);margin:10px 0}.bundle-grid{display:grid;grid-template-columns:1fr;gap:10px}@media(min-width:960px){.bundle-grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}.card h4{margin:0 0 8px;font-size:15px}.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e8fff0;border:1px solid #c7f6d4;font-size:11px;font-weight:800;margin-right:6px}
    ul.clean{margin:6px 0 0;padding-left:18px}ul.clean li{margin:3px 0}table{width:100%;border-collapse:collapse;font-size:13px}th,td{border-bottom:1px solid var(--line);padding:8px 10px}thead th{background:#f2fff5;text-align:left}.right{text-align:right;white-space:nowrap}
    .price-preview{font-weight:800;font-size:18px;margin-top:6px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    nav a{color:#064e3b;text-decoration:none;border:1px solid var(--line);background:var(--chip-bg);padding:6px 10px;border-radius:999px}
    nav a:hover{background:#eefdf3}
    .mini{font-size:12px;color:var(--muted)}
    .bridge-note{background:#f2fff7;border:1px dashed var(--line);padding:8px;border-radius:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Konfigurator pieców — Ferroli / DEFRO / Stalmark / LAZAR</h1>
        <div class="sub">
          Zestaw = kocioł + zasobnik CWU + montaż (+ opcje). Grzejniki (montaż): <b>750 PLN/szt.</b> • Wkład kominowy: <b>650 PLN/mb</b>.
          Dostępne marki: <b>Ferroli</b> (gaz/kondens.), <b>DEFRO</b> (pellet), <b>Stalmark</b> (pellet), <b>LAZAR</b> (zgazowujące drewno).
        </div>
        <nav>
          <a href="komponenty-piece.html" target="_blank" id="goArkon">Komponenty • Piece</a>
          <a href="ferroli_konfigurator.html" target="_blank">Ferroli — konfigurator</a>
          <a href="defro_piece.html" target="_blank">DEFRO (pellet) — konfigurator</a>
          <a href="stalmark_pellet.html" target="_blank">Stalmark (pellet) — konfigurator</a>
          <a href="lazar_zgazowujace.html" target="_blank">LAZAR (zgazowujące) — konfigurator</a>
        </nav>
      </div>
      <div class="bar">
        <button class="btn" id="exportQuote">Eksport koszyka (XLSX)</button>
        <button class="btn ghost" id="copyQuote">Kopiuj ofertę</button>
        <button class="btn ghost" id="print">Drukuj / PDF</button>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <h3>Dobierz parametry</h3>
        <div class="row">
          <div class="col">
            <label>Marka</label>
            <select id="brand">
              <option value="Ferroli">Ferroli (gaz/kondens.)</option>
              <option value="DEFRO">DEFRO (pellet)</option>
              <option value="Stalmark">Stalmark (pellet)</option>
              <option value="LAZAR">LAZAR (zgazowujące drewno)</option>
            </select>
          </div>
          <div class="col wide">
            <label>Model kotła (lokalna lista dla wybranej marki)</label>
            <select id="boiler"></select>
          </div>
          <div class="col">
            <label>Moc [kW]</label>
            <input id="power" type="text" readonly>
          </div>
          <div class="col">
            <label>Typ/paliwo</label>
            <input id="type" type="text" readonly>
          </div>
          <div class="col">
            <label>Cena kotła [PLN]</label>
            <input id="boilerPrice" type="text" readonly>
          </div>
          <div class="col">
            <label>Zasobnik CWU [l]</label>
            <select id="tank"></select>
          </div>
          <div class="col">
            <label>Cena zbiornika [PLN]</label>
            <input id="tankPrice" type="text" readonly>
          </div>
          <div class="col">
            <label>Liczba grzejników (montaż)</label>
            <input id="rads" type="number" min="0" step="1" value="0">
            <div class="mini">750 PLN/szt.</div>
          </div>
          <div class="col">
            <label>Wkład kominowy [m]</label>
            <input id="chimneyM" type="number" min="0" step="0.1" value="0">
            <div class="mini">650 PLN/mb</div>
          </div>
          <div class="col">
            <label>VAT</label>
            <select id="vat">
              <option value="0.08">8%</option>
              <option value="0.23">23%</option>
            </select>
          </div>
          <div class="col wide">
            <div class="muted">Aktualna cena zestawu (wg wyboru):</div>
            <div id="pricePreview" class="price-preview">—</div>
          </div>
        </div>

        <!-- ▼▼▼ MOSTEK: ARKON — Komponenty • Piece (ograniczony do Ferroli/DEFRO/Stalmark/LAZAR) ▼▼▼ -->
        <div class="sep"></div>
        <h3 style="margin-top:0">Mostek ARKON — Komponenty • Piece</h3>
        <div class="row">
          <div class="col">
            <label>Marka (z katalogu)</label>
            <select id="arkonBrand"></select>
          </div>
          <div class="col">
            <label>Paliwo / typ</label>
            <select id="arkonFuel">
              <option value="">— dowolne —</option>
              <option value="gaz">gaz</option>
              <option value="gaz-kondensacyjny">gaz-kondensacyjny</option>
              <option value="pellet">pellet</option>
              <option value="drewno">drewno</option>
            </select>
          </div>
          <div class="col">
            <label>Min moc [kW]</label>
            <input id="arkonMin" type="number" step="0.1" placeholder="np. 10">
          </div>
          <div class="col">
            <label>Max moc [kW]</label>
            <input id="arkonMax" type="number" step="0.1" placeholder="np. 25">
          </div>
          <div class="col wide">
            <label>Model (z „Komponenty • Piece”)</label>
            <select id="arkonModel" disabled></select>
          </div>
          <div class="col">
            <label>Akcje</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn ghost" id="useArkon">Użyj tego kotła</button>
              <button class="btn ghost" id="openArkon">Otwórz katalog (nowa karta)</button>
            </div>
          </div>
          <div class="col wide">
            <div id="arkonPreview" class="bridge-note">Brak wyboru z katalogu. Ograniczamy do Ferroli / DEFRO / Stalmark / LAZAR.</div>
          </div>
        </div>
        <div class="sub">
          Źródło: <code>localStorage["arkon_components_boilers_v2"]</code>. Filtrujemy tylko: <b>Ferroli</b>, <b>DEFRO</b>, <b>Stalmark</b>, <b>LAZAR</b>.
          Preferencje przekazujemy przez <code>arkon_return_to</code>, <code>arkon_pref_brand</code>, <code>arkon_pref_fuel</code>.
          Wybór przyjmujemy przez <code>arkon_selected_boiler_id</code> lub <code>postMessage</code> (<code>type:"ARKON_BOILER_SELECTED"</code>).
        </div>
        <!-- ▲▲▲ KONIEC MOSTKA ▲▲▲ -->

        <div class="sep"></div>
        <div class="row">
          <div class="col"><button class="btn" id="addPack">Dodaj: Zestaw (kocioł + CWU + montaż)</button></div>
          <div class="col"><button class="btn warn" id="addBoilerOnly">Dodaj: Sam kocioł</button></div>
        </div>
      </div>

      <div class="panel" id="mustHavePanel">
        <h3>Skład zestawu (must-have)</h3>
        <div id="mustHaveList" class="muted">Wybierz markę, model i zasobnik — pokażę skład.</div>
      </div>

      <div class="panel">
        <h3>Koszyk</h3>
        <table id="basket">
          <thead><tr><th>Pozycja</th><th>Ilość</th><th class="right">Cena</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="sep"></div>
        <div class="row">
          <div class="col"><span class="muted">Suma końcowa</span><div id="sumFinal" style="font-weight:800;font-size:22px;"></div></div>
          <div class="col"><span class="muted">Brutto (z VAT)</span><div id="sumBrutto" style="font-weight:800;font-size:22px;"></div></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Akcesoria (opcjonalnie)</h3>
      <div class="bundle-grid" id="addons"></div>
      <div class="sep"></div>
      <button class="btn ghost" id="addSelectedAddons">Dodaj wybrane</button>
      <div class="sub" style="margin-top:6px">Grzejniki i wkład kominowy wliczasz polami powyżej.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    /* ================== MODELE „NA SZTYWNO” — tylko nasze marki ================== */
    // Uwaga: wartości możesz dalej podmieniać pod swój cennik/netto/brutto. DEFRO/Stalmark/LAZAR mają już ceny skalkulowane (np. o +5000 względem minimum — jak w poprzednich plikach).
    const FERROLI = [
      { model:'Divacondens E 20 (2F)',             power:20, fuel:'gaz-kondensacyjny', type:'2F', price: 8400 },
      { model:'Divacondens E 24 (2F)',             power:24, fuel:'gaz-kondensacyjny', type:'2F', price: 8800 },
      { model:'Bluehelix Tech RRT 14C (2F)',       power:14, fuel:'gaz-kondensacyjny', type:'2F', price: 9200 },
      { model:'Bluehelix Tech RRT 18C (2F)',       power:18, fuel:'gaz-kondensacyjny', type:'2F', price: 9600 },
      { model:'Bluehelix Tech RRT 24S (1F)',       power:24, fuel:'gaz-kondensacyjny', type:'1F', price: 9200 },
      { model:'Bluehelix Tech RRT 24C (2F)',       power:24, fuel:'gaz-kondensacyjny', type:'2F', price: 9800 },
      { model:'Bluehelix Tech RRT 28C (2F)',       power:28, fuel:'gaz-kondensacyjny', type:'2F', price:10500 },
      { model:'Bluehelix Maxima 30C (2F)',         power:30, fuel:'gaz-kondensacyjny', type:'2F', price:14500 }
    ];
    const DEFRO = [
      { model:'Delta EkoPell 10 kW',   power:10, fuel:'pellet', price:21632.00 },
      { model:'Delta EkoPell 12 kW',   power:12, fuel:'pellet', price:21890.00 },
      { model:'Delta EkoPell 15 kW',   power:15, fuel:'pellet', price:21078.55 },
      { model:'Delta EkoPell 20 kW',   power:20, fuel:'pellet', price:22290.00 },
      { model:'Delta EkoPell 25 kW',   power:25, fuel:'pellet', price:23990.00 },
      { model:'Smart EkoPell 12 kW',   power:12, fuel:'pellet', price:22515.20 },
      { model:'Komfort EkoPell 14 kW', power:14, fuel:'pellet', price:18498.99 },
      { model:'Komfort EkoPell 20 kW', power:20, fuel:'pellet', price:18745.25 },
      { model:'Komfort EkoPell 25 kW', power:25, fuel:'pellet', price:19993.99 },
      { model:'SIGMA E 35 kW',         power:35, fuel:'pellet', price:27550.79 },
      { model:'SIGMA E 48 kW',         power:48, fuel:'pellet', price:29550.79 }
    ];
    const STALMARK = [
      { model:'Eko Silver 12 kW',   power:12, fuel:'pellet', price:19300 },
      { model:'Eko Silver 16 kW',   power:16, fuel:'pellet', price:20400 },
      { model:'Eko Silver 20 kW',   power:20, fuel:'pellet', price:21900 },
      { model:'Eko Silver 24 kW',   power:24, fuel:'pellet', price:23400 },
      { model:'Eko Silver 30 kW',   power:30, fuel:'pellet', price:25700 }
    ];
    const LAZAR = [
      { model:'Holz Master 20 kW', power:20, fuel:'drewno', price:20358.02 },
      { model:'Holz Master 30 kW', power:30, fuel:'drewno', price:23290.00 },
      { model:'DS 10 kW',          power:10, fuel:'drewno', price:15947.00 },
      { model:'DS 20 kW',          power:20, fuel:'drewno', price:16137.02 },
      { model:'DS 30 kW',          power:30, fuel:'drewno', price:18990.00 },
      { model:'DSpell 20 kW',      power:20, fuel:'drewno', price:26279.00 },
      { model:'DSpell 30 kW',      power:30, fuel:'drewno', price:28990.00 }
    ];

    // Zasobniki CWU i akcesoria
    const TANKS = { '120':2100, '150':2450, '200':2900, '300':3800 };
    const ACCESSORY_BASE = {
      "Zawór 3-drogowy przełączający 1\"":470,
      "Grupa bezpieczeństwa CO 3 bar":150,
      "Filtr siatkowy Y 1\"":180,
      "Separator magnetyczny / odmulacz 5/4\"":840,
      "Naczynie przeponowe CO 18 l":460,
      "Pompa obiegowa CO 25-60":1440
    };

    // Stałe biznesowe
    const RAD_PRICE = 750;
    const CHIMNEY_PRICE = 650;

    // Dla Ferroli wcześniej prosiłeś o +5000 dla „Tylko kocioł” — cicho, bez informacji w UI:
    const BOILER_ONLY_SURCHARGES = { 'Ferroli': 5000, 'DEFRO': 0, 'Stalmark': 0, 'LAZAR': 0 };

    // Baza montażowa wg paliwa (zestaw) — zgodnie z wcześniejszymi stronami
    const INSTALL_BASE = {
      'gaz': 15000, 'gaz-kondensacyjny': 15000,
      'pellet': 18000,
      'drewno': 18000
    };

    const state = {
      brand:'Ferroli',
      vat:0.08, basket:[],
      selectedBoiler:null, selectedTank:null,
      rads:0, chimneyM:0,
      arkon:{ list:[], byBrand:{}, selected:null }
    };

    const q = s=>document.querySelector(s);
    const INT = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
    const fmt = n => INT.format(Number(n)||0);

    /* ===== Helpers ===== */
    function modelsForBrand(b){
      if(b==='Ferroli') return FERROLI;
      if(b==='DEFRO') return DEFRO;
      if(b==='Stalmark') return STALMARK;
      if(b==='LAZAR') return LAZAR;
      return [];
    }
    function fuelOfBrand(b){
      if(b==='Ferroli') return 'gaz-kondensacyjny';
      if(b==='DEFRO') return 'pellet';
      if(b==='Stalmark') return 'pellet';
      if(b==='LAZAR') return 'drewno';
      return '';
    }

    function pricePack(boiler, tank, rads, chimneyM){
      const fuel = boiler?.fuel || fuelOfBrand(state.brand);
      const base = INSTALL_BASE[fuel] || 0;
      // pellet/drewno: pełna suma + montaż; gaz: również doliczamy wkład jeśli chcesz (ustawiasz metry)
      return (Number(boiler?.price)||0)
           + (Number(tank)||0)
           + base
           + (Number(rads)||0)*RAD_PRICE
           + (Number(chimneyM)||0)*CHIMNEY_PRICE;
    }

    function addToBasket(name, finalPrice, qty=1){
      const i = state.basket.findIndex(x=>x.name===name && Math.abs(x.final-finalPrice)<0.01);
      if(i>=0) state.basket[i].qty += qty; else state.basket.push({name, final:finalPrice, qty});
      renderBasket();
    }

    function renderBasket(){
      const tb=q('#basket tbody'); tb.innerHTML=''; let sum=0;
      state.basket.forEach((it,i)=>{
        sum += it.final*it.qty;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td><input type="number" data-qty-basket="${i}" value="${it.qty}" min="1" style="width:70px; padding:6px 8px; border:1px solid var(--line); border-radius:10px;"></td>
          <td class="right">${fmt(it.final)} PLN</td>
          <td class="right"><button class="btn danger" data-del="${i}">Usuń</button></td>`;
        tb.appendChild(tr);
      });
      q('#sumFinal').textContent  = fmt(sum) + ' PLN';
      q('#sumBrutto').textContent = fmt(sum*(1+state.vat)) + ' PLN';
    }

    function activeBoiler(){
      if(state.arkon.selected){
        return {
          model: `${state.arkon.selected.brand} ${state.arkon.selected.model}`,
          power: state.arkon.selected.powMax || state.arkon.selected.powMin || '',
          fuel:  (state.arkon.selected.fuel || '').toLowerCase(),
          type:  state.arkon.selected.type || '',
          price: Number(state.arkon.selected.price)||0,
          flue:  state.arkon.selected.flue || ''
        };
      }
      return state.selectedBoiler;
    }

    function renderMustHave(){
      const box=q('#mustHaveList');
      const b=activeBoiler(), t=state.selectedTank;
      if(!b||!t){ box.textContent='Wybierz markę, model i zasobnik — pokażę skład.'; return; }
      const items = [];
      const labelFuel = (b.fuel||fuelOfBrand(state.brand));
      items.push(`Kocioł — ${b.model}${b.power ? ` (${b.power} kW)` : ''} • ${labelFuel}`);
      items.push(`Zasobnik CWU — ${t} l`);
      items.push('Armatura: zawór 3D CWU/CO, grupa bezpieczeństwa CO, zawór zwrotny');
      items.push('Pompa obiegowa CO + filtr siatkowy + separator magnetyczny');
      items.push('Naczynie przeponowe CO, odpowietrzniki automatyczne');
      const r = Number(state.rads)||0; if(r>0) items.push(`Montaż grzejników: ${r} × ${RAD_PRICE} PLN/szt.`);
      const m = Number(state.chimneyM)||0; if(m>0) items.push(`Wkład kominowy: ${m} m × ${CHIMNEY_PRICE} PLN/mb${b.flue ? ` • zalec. Ø ${b.flue} mm` : ''}`);
      items.push('Montaż, uruchomienie, konfiguracja sterowania');
      box.innerHTML = '<ul class="clean">' + items.map(t => `<li>${t}</li>`).join('') + '</ul>';
    }

    function renderPreview(){
      const b = activeBoiler();
      const t = state.selectedTank;
      const r = Number(state.rads)||0;
      const m = Number(state.chimneyM)||0;
      if(!b || !t){ q('#pricePreview').textContent='—'; return; }
      const sum = pricePack(b, TANKS[t], r, m);
      q('#pricePreview').textContent = fmt(sum) + ' PLN netto (brutto: ' + fmt(sum*(1+state.vat)) + ' PLN)';
    }

    /* ====== UI fill ====== */
    function fillBrands(){
      const brandSel = q('#brand'); brandSel.value = state.brand;
      brandSel.addEventListener('change', ()=>{
        state.brand = brandSel.value; state.arkon.selected=null;
        fillBoilers(); renderPreview(); renderMustHave(); fillArkonDefaults();
      });
    }
    function fillBoilers(){
      const s=q('#boiler'); const list=modelsForBrand(state.brand).slice().sort((a,b)=> a.power-b.power || a.price-b.price );
      s.innerHTML = list.map((b,i) => `<option value="${i}">${b.model} • ${b.power} kW • ${fmt(b.price)} PLN</option>`).join('');
      s.value="0"; state.selectedBoiler = normalizeLocalModel(list[0]);
      applyBoilerToUi();
      s.addEventListener('change', ()=>{
        const idx=Number(s.value)||0; state.selectedBoiler=normalizeLocalModel(list[idx]); applyBoilerToUi();
      });
    }
    function normalizeLocalModel(b){
      if(!b) return null;
      return {
        model: `${state.brand} ${b.model}`,
        power: b.power || '',
        fuel: b.fuel || fuelOfBrand(state.brand),
        type: b.type || '',
        price: Number(b.price)||0
      };
    }
    function applyBoilerToUi(){
      const b=activeBoiler(); if(!b) return;
      q('#power').value = b.power? (b.power+' kW') : '';
      q('#type').value  = b.type? b.type : (b.fuel||'');
      q('#boilerPrice').value = fmt(b.price) + ' PLN';
      renderPreview(); renderMustHave();
    }
    function fillTanks(){
      const s=q('#tank'); const sizes=Object.keys(TANKS).map(Number).sort((a,b)=>a-b);
      s.innerHTML = sizes.map(v => `<option value="${v}">${v} l • ${fmt(TANKS[v])} PLN</option>`).join('');
      s.value=String(sizes[0]); state.selectedTank=s.value;
      q('#tankPrice').value = fmt(TANKS[state.selectedTank]) + ' PLN';
      s.addEventListener('change', ()=>{ state.selectedTank=s.value; q('#tankPrice').value=fmt(TANKS[state.selectedTank])+' PLN'; renderPreview(); renderMustHave(); });
    }
    function fillAddons(){
      const box=q('#addons'); box.innerHTML='';
      Object.keys(ACCESSORY_BASE).forEach((name,i)=>{
        const price=ACCESSORY_BASE[name];
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `
          <h4>${name}</h4>
          <div class="muted">Cena: ${fmt(price)} PLN</div>
          <div style="margin-top:8px;">
            <label>Ilość</label>
            <input type="number" min="1" step="1" value="1" data-qty="${i}">
          </div>
          <div style="margin-top:10px;"><button class="btn ghost" data-addon="${i}">Dodaj</button></div>`;
        box.appendChild(card);
      });
    }

    /* ====== MOSTEK ARKON: tylko 4 nasze marki ====== */
    const ARKON_LS_KEY = 'arkon_components_boilers_v2';
    const ARKON_PING_KEY = 'arkon_boilers_updated';
    const ARKON_SELECTED_KEY = 'arkon_selected_boiler_id';
    const ARKON_RETURN_KEY = 'arkon_return_to';
    const ARKON_PREF_BRAND = 'arkon_pref_brand';
    const ARKON_PREF_FUEL  = 'arkon_pref_fuel';
    const ALLOWED_BRANDS = ['Ferroli','DEFRO','Stalmark','LAZAR'];

    function loadArkon(){
      try{
        const raw = localStorage.getItem(ARKON_LS_KEY); if(!raw) return;
        const list = JSON.parse(raw); if(!Array.isArray(list)) return;
        state.arkon.list = list
          .filter(r => ALLOWED_BRANDS.includes(String(r.brand||'').trim()))
          .map(r=>({
            id:r.id, brand:r.brand||'', model:r.model||'',
            price:Number(r.price)||0,
            powMin:Number(r.powMin)||null, powMax:Number(r.powMax)||null,
            fuel:(r.fuel||r.type||'').toString().toLowerCase(),
            type:r.type||'',
            flue:r.flue || r['Spalin Ø [mm]'] || ''
          }));
        state.arkon.byBrand = state.arkon.list.reduce((a,b)=>{ (a[b.brand]??=[]).push(b); return a; },{});
      }catch{}
    }
    function fillArkonDefaults(){
      // ustaw preferencje zgodnie z wybraną marką
      try{
        localStorage.setItem(ARKON_RETURN_KEY, location.href);
        localStorage.setItem(ARKON_PREF_BRAND, state.brand);
        localStorage.setItem(ARKON_PREF_FUEL,  fuelOfBrand(state.brand));
      }catch{}
      fillArkonBrands(); fillArkonModels();
    }
    function fillArkonBrands(){
      const sel=q('#arkonBrand');
      const brands=Object.keys(state.arkon.byBrand).filter(b=>ALLOWED_BRANDS.includes(b)).sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
      sel.innerHTML = brands.length
        ? brands.map(b => `<option ${b===state.brand ? 'selected' : ''}>${b}</option>`).join('')
        : '<option value="">— brak danych —</option>';
      q('#arkonFuel').value = fuelOfBrand(state.brand) || '';
    }
    function currentArkonFiltered(){
      const brand=q('#arkonBrand').value;
      const fuel=(q('#arkonFuel').value||'').toLowerCase();
      const mn=Number(q('#arkonMin').value), mx=Number(q('#arkonMax').value);
      let list = (state.arkon.byBrand[brand]||[]).slice();
      if(fuel) list = list.filter(x=> (x.fuel||'').includes(fuel));
      return list.filter(x=>{
        const lo = Number(x.powMin||x.power||0) || 0;
        const hi = Number(x.powMax||x.power||0) || lo;
        if(!isNaN(mn) && mn>0 && hi < mn) return false;
        if(!isNaN(mx) && mx>0 && lo > mx) return false;
        return true;
      }).sort((a,b)=> (a.powMax||a.powMin||0) - (b.powMax||b.powMin||0) );
    }
    function fillArkonModels(){
      const ms=q('#arkonModel'); const list=currentArkonFiltered();
      ms.disabled = list.length===0;
      ms.innerHTML = list.length? '<option value="">— wybierz model —</option>' : '<option value="">— brak modeli —</option>';
      if(!list.length){ q('#arkonPreview').textContent='Brak modeli dla filtrów.'; return; }
      ms.innerHTML += list.map(x => `<option value="${x.id}">${x.model}${(x.powMax||x.powMin) ? ` • ${x.powMin||''}-${x.powMax||''} kW` : ''} • ${fmt(x.price)} PLN</option>`).join('');
      q('#arkonPreview').textContent='Wybierz model, aby zobaczyć szczegóły.';
    }
    function renderArkonPreview(){
      const p=state.arkon.selected, box=q('#arkonPreview');
      if(!p){ box.textContent='Brak wyboru z katalogu.'; return; }
      const pow = (p.powMin||'') + (p.powMax ? `–${p.powMax}` : '');
      box.innerHTML = `<b>${p.brand} ${p.model}</b><br>
        Moc: ${pow||'—'} kW • Paliwo: ${p.fuel||'—'} • Cena: <b>${fmt(p.price)} PLN</b>${p.flue?` • Spalin Ø: ${p.flue} mm`:''}`;
    }
    function selectArkonById(id){
      if(!id) return;
      loadArkon();
      const found = (state.arkon.list||[]).find(x=>x.id===id);
      if(!found) return;
      const bSel = q('#arkonBrand'); if(bSel){ bSel.value = found.brand || ''; }
      q('#arkonFuel').value = found.fuel || '';
      fillArkonModels();
      const mSel = q('#arkonModel'); if(mSel){ mSel.value = found.id; }
      state.arkon.selected = found;
      renderArkonPreview();
      // wpisz do pól głównych
      state.selectedBoiler = {
        model: `${found.brand} ${found.model}`,
        power: found.powMax||found.powMin||'',
        fuel: found.fuel||'',
        type: found.type||'',
        price: Number(found.price)||0,
        flue: found.flue||''
      };
      applyBoilerToUi();
    }

    document.addEventListener('change', (e)=>{
      if(e.target.id==='arkonBrand' || e.target.id==='arkonFuel' || e.target.id==='arkonMin' || e.target.id==='arkonMax'){
        state.arkon.selected=null; fillArkonModels(); renderArkonPreview(); renderPreview();
      }
      if(e.target.id==='arkonModel'){
        const id=e.target.value;
        state.arkon.selected = (state.arkon.list||[]).find(x=>x.id===id) || null;
        if(state.arkon.selected){
          state.selectedBoiler = {
            model: `${state.arkon.selected.brand} ${state.arkon.selected.model}`,
            power: state.arkon.selected.powMax||state.arkon.selected.powMin||'',
            fuel: state.arkon.selected.fuel||'',
            type: state.arkon.selected.type||'',
            price: Number(state.arkon.selected.price)||0,
            flue: state.arkon.selected.flue||''
          };
          applyBoilerToUi();
        }
        renderArkonPreview(); renderPreview(); renderMustHave();
      }
      if(e.target.id==='rads'){ state.rads=Math.max(0, Number(e.target.value)||0); renderPreview(); renderMustHave(); }
      if(e.target.id==='chimneyM'){ state.chimneyM=Math.max(0, Number(e.target.value)||0); renderPreview(); renderMustHave(); }
      if(e.target.id==='vat'){ state.vat=Number(e.target.value)||0.08; renderPreview(); renderBasket(); }
    });

    document.getElementById('useArkon').addEventListener('click', ()=>{
      if(!state.arkon.selected) return alert('Wybierz model w mostku ARKON.');
      applyBoilerToUi(); renderPreview(); renderMustHave();
    });
    document.getElementById('openArkon').addEventListener('click', ()=>{
      try{
        localStorage.setItem(ARKON_RETURN_KEY, location.href);
        localStorage.setItem(ARKON_PREF_BRAND, state.brand);
        localStorage.setItem(ARKON_PREF_FUEL,  fuelOfBrand(state.brand));
      }catch{}
      window.open('komponenty-piece.html', '_blank', 'noopener');
    });
    document.getElementById('goArkon').addEventListener('click', ()=>{
      try{
        localStorage.setItem(ARKON_RETURN_KEY, location.href);
        localStorage.setItem(ARKON_PREF_BRAND, state.brand);
        localStorage.setItem(ARKON_PREF_FUEL,  fuelOfBrand(state.brand));
      }catch{}
    });

    window.addEventListener('storage', (e)=>{
      if(e.key===ARKON_PING_KEY || e.key===ARKON_LS_KEY){
        const curId = state.arkon.selected?.id;
        loadArkon(); fillArkonDefaults();
        if(curId) selectArkonById(curId); else { state.arkon.selected=null; renderArkonPreview(); renderPreview(); renderMustHave(); }
      }
      if(e.key===ARKON_SELECTED_KEY && e.newValue){
        selectArkonById(e.newValue);
      }
    });
    window.addEventListener('message', (ev)=>{
      if(ev.data && ev.data.type==='ARKON_BOILER_SELECTED'){ selectArkonById(ev.data.id); }
    });
    window.addEventListener('focus', ()=>{
      try{ const selId = localStorage.getItem(ARKON_SELECTED_KEY); if(selId) selectArkonById(selId); }catch{}
    });

    /* ====== Kliknięcia / koszyk ====== */
    document.addEventListener('click', (e)=>{
      const del=e.target.getAttribute('data-del');
      if(del!=null){ state.basket.splice(Number(del),1); renderBasket(); return; }

      const addId=e.target.getAttribute('data-addon');
      if(addId!=null){
        const i=Number(addId); const name=Object.keys(ACCESSORY_BASE)[i];
        const qty=Math.max(1, Number(document.querySelector(`[data-qty="${i}"]`)?.value)||1);
        addToBasket(name, ACCESSORY_BASE[name], qty); return;
      }

      if(e.target.id==='addPack'){
        const b=activeBoiler(), t=state.selectedTank; if(!b||!t) return alert('Wybierz kocioł i zasobnik.');
        const price = pricePack(b, TANKS[t], Number(state.rads)||0, Number(state.chimneyM)||0);
        const rlabel = state.rads?` + grzejniki x${state.rads}`:'';
        const mlabel = (Number(state.chimneyM)||0)>0 ? ` + wkład ${state.chimneyM} m` : '';
        addToBasket(`Zestaw: ${b.model} + CWU ${t} l + montaż${rlabel}${mlabel}`, price, 1); return;
      }

      if(e.target.id==='addBoilerOnly'){
        const b=activeBoiler(); if(!b) return alert('Wybierz kocioł.');
        const surcharge = BOILER_ONLY_SURCHARGES[state.brand]||0;
        addToBasket(`Kocioł: ${b.model} — tylko urządzenie`, (Number(b.price)||0)+surcharge, 1); return;
      }
    });

    // Eksport / kopiuj / drukuj
    document.getElementById('exportQuote').addEventListener('click', ()=>{
      const ws = XLSX.utils.json_to_sheet(state.basket.map(it => ({ Pozycja: it.name, Ilość: it.qty, Cena: it.final })));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Koszyk');
      XLSX.writeFile(wb, 'Koszyk_piece_master.xlsx');
    });
    document.getElementById('copyQuote').addEventListener('click', ()=>{
      const vat=Number(document.getElementById('vat').value)||0.08;
      const sum=state.basket.reduce((a,b)=>a+b.final*b.qty,0);
      let txt = 'Oferta — Konfigurator pieców (master)\\n\\n';
      state.basket.forEach(it=>{ txt += `• ${it.name} x ${it.qty} | Cena: ${fmt(it.final)} PLN\\n`; });
      txt += `\\nRazem: ${fmt(sum)} netto, ${fmt(sum*(1+vat))} brutto (VAT ${Math.round(vat*100)}%)`;
      navigator.clipboard.writeText(txt); alert('Skopiowano do schowka');
    });
    document.getElementById('print').addEventListener('click', ()=> window.print());

    // INIT
    function init(){
      fillBrands(); fillBoilers(); fillTanks(); fillAddons();
      loadArkon(); fillArkonDefaults();
      renderArkonPreview(); renderMustHave(); renderPreview(); renderBasket();
    }
    init();
  </script>
</body>
</html>
