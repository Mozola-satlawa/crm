<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konfigurator PRIMA — v10 (dynamiczna kotłownia)</title>
  <style>
    :root{--bg:#f6fff7;--panel:#fff;--line:#d9f5df;--text:#083c1c;--muted:#3e7a52;--accent:#22c55e;--accent-2:#16a34a;--accent-soft:#d9fbe5;--chip-bg:#eafcf1;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:18px auto 48px;padding:0 16px}header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:0}.sub{font-size:12px;color:var(--muted)}.panel{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:12px}.panel h3{margin:0 0 8px;font-size:16px}
    .btn{background:var(--accent);color:#052e16;border:1px solid var(--accent-2);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}.btn.ghost{background:var(--chip-bg);border:1px dashed var(--line);color:var(--text)}
    .btn.warn{background:#fff4d7;border-color:#fcd34d;color:#7a4a00}.btn.danger{background:#ffe5e5;border-color:#fecaca;color:#7a0000}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:1060px){.grid{grid-template-columns:1fr .9fr}}label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fbfffc}select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}.col{grid-column:span 12}@media(min-width:680px){.col{grid-column:span 4}.col.wide{grid-column:span 8}}
    .muted{color:var(--muted)}.sep{height:1px;background:var(--line);margin:10px 0}.bundle-grid{display:grid;grid-template-columns:1fr;gap:10px}@media(min-width:960px){.bundle-grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}.card h4{margin:0 0 8px;font-size:15px}.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e8fff0;border:1px solid #c7f6d4;font-size:11px;font-weight:800;margin-right:6px}
    ul.clean{margin:6px 0 0;padding-left:18px}ul.clean li{margin:3px 0}table{width:100%;border-collapse:collapse;font-size:13px}th,td{border-bottom:1px solid var(--line);padding:8px 10px}thead th{background:#f2fff5;text-align:left}.right{text-align:right;white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Konfigurator PRIMA — v10</h1>
        <div class="sub">Filtruj po <b>mocy [kW]</b>. Poniżej <b>must-have</b> elementy. Ceny końcowe są liczone automatycznie.</div>
      </div>
      <div class="bar">
        <button class="btn" id="exportQuote">Eksport koszyka (XLSX)</button>
        <button class="btn ghost" id="copyQuote">Kopiuj ofertę</button>
        <button class="btn ghost" id="print">Drukuj / PDF</button>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <h3>Dobierz parametry</h3>
        <div class="row">
          <div class="col">
            <label>Rodzaj</label>
            <select id="rodzaj">
              <option value="">— dowolny —</option>
              <option value="MONOBLOK">MONOBLOK</option>
              <option value="SPLIT">SPLIT</option>
            </select>
          </div>
          <div class="col">
            <label>Moc pompy <b>[kW]</b> <span class="muted">(filtr po mocy)</span></label>
            <select id="power"><option value="">— dowolna —</option></select>
          </div>
          <div class="col">
            <label>Bufor</label>
            <select id="bufor">
              <option value="">— dowolny —</option>
              <option value="60">60</option>
              <option value="200">200</option>
              <option value="Complete 250/110">Complete 250/110</option>
            </select>
          </div>
          <div class="col">
            <label>Wymiennik / Zbiornik</label>
            <select id="wymiennik">
              <option value="">— dowolny —</option>
              <option value="Tower Grand 200">Tower Grand 200</option>
              <option value="Tower Grand 300">Tower Grand 300</option>
              <option value="Complete 250/110">Complete 250/110</option>
            </select>
          </div>
          <div class="col wide">
            <label>Szukaj</label>
            <input id="q" type="text" placeholder="np. PRIMA, Tower Grand, zawór…" />
          </div>
        </div>

        <!-- ▼▼▼ NOWE: podpięcie bazy ARKON (Komponenty • Pompy) ▼▼▼ -->
        <div class="row">
          <div class="col">
            <label>Marka (z bazy ARKON)</label>
            <select id="arkonBrand">
              <option value="">— dowolna —</option>
            </select>
          </div>
          <div class="col wide">
            <label>Model (z bazy ARKON)</label>
            <select id="arkonModel" disabled>
              <option value="">— najpierw wybierz markę —</option>
            </select>
          </div>
          <div class="col">
            <label>Akcja</label>
            <button class="btn ghost" id="addArkonPump">Dodaj wybraną pompę</button>
          </div>
        </div>
        <div class="sub" style="margin-top:6px">
          <b>Info:</b> dane czytane z <i>Komponenty • Pompy</i> (localStorage: <code>arkon_cmp_pumps_v1</code>). Wybór marki/modelu zawęża się wg „Rodzaj/Moc”.
        </div>
        <!-- ▲▲▲ KONIEC: podpięcie bazy ARKON ▲▲▲ -->

        <div class="sep"></div>
        <div id="matchInfo" class="muted">Wybierz parametry – pokażę najlepsze dopasowanie.</div>
        <div class="sep"></div>
        <div class="row">
          <div class="col"><button class="btn" id="addPumpOnly">Dodaj: Tylko pompa</button></div>
          <div class="col"><button class="btn warn" id="addFullBoilerRoom">Dodaj: Kotłownia z montażem</button></div>
          <div class="col">
            <label>VAT</label>
            <select id="vat">
              <option value="0.08">8%</option>
              <option value="0.23">23%</option>
            </select>
          </div>
        </div>
      </div>

      <div class="panel" id="mustHavePanel">
        <h3>Skład zestawu (must-have)</h3>
        <div id="mustHaveList" class="muted">Wybierz parametry, aby zobaczyć skład.</div>
      </div>

      <div class="panel">
        <h3>Koszyk</h3>
        <table id="basket">
          <thead><tr><th>Pozycja</th><th>Ilość</th><th class="right">Cena</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="sep"></div>
        <div class="row">
          <div class="col"><span class="muted">Suma końcowa</span><div id="sumFinal" style="font-weight:800;font-size:22px;"></div></div>
          <div class="col"><span class="muted">Brutto (z VAT)</span><div id="sumBrutto" style="font-weight:800;font-size:22px;"></div></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Gotowe zestawy (propozycje)</h3>
      <div class="bundle-grid" id="bundles"></div>
    </div>

    <div class="panel">
      <h3>Akcesoria / dodatkowe komponenty</h3>
      <div id="addons" class="bundle-grid"></div>
      <div class="sep"></div>
      <button class="btn ghost" id="addSelectedAddons">Dodaj wybrane</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const DATA = {"price_key": "Cena netto w PLN", "rows": [{"Nr katalogowy zestawu": "SG-000045", "Model": "PRIMA 8GT", "Rodzaj wymiennika": "SGW(S) Tower Grand 200", "Bufor c.o.": "60", "Zawór": "Zawór trójdrogowy do realizacji c.w.u.", "Komplet elektryczny": "K6/4\" (2 kW)", "Centrala SMART HOME Lite": "Centrala SMART HOME Lite", "Cena netto w PLN": "9054"}, {"Nr katalogowy zestawu": "SG-000046", "Model": "PRIMA 10GT", "Rodzaj wymiennika": "SGW(S) Tower Grand 200", "Bufor c.o.": "60", "Zawór": "Zawór trójdrogowy do realizacji c.w.u.", "Komplet elektryczny": "K6/4\" (2 kW)", "Centrala SMART HOME Lite": "Centrala SMART HOME Lite", "Cena netto w PLN": "9442"}, {"Nr katalogowy zestawu": "SG-000054", "Model": "PRIMA 3F 12GT", "Rodzaj wymiennika": "SGW(S) Tower Grand 300", "Bufor c.o.": "60", "Zawór": "Zawór trójdrogowy do realizacji c.w.u.", "Komplet elektryczny": "K6/4\" (2 kW)", "Centrala SMART HOME Lite": "Centrala SMART HOME Lite", "Cena netto w PLN": "10886"}, {"Nr katalogowy zestawu": "SG-000056", "Model": "PRIMA 3F 16GT", "Rodzaj wymiennika": "SGW(S) Tower Grand 300", "Bufor c.o.": "60", "Zawór": "Zawór trójdrogowy do realizacji c.w.u.", "Komplet elektryczny": "K6/4\" (2 kW)", "Centrala SMART HOME Lite": "Centrala SMART HOME Lite", "Cena netto w PLN": "11138"}]};
    const ACCESSORY_BASE = {"Zbiornik c.w.u. 300 l": 3000, "Pompa obiegowa 25-40": 1200, "Pompa obiegowa 25-60": 1440, "Pompa obiegowa 25-80": 1680, "Separator magnetyczny / odmulacz 5/4\"": 840, "Filtr siatkowy Y 1\"": 180, "Separator powietrza / odpowietrznik automatyczny": 380, "Grupa bezpieczeństwa c.w.u. 6 bar": 720, "Zawór mieszający termostatyczny c.w.u. 3/4\"": 580, "Zawór trójdrożny przełączający 1\"": 470, "Zawór kulowy 1\" (para)": 160, "Zawór spustowy 1/2\"": 60, "Zawór antyzamarzaniowy": 360, "Naczynie wzbiorcze CO 12 l": 380, "Naczynie wzbiorcze CO 18 l": 460, "Zawór bezpieczeństwa CO 3 bar": 150, "Zawór zwrotny 1\"": 110, "Taca skroplin do pompy ciepła": 830, "Pompa skroplin": 510, "Przewód grzewczy do tacy skroplin": 430, "Stopy amortyzujące / amortyzatory": 340, "Konsola / stelaż jednostki zewnętrznej": 620, "Otulina kauczukowa – pakiet": 460, "Płyn glikolowy do instalacji (20 l)": 580, "Grzałka elektryczna 3 kW 230V": 690, "Zestaw armatury montażowej": 1140};

    // Biznes — ukryte reguły:
    const PUMP_SURCHARGE = 5000;   // dopłata do „tylko pompa” (niewidoczna w UI)
    const PACK_BASE_8KW = 38000;   // kotłownia z montażem dla 8 kW (bazowa, niewidoczna)

    const q = (s) => document.querySelector(s);
    const priceKey = DATA.price_key || "Cena netto w PLN";
    const state = { vat: 0.08, basket: [], match: null, pumpBaseByPower: {} };

    const BUNDLES = [
      { id:'mono60', label:'MONOBLOK – Tower Grand 200 + bufor 60 + instalacja', prefer:{ rodzaj:'MONOBLOK', bufor:'60', wym:'Tower Grand 200' } },
      { id:'monoComplete', label:'MONOBLOK – Complete 250/110 + instalacja', prefer:{ rodzaj:'MONOBLOK', bufor:'Complete 250/110', wym:'Complete 250/110' } },
      { id:'split200', label:'SPLIT – Tower Grand 300 + bufor 200 + instalacja', prefer:{ rodzaj:'SPLIT', bufor:'200', wym:'Tower Grand 300' } },
      { id:'splitComplete', label:'SPLIT – Complete 250/110 + instalacja', prefer:{ rodzaj:'SPLIT', bufor:'Complete 250/110', wym:'Complete 250/110' } }
    ];

    function parsePLN(x){
      if (x == null) return NaN;
      if (typeof x === 'number') return x;
      let s = String(x).replace(/[^0-9,.-\s]/g,'').replace(/\s+/g,'').replace(',', '.');
      const n = parseFloat(s);
      return isNaN(n) ? NaN : n;
    }
    function fmt(n){ return (n??0).toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function joinVals(r){ return Object.values(r).map(v => v==null?'':String(v)).join(' | '); }
    function powerFromModel(modelVal){
      const s = String(modelVal || '').toUpperCase();
      const m = s.match(/(\d{1,2})\s*GT/);
      return m ? m[1] : '';
    }

    function derive(row){
      const out = { ...row };
      const model = String(row['Model'] || row['Model pompy ciepła'] || '').toUpperCase();
      out.__rodzaj = /\bPRIMA S/.test(model) ? 'SPLIT' : (/\bPRIMA\b/.test(model) ? 'MONOBLOK' : '');
      const wym = String(row['Rodzaj wymiennika'] || '').toUpperCase();
      if (/TOWER GRAND\s*200/.test(wym)) out.__wym = 'Tower Grand 200';
      else if (/TOWER GRAND\s*300/.test(wym)) out.__wym = 'Tower Grand 300';
      else if (/COMPLETE\s*250\/110/.test(wym)) out.__wym = 'Complete 250/110';
      else out.__wym = '';
      const bufor = String(row['Bufor c.o.'] || '').toUpperCase();
      out.__bufor = /200/.test(bufor) ? '200' : (/60/.test(bufor) ? '60' : (out.__wym === 'Complete 250/110' ? 'Complete 250/110' : ''));
      out.__power = powerFromModel(model);
      out.__netto = parsePLN(row[priceKey]);
      return out;
    }
    function rows(){ return (DATA.rows||[]).map(derive); }

    function buildPumpBaseByPower(){
      const dict = {};
      rows().forEach(r => {
        if (!r.__power || isNaN(r.__netto)) return;
        const p = Number(r.__netto);
        if (!(r.__power in dict) || p < dict[r.__power]) dict[r.__power] = p; // najmniejsza cena jako baza
      });
      state.pumpBaseByPower = dict;
    }

    function packPriceForPower(power){
      const dict = state.pumpBaseByPower;
      if (!power) return PACK_BASE_8KW;
      const ref8 = dict['8'] ?? Object.values(dict).sort((a,b)=>a-b)[0] ?? PACK_BASE_8KW;
      const sel = dict[power] ?? ref8;
      const delta = sel - ref8;
      return PACK_BASE_8KW + delta;
    }

    function bestMatch(pref=null){
      const list = rows();
      const rodzaj = pref?.rodzaj || q('#rodzaj').value;
      const power = q('#power').value;
      const bufor = pref?.bufor || q('#bufor').value;
      const wym = pref?.wym || q('#wymiennik').value;
      const qv = q('#q').value.trim().toLowerCase();
      let filtered = list.filter(r => {
        if (rodzaj && r.__rodzaj !== rodzaj) return false;
        if (power && r.__power !== power) return false;
        if (bufor && r.__bufor !== bufor) return false;
        if (wym && r.__wym !== wym) return false;
        if (qv && !joinVals(r).toLowerCase().includes(qv)) return false;
        return true;
      });
      filtered.sort((a,b) => {
        const score = (x) => (x.__power?10:0) + (x['Centrala SMART HOME Lite']||x['Centrala Smart Home SINUM Lite']?2:0) - (isNaN(x.__netto)?100:0);
        return score(b) - score(a);
      });
      return filtered[0] || null;
    }

    function renderMatch(){
      const m = bestMatch();
      state.match = m;
      const box = q('#matchInfo');
      if (!m){ box.textContent='Brak dopasowania – zmień filtry.'; q('#mustHaveList').textContent='—'; return; }
      const label = (m['Model'] || m['Nr katalogowy zestawu'] || 'Zestaw') + ' • ' + (m.__rodzaj||'') + (m.__power?(' • '+m.__power+' kW'):'') + (m.__bufor?(' • bufor '+m.__bufor):'');
      box.innerHTML = 'Wybrano: <b>'+label+'</b>';
      renderMustHave(m);
    }

    function buildPowerOptions(){
      const set = new Set(); rows().forEach(r => { if (r.__power) set.add(r.__power); });
      let arr = Array.from(set).sort((a,b)=>Number(a)-Number(b));
      if (arr.length < 2) arr = ['6','8','10','12','16'];
      q('#power').innerHTML = '<option value="">— dowolna —</option>' + arr.map(v => `<option value="${v}">${v}</option>`).join('');
    }

    function addToBasket(name, finalPrice, qty=1){
      const list = state.basket;
      const idx = list.findIndex(x => x.name === name && Math.abs(x.final - finalPrice) < 0.01);
      if (idx >= 0) list[idx].qty += qty; else list.push({ name, final: finalPrice, qty });
      renderBasket();
    }
    function renderBasket(){
      const tb = q('#basket tbody'); tb.innerHTML='';
      let sumF=0;
      state.basket.forEach((it,i) => {
        sumF += it.final * it.qty;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td><input type="number" data-qty="${i}" value="${it.qty}" min="1" style="width:70px; padding:6px 8px; border:1px solid var(--line); border-radius:10px;"></td>
          <td class="right">${fmt(it.final)} PLN</td>
          <td class="right"><button class="btn danger" data-del="${i}">Usuń</button></td>`;
        tb.appendChild(tr);
      });
      q('#sumFinal').textContent = fmt(sumF) + ' PLN';
      q('#sumBrutto').textContent = fmt(sumF * (1 + state.vat)) + ' PLN';
    }

    function renderMustHave(m){
      const box = q('#mustHaveList');
      if (!m){ box.textContent='—'; return; }
      const isMono = (m.__rodzaj === 'MONOBLOK');
      const items = [];
      items.push(`Pompa ciepła PRIMA ${m.__rodzaj||""} ${m.__power||""} kW`);
      if (m.__wym === 'Complete 250/110') {
        items.push('Zbiornik kombinowany Complete 250/110 – wymiennik c.w.u. + bufor c.o.');
      } else {
        if (m.__wym) items.push(`Wymiennik do pomp ciepła – ${m.__wym}`);
        if (m.__bufor) items.push(`Bufor/sprzęgło hydrauliczne – ${m.__bufor} l`);
      }
      items.push('Zawór trójdrogowy do realizacji c.w.u.');
      items.push('Komplet elektryczny GE z grz. 2 kW 230V – K6/4"');
      if (m['Centrala SMART HOME Lite'] || m['Centrala Smart Home SINUM Lite']) items.push('Centrala Smart Home (Lite)');
      items.push('Pompa obiegowa CO (min. 1 szt.)');
      items.push('Filtr siatkowy Y + separator magnetyczny + odpowietrznik automatyczny');
      items.push('Grupa bezpieczeństwa c.w.u., zawór bezpieczeństwa CO, zawór zwrotny, naczynie wzbiorcze CO');
      if (isMono){
        items.push('Taca skroplin + przewód grzewczy do tacy');
        items.push('Stopy amortyzujące / konsola jednostki zewnętrznej');
        items.push('Otulina + płyn glikolowy do obiegu');
      } else {
        items.push('Elementy montażowe przewodów chłodniczych (SPLIT)');
      }
      items.push('Zestaw armatury montażowej (zawory, nyple, mufy itp.)');
      box.innerHTML = '<ul class="clean">' + items.map(t => `<li>${t}</li>`).join('') + '</ul>';
    }

    document.addEventListener('change', (e)=>{
      if (e.target.id==='vat'){ state.vat = Number(e.target.value)||0.08; renderBasket(); }
      if (['rodzaj','power','bufor','wymiennik'].includes(e.target.id)) renderMatch();
    });
    document.addEventListener('input', (e)=>{
      if (e.target.id==='q') renderMatch();
      if (e.target.matches('[data-qty]')){
        const i = Number(e.target.getAttribute('data-qty'));
        state.basket[i].qty = Math.max(1, Number(e.target.value)||1);
        renderBasket();
      }
    });
    document.addEventListener('click', (e)=>{
      const del = e.target.getAttribute('data-del');
      if (del){ state.basket.splice(Number(del),1); renderBasket(); return; }

      const bid = e.target.getAttribute('data-bundle');
      if (bid){
        const b = BUNDLES.find(x=>x.id===bid);
        const m = bestMatch(b.prefer);
        if (!m) return alert('Brak dopasowania do tego zestawu – zmień moc/rodzaj lub sprawdź inny pakiet.');
        const price = packPriceForPower(m.__power);
        addToBasket(`${b.label} – ${m.__rodzaj||''} ${m.__power||''} kW`, price, 1);
        return;
      }

      if (e.target.id==='addPumpOnly'){
        const m = state.match;
        if (!m) return alert('Najpierw dobierz zestaw (filtry u góry).');
        const pumpBase = Number(m.__netto)||0;
        const final = pumpBase + PUMP_SURCHARGE; // dopłata ukryta
        addToBasket(`Pompa PRIMA ${m.__power||''} kW (${m.__rodzaj||''}) – tylko pompa`, final, 1);
        return;
      }
      if (e.target.id==='addFullBoilerRoom'){
        const m = state.match;
        if (!m) return alert('Najpierw dobierz zestaw (filtry u góry).');
        const price = packPriceForPower(m.__power);
        addToBasket(`Kotłownia z montażem – ${m.__rodzaj||''} ${m.__power||''} kW`, price, 1);
        return;
      }

      const aid = e.target.getAttribute('data-addon');
      if (aid != null){
        const i = Number(aid);
        const name = Object.keys(ACCESSORY_BASE)[i];
        const qty = Math.max(1, Number(document.querySelector(`[data-qty="${i}"]`).value)||1);
        const final = ACCESSORY_BASE[name] + 500; // final visible price = base + 500
        addToBasket(name, final, qty);
        return;
      }
    });

    function renderBundles(){
      const box = q('#bundles'); box.innerHTML='';
      BUNDLES.forEach(b => {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <h4>${b.label}</h4>
          <div class="muted">Cena pakietu jest liczona dynamicznie względem mocy pompy.</div>
          <div style="margin-top:8px;"><span class="pill">Dobór wg filtrów (moc, rodzaj)</span></div>
          <div style="margin-top:10px;"><button class="btn" data-bundle="${b.id}">Dodaj zestaw</button></div>`;
        box.appendChild(card);
      });
    }

    function renderAddons(){
      const box = q('#addons'); box.innerHTML='';
      Object.keys(ACCESSORY_BASE).forEach((name, i)=>{
        const final = ACCESSORY_BASE[name] + 500;
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <h4>${name}</h4>
          <div class="muted">Cena: ${fmt(final)} PLN</div>
          <div style="margin-top:8px;">
            <label>Ilość</label>
            <input type="number" min="1" step="1" value="1" data-qty="${i}">
          </div>
          <div style="margin-top:10px;"><button class="btn ghost" data-addon="${i}">Dodaj</button></div>`;
        box.appendChild(card);
      });
    }

    document.getElementById('exportQuote').addEventListener('click', ()=>{
      const ws = XLSX.utils.json_to_sheet(state.basket.map(it => ({ Pozycja: it.name, Ilość: it.qty, Cena: it.final })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Koszyk');
      XLSX.writeFile(wb, 'Koszyk_PRIMA_v10.xlsx');
    });
    document.getElementById('copyQuote').addEventListener('click', ()=>{
      const vat = Number(document.getElementById('vat').value)||0.08;
      let sum = state.basket.reduce((a,b)=>a + b.final*b.qty, 0);
      let txt = 'Oferta\n\n';
      state.basket.forEach(it => { txt += `• ${it.name} x ${it.qty} | Cena: ${fmt(it.final)} PLN\n`; });
      txt += `\nRazem: ${fmt(sum)} netto, ${fmt(sum*(1+vat))} brutto (VAT ${Math.round(vat*100)}%)`;
      navigator.clipboard.writeText(txt);
      alert('Skopiowano do schowka');
    });
    document.getElementById('print').addEventListener('click', ()=> window.print());

    /* ===================== ARKON BRIDGE (Komponenty • Pompy) ===================== */
    const ARKON_LS_KEY = 'arkon_cmp_pumps_v1';
    state.arkon = { pumps: [], byBrand: {}, selected: null };

    function toRodzajFromType(t){
      const s = String(t||'').toLowerCase();
      if (s === 'split') return 'SPLIT';
      if (s === 'monoblok') return 'MONOBLOK';
      return '';
    }
    function powerFromNumber(n){ const kW = Number(n)||0; return kW ? String(Math.round(kW)) : ''; }

    function loadArkonPumps(){
      try{
        const raw = localStorage.getItem(ARKON_LS_KEY);
        if(!raw) return;
        const list = JSON.parse(raw);
        if(!Array.isArray(list)) return;
        state.arkon.pumps = list.map(p => ({
          id: p.id, brand: p.brand||'', model: p.model||'',
          rodzaj: toRodzajFromType(p.type), power: powerFromNumber(p.power),
          scop: Number(p.scop)||null, refrig: p.refrig||'', phase: p.phase||'',
          lowtemp: p.lowtemp||'', noise: Number(p.noise)||null, cwu: p.cwu||'',
          price: Number(p.price)||0,
          tags: Array.isArray(p.tags)? p.tags : String(p.tags||'').split(',').map(s=>s.trim()).filter(Boolean),
          notes: p.notes||'', acc: p.acc||'', link: p.link||''
        })).filter(p => p.brand || p.model);
        state.arkon.byBrand = state.arkon.pumps.reduce((a,p)=>{ (a[p.brand] ||= []).push(p); return a; },{});
      }catch{}
    }
    function fillArkonBrands(){
      const sel = document.getElementById('arkonBrand'); if(!sel) return;
      const brands = Object.keys(state.arkon.byBrand).sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
      sel.innerHTML = '<option value="">— dowolna —</option>' + brands.map(b=>`<option>${b}</option>`).join('');
    }
    function fillArkonModels(){
      const brandSel = document.getElementById('arkonBrand');
      const modelSel = document.getElementById('arkonModel');
      if(!brandSel || !modelSel) return;
      const b = brandSel.value;
      const rodzaj = document.getElementById('rodzaj').value;
      const power = document.getElementById('power').value;
      let list = (state.arkon.byBrand[b] || []).slice();
      if (rodzaj) list = list.filter(x => x.rodzaj === rodzaj);
      if (power)  list = list.filter(x => x.power === power);
      modelSel.disabled = list.length === 0;
      if (!list.length){
        modelSel.innerHTML = '<option value="">— brak modeli dla wyboru —</option>';
        state.arkon.selected = null; return;
      }
      modelSel.innerHTML = '<option value="">— wybierz model —</option>' +
        list.map(x => {
          const lbl = `${x.model} • ${x.rodzaj||'?'}${x.power?(' • '+x.power+'kW'):''}${x.price?(' • '+fmt(x.price)+' PLN'):''}`;
          return `<option value="${x.id}">${lbl}</option>`;
        }).join('');
    }
    function renderArkonOverlay(){
      const box = document.getElementById('matchInfo'); if (!box) return;
      const p = state.arkon.selected;
      if (!p){ renderMatch(); return; }
      const lbl = `<b>${(p.brand||'') + ' ' + (p.model||'')}</b> • ${p.rodzaj||''}${p.power?(' • '+p.power+' kW'):''}${p.refrig?(' • '+p.refrig):''}`;
      box.innerHTML = `Wybrano z bazy ARKON: ${lbl} — cena katalogowa: <b>${fmt(p.price)} PLN</b>`;
      const fake = { __rodzaj: p.rodzaj, __power: p.power, __bufor:'', __wym:'',
        'Centrala SMART HOME Lite':'','Centrala Smart Home SINUM Lite':'' };
      renderMustHave(fake);
    }
    function pickArkonModel(){
      const modelSel = document.getElementById('arkonModel');
      const id = modelSel?.value || '';
      state.arkon.selected = id ? state.arkon.pumps.find(p => p.id === id) : null;
      renderArkonOverlay();
    }
    // eventy mostka
    document.addEventListener('change', (e)=>{
      if (['rodzaj','power','arkonBrand'].includes(e.target.id)){
        fillArkonModels();
        const p = state.arkon.selected;
        if (p){
          const rodzaj = document.getElementById('rodzaj').value;
          const power  = document.getElementById('power').value;
          if ((rodzaj && p.rodzaj !== rodzaj) || (power && p.power !== power)){
            state.arkon.selected = null;
            const ms = document.getElementById('arkonModel'); if (ms) ms.value = '';
            renderArkonOverlay();
          }
        }
      }
      if (e.target.id === 'arkonModel') pickArkonModel();
    });
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'addArkonPump'){
        const p = state.arkon.selected;
        if (!p) { alert('Wybierz najpierw markę i model z bazy ARKON.'); return; }
        const final = (Number(p.price)||0) + PUMP_SURCHARGE;
        addToBasket(`Pompa (ARKON) ${p.brand} ${p.model} — ${p.rodzaj||''} ${p.power||''} kW`, final, 1);
      }
    });

    // Auto-refresh: gdy Komponenty zapiszą nowe dane
    window.addEventListener('storage', (e) => {
      if (e.key === 'arkon_pumps_updated' || e.key === 'arkon_cmp_pumps_v1') {
        loadArkonPumps();
        fillArkonBrands();
        fillArkonModels();
        renderArkonOverlay();
      }
    });

    // Rozszerzenie referencji cenowej o najniższe ceny z ARKON
    {
      const _orig = packPriceForPower;
      packPriceForPower = function(power){
        const dict = { ...(state.pumpBaseByPower || {}) };
        (state.arkon?.pumps || []).forEach(p=>{
          if(!p.power || !p.price) return;
          const k = String(p.power), pr = Number(p.price)||0;
          if (!(k in dict) || pr < dict[k]) dict[k] = pr;
        });
        const keys = Object.keys(dict);
        if (!keys.length) return _orig(power);
        const ref8 = dict['8'] ?? Object.values(dict).sort((a,b)=>a-b)[0] ?? PACK_BASE_8KW;
        const sel  = dict[power] ?? ref8;
        return PACK_BASE_8KW + (sel - ref8);
      };
    }

    // wybór pompy po ID (z Komponentów przez postMessage albo localStorage)
    function selectPumpById(id){
      if (!id) return;
      loadArkonPumps();
      const p = (state.arkon.pumps||[]).find(x => x.id === id);
      if (!p) return;
      const brandSel = document.getElementById('arkonBrand');
      if (brandSel){ brandSel.value = p.brand || ''; fillArkonModels(); }
      const modelSel = document.getElementById('arkonModel');
      if (modelSel){ modelSel.value = p.id; pickArkonModel(); }
    }

    function init(){
      buildPumpBaseByPower();
      buildPowerOptions();
      renderMatch();
      renderBundles();
      renderAddons();
      renderBasket();
    }

    // start: wczytaj bazę ARKON i przygotuj pola
    loadArkonPumps();
    fillArkonBrands();
    fillArkonModels();

    // jeżeli Komponenty wskazały konkretną pompę
    try{
      const selId = localStorage.getItem('arkon_selected_pump_id');
      if (selId){ selectPumpById(selId); localStorage.removeItem('arkon_selected_pump_id'); }
    }catch{}

    // obsługa wysyłki z Komponentów via postMessage
    window.addEventListener('message', (ev)=>{
      if (ev.data && ev.data.type === 'ARKON_PUMP_SELECTED'){
        selectPumpById(ev.data.id);
      }
    });

    init();
    /* =================== /ARKON BRIDGE =================== */
  </script>
</body>
</html>
