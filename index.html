<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Pulpit / Indeks</title>
<meta name="description" content="Strona g≈Ç√≥wna ARKON CRM: logowanie, szybkie podglƒÖdy, skr√≥ty, ostatnie rekordy, nawigacja do wszystkich modu≈Ç√≥w.">
<link rel="icon" type="image/svg+xml" href="pv-icon.svg">
<link rel="alternate icon" href="pv-icon.svg">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230b8d3b'/%3E%3Ctext x='50' y='62' font-size='60' text-anchor='middle' fill='white' font-family='Arial,Helvetica,sans-serif'%3EA%3C/text%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0b1020; --grad1:#0a1028; --grad2:#0d1536;
    --ink:#e8edff; --muted:#aeb8da; --line:#22306a;
    --card:#0f1636; --chip:#16245a; --accent:#4cc9f0;
    --ok:#2fbf71; --warn:#ffb84d; --bad:#ff6b6b;
    --focus:#82c4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.55 system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--grad1),var(--grad2));color:var(--ink)}
  a{color:#cfe0ff;text-decoration:none}
  header{padding:16px;border-bottom:1px solid var(--line);background:#0e1534;position:sticky;top:0;z-index:8}
  header h1{margin:0;font-size:22px}
  header .muted{color:var(--muted);font-size:13px}
  nav{display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line);background:#121a44}
  nav a{padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#1a2758}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:14px}
  @media(min-width:1100px){ .cols-3{grid-template-columns:repeat(3,1fr)} .cols-2{grid-template-columns:2fr 1fr} }
  .card{background:linear-gradient(180deg,#0f1636,#0f1a42);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;border-bottom:1px solid #1a244d;text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .kpi{display:flex;align-items:center;gap:12px}
  .kpi .n{font-weight:700;font-size:20px}
  .ok{color:#7ee2ab} .warn{color:#ffd699} .bad{color:#ffb1b1}
  .list-reset{list-style:none;margin:0;padding:0}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .status.lead{background:#19224e}
  .status.q{background:#21305f}
  .status.w{background:#24336b}
  .status.c{background:#1d3d2f}
  .status.l{background:#4a1d1d}
  .apps{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .app{display:block;padding:14px;border-radius:12px;background:#111a42;border:1px solid #2a3a75}
  .app b{display:block;margin-bottom:4px}
  .app:hover{background:#16235a}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:720px){ .grid-2{grid-template-columns:1fr} }
  @media print{ #lock,nav,.btn,.kbd{display:none!important} }

  /* ===== LOCK / LOGIN OVERLAY for DASHBOARD ===== */
  #lock{position:fixed;inset:0;background:radial-gradient(1200px 600px at 60% -10%,#19307144,transparent),linear-gradient(180deg,#0a0f22 0%,#0a0f22 30%,#0b1130 100%);-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
  #lock.open{display:flex}
  .login-panel{width:460px;max-width:94vw;background:linear-gradient(180deg,#0f1636,#101a44);border:1px solid #2a3a75;border-radius:16px;padding:16px;box-shadow:0 20px 60px #0008}
  .login-panel h2{margin:0 0 4px}
  .login-panel .muted{margin-bottom:8px}
  .field{width:100%;background:#0d1530;border:1px solid #28356c;color:#e8edff;border-radius:10px;padding:10px 12px;outline:0}
  .field:focus{border-color:#3e61cc;box-shadow:0 0 0 3px #3e61cc33}
  .row-sb{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .social{display:flex;gap:8px}
  .btn.icon{display:inline-flex;align-items:center;gap:8px}
  .g{background:#1f3b7a} .f{background:#2d3f75}
  .err{color:#ffb1b1;font-size:13px;height:16px}
  .shake{animation:shake .36s}
  @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

  /* user menu */
  .userbar{position:fixed;right:10px;top:10px;display:flex;align-items:center;gap:8px;z-index:9}
  .avatar{width:30px;height:30px;border-radius:50%;display:inline-grid;place-items:center;background:#133; border:1px solid #2a3a75;font-weight:700}
  .online{width:8px;height:8px;border-radius:50%;background:#2fbf71;border:1px solid #0b1}
  .link-like{background:transparent;border:0;color:#cfe0ff;text-decoration:underline;cursor:pointer}

  /* utility classes to avoid inline styles */
  .mt-8{margin-top:8px}
  .mt-6{margin-top:6px}
  .m-8-0{margin:8px 0}
  .gap-10{gap:10px}
  .gap-6{gap:6px}
  .gap-8{gap:8px}
  .form-grid{display:grid;gap:8px;margin-top:6px}
  .grid-cols-1fr-auto{display:grid;grid-template-columns:1fr auto;gap:6px}
  .note-field{width:100%;min-height:100px;margin-top:8px}
  .label-row{display:flex;align-items:center;gap:6px}
  .center{text-align:center}
  .muted-85{opacity:.85}
  .overflow-auto{overflow:auto}

</style>
</head>
<body>

<!-- ===== USER BAR ===== -->
<div class="userbar">
  <span id="ubName" class="small">Go≈õƒá</span>
  <span class="online" title="online"></span>
  <div id="ubAvatar" class="avatar">A</div>
  <button id="btnLogout" class="btn ghost" title="Wyloguj">Wyloguj</button>
  <button id="btnLock" class="btn ghost" title="Zablokuj ekran">Zablokuj</button>
</div>

<header>
  <h1>Pulpit ‚Ä¢ ARKON CRM</h1>
  <div class="small">Szybki podglƒÖd i skr√≥ty. Wszystkie dane przechowywane lokalnie (LocalStorage/IndexedDB). Eksport/Backup dostƒôpny z modu≈Ç√≥w.</div>
</header>

<nav aria-label="Nawigacja g≈Ç√≥wna">
  <a href="index.html" aria-current="page">üè† Pulpit</a>
  <a href="klienci.html">üë• Klienci</a>
  <a href="lidy.html">üß≤ Lidy</a>
  <a href="komponenty.html">üß© Komponenty</a>
  <a href="upload.html">üì§ Przesy≈Ç plik√≥w</a>
  <a href="dokumenty.html">üìÑ Dokumenty</a>
  <a href="chat.html">üí¨ Komunikator</a>
  <a href="ustawienia.html">‚öô Ustawienia</a>
  <a href="kalkulator.html" target="_blank" rel="noopener">üßÆ Kalkulator ‚ÜóÔ∏è</a>
  <a href="baza.html">üóÉ Baza (storage)</a>
  <!-- NOWY LINK -->
  <a href="kalendarz-montaze.html">üìÖ Kalendarz monta≈ºy</a>
</nav>

<div class="wrap grid cols-2" id="panel">

<aside>
  <div class="card">
    <div class="row gap-10 m-8-0">
      <div class="avatar" id="lpAvatar" aria-hidden="true">A</div>
      <div class="small" id="lpWelcome">Witaj! Zaloguj siƒô, aby przej≈õƒá do panelu.</div>
    </div>

    <form id="loginForm" class="form-grid">
      <label class="small">U≈ºytkownik</label>
      <input id="loginUser" class="field" inputmode="email" placeholder="np. u≈ºytkownik" aria-label="U≈ºytkownik" required>
      <label class="small">Has≈Ço</label>
      <div class="grid-cols-1fr-auto">
        <input id="loginPass" class="field" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-label="Has≈Ço" required>
        <button type="button" id="togglePass" class="btn ghost" aria-label="Poka≈º/ukryj has≈Ço">üëÅ</button>
      </div>

      <div class="row-sb">
        <label class="small label-row">
          <input id="rememberMe" type="checkbox"> Pamiƒôtaj mnie (7 dni)
        </label>
        <button type="button" id="forgot" class="link-like">Zapomnia≈Çe≈õ has≈Ça?</button>
      </div>

      <div id="err" class="err"></div>
      <button class="btn ok" type="submit">Zaloguj</button>
      <div class="small center muted-85">lub</div>
      <div class="social">
        <button type="button" id="loginGoogle" class="btn icon g">G Zaloguj przez Google</button>
        <button type="button" id="loginFacebook" class="btn icon f">f Zaloguj przez Facebook</button>
      </div>
    </form>
  </div>

  <div class="right mt-8">
    <a class="btn ghost" href="komponenty.html">Otw√≥rz komponenty</a>
  </div>
</aside>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmt = n => INT.format(Math.round(Number(n)||0));
const fmtDate = ts => new Date(ts||Date.now()).toLocaleString('pl-PL');
function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ===== storage keys (zgodne z innymi stronami) ===== */
const LS = {
  clients: 'arkon_clients_v1',
  leads:   'arkon_leads_v1',
  cmp: {
    pumps:  'arkon_cmp_pumps_v1',
    boilers:'arkon_cmp_boilers_v1',
    pv:     'arkon_cmp_pv_v1',
    insul:  'arkon_cmp_insul_v1',
    garage: 'arkon_cmp_garage_v1'
  },
  note: 'arkon_note',
  authToken: 'arkon_auth_token_v1',     // localStorage (remember me)
  authSession: 'arkon_auth_session_v1'  // sessionStorage (bez remember)
};

/* ======== AUTH (local-only, hashed) ========
   Domy≈õlne dane: u≈ºytkownik "Arkon2", has≈Ço "Szybkakasa".
   W kodzie NIE zapisujemy jawnych danych ‚Äì tylko hashe SHA-256.
*/
const USER_HASH = 'cc6c7f1d16552c14bc8aaa46f3f869743c08c26d7e3c66fd58ee6c304cf5d5ac'; // sha256("Arkon2")
const PASS_HASH = '2fdc3bfddb6c06d9572b7a69c5012742b63d83a1f01c5254dc1fd0fa33352a93'; // sha256("Szybkakasa")

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isTokenValid(obj){
  if(!obj) return false;
  const now = Date.now();
  return typeof obj==='object' && obj.exp && obj.exp>now && obj.user && obj.sig;
}
function genSig(userHash, passHash){ // prosta sygnatura lokalna
  return btoa(userHash.slice(0,16) + ':' + passHash.slice(-16) + ':' + Date.now());
}
function setAvatarFromName(name, el){
  const letter = (name||'A').trim().charAt(0).toUpperCase() || 'A';
  el.textContent = letter;
}

/* ====== LOCK / LOGIN HANDLERS ====== */
const lock = $('#lock');
const loginForm = $('#loginForm');
const loginUser = $('#loginUser');
const loginPass = $('#loginPass');
const rememberMe = $('#rememberMe');
const errBox = $('#err');

$('#togglePass').addEventListener('click', ()=>{
  loginPass.type = loginPass.type==='password' ? 'text' : 'password';
});

$('#forgot').addEventListener('click', ()=>{
  const u = prompt('Podaj sw√≥j identyfikator u≈ºytkownika (np. e-mail lub login). Wy≈õlemy lokalny reset (symulacja):');
  if(!u) return;
  alert('Instrukcje resetu has≈Ça zosta≈Çy wys≈Çane (symulacja offline).');
});

$('#loginGoogle').addEventListener('click', ()=>{
  // symulacja: ustawiamy u≈ºytkownika i token (wa≈ºny 7 dni)
  const name='Google User';
  const token = { user: name, exp: Date.now()+7*24*3600*1000, sig: genSig(USER_HASH,PASS_HASH), idp:'google' };
  localStorage.setItem(LS.authToken, JSON.stringify(token));
  afterLogin(name, true);
});
$('#loginFacebook').addEventListener('click', ()=>{
  const name='Facebook User';
  const token = { user: name, exp: Date.now()+7*24*3600*1000, sig: genSig(USER_HASH,PASS_HASH), idp:'facebook' };
  localStorage.setItem(LS.authToken, JSON.stringify(token));
  afterLogin(name, true);
});

loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  errBox.textContent='';
  const uh = await sha256Hex(loginUser.value || '');
  const ph = await sha256Hex(loginPass.value || '');
  if(uh===USER_HASH && ph===PASS_HASH){
    const name = loginUser.value || 'U≈ºytkownik';
    const token = { user: name, exp: Date.now() + (rememberMe.checked? 7*24*3600*1000 : 2*3600*1000), sig: genSig(uh,ph) };
    if(rememberMe.checked){
      localStorage.setItem(LS.authToken, JSON.stringify(token));
      sessionStorage.removeItem(LS.authSession);
    }else{
      sessionStorage.setItem(LS.authSession, JSON.stringify(token));
      localStorage.removeItem(LS.authToken);
    }
    afterLogin(name, rememberMe.checked);
  }else{
    errBox.textContent = 'Nieprawid≈Çowe dane logowania.';
    loginForm.classList.remove('shake'); void loginForm.offsetWidth; loginForm.classList.add('shake');
    loginPass.value='';
    loginPass.focus();
  }
});

function afterLogin(name, persisted){
  lock.classList.remove('open');
  document.body.style.overflow = '';
  $('#ubName').textContent = name;
  setAvatarFromName(name, $('#ubAvatar'));
  $('#panel').setAttribute('tabindex','-1');
  $('#panel').focus({preventScroll:true});
}

/* autologin */
(function autoLogin(){
  try{
    const rawL = localStorage.getItem(LS.authToken);
    const rawS = sessionStorage.getItem(LS.authSession);
    const obj = rawL ? JSON.parse(rawL) : rawS ? JSON.parse(rawS) : null;
    if(isTokenValid(obj)){
      $('#ubName').textContent = obj.user || 'U≈ºytkownik';
      setAvatarFromName(obj.user, $('#ubAvatar'));
      lock.classList.remove('open');
      document.body.style.overflow = '';
    }else{
      lock.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
  }catch{
    lock.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
})();

/* Blokuj/wyloguj */
$('#btnLock').addEventListener('click', ()=>{
  lock.classList.add('open');
  document.body.style.overflow = 'hidden';
});
$('#btnLogout').addEventListener('click', ()=>{
  if(confirm('Wylogowaƒá z pulpitu?')){
    localStorage.removeItem(LS.authToken);
    sessionStorage.removeItem(LS.authSession);
    lock.classList.add('open');
    document.body.style.overflow = 'hidden';
    loginUser.value=''; loginPass.value=''; rememberMe.checked=false;
    $('#ubName').textContent = 'Go≈õƒá';
    setAvatarFromName('A', $('#ubAvatar'));
  }
});

/* ===== KPI ===== */
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; } }
function refreshKPI(){
  const clients = load(LS.clients, []);
  const leads   = load(LS.leads,   []);
  const cmpSum =
    ['pumps','boilers','pv','insul','garage']
      .map(k => load(LS.cmp[k], []).length)
      .reduce((a,b)=>a+b,0);
  $('#kpiClients').textContent = clients.length;
  $('#kpiLeads').textContent   = leads.length;
  $('#kpiComp').textContent    = cmpSum;

  // komponenty by cat
  $('#cmp_pumps').textContent  = load(LS.cmp.pumps, []).length;
  $('#cmp_boilers').textContent= load(LS.cmp.boilers, []).length;
  $('#cmp_pv').textContent     = load(LS.cmp.pv, []).length;
  $('#cmp_insul').textContent  = load(LS.cmp.insul, []).length;
  $('#cmp_garage').textContent = load(LS.cmp.garage, []).length;
}

/* ===== Recent Clients ===== */
function renderRecentClients(){
  const tb = $('#tblClients tbody'); tb.innerHTML = '';
  const clients = load(LS.clients, [])
    .slice().sort((a,b)=>(b.created||0)-(a.created||0)).slice(0,8);
  if(!clients.length){
    tb.innerHTML = '<tr><td colspan="5" class="small">Brak danych. Dodaj pierwszego klienta w module ‚ÄûKlienci‚Äù.</td></tr>';
    return;
  }
  clients.forEach(c=>{
    const tr = document.createElement('tr');
    const tags = (c.tags||[]).slice(0,3).map(t=>'<span class="tag">'+escapeHtml(t)+'</span>').join('');
    tr.innerHTML = `
      <td><a href="klienci.html" title="Otw√≥rz w Klienci"><b>${escapeHtml(c.name||'‚Äî')}</b></a></td>
      <td><span class="status ${statusClass(c.status)}">${escapeHtml(c.status||'‚Äî')}</span></td>
      <td>${escapeHtml(c.email||'')}<div class="small">${escapeHtml(c.phone||'')}</div></td>
      <td>${tags}</td>
      <td>${fmtDate(c.created)}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Recent Leads ===== */
function renderRecentLeads(){
  const tb = $('#tblLeads tbody'); tb.innerHTML = '';
  const leads = load(LS.leads, [])
    .slice().sort((a,b)=>(b.created||0)-(a.created||0)).slice(0,8);
  if(!leads.length){
    tb.innerHTML = '<tr><td colspan="4" class="small">Brak lead√≥w. Dodaj w module ‚ÄûLidy‚Äù.</td></tr>';
    return;
  }
  leads.forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="lidy.html"><b>${escapeHtml(l.title||'Lead')}</b></a></td>
      <td>${escapeHtml(l.source||'')}</td>
      <td>${escapeHtml(l.status||'NOWY')}</td>
      <td>${fmtDate(l.created)}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Notatka ===== */
function initNote(){
  const el = $('#note');
  el.value = localStorage.getItem(LS.note) || '';
  el.addEventListener('input', ()=> localStorage.setItem(LS.note, el.value));
  $('#btnClearNote').addEventListener('click', ()=>{
    if(confirm('Wyczy≈õciƒá notatkƒô?')){ el.value=''; localStorage.removeItem(LS.note); }
  });
}

/* ===== utils ===== */
function statusClass(s){
  switch((s||'').toUpperCase()){
    case 'LEAD': return 'lead';
    case 'ZAPYTANIE': return 'q';
    case 'W TOKU': return 'w';
    case 'KLIENT': return 'c';
    case 'UTRACONY': return 'l';
    default: return '';
  }
}

/* ===== keyboard shortcuts ===== */
window.addEventListener('keydown', (e)=>{
  // / -> przej≈õcie do Klienci
  if(e.key === '/'){
    e.preventDefault();
    location.href = 'klienci.html';
  }
  // Alt+N -> Nowy klient
  if(e.altKey && (e.key==='n' || e.key==='N')){
    e.preventDefault();
    location.href = 'klienci.html#new';
  }
});

/* ===== boot ===== */
refreshKPI();
renderRecentClients();
renderRecentLeads();
initNote();

/* dostƒôpno≈õƒá: focus, Enter w loginie */
$('#loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#loginPass').focus(); }});
</script>
</body>
</html>
