<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Pulpit / Kalendarz / Monta≈ºe / Notatki</title>
<meta name="description" content="ARKON CRM: pulpit, klienci, leady, kalendarz monta≈ºy (drag&drop), kalendarz og√≥lny, uwagi i notatki. Wszystko lokalnie (LocalStorage).">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230b8d3b'/%3E%3Ctext x='50' y='62' font-size='60' text-anchor='middle' fill='white' font-family='Arial,Helvetica,sans-serif'%3EA%3C/text%3E%3C/svg%3E">
<style>
  :root{ --bg:#0b1020; --grad1:#0a1028; --grad2:#0d1536; --ink:#e8edff; --muted:#aeb8da; --line:#22306a; --card:#0f1636; --accent:#4cc9f0; --ok:#2fbf71; --warn:#ffb84d; --bad:#ff6b6b; --focus:#82c4ff; --chip:#16245a; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.55 system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--grad1),var(--grad2));color:var(--ink)}
  a{color:#cfe0ff;text-decoration:none}
  header{padding:16px;border-bottom:1px solid var(--line);background:#0e1534;position:sticky;top:0;z-index:8}
  header h1{margin:0;font-size:22px}
  header .muted{color:var(--muted);font-size:13px}
  nav{display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line);background:#121a44;position:sticky;top:58px;z-index:7}
  nav a{padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#1a2758}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:14px}
  @media(min-width:1100px){ .cols-3{grid-template-columns:repeat(3,1fr)} .cols-2{grid-template-columns:2fr 1fr} .cols-main{grid-template-columns:1.6fr 1.4fr} }
  .card{background:linear-gradient(180deg,#0f1636,#0f1a42);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px;color:var(--muted)}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .status.ok{background:#153523;color:#9cf3c2}
  .status.warn{background:#3e2b12;color:#ffd699}
  .status.bad{background:#431a1a;color:#ffb1b1}
  .kpi{display:flex;align-items:center;gap:12px}
  .kpi .n{font-weight:700;font-size:26px}
  .min-w-320{min-width:320px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;border-bottom:1px solid #1a244d;text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted);cursor:pointer;-webkit-user-select:none;user-select:none}
  th.sort-asc::after{content:" ‚Üë"}
  th.sort-desc::after{content:" ‚Üì"}
  .field{width:100%;background:#0d1530;border:1px solid #28356c;color:#e8edff;border-radius:10px;padding:10px 12px;outline:0}
  .field:focus{border-color:#3e61cc;box-shadow:0 0 0 3px #3e61cc33}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .pager{display:flex;gap:6px;align-items:center}

  /* utility */
  .mt-10{margin-top:10px}
  .mt-8{margin-top:8px}
  .justify-between{justify-content:space-between}
  .align-center{align-items:center}
  .daylist{margin:6px 0 0 0;padding:0;list-style:none}
  .list-reset{list-style:none;margin:8px 0 0 0;padding:0}
  .min-h-110{min-height:110px}
  .form-sm{gap:8px;min-width:280px}
  .form-md{gap:8px;min-width:340px}
  .tag.montaz{border-color:#2b7}
  .tag.deadline{border-color:#b55}

  /* mini calendar */
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal .d,.cal .h{padding:8px;border:1px solid #22306a;border-radius:10px;background:#10173a;min-height:60px}
  .cal .h{background:transparent;border-color:transparent;color:#aeb8da;text-align:center;font-size:12px}
  .cal .d{position:relative}
  .cal .d .n{font-size:12px;color:#aeb8da}
  .cal .d .b{position:absolute;bottom:6px;left:6px;right:6px;display:flex;gap:4px;flex-wrap:wrap}
  .dot{width:12px;height:12px;border-radius:50%;border:1px solid #2a3a75}
  .dot[draggable="true"]{cursor:grab}
  .dot.inst{background:#7ee2ab}
  .dot.event{background:#82c4ff}
  .dot.dead{background:#ffb1b1}
  .cal .d.today{outline:2px solid #4cc9f0}
  .cal .d.muted{opacity:.5}

  /* modal */
  dialog.modal{border:1px solid #2a3a75;background:linear-gradient(180deg,#0f1636,#102048);color:var(--ink);border-radius:12px;padding:12px}
  dialog::backdrop{background:#0008}
</style>
</head>
<body>
<header>
  <h1>ARKON ‚Ä¢ Pulpit + Kalendarz</h1>
  <nav>
    <a href="#inst">üõ† Kalendarz monta≈ºy</a>
    <a href="#notes">üóí Uwagi i notatki</a>
    <a href="kalkulator.html" target="_blank" rel="noopener">üßÆ Kalkulator ‚Üó</a>
  </nav>
</header>

<main class="wrap grid cols-main">
  <!-- LEWA KOLUMNA -->
  <section>
    <!-- Klienci -->
    <div class="row form-sm">
      <input id="filterClients" class="field" placeholder="Szukaj klienta (Ctrl/‚åò+K)">
      <div class="pager">
        <button type="button" class="btn ghost" id="cPrev">‚óÄ</button>
        <span class="small" id="cPageLbl">1/1</span>
        <button type="button" class="btn ghost" id="cNext">‚ñ∂</button>
      </div>
      <button type="button" id="exportClients" class="btn ghost">Eksport</button>
      <label class="btn ghost" for="importClients">Import</label>
      <input id="importClients" type="file" accept="application/json" hidden>
      <button type="button" id="addClientBtn" class="btn">+ Klient</button>
    </div>

    <div class="card mt-10">
      <h3>Klienci</h3>
      <table id="tblClients">
        <thead><tr>
          <th data-k="name">Nazwa</th>
          <th data-k="status">Status</th>
          <th data-k="contact">Kontakt</th>
          <th data-k="tags">Tagi</th>
          <th data-k="created">Dodano</th>
          <th>Akcje</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Leady -->
    <div class="card mt-10">
      <div class="row justify-between align-center">
        <div class="row align-center">
          <input id="filterLeads" class="field" placeholder="Szukaj leadu">
          <button type="button" class="btn ghost" id="lPrev">‚óÄ</button>
          <span class="small" id="lPageLbl">1/1</span>
          <button type="button" class="btn ghost" id="lNext">‚ñ∂</button>
        </div>
        <div class="row">
          <button type="button" id="exportLeads" class="btn ghost">Eksport</button>
          <label class="btn ghost" for="importLeads">Import</label>
          <input id="importLeads" type="file" accept="application/json" hidden>
          <button type="button" id="addLeadBtn" class="btn">+ Lead</button>
        </div>
      </div>

      <table id="tblLeads">
        <thead><tr>
          <th data-k="title">Tytu≈Ç</th>
          <th data-k="source">≈πr√≥d≈Ço</th>
          <th data-k="status">Status</th>
          <th data-k="created">Dodano</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Kalendarz -->
    <div class="card mt-10">
      <div class="row align-center">
        <button type="button" class="btn ghost" id="prevMonth">‚óÄ</button>
        <div id="monthLabel" class="small">‚Äî</div>
        <button type="button" class="btn ghost" id="nextMonth">‚ñ∂</button>
        <button type="button" class="btn" id="addEvent">+ Wydarzenie</button>
      </div>

      <div id="calGrid" class="cal mt-8"></div>

      <div class="small mt-8">
        <span class="tag">‚óè wydarzenie</span>
        <span class="tag montaz">‚óè monta≈º</span>
        <span class="tag deadline">‚óè deadline</span>
      </div>

      <div class="mt-10">
        <h4>Wydarzenia w wybranym dniu</h4>
        <ul id="dayList" class="small daylist"></ul>
      </div>
    </div>
  </section>

  <!-- PRAWA KOLUMNA -->
  <aside class="min-w-320">
    <!-- Monta≈ºe -->
    <div class="card mt-10" id="inst">
      <div class="row justify-between align-center">
        <h3>üõ† Monta≈ºe</h3>
        <div class="row">
          <button type="button" class="btn" id="newInstall">+ Monta≈º</button>
          <button type="button" class="btn ghost" id="exportInst">Eksport</button>
          <label class="btn ghost" for="importInst">Import</label>
          <input id="importInst" type="file" accept="application/json" hidden>
        </div>
      </div>
      <div class="small mt-8">
        <span class="tag">‚óè wydarzenie</span>
        <span class="tag montaz">‚óè monta≈º</span>
        <span class="tag deadline">‚óè deadline</span>
      </div>

      <table id="tblInst" class="mt-8"><thead><tr>
        <th data-k="date">Data</th>
        <th data-k="client">Klient</th>
        <th data-k="addr">Adres</th>
        <th data-k="crew">Ekipa</th>
        <th data-k="status">Status</th>
        <th>Akcje</th>
      </tr></thead><tbody></tbody></table>
    </div>

    <!-- Notatki -->
    <div class="card mt-10" id="notes">
      <h3>üóí Uwagi i notatki</h3>
      <textarea id="note" class="field min-h-110" placeholder="Twoje notatki‚Ä¶"></textarea>
      <div class="right mt-8">
        <button type="button" id="clearNote" class="btn ghost">Wyczy≈õƒá</button>
        <button type="button" id="exportNote" class="btn ghost">Eksport</button>
      </div>
      <div class="row mt-8">
        <input id="todoText" class="field" placeholder="Dodaj uwagƒô / zadanie (Enter)">
        <button type="button" id="addTodo" class="btn">Dodaj</button>
      </div>
      <ul id="todoList" class="list-reset"></ul>
    </div>
  </aside>
</main>

<!-- DIALOGI -->
<dialog id="dlgEvent" class="modal">
  <form method="dialog" id="formEvent" class="grid form-sm">
    <h3>Nowe/Edytuj wydarzenie</h3>
    <input type="hidden" id="evId">
    <label>Tytu≈Ç<input id="evTitle" class="field" required></label>
    <label>Data<input id="evDate" type="date" class="field" required></label>
    <label>Godzina<input id="evTime" type="time" class="field"></label>
    <label>Typ
      <select id="evType" class="field">
        <option value="event">wydarzenie</option>
        <option value="dead">deadline</option>
      </select>
    </label>
    <div class="right">
      <button type="button" class="btn ghost" value="cancel" onclick="document.getElementById('dlgEvent').close()">Anuluj</button>
      <button type="button" class="btn ok" value="ok" id="evSave">Zapisz</button>
    </div>
  </form>
</dialog>

<dialog id="dlgInstall" class="modal">
  <form method="dialog" id="formInstall" class="grid form-sm">
    <h3>Nowy/Edytuj monta≈º</h3>
    <input type="hidden" id="inId">
    <label>Data<input id="inDate" type="date" class="field" required></label>
    <label>Godzina<input id="inTime" type="time" class="field"></label>
    <label>Klient<select id="inClient" class="field" required></select></label>
    <label>Adres<input id="inAddr" class="field" placeholder="miejscowo≈õƒá, ulica‚Ä¶"></label>
    <label>Ekipa<input id="inCrew" class="field" placeholder="np. Ekipa A"></label>
    <label>Status<select id="inStatus" class="field"><option>PLAN</option><option>ZATWIERDZONY</option><option>W TRAKCIE</option><option>ZAKO≈ÉCZONY</option><option>PRZE≈ÅO≈ªONY</option></select></label>
    <div class="right">
      <button type="button" class="btn ghost" value="cancel" onclick="document.getElementById('dlgInstall').close()">Anuluj</button>
      <button type="button" class="btn ok" value="ok" id="inSave">Zapisz</button>
    </div>
  </form>
</dialog>

<dialog id="dlgClient" class="modal">
  <form method="dialog" class="grid form-sm" id="formClient">
    <h3>Dodaj/Edytuj klienta</h3>
    <input type="hidden" id="clId">
    <label>Nazwa/Imiƒô i nazwisko<input id="clName" class="field" required></label>
    <label>E-mail<input id="clEmail" class="field" type="email"></label>
    <label>Telefon<input id="clPhone" class="field"></label>
    <label>Status<input id="clStatus" class="field" placeholder="LEAD / W TOKU / ZAKO≈ÉCZONY"></label>
    <label>Tagi (po przecinku)<input id="clTags" class="field" placeholder="PV, PC, Ocieplenie"></label>
    <div class="right">
      <button type="button" class="btn ghost" onclick="document.getElementById('dlgClient').close()">Anuluj</button>
      <button type="button" class="btn ok" id="clSave">Zapisz</button>
    </div>
  </form>
</dialog>

<dialog id="dlgLead" class="modal">
  <form method="dialog" class="grid form-sm" id="formLead">
    <h3>Dodaj/Edytuj lead</h3>
    <input type="hidden" id="ldId">
    <label>Tytu≈Ç<input id="ldTitle" class="field" required></label>
    <label>≈πr√≥d≈Ço<input id="ldSource" class="field" placeholder="www / telefon / polecenie"></label>
    <label>Status<input id="ldStatus" class="field" placeholder="NOWY / KONTAKT / W TOKU"></label>
    <div class="right">
      <button type="button" class="btn ghost" onclick="document.getElementById('dlgLead').close()">Anuluj</button>
      <button type="button" class="btn ok" id="ldSave">Zapisz</button>
    </div>
  </form>
</dialog>

<script>
'use strict';

/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL', { maximumFractionDigits: 0 });
const fmt = n => INT.format(Math.round(Number(n) || 0));
const LS = {
  clients: 'arkon_clients_v1',
  leads:   'arkon_leads_v1',
  ev:      'arkon_events_v2',
  inst:    'arkon_installs_v2',
  note:    'arkon_note_v2',
  todos:   'arkon_todos_v1'
};

function load(k, f) { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(f)) } catch { return f } }
function save(k, v) { localStorage.setItem(k, JSON.stringify(v)) }
function download(name, data) {
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), { href: url, download: name });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
}
function escapeHtml(s) { return (s == null ? '' : String(s)).replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])) }
function cmp(a, b) { return a < b ? -1 : a > b ? 1 : 0 }
function pageSlice(arr, state) { const s = (state.page - 1) * state.per; return arr.slice(s, s + state.per) }
function ymd(d) { const z = n => String(n).padStart(2, '0'); return d.getFullYear() + "-" + z(d.getMonth() + 1) + "-" + z(d.getDate()) }

/* ===== state ===== */
const clientsState = { sort: { key: 'created', dir: 'desc' }, page: 1, per: 8, filter: '' };
const leadsState   = { sort: { key: 'created', dir: 'desc' }, page: 1, per: 8, filter: '' };
const instState    = { sort: { key: 'date', dir: 'asc' } };

/* ===== utils ===== */
function statusClass(s) {
  s = (s || '').toUpperCase();
  if (s === 'W TOKU' || s === 'KONTAKT' || s === 'LEAD') return 'status warn';
  if (s === 'UTRACONY' || s === 'ANULOWANY') return 'status bad';
  if (s === 'WYGRA≈Å' || s === 'WYGRANY' || s === 'ZAKO≈ÉCZONY') return 'status ok';
  return 'status';
}
function openContractFor(clientName){
  localStorage.setItem('arkon_selected_client', clientName || '');
  location.href = 'komponenty-wybor.html';
}

/* ===== Clients ===== */
function renderClients() {
  const tb = $('#tblClients tbody'); tb.innerHTML = '';
  let arr = load(LS.clients, []).slice();

  if (clientsState.filter) {
    const q = clientsState.filter.toLowerCase();
    arr = arr.filter(c =>
      (c.name || '').toLowerCase().includes(q) ||
      (c.email || '').toLowerCase().includes(q) ||
      (c.phone || '').toLowerCase().includes(q)
    );
  }

  // sort
  arr.sort((a, b) => {
    const k = clientsState.sort.key;
    let av, bv;
    if (k === 'name')      { av = (a.name || '').toLowerCase();     bv = (b.name || '').toLowerCase() }
    else if (k === 'status'){ av = (a.status || '');                 bv = (b.status || '') }
    else if (k === 'contact'){ av = (a.email || '') + (a.phone || ''); bv = (b.email || '') + (b.phone || '') }
    else                   { av = a.created || 0;                    bv = b.created || 0 }
    const r = cmp(av, bv); return clientsState.sort.dir === 'asc' ? r : -r;
  });

  // paging
  const total = Math.max(1, Math.ceil(arr.length / clientsState.per));
  clientsState.page = Math.min(clientsState.page, total);
  $('#cPageLbl').textContent = clientsState.page + '/' + total;
  arr = pageSlice(arr, clientsState);

  if (!arr.length) { tb.innerHTML = '<tr><td colspan="6" class="small">Brak danych</td></tr>'; return }

  arr.forEach(c => {
    const tr = document.createElement('tr');
    const tags = (c.tags || []).slice(0, 3).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
    const calcUrl = 'kalkulator.html?client=' + encodeURIComponent(c.name || '');
    tr.innerHTML = `
      <td><b>${escapeHtml(c.name || '‚Äî')}</b></td>
      <td><span class="${statusClass(c.status)}">${escapeHtml(c.status || '‚Äî')}</span></td>
      <td>${escapeHtml(c.email || '')}<div class="small">${escapeHtml(c.phone || '')}</div></td>
      <td>${tags}</td>
      <td>${c.created ? new Date(c.created).toLocaleString('pl-PL') : '‚Äî'}</td>
      <td>
        <button type="button" class="btn ghost" data-contract="${escapeHtml(c.name || '')}">Umowa/Zestaw</button>
        <a class="btn ghost" href="${calcUrl}" target="_blank" rel="noopener">Kalkulator</a>
        <button type="button" class="btn ghost" data-edit="${escapeHtml(c.name || '')}">Edytuj</button>
        <button type="button" class="btn ghost" data-del="${escapeHtml(c.name || '')}">Usu≈Ñ</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // actions
  tb.querySelectorAll('[data-contract]').forEach(b => b.addEventListener('click', () => openContractFor(b.getAttribute('data-contract'))));
  tb.querySelectorAll('[data-edit]').forEach(b => b.addEventListener('click', () => openClientEditor(b.getAttribute('data-edit'))));
  tb.querySelectorAll('[data-del]').forEach(b => b.addEventListener('click', () => deleteClient(b.getAttribute('data-del'))));
}

function openClientEditor(name){
  const arr = load(LS.clients, []);
  const it = arr.find(c => (c.name || '') === name);
  $('#clId').value = it ? (it.name || '') : '';
  $('#clName').value = it ? (it.name || '') : '';
  $('#clEmail').value = it ? (it.email || '') : '';
  $('#clPhone').value = it ? (it.phone || '') : '';
  $('#clStatus').value = it ? (it.status || '') : '';
  $('#clTags').value = it ? (it.tags || []).join(', ') : '';
  $('#dlgClient').showModal();
}
function deleteClient(name){
  if (!confirm('UsunƒÖƒá klienta: ' + name + ' ?')) return;
  const arr = load(LS.clients, []).filter(c => (c.name || '') !== name);
  save(LS.clients, arr);
  renderClients(); fillClientSelect();
}

/* ===== Leads ===== */
function renderLeads() {
  const tb = $('#tblLeads tbody'); tb.innerHTML = '';
  let arr = load(LS.leads, []).slice();

  if (leadsState.filter) {
    const q = leadsState.filter.toLowerCase();
    arr = arr.filter(l => (l.title || '').toLowerCase().includes(q) || (l.source || '').toLowerCase().includes(q));
  }

  arr.sort((a, b) => {
    const k = leadsState.sort.key;
    let av, bv;
    if (k === 'title')  { av = (a.title || '').toLowerCase();  bv = (b.title || '').toLowerCase() }
    else if (k === 'source'){ av = (a.source || '').toLowerCase(); bv = (b.source || '').toLowerCase() }
    else if (k === 'status'){ av = (a.status || '');            bv = (b.status || '') }
    else { av = a.created || 0; bv = b.created || 0 }
    const r = cmp(av, bv); return leadsState.sort.dir === 'asc' ? r : -r;
  });

  const total = Math.max(1, Math.ceil(arr.length / leadsState.per));
  leadsState.page = Math.min(leadsState.page, total);
  $('#lPageLbl').textContent = leadsState.page + '/' + total;
  arr = pageSlice(arr, leadsState);

  if (!arr.length) { tb.innerHTML = '<tr><td colspan="4" class="small">Brak danych</td></tr>'; return }

  arr.forEach(l => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${escapeHtml(l.title || '‚Äî')}</b></td>
      <td>${escapeHtml(l.source || '')}</td>
      <td>${escapeHtml(l.status || 'NOWY')}</td>
      <td>${l.created ? new Date(l.created).toLocaleString('pl-PL') : '‚Äî'}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== Calendar ===== */
let calDate = new Date(); calDate.setDate(1);

function renderMonth() {
  const year = calDate.getFullYear(), month = calDate.getMonth();
  $('#monthLabel').textContent = calDate.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
  const grid = $('#calGrid'); grid.innerHTML = '';
  const heads = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];
  heads.forEach(h => { const div = document.createElement('div'); div.className = 'h'; div.textContent = h; grid.appendChild(div) });

  const firstDay = new Date(year, month, 1);
  const startIdx = (firstDay.getDay() + 6) % 7; // pon=0
  const daysIn = new Date(year, month + 1, 0).getDate();
  const events = load(LS.ev, []);
  const today = new Date();

  for (let i = 0; i < startIdx; i++) { const d = document.createElement('div'); d.className = 'd muted'; grid.appendChild(d) }

  for (let day = 1; day <= daysIn; day++) {
    const d = document.createElement('div'); d.className = 'd';
    const date = new Date(year, month, day);
    const label = document.createElement('div'); label.className = 'n'; label.textContent = String(day); d.appendChild(label);
    const box = document.createElement('div'); box.className = 'b';
    const ymdStr = ymd(date);
    const evToday = events.filter(e => e.date === ymdStr);
    evToday.forEach(e => {
      const dot = document.createElement('span');
      dot.className = 'dot ' + (e.type === 'inst' ? 'inst' : e.type === 'dead' ? 'dead' : 'event');
      dot.title = e.title; dot.setAttribute('data-id', e.id); dot.setAttribute('draggable', 'true');
      dot.addEventListener('dragstart', onDotDragStart);
      box.appendChild(dot);
    });
    d.appendChild(box);
    if (date.toDateString() === today.toDateString()) d.classList.add('today');
    d.addEventListener('dragover', e => { e.preventDefault(); d.style.outline = '2px dashed var(--focus)' });
    d.addEventListener('dragleave', () => d.style.outline = '');
    d.addEventListener('drop', e => { e.preventDefault(); d.style.outline = ''; const id = e.dataTransfer.getData('text/plain'); moveEventToDate(id, ymdStr) });
    d.addEventListener('click', () => selectDay(ymdStr));
    grid.appendChild(d);
  }
}
function onDotDragStart(ev) { ev.dataTransfer.setData('text/plain', ev.target.getAttribute('data-id')); }
function moveEventToDate(id, newDate) {
  const evs = load(LS.ev, []); const idx = evs.findIndex(e => String(e.id) === String(id));
  if (idx > -1) {
    evs[idx].date = newDate; save(LS.ev, evs);
    // je≈õli to monta≈º ‚Äì zaktualizuj te≈º tabelƒô monta≈ºy
    if (String(id).startsWith('i')) {
      const iid = Number(String(id).slice(1));
      const inst = load(LS.inst, []); const j = inst.findIndex(x => x.id === iid);
      if (j > -1) { inst[j].date = newDate; save(LS.inst, inst); renderInst() }
    }
    renderMonth(); selectDay(newDate);
  }
}
function selectDay(ymdStr) {
  const list = $('#dayList');
  const arr = load(LS.ev, []).filter(e => e.date === ymdStr).sort((a, b) => (a.time || '').localeCompare(b.time || ''));
  list.innerHTML = '';
  const head = document.createElement('div');
  head.textContent = new Date(ymdStr).toLocaleDateString('pl-PL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  head.className = 'small';
  list.appendChild(head);
  if (!arr.length) { const li = document.createElement('li'); li.textContent = 'Brak wydarze≈Ñ'; li.className = 'small'; list.appendChild(li); return }
  arr.forEach(e => {
    const li = document.createElement('li');
    const clientFromTitle = String(e.title || '').replace(/^Monta≈º:\s*/i, '');
    const calcUrl = 'kalkulator.html?client=' + encodeURIComponent(clientFromTitle);
    li.innerHTML = `
      <b>${escapeHtml(e.title)}</b> ‚Ä¢ ${escapeHtml(e.time || '')}
      <span class="tag">${escapeHtml(e.type)}</span>
      <a class="btn ghost" href="${calcUrl}" target="_blank">Kalkulator</a>
      <button type="button" class="btn ghost" data-edit="${e.id}">Edytuj</button>
      <button type="button" class="btn ghost" data-del="${e.id}">Usu≈Ñ</button>`;
    list.appendChild(li);
  });
  list.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
    const id = btn.getAttribute('data-del'); delEvent(id); renderMonth(); selectDay(ymdStr);
  }));
  list.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => openEventEditor(btn.getAttribute('data-edit'))));
}
function delEvent(id) {
  const evs = load(LS.ev, []).filter(x => String(x.id) !== String(id)); save(LS.ev, evs);
  if (String(id).startsWith('i')) {
    const iid = Number(String(id).slice(1)); const inst = load(LS.inst, []).filter(x => x.id !== iid); save(LS.inst, inst); renderInst();
  }
}
function openEventEditor(id) {
  const evs = load(LS.ev, []); const e = evs.find(x => String(x.id) === String(id));
  if (!e) return;
  $('#evId').value = e.id; $('#evTitle').value = e.title; $('#evDate').value = e.date; $('#evTime').value = e.time || ''; $('#evType').value = e.type || 'event';
  $('#dlgEvent').showModal();
}

/* ===== Installs ===== */
function fillClientSelect() {
  const sel = $('#inClient'); sel.innerHTML = '';
  const clients = load(LS.clients, []).slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  clients.forEach(c => { const o = document.createElement('option'); o.value = c.name; o.textContent = c.name; sel.appendChild(o) });
}
function renderInst() {
  const tb = $('#tblInst tbody'); tb.innerHTML = '';
  let arr = load(LS.inst, []).slice();
  arr.sort((a, b) => {
    const k = instState.sort.key; let av = a[k] || '', bv = b[k] || '';
    const r = cmp(av, bv); return instState.sort.dir === 'asc' ? r : -r;
  });
  if (!arr.length) { tb.innerHTML = '<tr><td colspan="6" class="small">Brak monta≈ºy</td></tr>'; return }
  arr.forEach(x => {
    const tr = document.createElement('tr');
    const st = (x.status || '').toUpperCase();
    const cls = st === 'ZAKO≈ÉCZONY' ? 'ok' : (st === 'PLAN' || st === 'ZATWIERDZONY') ? 'warn' : 'bad';
    const calcUrl = 'kalkulator.html?client=' + encodeURIComponent(x.client || '');
    tr.innerHTML = `
      <td>${escapeHtml(x.date)} ${x.time ? ('<div class="small">' + escapeHtml(x.time) + '</div>') : ''}</td>
      <td>${escapeHtml(x.client || '')}</td>
      <td>${escapeHtml(x.addr || '')}</td>
      <td>${escapeHtml(x.crew || '')}</td>
      <td><span class="status ${cls}">${escapeHtml(x.status || '')}</span></td>
      <td>
        <a class="btn ghost" href="${calcUrl}" target="_blank">Kalkulator</a>
        <button type="button" class="btn ghost" data-edit="${x.id}">Edytuj</button>
        <button type="button" class="btn ghost" data-del="${x.id}">Usu≈Ñ</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
    const id = Number(btn.getAttribute('data-del'));
    const all = load(LS.inst, []).filter(i => i.id !== id); save(LS.inst, all);
    const evs = load(LS.ev, []).filter(e => String(e.id) !== 'i' + id); save(LS.ev, evs);
    renderInst(); renderMonth();
  }));
  tb.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => openInstallEditor(Number(btn.getAttribute('data-edit')))));
}
function openInstallEditor(id) {
  fillClientSelect();
  const all = load(LS.inst, []); const it = all.find(x => x.id === id); if (!it) return;
  $('#inId').value = it.id; $('#inDate').value = it.date; $('#inTime').value = it.time || ''; $('#inClient').value = it.client || ''; $('#inAddr').value = it.addr || ''; $('#inCrew').value = it.crew || ''; $('#inStatus').value = it.status || 'PLAN';
  $('#dlgInstall').showModal();
}

/* ===== Notes & Todos ===== */
function initNotes() {
  $('#note').value = localStorage.getItem(LS.note) || '';
  $('#note').addEventListener('input', () => localStorage.setItem(LS.note, $('#note').value));
  $('#clearNote').addEventListener('click', () => { if (confirm('Wyczy≈õciƒá notatkƒô?')) { $('#note').value = ''; localStorage.removeItem(LS.note) } });
  $('#exportNote').addEventListener('click', () => download('arkon-notatka.txt', $('#note').value || ''));
}
function renderTodos() {
  const ul = $('#todoList'); ul.innerHTML = '';
  const arr = load(LS.todos, []);
  if (!arr.length) { const li = document.createElement('li'); li.className = 'small'; li.textContent = 'Brak zada≈Ñ.'; ul.appendChild(li); return }
  arr.forEach((t, i) => {
    const li = document.createElement('li'); li.className = 'row'; li.style.alignItems = 'center'; li.style.justifyContent = 'space-between';
    li.innerHTML = `<div><input type="checkbox" ${t.done ? 'checked' : ''} data-idx="${i}"> <span ${t.done ? 'style="text-decoration:line-through;opacity:.7"' : ''}>${escapeHtml(t.text)}</span></div><div class="row"><span class="small">${new Date(t.created).toLocaleString('pl-PL')}</span> <button type="button" class="btn ghost" data-del="${i}">Usu≈Ñ</button></div>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll('input[type=checkbox]').forEach(ch => ch.addEventListener('change', () => {
    const i = +ch.getAttribute('data-idx'); const arr = load(LS.todos, []); arr[i].done = ch.checked; save(LS.todos, arr); renderTodos();
  }));
  ul.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
    const i = +btn.getAttribute('data-del'); const arr = load(LS.todos, []); arr.splice(i, 1); save(LS.todos, arr); renderTodos();
  }));
}
function addTodo() {
  const txt = $('#todoText').value.trim(); if (!txt) return;
  const arr = load(LS.todos, []); arr.unshift({ text: txt, done: false, created: Date.now() }); save(LS.todos, arr); $('#todoText').value = ''; renderTodos();
}

/* ===== Export / Import ===== */
$('#exportClients').addEventListener('click', () => download('arkon-klienci.json', JSON.stringify(load(LS.clients, []), null, 2)));
$('#importClients').addEventListener('change', async e => {
  const f = e.target.files?.[0]; if (!f) return;
  try { const txt = await f.text(); const data = JSON.parse(txt); if (Array.isArray(data)) { save(LS.clients, data); renderClients(); fillClientSelect(); } } catch {}
  e.target.value = '';
});

$('#exportLeads').addEventListener('click', () => download('arkon-leady.json', JSON.stringify(load(LS.leads, []), null, 2)));
$('#importLeads').addEventListener('change', async e => {
  const f = e.target.files?.[0]; if (!f) return;
  try { const txt = await f.text(); const data = JSON.parse(txt); if (Array.isArray(data)) { save(LS.leads, data); renderLeads(); } } catch {}
  e.target.value = '';
});

$('#exportInst').addEventListener('click', () => download('arkon-montaze.json', JSON.stringify(load(LS.inst, []), null, 2)));
$('#importInst').addEventListener('change', async e => {
  const f = e.target.files?.[0]; if (!f) return;
  try { const text = await f.text(); const data = JSON.parse(text); if (Array.isArray(data)) { save(LS.inst, data); renderInst(); renderMonth() } } catch {}
  e.target.value = '';
});

/* ===== UI wiring ===== */
$('#filterClients').addEventListener('input', e => { clientsState.filter = e.target.value; clientsState.page = 1; renderClients() });
$('#cPrev').addEventListener('click', () => { clientsState.page = Math.max(1, clientsState.page - 1); renderClients() });
$('#cNext').addEventListener('click', () => { clientsState.page = clientsState.page + 1; renderClients() });

$('#filterLeads').addEventListener('input', e => { leadsState.filter = e.target.value; leadsState.page = 1; renderLeads() });
$('#lPrev').addEventListener('click', () => { leadsState.page = Math.max(1, leadsState.page - 1); renderLeads() });
$('#lNext').addEventListener('click', () => { leadsState.page = leadsState.page + 1; renderLeads() });

$('#prevMonth').addEventListener('click', () => { calDate.setMonth(calDate.getMonth() - 1); renderMonth() });
$('#nextMonth').addEventListener('click', () => { calDate.setMonth(calDate.getMonth() + 1); renderMonth() });
$('#addEvent').addEventListener('click', () => {
  const d = $('#dlgEvent'); const t = new Date();
  $('#evId').value = ''; $('#evTitle').value = ''; $('#evDate').value = ymd(t); $('#evTime').value = ''; $('#evType').value = 'event'; d.showModal()
});
$('#evSave').addEventListener('click', () => {
  const id = $('#evId').value || Date.now();
  const obj = { id, title: $('#evTitle').value.trim(), date: $('#evDate').value, time: $('#evTime').value, type: $('#evType').value || 'event' };
  if (!obj.title || !obj.date) return;
  const all = load(LS.ev, []); const i = all.findIndex(x => String(x.id) === String(id)); if (i > -1) all[i] = obj; else all.push(obj);
  save(LS.ev, all); $('#dlgEvent').close(); renderMonth(); selectDay(obj.date);
});

$('#newInstall').addEventListener('click', () => {
  fillClientSelect();
  $('#inId').value=''; $('#inDate').value = new Date().toISOString().slice(0,10); $('#inTime').value=''; $('#inClient').value=$('#inClient').options[0]?.value||''; $('#inAddr').value=''; $('#inCrew').value=''; $('#inStatus').value='PLAN';
  $('#dlgInstall').showModal();
});
$('#inSave').addEventListener('click', () => {
  const id = $('#inId').value ? Number($('#inId').value) : Date.now();
  const item = { id, date: $('#inDate').value, time: $('#inTime').value, client: $('#inClient').value, addr: $('#inAddr').value.trim(), crew: $('#inCrew').value.trim(), status: $('#inStatus').value };
  if (!item.client || !item.date) return;
  const all = load(LS.inst, []); const i = all.findIndex(x => x.id === id); if (i > -1) all[i] = item; else all.push(item); save(LS.inst, all);
  const evs = load(LS.ev, []); const eid = 'i' + id; const j = evs.findIndex(e => String(e.id) === eid);
  const title = 'Monta≈º: ' + item.client; const evObj = { id: eid, title, date: item.date, time: item.time, type: 'inst' };
  if (j > -1) evs[j] = evObj; else evs.push(evObj); save(LS.ev, evs); $('#dlgInstall').close(); renderInst(); renderMonth();
});

window.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) { e.preventDefault(); $('#filterClients').focus() } });

/* Add/Edit Client modal */
$('#addClientBtn').addEventListener('click', () => {
  $('#clId').value=''; $('#clName').value=''; $('#clEmail').value=''; $('#clPhone').value=''; $('#clStatus').value='LEAD'; $('#clTags').value='';
  $('#dlgClient').showModal();
});
$('#clSave').addEventListener('click', () => {
  const name = $('#clName').value.trim(); if (!name) return;
  const obj = {
    name,
    email: $('#clEmail').value.trim(),
    phone: $('#clPhone').value.trim(),
    status: $('#clStatus').value.trim(),
    tags: ($('#clTags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    created: Date.now()
  };
  let arr = load(LS.clients, []);
  const i = arr.findIndex(c => (c.name||'') === $('#clId').value);
  if (i > -1) arr[i] = { ...arr[i], ...obj };
  else arr.push(obj);
  save(LS.clients, arr);
  $('#dlgClient').close(); renderClients(); fillClientSelect();
});

/* Add/Edit Lead modal */
$('#addLeadBtn').addEventListener('click', () => {
  $('#ldId').value=''; $('#ldTitle').value=''; $('#ldSource').value=''; $('#ldStatus').value='NOWY';
  $('#dlgLead').showModal();
});
$('#ldSave').addEventListener('click', () => {
  const title = $('#ldTitle').value.trim(); if (!title) return;
  const obj = { title, source: $('#ldSource').value.trim(), status: $('#ldStatus').value.trim(), created: Date.now() };
  let arr = load(LS.leads, []);
  const i = $('#ldId').value ? arr.findIndex(l => l.id === $('#ldId').value) : -1;
  if (i > -1) arr[i] = { ...arr[i], ...obj }; else arr.push(obj);
  save(LS.leads, arr);
  $('#dlgLead').close(); renderLeads();
});

/* Notes & Todos */
$('#addTodo').addEventListener('click', addTodo);
$('#todoText').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addTodo(); } });

/* ===== boot ===== */
function boot() {
  renderClients(); renderLeads(); renderMonth();
  selectDay(new Date().toISOString().slice(0, 10));
  renderInst(); initNotes(); renderTodos(); fillClientSelect();
}
boot();
</script>
</body>
</html>
