
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komponenty: Fotowoltaika</title>
<meta name="description" content="ARKON CRM ‚Äî Fotowoltaika: modu≈Çy, falowniki, mikroinwertery, magazyny energii, monta≈º, akcesoria, zestawy. Edycja, filtry, eksport/import, PDF import do kalkulatora, prefill zestawu.">
<style>
  :root{
    --bg:#0a0f1e; --ink:#e8edff; --muted:#aeb8da; --line:#243059; --card:#0f1533; --card2:#121a34;
    --accent:#4cc9f0; --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .muted{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.warn{background:#5a3c12;border-color:#c48a26}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:13px;color:var(--muted);white-space:nowrap}
  .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .subtabs{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .subtabs button{padding:8px 12px;border-radius:999px;border:1px solid #2a3a75;background:#0d1530;color:#cfe1ff;cursor:pointer}
  .subtabs button[aria-selected="true"]{background:#1b2550;border-color:#67a1ff}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:13px}
  .right{display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .small{font-size:12px;color:#aeb8da}
  .scroll{overflow:auto}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:2fr 1fr} }
  .danger{color:#ffb4b4}
  .tag{display:inline-block;border:1px solid #7b3341;color:#ffb4b4;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
  .info{font-size:12px;color:#cfe1ff}
  @media print{ nav,.toolbar,.subtabs,.right,.filters{display:none!important} }
</style>

<!-- PDF.js do importu cennika -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<header>
  <h1>Komponenty ‚Ä¢ Fotowoltaika ‚Äî ARKON</h1>
  <div class="muted">Modu≈Çy, falowniki, mikroinwertery, magazyny energii, monta≈º, akcesoria i gotowe zestawy. Edycja w tabeli, filtry, eksport do wbudowanego Kalkulatora (ukryty narzut firmy 8000 z≈Ç / instalacja).</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="klienci.html">Klienci</a>
  <a href="komponenty-pompy.html">Pompy</a>
  <a href="komponenty-piece.html">Piece</a>
  <a href="komponenty-fotowoltaika.html" aria-current="page">Fotowoltaika</a>
  <a href="komponenty-ocieplenie.html">Ocieplenie</a>
  <a href="komponenty-stolarka.html">Stolarka</a>
  <a href="#" id="openCalc">Kalkulator ‚Üó</a>
</nav>

<div class="wrap">
  <div class="card">
    <div class="subtabs" role="tablist" aria-label="Kategorie PV">
      <button class="sb" data-k="sets" aria-selected="true">Zestawy</button>
      <button class="sb" data-k="modules">Modu≈Çy</button>
      <button class="sb" data-k="inverters">Falowniki</button>
      <button class="sb" data-k="micro">Mikroinwertery</button>
      <button class="sb" data-k="batt">Magazyny energii</button>
      <button class="sb" data-k="mount">System monta≈ºu</button>
      <button class="sb" data-k="acc">Akcesoria</button>
    </div>

    <div class="toolbar">
      <input id="q" placeholder="üîé Szukaj w aktywnej kategorii‚Ä¶ (marka, model, opis, cechy)" style="min-width:340px">
      <span id="dynFilters" class="row filters"></span>

      <button id="btnAdd" class="btn ok">+ Dodaj pozycjƒô</button>
      <button id="btnCSV" class="btn ghost">CSV eksport</button>
      <button id="btnJSON" class="btn ghost">JSON eksport</button>
      <label class="btn ghost">JSON import <input id="inJSON" type="file" accept="application/json" hidden></label>
      <label class="btn ghost">PDF cennika import <input id="inPDF" type="file" accept="application/pdf" hidden></label>

      <button id="btnExportCalc" class="btn warn">Eksport do Kalkulatora</button>

      <span class="pill">Widocznych: <b id="countVis">0</b></span>
      <span class="pill">≈ÅƒÖcznie: <b id="countAll">0</b></span>
      <span class="pill">Sort: <b id="sortLabel">marka‚Üímodel</b></span>
    </div>

    <div class="small info" style="margin:4px 0 10px">
      Dozwolone marki ‚Äî <b>Panele:</b> Q-CELLS, HYUNDAI, JA SOLAR, JOLYWOOD, LONGi, TRINA, JINKO, AIKO ‚Ä¢
      <b>Inwertery:</b> DEYE, HUAWEI, SOLAREDGE, SOFAR, FOXESS, GOODWE, GROWATT, SOLAX, FELICITY ‚Ä¢
      <b>Akcesoria (przyk≈Ç.):</b> SOLAREDGE, HUAWEI, SOFAR, FOXESS, GROWATT, TIGO, DEYE, CHINT, FRONIUS, EASTRON
    </div>

    <div class="card" style="padding:0">
      <div class="scroll">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="small muted" style="padding:10px 12px">
        Edytuj w kom√≥rkach. Usu≈Ñ/duplikuj z kolumny ‚ÄûAkcje‚Äù. Zmiany zapisujƒÖ siƒô automatycznie.
        Skr√≥ty: <span class="kbd">/</span> fokus na wyszukiwaniu ‚Ä¢ <span class="kbd">Alt+N</span> nowa pozycja ‚Ä¢ klik nag≈Ç√≥wka = sortowanie.
      </div>
    </div>
  </div>
</div>

<!-- === WBUdowany SZABLON KALKULATORA (otwierany do nowej karty jako Blob URL) === -->
<template id="calc-template">
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Kalkulator instalacji PV</title>
<meta name="description" content="Kalkulator ARKON: dob√≥r paneli, inwertera i osprzƒôtu. Ukryty narzut firmy 8000 z≈Ç, prowizja handlowca opcjonalna.">
<style>
  :root{--bg:#0a0f1e;--ink:#e8edff;--muted:#aeb8da;--line:#243059;--card:#0f1533;--card2:#121a34;--accent:#4cc9f0;--ok:#2b8a57}
  *{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)} header h1{margin:0;font-size:22px}
  .wrap{max-width:1200px;margin:auto;padding:16px} .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .grid{display:grid;gap:12px} @media(min-width:1100px){ .cols-2{grid-template-columns:1.2fr 1fr} }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
  select,input{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.ok{background:#194d34;border-color:var(--ok)} table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top} th{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px} .big{font-size:28px;font-weight:700} .right{display:flex;justify-content:flex-end}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>Kalkulator instalacji ‚Ä¢ ARKON</h1>
  <div class="muted">Ceny z katalogu (eksport z ‚ÄûKomponenty‚Äù) ‚Ä¢ ukryty narzut firmy: 8000 z≈Ç ‚Ä¢ prowizja handlowca opcjonalna.</div>
</header>

<div class="wrap grid cols-2">
  <section class="card">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><label>Marka paneli</label><select id="brandPanel"></select></div>
      <div><label>Model paneli</label><select id="modelPanel"></select></div>
      <div><label>Marka inwertera</label><select id="brandInv"></select></div>
      <div><label>Model inwertera</label><select id="modelInv"></select></div>
      <div><label>Akcesoria / dodatki</label><select id="acc" multiple size="6"></select></div>
      <div>
        <label>Ilo≈õƒá paneli (szt.)</label><input id="qtyPanels" type="number" min="1" step="1" value="10">
        <label class="muted" style="margin-top:8px">Prowizja handlowca (opcjonalnie)</label>
        <input id="commission" type="number" min="0" step="1" value="0" placeholder="0">
        <div class="muted" style="margin-top:6px">Pole opcjonalne. Firma i tak zarabia sta≈Çe 8000 z≈Ç na instalacji.</div>
      </div>
    </div>
    <div style="margin-top:12px"><button class="btn ok" id="recalc">Przelicz</button> <span class="pill">Ceny: netto</span></div>
  </section>

  <section class="card">
    <table><thead><tr><th>Pozycja</th><th>Warto≈õƒá</th></tr></thead><tbody id="tBody"></tbody></table>
    <div class="right" style="margin-top:10px"><div class="big" id="grand">‚Äî</div></div>
    <div class="muted" style="margin-top:8px">Uwaga: narzut firmy 8000 z≈Ç jest uwzglƒôdniony w wyliczeniu i ukryty dla u≈ºytkownika ko≈Ñcowego.</div>
  </section>
</div>

<script>
'use strict';
const BASE_PROFIT_PLN = 8000;
const ALLOWED = {
  panels:['Q-CELLS','HYUNDAI','JA SOLAR','JOLYWOOD','LONGI','TRINA','JINKO','AIKO'],
  inverters:['DEYE','HUAWEI','SOLAREDGE','SOFAR','FOXESS','GOODWE','GROWATT','SOLAX','FELICITY'],
  accessoriesBrands:['SOLAREDGE','HUAWEI','SOFAR','FOXESS','GROWATT','TIGO','DEYE','CHINT','FRONIUS','EASTRON']
};
const norm = s=>String(s||'').trim().toUpperCase();
const PLN0 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const money = n => PLN0.format(Math.round(+n))+' z≈Ç';

function loadCatalog(){
  try{
    const fromLS = JSON.parse(localStorage.getItem('arkon_calc_catalog')||'null');
    if(fromLS && fromLS.panels && fromLS.inverters){
      const filter = cat=>{
        const p=(cat.panels||[]).filter(x=>ALLOWED.panels.includes(norm(x.brand)));
        const i=(cat.inverters||[]).filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
        const a=(cat.accessories||[]).filter(x=>ALLOWED.accessoriesBrands.includes(norm(x.brand)));
        return {panels:p,inverters:i,accessories:a};
      };
      return filter(fromLS);
    }
  }catch{}
  // fallback minimum
  return {
    panels:[{brand:'TRINA',model:'Vertex S+ 440 FB',price:200},{brand:'JINKO',model:'JKM445N-54HL4R-B',price:240}],
    inverters:[{brand:'HUAWEI',model:'SUN2000-10KTL-M1-HC',price:3953},{brand:'SOFAR',model:'HYD 10KTL 3F',price:6227}],
    accessories:[{brand:'HUAWEI',name:'DTSU666-H 3F 250A',price:497},{brand:'SOLAREDGE',name:'Optymalizator S500',price:176}]
  };
}
const CATALOG = loadCatalog();
const el=id=>document.getElementById(id);

function fillSelects(){
  const bp=[...new Set(CATALOG.panels.map(x=>x.brand))].sort();
  el('brandPanel').innerHTML = bp.map(b=><option>${b}</option>).join('');
  syncModels('panel');
  const bi=[...new Set(CATALOG.inverters.map(x=>x.brand))].sort();
  el('brandInv').innerHTML = bi.map(b=><option>${b}</option>).join('');
  syncModels('inv');
  const acc = CATALOG.accessories.slice().sort((a,b)=>(a.brand+a.name).localeCompare(b.brand+b.name,'pl'));
  el('acc').innerHTML = acc.map(a=><option value="${a.brand}||${a.name}">${a.brand} ‚Äî ${a.name} (${money(a.price)})</option>).join('');
}
function syncModels(kind){
  if(kind==='panel'){
    const b=el('brandPanel').value;
    const models=CATALOG.panels.filter(x=>x.brand===b);
    el('modelPanel').innerHTML = models.map(m=><option value="${m.model}">${m.model} (${money(m.price)})</option>).join('');
  }else{
    const b=el('brandInv').value;
    const models=CATALOG.inverters.filter(x=>x.brand===b);
    el('modelInv').innerHTML = models.map(m=><option value="${m.model}">${m.model} (${money(m.price)})</option>).join('');
  }
}
el('brandPanel').addEventListener('change', ()=>syncModels('panel'));
el('brandInv').addEventListener('change', ()=>syncModels('inv'));
el('recalc').addEventListener('click', recalc);

function prefillFromQuery(){
  const p=new URLSearchParams(location.search);
  const bp=p.get('brandPanel'), mp=p.get('modelPanel');
  const bi=p.get('brandInv'), mi=p.get('modelInv');
  const qty=p.get('qty'), acc=p.get('acc');
  if(bp && CATALOG.panels.some(x=>x.brand===bp)){ el('brandPanel').value=bp; syncModels('panel'); if(mp && CATALOG.panels.some(x=>x.brand===bp && x.model===mp)) el('modelPanel').value=mp; }
  if(bi && CATALOG.inverters.some(x=>x.brand===bi)){ el('brandInv').value=bi; syncModels('inv'); if(mi && CATALOG.inverters.some(x=>x.brand===bi && x.model===mi)) el('modelInv').value=mi; }
  if(qty) el('qtyPanels').value = Math.max(1, parseInt(qty,10)||10);
  if(acc){
    const wanted = acc.split(',').map(s=>s.split('::'));
    Array.from(el('acc').options).forEach(o=>{
      const [b,n]=o.value.split('||');
      if(wanted.find(([wb,wn])=>wb===b && wn===n)) o.selected=true;
    });
  }
}
function findItem(arr,brand,key,val){ return arr.find(x=>x.brand===brand && x[key]===val); }
function recalc(){
  const qty = +el('qtyPanels').value || 0;
  const bP=el('brandPanel').value, mP=el('modelPanel').value;
  const pPanel = findItem(CATALOG.panels,bP,'model',mP)?.price || 0;
  const sumPanels = pPanel*qty;
  const bI=el('brandInv').value, mI=el('modelInv').value;
  const pInv = findItem(CATALOG.inverters,bI,'model',mI)?.price || 0;
  const accSel = Array.from(el('acc').selectedOptions).map(o=>o.value.split('||'));
  const sumAcc = accSel.reduce((a,[brand,name])=>{
    const it = CATALOG.accessories.find(x=>x.brand===brand && x.name===name);
    return a + (it?.price || 0);
  },0);
  const commission = Math.max(0, +el('commission').value || 0);
  const subtotal = sumPanels + pInv + sumAcc;
  const grand = subtotal + BASE_PROFIT_PLN + commission;
  const rows = [
    ['Panele', ${bP} ‚Ä¢ ${mP} √ó ${qty} = ${money(sumPanels)}],
    ['Inwerter', ${bI} ‚Ä¢ ${mI} = ${money(pInv)}],
    ['Akcesoria', accSel.length? accSel.map(([brand,name])=>${brand} ${name}).join(', ')+' = '+money(sumAcc) : '‚Äî'],
    ['Prowizja handlowca (opc.)', money(commission)],
  ];
  document.getElementById('tBody').innerHTML = rows.map(([k,v])=><tr><th>${k}</th><td>${v}</td></tr>).join('');
  document.getElementById('grand').textContent = money(grand);
}
fillSelects(); prefillFromQuery(); recalc();
</script>
</body></html>
</template>

<script>
'use strict';

/* ===== sta≈Çe i helpers (strona komponent√≥w) ===== */
const ALLOWED = {
  panels: ['Q-CELLS','HYUNDAI','JA SOLAR','JOLYWOOD','LONGI','TRINA','JINKO','AIKO'],
  inverters: ['DEYE','HUAWEI','SOLAREDGE','SOFAR','FOXESS','GOODWE','GROWATT','SOLAX','FELICITY'],
  accessories: ['SOLAREDGE','HUAWEI','SOFAR','FOXESS','GROWATT','TIGO','DEYE','CHINT','FRONIUS','EASTRON']
};
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT0 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const INT1 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:1});
const INT2 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:2});
const money = n => isFinite(+n)? INT0.format(Math.round(+n))+' z≈Ç' : '‚Äî';
const uid = ()=> 'PV_'+Math.random().toString(36).slice(2)+'_'+Date.now().toString(36);
const esc = s => (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
const norm = b => String(b||'').trim().toUpperCase();

function toCSV(rows, cols){
  const escCsv = v => { let s=(v==null?'':String(v)); if(/[;\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; };
  const out = [cols.join(';')].concat(rows.map(r=>cols.map(c=>escCsv(r[c])).join(';')));
  const blob = new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_'+state.tab+'.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function saveJSON(data){
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_'+state.tab+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function readJSON(f){ return f.text().then(t=>JSON.parse(t)); }

/* ===== storage ===== */
const KS = {
  sets:'arkon_pv_sets_v2',
  modules:'arkon_pv_modules_v2',
  inverters:'arkon_pv_inverters_v2',
  micro:'arkon_pv_micro_v2',
  batt:'arkon_pv_batt_v2',
  mount:'arkon_pv_mount_v2',
  acc:'arkon_pv_acc_v2'
};

const state = {
  tab:'sets', q:'', sort:{key:'brand_model',dir:1},
  filters:{modules:{tech:'',pMin:'',pMax:'',effMin:'',bif:''}, inverters:{phase:'',hybrid:'',acMin:'',acMax:'',mppt:''}, micro:{brand:'',acMin:'',acMax:''}, batt:{capMin:'',capMax:'',chem:''}, mount:{roof:'',tilt:'',ground:''}, sets:{kwpMin:'',kwpMax:'',phase:'',storage:''}},
  data:{sets:[],modules:[],inverters:[],micro:[],batt:[],mount:[],acc:[]}
};

/* ===== load/save + allowed filters ===== */
function isAllowedModule(x){ return ALLOWED.panels.includes(norm(x.brand)); }
function isAllowedInverter(x){ return ALLOWED.inverters.includes(norm(x.brand)); }
function isAllowedAccessory(x){ return ALLOWED.accessories.includes(norm(x.brand||x.cat||'')); }

function loadAll(){
  Object.keys(state.data).forEach(k=>{
    try{ state.data[k] = JSON.parse(localStorage.getItem(KS[k])||'[]'); }catch{ state.data[k]=[]; }
  });
  state.data.modules = (state.data.modules||[]).filter(isAllowedModule);
  state.data.inverters = (state.data.inverters||[]).filter(isAllowedInverter);
  state.data.acc = (state.data.acc||[]).filter(isAllowedAccessory);
  localStorage.setItem(KS.modules, JSON.stringify(state.data.modules||[]));
  localStorage.setItem(KS.inverters, JSON.stringify(state.data.inverters||[]));
  localStorage.setItem(KS.acc, JSON.stringify(state.data.acc||[]));
}
function saveTab(){
  if(state.tab==='modules') state.data.modules = (state.data.modules||[]).filter(isAllowedModule);
  if(state.tab==='inverters') state.data.inverters = (state.data.inverters||[]).filter(isAllowedInverter);
  if(state.tab==='acc') state.data.acc = (state.data.acc||[]).filter(isAllowedAccessory);
  localStorage.setItem(KS[state.tab], JSON.stringify(state.data[state.tab]||[]));
  render();
}

/* ===== seed (demo) ===== */
function seedIfEmpty(){
  if(!(state.data.modules||[]).length){
    state.data.modules = [
      {id:uid(),brand:'JINKO',model:'JKM445N-54HL4R-B Full black',tech:'TopCon N',bifacial:'NIE',watt:445,eff:21.5,size:'1762x1134x30',temp:'-0.30',warr_prod:15,warr_perf:30,price:240,note:''},
      {id:uid(),brand:'TRINA',model:'Vertex S+ 440 FB',tech:'TopCon N',bifacial:'NIE',watt:440,eff:21.7,size:'1762x1134x30',temp:'-0.30',warr_prod:25,warr_perf:30,price:200,note:''},
      {id:uid(),brand:'LONGI',model:'LR7-54HTH-460M',tech:'HPBC',bifacial:'NIE',watt:460,eff:21.9,size:'1903x1134x30',temp:'-0.29',warr_prod:15,warr_perf:25,price:225,note:''},
      {id:uid(),brand:'JA SOLAR',model:'JAM60D41-500/LB Full Black (bif.)',tech:'TopCon N',bifacial:'TAK',watt:500,eff:22.0,size:'1903x1134x30',temp:'-0.29',warr_prod:15,warr_perf:30,price:250,note:''}
    ];
  }
  if(!(state.data.inverters||[]).length){
    state.data.inverters = [
      {id:uid(),brand:'HUAWEI',model:'SUN2000-10KTL-M1-HC',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:2,max_v:1080,eff:98.6,price:3953,note:''},
      {id:uid(),brand:'SOFAR',model:'HYD 10KTL 3F',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:2,max_v:1100,eff:98.2,price:6227,note:''},
      {id:uid(),brand:'GOODWE',model:'GW10K-ET-20',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:3,max_v:1000,eff:98.0,price:4631,note:''}
    ];
  }
  if(!(state.data.acc||[]).length){
    state.data.acc = [
      {id:uid(),brand:'HUAWEI',cat:'AC',name:'DTSU666-H 3F 250A',spec:'licznik',price:497,note:''},
      {id:uid(),brand:'SOLAREDGE',cat:'DC',name:'Optymalizator S500',spec:'700W',price:176,note:''},
      {id:uid(),brand:'SOFAR',cat:'AC',name:'DTSD422-D 3F',spec:'licznik',price:426,note:''},
      {id:uid(),brand:'EASTRON',cat:'AC',name:'SDM630MCT 3F (DEYE)',spec:'licznik',price:410,note:''}
    ];
  }
  if(!(state.data.sets||[]).length){
    state.data.sets = [
      {id:uid(),title:'6.1 kWp ‚Ä¢ Trina 440 + Huawei M1',kwp:6.16,phase:'3F',storage:'opcjonalnie',items:'Modu≈Çy: 14√ó TRINA Vertex S+ 440 FB; Falownik: HUAWEI SUN2000-10KTL-M1-HC; Monta≈º: dach sko≈õny; Akcesoria: licznik DTSU',price:36900,note:'DC/AC‚âà0.61'},
      {id:uid(),title:'9.0 kWp ‚Ä¢ Jinko 445 + Sofar HYD 10 (hybryda)',kwp:8.90,phase:'3F',storage:'TAK',items:'Modu≈Çy: 20√ó JINKO JKM445N-54HL4R-B; Falownik: SOFAR HYD 10KTL 3F; Monta≈º: dach sko≈õny; Akcesoria: optymalizatory SE S500',price:51200,note:'HV ready'}
    ];
  }
}

/* ===== kolumny, render, filtry, sort (jak wcze≈õniej) ===== */
const COLS = {
  sets:[
    {k:'title',lbl:'Nazwa zestawu',w:280},
    {k:'kwp',lbl:'Moc [kWp]',num:1},
    {k:'phase',lbl:'Fazy',sel:['1F','3F']},
    {k:'storage',lbl:'Magazyn',sel:['NIE','opcjonalnie','TAK']},
    {k:'items',lbl:'Sk≈Çad',w:420},
    {k:'price',lbl:'Cena (bazowa) [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:220}
  ],
  modules:[
    {k:'brand',lbl:'Marka (dozwolone: panele)'},
    {k:'model',lbl:'Model',w:220},
    {k:'tech',lbl:'Technologia',sel:['Mono PERC','TopCon N','HJT','HPBC','IBC','Inna']},
    {k:'bifacial',lbl:'Bifacial',sel:['NIE','TAK']},
    {k:'watt',lbl:'Moc [W]',num:0},
    {k:'eff',lbl:'Sprawno≈õƒá [%]',num:2},
    {k:'size',lbl:'Wymiar [mm]',w:150},
    {k:'temp',lbl:'Coeff. [%/¬∞C]'},
    {k:'warr_prod',lbl:'Gwarancja prod. [l]',num:0},
    {k:'warr_perf',lbl:'Gwarancja perf. [l]',num:0},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:180}
  ],
  inverters:[
    {k:'brand',lbl:'Marka (dozwolone: inwertery)'},
    {k:'model',lbl:'Model',w:220},
    {k:'phase',lbl:'Fazy',sel:['1F','3F']},
    {k:'hybrid',lbl:'Hybryda',sel:['NIE','TAK']},
    {k:'ac_kw',lbl:'Moc AC [kW]',num:1},
    {k:'mppt',lbl:'MPPT',num:0},
    {k:'max_v',lbl:'V max [V]',num:0},
    {k:'eff',lbl:'Sprawno≈õƒá [%]',num:1},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:200}
  ],
  micro:[
    {k:'brand',lbl:'Marka'},
    {k:'model',lbl:'Model',w:160},
    {k:'ac_va',lbl:'Moc AC [VA]',num:0},
    {k:'peak',lbl:'Szczyt [VA]',num:0},
    {k:'module_w',lbl:'Zakres modu≈Çu [W]',w:160},
    {k:'eff',lbl:'Sprawno≈õƒá [%]',num:1},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:200}
  ],
  batt:[
    {k:'brand',lbl:'Marka'},
    {k:'model',lbl:'Model',w:220},
    {k:'chem',lbl:'Chemia',sel:['LFP','NMC','inne']},
    {k:'cap_kwh',lbl:'Pojemno≈õƒá [kWh]',num:1},
    {k:'stackable',lbl:'Modu≈Çowa',sel:['TAK','NIE']},
    {k:'v',lbl:'Poziom V',sel:['LV','HV']},
    {k:'dod',lbl:'DoD [%]',num:0},
    {k:'cycles',lbl:'Cykl√≥w',num:0},
    {k:'warr',lbl:'Gwar. [l]',num:0},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:200}
  ],
  mount:[
    {k:'brand',lbl:'Marka'},
    {k:'model',lbl:'Model',w:200},
    {k:'type',lbl:'Typ',sel:['Dach sko≈õny','Dach p≈Çaski','Grunt']},
    {k:'roof',lbl:'Pokrycie',w:140},
    {k:'tilt',lbl:'KƒÖt',w:100},
    {k:'mat',lbl:'Materia≈Ç',w:120},
    {k:'price_kwp',lbl:'Cena / kWp [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:220}
  ],
  acc:[
    {k:'brand',lbl:'Marka (dozwolone: akcesoria)'},
    {k:'cat',lbl:'Kategoria',sel:['DC','AC','Okablowanie','Z≈ÇƒÖcza','Bezpieczniki','Rozdzielnica','Pomiar','Inne']},
    {k:'name',lbl:'Nazwa',w:240},
    {k:'spec',lbl:'Specyfikacja',w:160},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:220}
  ]
};

function renderDynamicFilters(){
  const box = $('#dynFilters'); box.innerHTML='';
  if(state.tab==='modules'){
    box.innerHTML = `
      <select id="f_tech"><option value="">Technologia (wszystkie)</option>${['Mono PERC','TopCon N','HJT','HPBC','IBC','Inna'].map(t=><option>${t}</option>).join('')}</select>
      <input id="f_pmin" type="number" placeholder="Moc min [W]" style="width:130px">
      <input id="f_pmax" type="number" placeholder="Moc max [W]" style="width:130px">
      <input id="f_eff" type="number" step="0.1" placeholder="Sprawno≈õƒá min [%]" style="width:160px">
      <select id="f_bif"><option value="">Bifacial?</option><option>TAK</option><option>NIE</option></select>`;
    ['f_tech','f_pmin','f_pmax','f_eff','f_bif'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='inverters'){
    box.innerHTML = `
      <select id="f_phase"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
      <select id="f_hyb"><option value="">Hybryda?</option><option>TAK</option><option>NIE</option></select>
      <input id="f_acmin" type="number" step="0.1" placeholder="AC kW min" style="width:120px">
      <input id="f_acmax" type="number" step="0.1" placeholder="AC kW max" style="width:120px">
      <input id="f_mppt" type="number" placeholder="MPPT ‚â•" style="width:120px">`;
    ['f_phase','f_hyb','f_acmin','f_acmax','f_mppt'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='micro'){
    box.innerHTML = <input id="f_mbrand" placeholder="Marka (np. Enphase)" style="width:180px"><input id="f_mvmin" type="number" placeholder="VA min" style="width:120px"><input id="f_mvmax" type="number" placeholder="VA max" style="width:120px">;
    ['f_mbrand','f_mvmin','f_mvmax'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); });
  }else if(state.tab==='batt'){
    box.innerHTML = <select id="f_chem"><option value="">Chemia</option><option>LFP</option><option>NMC</option></select><input id="f_cmin" type="number" step="0.1" placeholder="kWh min" style="width:120px"><input id="f_cmax" type="number" step="0.1" placeholder="kWh max" style="width:120px">;
    ['f_chem','f_cmin','f_cmax'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='mount'){
    box.innerHTML = <select id="f_roof"><option value="">Pokrycie</option><option>dach√≥wka</option><option>blachodach√≥wka</option><option>balast</option><option>‚Äî</option></select><select id="f_type"><option value="">Typ</option><option>Dach sko≈õny</option><option>Dach p≈Çaski</option><option>Grunt</option></select>;
    ['f_roof','f_type'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='sets'){
    box.innerHTML = <input id="f_kwpmin" type="number" step="0.1" placeholder="kWp min" style="width:120px"><input id="f_kwpmax" type="number" step="0.1" placeholder="kWp max" style="width:120px"><select id="f_phase_s"><option value="">Fazy</option><option>1F</option><option>3F</option></select><select id="f_store"><option value="">Magazyn</option><option>NIE</option><option>opcjonalnie</option><option>TAK</option></select>;
    ['f_kwpmin','f_kwpmax','f_phase_s','f_store'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }
}
function applyFilters(){
  if(state.tab==='modules'){
    state.filters.modules.tech=$('#f_tech').value; state.filters.modules.pMin=$('#f_pmin').value; state.filters.modules.pMax=$('#f_pmax').value; state.filters.modules.effMin=$('#f_eff').value; state.filters.modules.bif=$('#f_bif').value;
  }else if(state.tab==='inverters'){
    state.filters.inverters.phase=$('#f_phase').value; state.filters.inverters.hybrid=$('#f_hyb').value; state.filters.inverters.acMin=$('#f_acmin').value; state.filters.inverters.acMax=$('#f_acmax').value; state.filters.inverters.mppt=$('#f_mppt').value;
  }else if(state.tab==='micro'){
    state.filters.micro.brand=$('#f_mbrand').value.trim(); state.filters.micro.acMin=$('#f_mvmin').value; state.filters.micro.acMax=$('#f_mvmax').value;
  }else if(state.tab==='batt'){
    state.filters.batt.chem=$('#f_chem').value; state.filters.batt.capMin=$('#f_cmin').value; state.filters.batt.capMax=$('#f_cmax').value;
  }else if(state.tab==='mount'){
    state.filters.mount.roof=$('#f_roof').value; state.filters.mount.ground=$('#f_type').value;
  }else if(state.tab==='sets'){
    state.filters.sets.kwpMin=$('#f_kwpmin').value; state.filters.sets.kwpMax=$('#f_kwpmax').value; state.filters.sets.phase=$('#f_phase_s').value; state.filters.sets.storage=$('#f_store').value;
  }
  render();
}
function toggleSort(key){ if(state.sort.key===key){ state.sort.dir*=-1; } else { state.sort.key=key; state.sort.dir=1; } render(); }
function sortFn(a,b){ const k=state.sort.key,d=state.sort.dir; const va=String(a[k]??'').toLowerCase(), vb=String(b[k]??'').toLowerCase(); if(!isNaN(+a[k]) && !isNaN(+b[k])) return d*(+a[k]-+b[k]); return d*va.localeCompare(vb,'pl',{sensitivity:'base'}); }

function renderHead(){
  const cols = COLS[state.tab];
  $('#thead').innerHTML = <tr><th>Akcje</th>${cols.map(c=><th>${esc(c.lbl)}</th>).join('')}</tr>;
  Array.from($('#thead').querySelectorAll('th')).forEach((th,i)=>{
    if(i===0) return;
    const col = cols[i-1]; th.style.cursor='pointer'; th.title='Kliknij aby sortowaƒá';
    th.addEventListener('click',()=>{ toggleSort(col.k); $('#sortLabel').textContent = col.lbl; });
  });
}
function render(){
  renderHead(); renderDynamicFilters();
  const cols = COLS[state.tab];
  let rows = (state.data[state.tab]||[]).slice();
  const q = ($('#q').value||'').toLowerCase();
  if(q){ rows = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(q) ); }
  if(state.tab==='modules') rows = rows.filter(isAllowedModule);
  if(state.tab==='inverters') rows = rows.filter(isAllowedInverter);
  if(state.tab==='acc') rows = rows.filter(isAllowedAccessory);

  // tab-specyficzne filtry
  if(state.tab==='modules'){
    const f=state.filters.modules;
    if(f.tech) rows=rows.filter(r=>r.tech===f.tech);
    if(f.bif) rows=rows.filter(r=>String(r.bifacial).toUpperCase()===f.bif.toUpperCase());
    if(+f.pMin) rows=rows.filter(r=>+r.watt>=+f.pMin);
    if(+f.pMax) rows=rows.filter(r=>+r.watt<=+f.pMax);
    if(+f.effMin) rows=rows.filter(r=>+r.eff>=+f.effMin);
  }else if(state.tab==='inverters'){
    const f=state.filters.inverters;
    if(f.phase) rows=rows.filter(r=>r.phase===f.phase);
    if(f.hybrid) rows=rows.filter(r=>r.hybrid===f.hybrid);
    if(+f.acMin) rows=rows.filter(r=>+r.ac_kw>=+f.acMin);
    if(+f.acMax) rows=rows.filter(r=>+r.ac_kw<=+f.acMax);
    if(+f.mppt) rows=rows.filter(r=>+r.mppt>=+f.mppt);
  }else if(state.tab==='micro'){
    const f=state.filters.micro;
    if(f.brand) rows=rows.filter(r=>String(r.brand).toLowerCase().includes(f.brand.toLowerCase()));
    if(+f.acMin) rows=rows.filter(r=>+r.ac_va>=+f.acMin);
    if(+f.acMax) rows=rows.filter(r=>+r.ac_va<=+f.acMax);
  }else if(state.tab==='batt'){
    const f=state.filters.batt;
    if(f.chem) rows=rows.filter(r=>r.chem===f.chem);
    if(+f.capMin) rows=rows.filter(r=>+r.cap_kwh>=+f.capMin);
    if(+f.capMax) rows=rows.filter(r=>+r.cap_kwh<=+f.capMax);
  }else if(state.tab==='mount'){
    const f=state.filters.mount;
    if(f.roof) rows=rows.filter(r=>String(r.roof).toLowerCase().includes(f.roof.toLowerCase()));
    if(f.ground) rows=rows.filter(r=>r.type===f.ground);
  }else if(state.tab==='sets'){
    const f=state.filters.sets;
    if(+f.kwpMin) rows=rows.filter(r=>+r.kwp>=+f.kwpMin);
    if(+f.kwpMax) rows=rows.filter(r=>+r.kwp<=+f.kwpMax);
    if(f.phase) rows=rows.filter(r=>r.phase===f.phase);
    if(f.storage) rows=rows.filter(r=>r.storage===f.storage);
  }

  if(state.sort.key==='brand_model'){
    rows.sort((a,b)=>{ const a1=(a.brand||'')+' '+(a.model||''); const b1=(b.brand||'')+' '+(b.model||''); return state.sort.dir * a1.localeCompare(b1,'pl',{sensitivity:'base'}); });
  }else rows.sort(sortFn);

  $('#countAll').textContent = (state.data[state.tab]||[]).length;
  $('#countVis').textContent = rows.length;

  const tb = $('#tbody'); tb.innerHTML='';
  rows.forEach((r)=>{
    const tr=document.createElement('tr');
    const act=document.createElement('td');
    act.innerHTML = `<div class="row">
      <button class="btn ghost" data-act="dup" data-id="${r.id}">Duplikuj</button>
      <button class="btn bad" data-act="del" data-id="${r.id}">Usu≈Ñ</button>
      ${state.tab==='sets' ? <button class="btn warn" data-act="toCalc" data-id="${r.id}">Wyce≈Ñ w Kalkulatorze</button> : ''}
    </div>`;
    tr.appendChild(act);
    COLS[state.tab].forEach(col=>{
      const td=document.createElement('td');
      const id=r.id+''+col.k;
      const v=r[col.k];
      if(col.sel){
        td.innerHTML = <select id="${id}">${col.sel.map(o=><option ${o==v?'selected':''}>${esc(o)}</option>).join('')}</select>;
      }else if(col.num!=null){
        td.innerHTML = <input id="${id}" type="number" step="${col.num===0?1:(col.num===1?0.1:0.01)}" value="${v??''}" style="max-width:140px">;
      }else{
        td.innerHTML = `<input id="${id}" value="${v==null?'':esc(v)}" ${col.w?style="min-width:${col.w}px":''}>`;
      }
      tr.appendChild(td);
      const el = td.querySelector('#'+CSS.escape(id));
      el.addEventListener('input', ()=> editCell(r.id,col.k,(col.num!=null? (el.value===''? '' : +el.value) : el.value)) );
      el.addEventListener('change', ()=> editCell(r.id,col.k,(col.num!=null? (el.value===''? '' : +el.value) : el.value)) );
    });
    tb.appendChild(tr);
  });

  tb.querySelectorAll('[data-act="del"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id; state.data[state.tab]=(state.data[state.tab]||[]).filter(x=>x.id!==id); saveTab();
  }));
  tb.querySelectorAll('[data-act="dup"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id; const src=(state.data[state.tab]||[]).find(x=>x.id===id); if(!src) return;
    const copy=JSON.parse(JSON.stringify(src)); copy.id=uid(); if(copy.title) copy.title = copy.title+' (kopia)';
    state.data[state.tab].unshift(copy); saveTab();
  }));
  tb.querySelectorAll('[data-act="toCalc"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id; const set=(state.data.sets||[]).find(x=>x.id===id); openSetInCalculator(set||{});
  }));
}
function editCell(id,key,val){
  const arr=state.data[state.tab]||[]; const it=arr.find(x=>x.id===id); if(!it) return;
  if(state.tab==='modules' && key==='brand' && !ALLOWED.panels.includes(norm(val||''))) return render();
  if(state.tab==='inverters' && key==='brand' && !ALLOWED.inverters.includes(norm(val||''))) return render();
  if(state.tab==='acc' && key==='brand' && !ALLOWED.accessories.includes(norm(val||''))) return render();
  it[key]=val; saveTab();
}

/* ===== UI binds ===== */
$$('.sb').forEach(b=>b.addEventListener('click',()=>{
  $$('.sb').forEach(x=>x.setAttribute('aria-selected','false')); b.setAttribute('aria-selected','true');
  state.tab = b.dataset.k; state.sort={key:'brand_model',dir:1}; render();
}));
$('#q').addEventListener('input', e=>{ state.q=e.target.value.trim(); render(); });
window.addEventListener('keydown', e=>{ if(e.key==='/' && !/^(INPUT|SELECT|TEXTAREA)$/.test(document.activeElement.tagName)){ e.preventDefault(); $('#q').focus(); } });
window.addEventListener('keydown', e=>{ if(e.altKey && (e.key==='n' || e.key==='N')) addRow(); });

$('#btnAdd').addEventListener('click', addRow);
$('#btnCSV').addEventListener('click', ()=>{ const cols=COLS[state.tab].map(c=>c.k); toCSV(state.data[state.tab]||[], cols); });
$('#btnJSON').addEventListener('click', ()=> saveJSON(state.data[state.tab]||[]) );
$('#inJSON').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const arr=await readJSON(f);
    if(!Array.isArray(arr)) throw new Error('Z≈Çy plik JSON (oczekujƒô tablicy).');
    let cleaned=arr;
    if(state.tab==='modules') cleaned=arr.filter(isAllowedModule);
    if(state.tab==='inverters') cleaned=arr.filter(isAllowedInverter);
    if(state.tab==='acc') cleaned=arr.filter(isAllowedAccessory);
    state.data[state.tab]=cleaned; saveTab();
  }catch(err){ alert('B≈ÇƒÖd importu: '+(err.message||err)); }
  e.target.value='';
});
$('#btnExportCalc').addEventListener('click', exportCatalogToCalculator);
$('#openCalc').addEventListener('click', (e)=>{ e.preventDefault(); openCalculatorStandalone(); });

function addRow(){
  const def=(tab)=>{
    switch(tab){
      case 'modules': return {id:uid(),brand:'JINKO',model:'',tech:'Mono PERC',bifacial:'NIE',watt:450,eff:21,size:'',temp:'-0.35',warr_prod:12,warr_perf:25,price:0,note:''};
      case 'inverters': return {id:uid(),brand:'HUAWEI',model:'',phase:'3F',hybrid:'NIE',ac_kw:10,mppt:2,max_v:1000,eff:98,price:0,note:''};
      case 'micro': return {id:uid(),brand:'Enphase',model:'',ac_va:800,peak:800,module_w:'2x 300‚Äì450',eff:96.5,price:0,note:''};
      case 'batt': return {id:uid(),brand:'Huawei',model:'',chem:'LFP',cap_kwh:5,stackable:'TAK',v:'HV',dod:95,cycles:6000,warr:10,price:0,note:''};
      case 'mount': return {id:uid(),brand:'Corab',model:'',type:'Dach sko≈õny',roof:'dach√≥wka',tilt:'10¬∞',mat:'AL/SS',price_kwp:0,note:''};
      case 'acc': return {id:uid(),brand:'HUAWEI',cat:'AC',name:'',spec:'',price:0,note:''};
      case 'sets': return {id:uid(),title:'Nowy zestaw',kwp:5.0,phase:'3F',storage:'NIE',items:'',price:0,note:''};
    }
  };
  state.data[state.tab].unshift(def(state.tab)); saveTab();
}

/* ===== Eksport ‚Üí Kalkulator (localStorage) ===== */
function exportCatalogToCalculator(){
  const panels = (state.data.modules||[]).filter(isAllowedModule).map(m=>({brand:norm(m.brand), model:m.model, price:+m.price||0}));
  const inverters = (state.data.inverters||[]).filter(isAllowedInverter).map(i=>({brand:norm(i.brand), model:i.model, price:+i.price||0}));
  const accessories = (state.data.acc||[]).filter(isAllowedAccessory).map(a=>({brand:norm(a.brand||a.cat||''), name:a.name||a.model||a.spec||'', price:+a.price||0}));
  localStorage.setItem('arkon_calc_catalog', JSON.stringify({panels,inverters,accessories}));
  alert('Katalog PV wyeksportowany do Kalkulatora.');
}

/* ===== PDF import ‚Üí kalkulator ===== */
async function readPdfText(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  let all=''; for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const content=await page.getTextContent(); all+='\n'+content.items.map(it=>it.str).join(' '); }
  return all.replace(/\s{2,}/g,' ').trim();
}
function parseCatalogFromPdf(text){
  const out={panels:[],inverters:[],accessories:[]};
  const lines=text.split(/\n|(?=\b[A-Z][A-Z0-9\- ]{1,}\b)/g).map(s=>s.trim()).filter(Boolean);
  lines.forEach(line=>{
    const m = line.match(/^([A-Z][A-Z \-0-9]+?)\s+([A-Za-z0-9\.\-\/\(\) ]{4,}?)\s+(\d{2,}(?:[.,]\d{2})?)$/);
    if(m){
      let [,brand, model, price]=m; brand=brand.trim(); const p=+String(price).replace(',','.');
      if(ALLOWED.panels.includes(norm(brand))) { out.panels.push({brand:norm(brand),model:model.trim(),price:p}); return; }
      if(ALLOWED.inverters.includes(norm(brand))) { out.inverters.push({brand:norm(brand),model:model.trim(),price:p}); return; }
      if(ALLOWED.accessories.includes(norm(brand))) { out.accessories.push({brand:norm(brand),name:model.trim(),price:p}); return; }
    }
  });
  const dedup=(arr,key)=>Object.values(arr.reduce((a,x)=>{a[key(x)]=x;return a;},{}));
  out.panels=dedup(out.panels,x=>x.brand+'|'+x.model);
  out.inverters=dedup(out.inverters,x=>x.brand+'|'+x.model);
  out.accessories=dedup(out.accessories,x=>x.brand+'|'+x.name);
  return out;
}
document.getElementById('inPDF').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await readPdfText(f);
    const cat=parseCatalogFromPdf(txt);
    const panels=(cat.panels||[]).filter(isAllowedModule).map(m=>({brand:norm(m.brand),model:m.model,price:+m.price||0}));
    const inverters=(cat.inverters||[]).filter(isAllowedInverter).map(i=>({brand:norm(i.brand),model:i.model,price:+i.price||0}));
    const accessories=(cat.accessories||[]).filter(isAllowedAccessory).map(a=>({brand:norm(a.brand||a.cat||''),name:a.name||'',price:+a.price||0}));
    localStorage.setItem('arkon_calc_catalog', JSON.stringify({panels,inverters,accessories}));
    alert(Zaimportowano z PDF do Kalkulatora:\nPanele: ${panels.length}\nInwertery: ${inverters.length}\nAkcesoria: ${accessories.length}\n\nOtw√≥rz Kalkulator ‚Üó aby u≈ºyƒá.);
  }catch(err){ console.error(err); alert('Nie uda≈Ço siƒô odczytaƒá PDF. Upewnij siƒô, ≈ºe to tekstowy PDF i ≈ºe wiersze majƒÖ: marka, model/nazwa, cena.'); }
  e.target.value='';
});

/* ===== Prefill zestawu ‚Üí kalkulator ===== */
function guessFromSet(set){
  const out={brandPanel:'',modelPanel:'',qty:'',brandInv:'',modelInv:'',acc:[]};
  const items=String(set.items||'');
  const mQty=items.match(/(\d+)\s*[√óxX]/); if(mQty) out.qty=mQty[1];
  const pBrand=ALLOWED.panels.find(b=> new RegExp(\\b${b}\\b,'i').test(items)); if(pBrand){ out.brandPanel=pBrand; const m=new RegExp(pBrand+'\\s+([^;]+?)(?:;|Falownik|,|$)','i').exec(items); if(m) out.modelPanel=m[1].trim(); }
  const iBrand=ALLOWED.inverters.find(b=> new RegExp(\\b${b}\\b,'i').test(items)); if(iBrand){ out.brandInv=iBrand; const m=new RegExp(iBrand+'\\s+([^;]+?)(?:;|Magazyn|,|$)','i').exec(items); if(m) out.modelInv=m[1].trim(); }
  if(/optymali[zs]ator|S500|TS4|TIGO|SOLAREDGE/i.test(items)) out.acc.push('SOLAREDGE::Optymalizator S500','TIGO::TS4-A-O 700W');
  if(/licznik|meter|DTSU|DTSD|SDM/i.test(items)){
    if(out.brandInv==='HUAWEI') out.acc.push('HUAWEI::DTSU666-H 3F 250A');
    if(out.brandInv==='SOFAR')  out.acc.push('SOFAR::DTSD422-D 3F');
    if(out.brandInv==='DEYE')   out.acc.push('EASTRON::SDM630MCT 3F (DEYE)');
  }
  const catRaw=JSON.parse(localStorage.getItem('arkon_calc_catalog')||'{}');
  const cat={panels:catRaw.panels||[],inverters:catRaw.inverters||[],accessories:catRaw.accessories||[]};
  if(out.brandPanel){
    const same=cat.panels.filter(p=>p.brand===out.brandPanel);
    const best = same.find(p=> out.modelPanel && new RegExp(out.modelPanel.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i').test(p.model)) || same[0];
    if(best){ out.brandPanel=best.brand; out.modelPanel=best.model; }
  }
  if(out.brandInv){
    const sameI=cat.inverters.filter(i=>i.brand===out.brandInv);
    const bestI = sameI.find(i=> out.modelInv && new RegExp(out.modelInv.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i').test(i.model)) || sameI[0];
    if(bestI){ out.brandInv=bestI.brand; out.modelInv=bestI.model; }
  }
  return out;
}
function openSetInCalculator(set){
  exportCatalogToCalculator(); // ≈õwie≈ºy katalog
  const g=guessFromSet(set);
  const params=new URLSearchParams();
  if(g.brandPanel) params.set('brandPanel',g.brandPanel);
  if(g.modelPanel) params.set('modelPanel',g.modelPanel);
  if(g.brandInv) params.set('brandInv',g.brandInv);
  if(g.modelInv) params.set('modelInv',g.modelInv);
  if(g.qty) params.set('qty',g.qty);
  if(g.acc && g.acc.length) params.set('acc', g.acc.join(','));
  openCalculatorStandalone(params.toString());
}

/* ===== Otw√≥rz kalkulator z wbudowanego szablonu ===== */
function openCalculatorStandalone(query=''){
  const tpl = document.getElementById('calc-template').innerHTML;
  const html = tpl.replace('<html','<html').replace('</html>','</html>');
  const blob = new Blob([html],{type:'text/html'});
  const url = URL.createObjectURL(blob);
  const final = url + (query? ('?'+query) : '');
  window.open(final,'_blank','noopener');
  // URL.revokeObjectURL po nawigacji nie jest konieczne; przeglƒÖdarka zreklamuje po zamkniƒôciu karty
}

/* ===== boot ===== */
loadAll(); seedIfEmpty();
// jeszcze raz oczy≈õƒá i zapisz
state.data.modules = (state.data.modules||[]).filter(isAllowedModule);
state.data.inverters = (state.data.inverters||[]).filter(isAllowedInverter);
state.data.acc = (state.data.acc||[]).filter(isAllowedAccessory);
localStorage.setItem(KS.modules, JSON.stringify(state.data.modules||[]));
localStorage.setItem(KS.inverters, JSON.stringify(state.data.inverters||[]));
localStorage.setItem(KS.acc, JSON.stringify(state.data.acc||[]));
render();
</script>
</body>
</html>
