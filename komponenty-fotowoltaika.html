<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Komponenty Fotowoltaika</title>
    <!-- Bootstrap 4 CSS (dla stylowania formularza i tabel) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="komponenty-fotowoltaika.css">
    <style>
        /* Ciemne tło strony i karty zgodne z motywem CRM */
        body { background-color: #2b2b2b; color: #f0f0f0; }
        .card { background-color: #3a3a3a; color: #ffffff; }
        .card a { color: #ff5a00; } /* wyróżnienie linków (pomarańczowy) */
        /* Stylowanie pól formularza na ciemnym tle */
        .card .form-control, .card .form-control-select {
            background-color: #555; color: #fff; border: 1px solid #666;
        }
        /* Stylowanie tabeli podsumowania (ciemna tabela) */
        .table-dark th, .table-dark td { border-color: #555; }
        /* Ustawienia wydruku: ukrycie elementów interaktywnych */
        .no-print { display: block; }
        @media print {
            .no-print { display: none; }
            body { background-color: #ffffff; color: #000000; }
            .card { background-color: #ffffff; color: #000; }
            .table-dark {
                color: #000;
                background-color: #fff;
            }
            .table-dark th, .table-dark td {
                color: #000;
                border-color: #000;
            }
        }
    </style>
</head>
<body class="bg-dark text-light">
<div class="container-fluid">
    <div class="row equal">
        <div class="col-md-9 equal-padding">
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Dobór komponentów fotowoltaiki</h4>
                </div>
                <div class="card-body">
                    <!-- Sekcja formularza (dane wejściowe) -->
                    <div class="no-print">
                        <!-- Wybór paneli i liczby sztuk -->
                        <div class="form-group">
                            <label for="panelSelect">Panele PV</label>
                            <div class="d-flex">
                                <input type="number" id="panelCount" class="form-control bg-secondary text-light panel-count-input" 
                                       value="10" min="0" title="Liczba paneli">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">szt.</span>
                                </div>
                            </div>
                        </div>
                        <!-- Falownik -->
                        <div class="form-group">
                            <select id="inverterSelect" class="form-control form-control-select bg-secondary text-light mt-1" aria-label="Wybierz falownik" title="Wybierz falownik"></select>
                        </div>
                        <!-- Magazyn energii -->
                        <div class="form-group">
                            <select id="batterySelect" class="form-control form-control-select bg-secondary text-light mt-1" disabled aria-label="Wybierz magazyn energii" title="Wybierz magazyn energii"></select>
                        </div>
                        <!-- Magazyn ciepła -->
                        <div class="form-group">
                            <select id="heatSelect" class="form-control form-control-select bg-secondary text-light mt-1" disabled aria-label="Wybierz magazyn ciepła" title="Wybierz magazyn ciepła"></select>
                        </div>
                        <hr>
                        <h5>Opcje dodatkowe</h5>
                        <!-- Długość przekopu -->
                        <div class="form-group">
                            <label for="trenchLength">Przekop (długość wykopu w metrach)</label>
                            <div class="input-group">
                                <input type="number" id="trenchLength" class="form-control bg-secondary text-light" value="0" min="0">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">m</span>
                                </div>
                            </div>
                        </div>
                        <!-- Dodatkowy kabel -->
                        <div class="form-group">
                            <label for="cableLength">Dodatkowy kabel DC/AC (metry ponad standard)</label>
                            <div class="input-group">
                                <input type="number" id="cableLength" class="form-control bg-secondary text-light" value="0" min="0">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">m</span>
                                </div>
                            </div>
                        </div>
                        <!-- Optymalizatory -->
                        <div class="form-group">
                            <label for="numOptimizers">Optymalizatory mocy</label>
                            <div class="input-group">
                                <input type="number" id="numOptimizers" class="form-control bg-secondary text-light" value="0" min="0">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">szt.</span>
                                </div>
                            </div>
                        </div>
                        <!-- Rozdzielnia -->
                        <div class="form-group">
                            <label for="numDBoard">Dodatkowa rozdzielnia AC/DC</label>
                            <div class="input-group">
                                <input type="number" id="numDBoard" class="form-control bg-secondary text-light" value="0" min="0" max="1">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">szt.</span>
                                </div>
                            </div>
                        </div>
                        <!-- Licznik produkcji -->
                        <div class="form-group">
                            <label for="numMeter">Licznik produkcji energii</label>
                            <div class="input-group">
                                <input type="number" id="numMeter" class="form-control bg-secondary text-light" value="0" min="0" max="1">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">szt.</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h5>Dane inwestora i VAT</h5>
                        <!-- Typ inwestora: osoba prywatna vs firma -->
                        <div class="form-group">
                            <label for="investorType">Typ inwestora</label>
                            <select id="investorType" class="form-control form-control-select bg-secondary text-light">
                                <option value="private">Osoba prywatna</option>
                                <option value="company">Firma</option>
                            </select>
                        </div>
                        <!-- Pola dla osoby prywatnej: typ budynku i powierzchnia -->
                        <div id="privateFields">
                            <div class="form-group">
                                <label for="buildingType">Typ budynku mieszkalnego</label>
                                <select id="buildingType" class="form-control form-control-select bg-secondary text-light">
                                    <option value="house">Dom jednorodzinny</option>
                                    <option value="apartment">Mieszkanie</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="buildingArea">Powierzchnia budynku (m<sup>2</sup>)</label>
                                <div class="input-group">
                                    <input type="number" id="buildingArea" class="form-control bg-secondary text-light" value="100" min="1">
                                    <div class="input-group-append">
                                        <span class="input-group-text bg-secondary text-light">m&sup2;</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Prowizja handlowca -->
                        <div class="form-group">
                            <label for="commissionPercent">Prowizja handlowca (%)</label>
                            <div class="input-group">
                                <input type="number" id="commissionPercent" class="form-control bg-secondary text-light" value="0" min="0" max="100" step="0.1">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light">%</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <!-- Przyciski akcji -->
                        <div class="form-group">
                            <button id="printButton" class="btn btn-primary btn-sm">Drukuj / PDF</button>
                        </div>
                        <hr>
                        <!-- Panel edycji katalogu komponentów -->
                        <h5>Edytuj katalog komponentów</h5>
                        <div class="form-group">
                            <label for="newCategory">Kategoria</label>
                            <select id="newCategory" class="form-control form-control-select bg-secondary text-light">
                                <option value="panel">Panel PV</option>
                                <option value="inverter">Falownik</option>
                                <option value="battery">Magazyn energii</option>
                                <option value="heat">Magazyn ciepła</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newBrand">Marka</label>
                            <input type="text" id="newBrand" class="form-control bg-secondary text-light">
                        </div>
                        <div class="form-group">
                            <label for="newModel">Model</label>
                            <input type="text" id="newModel" class="form-control bg-secondary text-light">
                        </div>
                        <div class="form-group">
                            <label id="labelSpec" for="newSpec">Moc [W]</label>
                            <input type="number" id="newSpec" class="form-control bg-secondary text-light" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="newPrice">Cena netto [zł]</label>
                            <input type="number" id="newPrice" class="form-control bg-secondary text-light" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <button id="addComponentBtn" class="btn btn-secondary btn-sm">Dodaj komponent</button>
                            <button id="saveCatalogBtn" class="btn btn-secondary btn-sm">Zapisz zmiany katalogu</button>
                        </div>
                    </div>
                    <!-- Koniec sekcji formularza -->
                    <!-- Sekcja wyników (podsumowanie) -->
                    <h5 class="mt-4">Podsumowanie</h5>
                    <p>Moc zestawu PV: <span id="systemPower">0</span> kWp</p>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped" id="summaryTable">
                            <thead>
                                <tr>
                                    <th>Element</th>
                                    <th>Ilość</th>
                                    <th>Cena netto</th>
                                    <th>Wartość netto</th>
                                    <th>VAT</th>
                                    <th>Wartość brutto</th>
                                </tr>
                            </thead>
                            <tbody id="summaryBody">
                                <!-- wiersze z elementami - generowane skryptem -->
                            </tbody>
                            <tfoot id="summaryFooter">
                                <!-- wiersz sumy - generowany skryptem -->
                            </tfoot>
                        </table>
                    </div>
                    <p><strong>Dotacja Mój Prąd 6.0:</strong> <span id="subsidyAmount">0</span> zł</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Skrypty JavaScript -->
<script>
    // Tablice do przechowywania danych komponentów
    let panels = [], inverters = [], batteries = [], heats = [], additionalItems = [];
    let addItems = {};  // pomocniczy słownik dla opcji dodatkowych
    // Flagi do śledzenia czy użytkownik ręcznie wybrał falownik/magazyn (aby nie nadpisywać)
    let inverterManual = false;
    let batteryManual = false;
    // Funkcja ładowania danych z CSV lub localStorage
    function loadData() {
        // Najpierw sprawdź localStorage (czy zapisano zmodyfikowany katalog)
        let stored = localStorage.getItem('componentsData');
        if(stored) {
            try {
                let data = JSON.parse(stored);
                if(data && data.panels && data.inverters && data.batteries && data.heats && data.additional) {
                    panels = data.panels;
                    inverters = data.inverters;
                    batteries = data.batteries;
                    heats = data.heats;
                    additionalItems = data.additional;
                    console.log("Loaded components from local storage.");
                    populateSelects();
                    return;
                }
            } catch(e) { console.warn("Local storage parse error:", e); }
        }
        // Jeśli brak danych w localStorage, wczytaj z plików CSV
        Promise.all([
            fetch('panels.csv').then(res => res.text()),
            fetch('inverters.csv').then(res => res.text()),
            fetch('batteries.csv').then(res => res.text()),
            fetch('heat_storage.csv').then(res => res.text()),
            fetch('additional.csv').then(res => res.text())
        ]).then(function([panelsText, invertersText, batteriesText, heatsText, additionalText]) {
            panels = parseCSV(panelsText, 'panel');
            inverters = parseCSV(invertersText, 'inverter');
            batteries = parseCSV(batteriesText, 'battery');
            heats = parseCSV(heatsText, 'heat');
            additionalItems = parseCSV(additionalText, 'additional');
            console.log("Loaded components from CSV files.");
            populateSelects();
        }).catch(function(error) {
            console.error("Error loading CSV files:", error);
        });
    }
    // Parser CSV – konwertuje tekst CSV na obiekty w zależności od kategorii
    function parseCSV(csvText, type) {
        let lines = csvText.split(/\\r?\\n/).map(l => l.trim()).filter(l => l);
        if(lines.length === 0) return [];
        // Zakładamy, że pierwsza linia to nagłówek
        lines.shift();  // usuń nagłówek
        let result = [];
        lines.forEach(line => {
            let cols = line.split(/[;,]+/);  // akceptuj CSV rozdzielony przecinkami lub średnikami
            if(cols.length < 2) return;
            switch(type) {
                case 'panel':
                    // format: Brand, Model, Power(W), Price
                    if(cols.length >= 4) {
                        result.push({
                            brand: cols[0],
                            model: cols[1],
                            power: parseFloat(cols[2]) || 0,
                            price: parseFloat(cols[3]) || 0
                        });
                    }
                    break;
                case 'inverter':
                    // format: Brand, Model, Power(kW), Price
                    if(cols.length >= 4) {
                        result.push({
                            brand: cols[0],
                            model: cols[1],
                            power: parseFloat(cols[2]) || 0,
                            price: parseFloat(cols[3]) || 0
                        });
                    }
                    break;
                case 'battery':
                    // format: Brand, Model, Capacity(kWh), Price
                    if(cols.length >= 4) {
                        result.push({
                            brand: cols[0],
                            model: cols[1],
                            capacity: parseFloat(cols[2]) || 0,
                            price: parseFloat(cols[3]) || 0
                        });
                    }
                    break;
                case 'heat':
                    // format: Brand, Model, Capacity(l), Price
                    if(cols.length >= 4) {
                        result.push({
                            brand: cols[0],
                            model: cols[1],
                            capacity: parseFloat(cols[2]) || 0,
                            price: parseFloat(cols[3]) || 0
                        });
                    }
                    break;
                case 'additional':
                    // format: Name, Price, Unit
                    if(cols.length >= 3) {
                        result.push({
                            name: cols[0],
                            price: parseFloat(cols[1]) || 0,
                            unit: cols[2]
                        });
                    }
                    break;
            }
        });
        return result;
    }
    // Inicjalizacja list wyboru na podstawie załadowanych danych
    function populateSelects() {
        // Panele PV
        const panelSelect = document.getElementById('panelSelect');
        panelSelect.innerHTML = "";
        panels.forEach((p, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.textContent = p.brand + " " + p.model + " (" + p.power + " W)";
            panelSelect.appendChild(option);
        });
        // Falowniki
        const inverterSelect = document.getElementById('inverterSelect');
        inverterSelect.innerHTML = "";
        inverters.forEach((inv, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.textContent = inv.brand + " " + inv.model + " (" + inv.power + " kW)";
            inverterSelect.appendChild(option);
        });
        // Magazyny energii
        const batterySelect = document.getElementById('batterySelect');
        batterySelect.innerHTML = "";
        batteries.forEach((bat, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.textContent = bat.brand + " " + bat.model + " (" + bat.capacity + " kWh)";
            batterySelect.appendChild(option);
        });
        // Magazyny ciepła
        const heatSelect = document.getElementById('heatSelect');
        heatSelect.innerHTML = "";
        heats.forEach((hs, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.textContent = hs.brand + " " + hs.model + " (" + hs.capacity + " l)";
            heatSelect.appendChild(option);
        });
        // Opcje dodatkowe – budujemy słownik dla szybkiego dostępu po nazwie
        addItems = {};
        additionalItems.forEach(item => {
            let nameLower = item.name.toLowerCase();
            if(nameLower.includes('przekop') || nameLower.includes('trench')) {
                addItems.trench = item;
            } else if(nameLower.includes('kabel') || nameLower.includes('cable')) {
                addItems.cable = item;
            } else if(nameLower.includes('rozdziel') || nameLower.includes('board')) {
                addItems.db = item;
            } else if(nameLower.includes('optymal') || nameLower.includes('optim')) {
                addItems.opt = item;
            } else if(nameLower.includes('licznik') || nameLower.includes('meter')) {
                addItems.meter = item;
            }
        });
        // Ustaw domyślne indeksy (pierwsze na liście)
        panelSelect.selectedIndex = 0;
        inverterSelect.selectedIndex = 0;
        batterySelect.selectedIndex = 0;
        heatSelect.selectedIndex = 0;
        // Oblicz początkowe wartości
        recalc();
    }
    // Funkcja przeliczająca wartości na podstawie bieżących wyborów
    function recalc() {
        // Pokaż/ukryj pola dla osoby prywatnej w zależności od typu inwestora
        const investorType = document.getElementById('investorType').value;
        const privateFieldsDiv = document.getElementById('privateFields');
        privateFieldsDiv.style.display = (investorType === 'company') ? 'none' : 'block';
        // Blokuj/odblokuj listy wyboru falownika i magazynów w zależności od checkboxów
        const invCheckbox = document.getElementById('includeInverter');
        const batCheckbox = document.getElementById('includeBattery');
        const heatCheckbox = document.getElementById('includeHeat');
        const inverterSelect = document.getElementById('inverterSelect');
        const batterySelect = document.getElementById('batterySelect');
        const heatSelect = document.getElementById('heatSelect');
        inverterSelect.disabled = !invCheckbox.checked;
        batterySelect.disabled = !batCheckbox.checked;
        heatSelect.disabled = !heatCheckbox.checked;
        // Panel – liczba sztuk (jeśli 0 to blokujemy wybór modelu)
        const panelCountInput = document.getElementById('panelCount');
        const panelSelect = document.getElementById('panelSelect');
        let panelCount = parseInt(panelCountInput.value) || 0;
        if(panelCount <= 0) {
            panelCount = 0;
            panelCountInput.value = 0;
        }
        panelSelect.disabled = (panelCount === 0);
        // Aktualizacja wyświetlenia mocy zestawu
        let systemPowerKW = 0;
        if(panelCount > 0 && panelSelect.value !== "" && panels[panelSelect.value]) {
            systemPowerKW = (panels[panelSelect.value].power * panelCount) / 1000.0;
        }
        document.getElementById('systemPower').textContent = systemPowerKW.toFixed(2);
        // Sugestia falownika (jeśli użytkownik nie wybrał ręcznie)
        if(invCheckbox.checked && !inverterManual) {
            if(panelCount > 0) {
                let pvPower = systemPowerKW;  // moc PV w kW
                // Znajdź najmniejszy falownik o mocy >= pvPower
                let invIndex = 0;
                let bestPower = Infinity;
                inverters.forEach((inv, idx) => {
                    if(inv.power >= pvPower && inv.power < bestPower) {
                        bestPower = inv.power;
                        invIndex = idx;
                    }
                });
                // Jeśli żaden falownik nie był wystarczająco duży – wybierz największy dostępny
                if(bestPower === Infinity && inverters.length > 0) {
                    invIndex = inverters.length - 1;
                }
                inverterSelect.selectedIndex = invIndex;
            }
        }
        // Sugestia magazynu energii (jeśli włączony i nie wybrano ręcznie, tylko gdy są panele)
        if(batCheckbox.checked && !batteryManual) {
            if(panelCount > 0 && batteries.length > 0) {
                let pvPower = systemPowerKW;
                let batIndex = 0;
                let bestCap = Infinity;
                batteries.forEach((bat, idx) => {
                    if(bat.capacity >= pvPower && bat.capacity < bestCap) {
                        bestCap = bat.capacity;
                        batIndex = idx;
                    }
                });
                if(bestCap === Infinity) {
                    batIndex = batteries.length - 1;
                }
                batterySelect.selectedIndex = batIndex;
            }
        }
        // Oblicz listę pozycji do tabeli
        let lines = [];
        // Panele
        if(panelCount > 0) {
            let p = panels[panelSelect.value];
            let netPrice = p.price;
            let netTotal = netPrice * panelCount;
            lines.push({
                name: "Panele PV " + p.brand + " " + p.model,
                qty: panelCount + " szt.",
                unitNet: netPrice,
                net: netTotal
            });
        }
        // Falownik
        if(invCheckbox.checked) {
            let inv = inverters[inverterSelect.value];
            let netPrice = inv.price;
            lines.push({
                name: "Falownik " + inv.brand + " " + inv.model,
                qty: "1 szt.",
                unitNet: netPrice,
                net: netPrice
            });
        }
        // Magazyn energii
        if(batCheckbox.checked) {
            let bat = batteries[batterySelect.value];
            let netPrice = bat.price;
            lines.push({
                name: "Magazyn energii " + bat.brand + " " + bat.model,
                qty: "1 szt.",
                unitNet: netPrice,
                net: netPrice
            });
        }
        // Magazyn ciepła
        if(heatCheckbox.checked) {
            let hs = heats[heatSelect.value];
            let netPrice = hs.price;
            lines.push({
                name: "Magazyn ciepła " + hs.brand + " " + hs.model,
                qty: "1 szt.",
                unitNet: netPrice,
                net: netPrice
            });
        }
        // Przekop
        const trenchLength = parseFloat(document.getElementById('trenchLength').value) || 0;
        if(trenchLength > 0 && addItems.trench) {
            let price = addItems.trench.price;
            let netTotal = price * trenchLength;
            lines.push({
                name: "Przekop",
                qty: trenchLength + " m",
                unitNet: price,
                net: netTotal
            });
        }
        // Dodatkowy kabel
        const cableLength = parseFloat(document.getElementById('cableLength').value) || 0;
        if(cableLength > 0 && addItems.cable) {
            let price = addItems.cable.price;
            let netTotal = price * cableLength;
            lines.push({
                name: "Dodatkowy kabel",
                qty: cableLength + " m",
                unitNet: price,
                net: netTotal
            });
        }
        // Optymalizatory
        const numOpt = parseInt(document.getElementById('numOptimizers').value) || 0;
        if(numOpt > 0 && addItems.opt) {
            let price = addItems.opt.price;
            let netTotal = price * numOpt;
            lines.push({
                name: "Optymalizatory",
                qty: numOpt + " szt.",
                unitNet: price,
                net: netTotal
            });
        }
        // Rozdzielnia
        const numDB = parseInt(document.getElementById('numDBoard').value) || 0;
        if(numDB > 0 && addItems.db) {
            let price = addItems.db.price;
            let netTotal = price * numDB;
            lines.push({
                name: "Rozdzielnia AC/DC",
                qty: numDB + " szt.",
                unitNet: price,
                net: netTotal
            });
        }
        // Licznik
        const numMet = parseInt(document.getElementById('numMeter').value) || 0;
        if(numMet > 0 && addItems.meter) {
            let price = addItems.meter.price;
            let netTotal = price * numMet;
            lines.push({
                name: "Licznik produkcji",
                qty: numMet + " szt.",
                unitNet: price,
                net: netTotal
            });
        }
        // Prowizja handlowca
        const commissionPercent = parseFloat(document.getElementById('commissionPercent').value) || 0;
        if(commissionPercent > 0) {
            let baseNetSum = lines.reduce((sum, line) => sum + line.net, 0);
            let commissionNet = baseNetSum * (commissionPercent / 100.0);
            lines.push({
                name: "Prowizja handlowca (" + commissionPercent + "%)",
                qty: "",
                unitNet: "",
                net: commissionNet
            });
        }
        // Oblicz stawkę VAT (8% czy 23%)
        let vatRate = 0.23;
        if(investorType === 'private') {
            let bType = document.getElementById('buildingType').value;
            let area = parseFloat(document.getElementById('buildingArea').value) || 0;
            if((bType === 'house' && area <= 300) || (bType === 'apartment' && area <= 150)) {
                vatRate = 0.08;
            } else {
                vatRate = 0.23;
            }
        } else {
            vatRate = 0.23;
        }
        // Generowanie tabeli podsumowania
        const tbody = document.getElementById('summaryBody');
        const tfoot = document.getElementById('summaryFooter');
        tbody.innerHTML = "";
        let totalNet = 0, totalVat = 0, totalGross = 0;
        lines.forEach(line => {
            let netVal = line.net || 0;
            let vatVal = netVal * vatRate;
            let grossVal = netVal + vatVal;
            totalNet += netVal;
            totalVat += vatVal;
            totalGross += grossVal;
            // Utwórz wiersz tabeli
            let tr = document.createElement('tr');
            let tdName = document.createElement('td');
            tdName.textContent = line.name;
            let tdQty = document.createElement('td');
            tdQty.textContent = line.qty;
            let tdUnitNet = document.createElement('td');
            tdUnitNet.textContent = line.unitNet !== "" ? formatCurrency(line.unitNet) : "";
            let tdNet = document.createElement('td');
            tdNet.textContent = formatCurrency(netVal);
            let tdVat = document.createElement('td');
            tdVat.textContent = formatCurrency(vatVal);
            let tdGross = document.createElement('td');
            tdGross.textContent = formatCurrency(grossVal);
            tr.appendChild(tdName);
            tr.appendChild(tdQty);
            tr.appendChild(tdUnitNet);
            tr.appendChild(tdNet);
            tr.appendChild(tdVat);
            tr.appendChild(tdGross);
            tbody.appendChild(tr);
        });
        // Wiersz sumaryczny (RAZEM)
        tfoot.innerHTML = "";
        let ftTr = document.createElement('tr');
        ftTr.innerHTML = "<th>RAZEM:</th><th></th><th></th>" +
                         "<th>" + formatCurrency(totalNet) + "</th>" +
                         "<th>" + formatCurrency(totalVat) + "</th>" +
                         "<th>" + formatCurrency(totalGross) + "</th>";
        tfoot.appendChild(ftTr);
        // Oblicz i wyświetl dotację Mój Prąd
        let subsidy = 0;
        let hasPV = (panelCount > 0);
        let hasBattery = batCheckbox.checked;
        let hasHeat = heatCheckbox.checked;
        if(hasPV && hasBattery && hasHeat) {
            subsidy = 28000;
        } else if(hasPV && hasBattery) {
            subsidy = 23000;
        } else if(hasPV && hasHeat && !hasBattery) {
            subsidy = 12000;
        } else if(!hasPV && hasBattery) {
            // tylko magazyn energii
            if(hasBattery) {
                let batCost = batteries[batterySelect.value].price || 0;
                subsidy = Math.min(0.5 * batCost, 16000);
            }
        } else {
            subsidy = 0;
        }
        document.getElementById('subsidyAmount').textContent = formatCurrency(subsidy);
    }
    // Formatuj kwotę do 2 miejsc (z separatorem dziesiętnym przecinkowym)
    function formatCurrency(value) {
        return (Math.round(value * 100) / 100).toFixed(2).replace('.', ',') + " zł";
    }
    // Nasłuchiwanie zdarzeń (zmiana pól formularza)
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        // Reakcje na zmiany pól:
        document.getElementById('panelSelect').addEventListener('change', recalc);
        document.getElementById('panelCount').addEventListener('input', recalc);
        document.getElementById('includeInverter').addEventListener('change', recalc);
        document.getElementById('includeBattery').addEventListener('change', recalc);
        document.getElementById('includeHeat').addEventListener('change', recalc);
        document.getElementById('inverterSelect').addEventListener('change', function() {
            inverterManual = true;
            recalc();
        });
        document.getElementById('batterySelect').addEventListener('change', function() {
            batteryManual = true;
            recalc();
        });
        document.getElementById('heatSelect').addEventListener('change', recalc);
        document.getElementById('trenchLength').addEventListener('input', recalc);
        document.getElementById('cableLength').addEventListener('input', recalc);
        document.getElementById('numOptimizers').addEventListener('input', recalc);
        document.getElementById('numDBoard').addEventListener('input', recalc);
        document.getElementById('numMeter').addEventListener('input', recalc);
        document.getElementById('investorType').addEventListener('change', recalc);
        document.getElementById('buildingType').addEventListener('change', recalc);
        document.getElementById('buildingArea').addEventListener('input', recalc);
        document.getElementById('commissionPercent').addEventListener('input', recalc);
        // Obsługa przycisku Drukuj
        document.getElementById('printButton').addEventListener('click', function() {
            window.print();
        });
        // Zmiana kategorii przy dodawaniu komponentu – dostosowanie etykiety pola "specyfikacja"
        document.getElementById('newCategory').addEventListener('change', function() {
            const labelSpec = document.getElementById('labelSpec');
            switch(this.value) {
                case 'panel': labelSpec.textContent = 'Moc [W]'; break;
                case 'inverter': labelSpec.textContent = 'Moc [kW]'; break;
                case 'battery': labelSpec.textContent = 'Pojemność [kWh]'; break;
                case 'heat': labelSpec.textContent = 'Pojemność [l]'; break;
            }
        });
        // Dodawanie nowego komponentu do katalogu
        document.getElementById('addComponentBtn').addEventListener('click', function() {
            const cat = document.getElementById('newCategory').value;
            const brand = document.getElementById('newBrand').value.trim();
            const model = document.getElementById('newModel').value.trim();
            const specVal = parseFloat(document.getElementById('newSpec').value) || 0;
            const priceVal = parseFloat(document.getElementById('newPrice').value) || 0;
            if(!brand || !model || priceVal <= 0) {
                alert("Wypełnij poprawnie wszystkie pola nowego komponentu.");
                return;
            }
            if(cat === 'panel') {
                panels.push({ brand: brand, model: model, power: specVal, price: priceVal });
            } else if(cat === 'inverter') {
                inverters.push({ brand: brand, model: model, power: specVal, price: priceVal });
            } else if(cat === 'battery') {
                batteries.push({ brand: brand, model: model, capacity: specVal, price: priceVal });
            } else if(cat === 'heat') {
                heats.push({ brand: brand, model: model, capacity: specVal, price: priceVal });
            }
            populateSelects();  // odśwież listy z dodanym elementem
            alert("Dodano komponent: " + brand + " " + model);
            saveCatalog();
        });
        // Zapis bieżącego katalogu do localStorage
        document.getElementById('saveCatalogBtn').addEventListener('click', function() {
            saveCatalog();
            alert("Zapisano zmiany katalogu (lokalnie).");
        });
    });
    // Zapis katalogu komponentów do localStorage
    function saveCatalog() {
        const data = {
            panels: panels,
            inverters: inverters,
            batteries: batteries,
            heats: heats,
            additional: additionalItems
        };
        localStorage.setItem('componentsData', JSON.stringify(data));
    }
</script>
</body>
</html>
