<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON — Komponenty: Fotowoltaika (Kalkulator — all-in-one)</title>
<style>
  :root{
    --bg:#0a0f1e; --ink:#e8edff; --muted:#aeb8da; --line:#243059; --card:#0f1533; --card2:#121a34;
    --accent:#4cc9f0; --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;background:#11183a;border-bottom:1px solid #2a3a59;display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:20px}
  header .actions a{color:#cfe1ff;text-decoration:none;border:1px solid #2a3a75;padding:6px 10px;border-radius:10px}
  header .actions a:hover{background:#223160}
  .wrap{max-width:1350px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .grid{display:grid;gap:14px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:1.25fr 0.75fr} }
  label{display:block;margin:6px 0 6px 2px;font-size:13px;color:#cfe1ff}
  select,input,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px 10px;color:#cfe1ff;font:inherit}
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.warn{background:#5a3c12;border-color:#c48a26}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid #243059;text-align:left;vertical-align:top}
  thead th{font-size:12px;color:#aeb8da}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:12px}
  .stack{display:grid;gap:10px}
  .sum{font-size:18px;font-weight:700}
  .title{font-weight:700;color:#dce6ff}
  .split{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media(max-width:780px){ .split{grid-template-columns:1fr} }
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a75;background:#0d1530;color:#cfe1ff;font-size:12px}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #2a3a75;background:#0d1530;border-radius:999px;padding:4px 8px;font-size:12px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  .hr{height:1px;background:#243059;margin:8px 0}
  .label-small{font-size:11px;color:#aeb8da;margin-left:6px}
  .sticky{position:sticky;top:12px}
  .no-print{display:block}
  .gap-6{gap:6px}
  .gap-8{gap:8px}
  .max-w-140{max-width:140px}
  .max-w-120{max-width:120px}
  .max-w-100{max-width:100px}
  .max-w-90{max-width:90px}
  .max-w-180{max-width:180px}
  .max-w-200{max-width:200px}
  .max-w-320{max-width:320px}
  .justify-between{justify-content:space-between}
  .hidden{display:none}
  /* DUŻE CENY */
  .priceBlock{display:grid;gap:6px;margin:8px 0 12px}
  .priceLine{display:flex;justify-content:space-between;align-items:baseline;background:#0d1530;border:1px solid #2b3a77;border-radius:12px;padding:10px 12px}
  .priceLine .label{font-size:13px;color:#cfe1ff}
  .priceLine .value{font-size:22px;font-weight:800}
  .subGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .subCell{background:#0d1530;border:1px dashed #2b3a77;border-radius:10px;padding:8px 10px}
  .subCell .small{font-size:12px;color:#aeb8da}
  .subCell .big{font-size:16px;font-weight:800}
  @media print{ .no-print{display:none!important} body{background:#fff;color:#000} .card{background:#fff;color:#000;border-color:#000} th,td{border-color:#000} a{text-decoration:none;color:#000} }
</style>
</head>
<body>
<header>
  <div>
    <h1>Komponenty • Fotowoltaika — ARKON</h1>
    <div class="muted">Wycena zestawu PV w 1–2 kliknięciach. Auto-dobór, pakiety, dotacje, VAT, wydruk i zapis oferty.</div>
  </div>
  <div class="actions no-print">
    <a href="index.html">⟵ Pulpit</a>
  </div>
</header>

<div class="wrap">
  <div class="grid cols-2">
    <!-- LEWA -->
    <div class="card">
      <label class="row gap-6"><input type="radio" name="mode" value="set" checked> zestaw (kW)</label>
      <label class="row gap-6"><input type="radio" name="mode" value="manual"> ręcznie (szt.)</label>
      <div class="hr"></div>

      <div class="stack">
        <!-- Zestaw / Panele -->
        <div class="split">
          <div>
            <label class="title" for="setKW">Zestaw — moc (kW)</label>
            <select id="setKW">
              <option>2.7</option><option>3.6</option><option>4.5</option><option selected>5.0</option>
              <option>6.0</option><option>7.2</option><option>9.0</option><option>10.0</option>
            </select>
            <div class="muted">W trybie „zestaw” liczba paneli liczy się automatycznie z mocy panelu.</div>
          </div>
          <div>
            <label class="title" for="panelSelect">Panele (firma + model)</label>
            <select id="panelSelect"></select>
            <div class="muted">Moc panelu: <b id="panelWatt">—</b> W <span id="benchKW" class="badge hidden"></span></div>
          </div>
        </div>

        <div id="manualBlock" class="hidden">
          <label class="title" for="panelCount">Liczba paneli (szt.)</label>
          <input id="panelCount" type="number" min="0" step="1" value="10">
          <div class="muted">Tryb „ręcznie” liczy moc zestawu z paneli.</div>
        </div>

        <!-- Falownik / Bateria -->
        <div class="split">
          <div>
            <label class="title" for="inverterSelect">Falownik</label>
            <select id="inverterSelect"></select>
            <div class="row">
              <span id="ratioBadge" class="chip"><span class="dot"></span><span id="ratioText">DC/AC —</span></span>
              <span class="label-small">docelowo ~0.9–1.1</span>
            </div>
          </div>
          <div>
            <label class="title" for="batterySelect">Magazyn energii (opcjonalnie)</label>
            <select id="batterySelect"><option value="none">Brak</option></select>
            <div class="muted">Auto-sugestia: pojemność ≥ moc PV (kW). Wybór baterii wymusi falownik hybrydowy.</div>
          </div>
        </div>

        <!-- Magazyn ciepła -->
        <div>
          <label class="title" for="heatSelect">Magazyn ciepła (opcjonalnie)</label>
          <select id="heatSelect"><option value="none">Brak</option></select>
          <div class="muted">Ryczałt 3000 zł/szt. — wybierz pojemność.</div>
        </div>

        <!-- Montaż / kabel -->
        <div class="split">
          <div>
            <label class="title" for="mountType">Montaż</label>
            <select id="mountType">
              <option value="pitched" selected>Dach skośny (0 zł)</option>
              <option value="flat">Dach płaski (+500 zł)</option>
              <option value="ground">Grunt (+500 zł + przekop)</option>
            </select>
          </div>
          <div>
            <label class="title" for="cableExtra">Dodatkowy kabel ponad 20 m</label>
            <div class="row">
              <input id="cableExtra" class="max-w-140" type="number" min="0" step="1" value="0">
              <span class="muted">50 zł / m</span>
            </div>
          </div>
        </div>

        <!-- Pakiety / dodatki -->
        <div class="row">
          <label class="row gap-8"><input type="checkbox" id="transportYes"> transport i logistyka (450 zł)</label>
        </div>

        <div class="split">
          <div>
            <label class="title">Pakiety akcesoriów</label>
            <div class="stack">
              <label class="row gap-8"><input type="checkbox" id="pkgMeterBoard"> licznik + rozdzielnia</label>
              <label class="row gap-8"><input type="checkbox" id="pkgOptAuto"> optymalizatory (auto: = liczba paneli)</label>
              <label class="row gap-8"><input type="checkbox" id="pkgTrench"> przekop (ryczałt +2000 zł)</label>
            </div>
          </div>
          <div>
            <label class="title">Ustawienia ręczne</label>
            <div class="stack">
              <div class="row gap-8">
                <label class="row gap-6"><input type="checkbox" id="optManual"> optymalizatory ręcznie</label>
                <input id="optQty" class="max-w-120" type="number" min="0" step="1" value="0" placeholder="0" title="Ilość optymalizatorów">
                <span class="muted">@ 230 zł/szt.</span>
              </div>
              <div class="row gap-8">
                <label class="row gap-6"><input type="checkbox" id="meterYes"> licznik (410 zł)</label>
                <label class="row gap-6"><input type="checkbox" id="boardYes"> rozdzielnia (820 zł)</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Przekop -->
        <div>
          <label class="title" for="trenchYes">Przekop (ryczałt)</label>
          <div class="row">
            <input id="trenchYes" type="checkbox">
            <span class="muted">+2000 zł • przy „Grunt” włączamy automatycznie (możesz odznaczyć).</span>
          </div>
        </div>

        <div class="hr"></div>

        <!-- VAT / rabat / prowizja / dotacja -->
        <div class="split">
          <div>
            <label class="title">Inwestor & VAT</label>
            <div class="row">
              <select id="investorType" class="max-w-180" title="Typ inwestora">
                <option value="private" selected>Osoba prywatna</option>
                <option value="company">Firma</option>
              </select>
              <div class="row gap-6">
                <label for="area" class="muted">Pow. domu</label>
                <input id="area" class="max-w-100" type="number" min="1" value="120">
                <span class="muted">m²</span>
              </div>
            </div>
            <div class="muted">Dom ≤300 m² / mieszkanie ≤150 m² → 8% VAT; firma → 23%.</div>
          </div>
          <div>
            <label class="title">Rabat</label>
            <div class="row">
              <input id="discountValue" class="max-w-120" type="number" min="0" step="1" value="0" placeholder="rabat">
              <select id="discountType" class="max-w-90" title="Typ rabatu">
                <option value="amount">zł</option>
                <option value="percent">%</option>
              </select>
            </div>
          </div>
        </div>

        <div class="split">
          <div>
            <label class="title">Prowizja handlowca</label>
            <div class="row">
              <input id="commissionPct" class="max-w-120" type="number" min="0" step="0.1" value="0" placeholder="0.0" title="Procent prowizji">
              <span class="muted">%</span>
            </div>
            <div class="muted">Liczona od NETTO po rabacie + ukryty narzut firmy.</div>
          </div>
          <div>
            <label class="title">Przypisanie prowizji do dotacji</label>
            <select id="commissionAssign" class="max-w-200" title="Jak doliczać prowizję do podstawy dotacji">
              <option value="panels" selected>Do paneli</option>
              <option value="prop">Proporcjonalnie (kwalifikowane)</option>
            </select>
            <div class="muted">Wpływa tylko na cenę kwalifikowaną.</div>
          </div>
        </div>

        <div class="split">
          <div>
            <label class="title">Dotacja „Mój Prąd”</label>
            <div class="row">
              <select id="subsidyMode" class="max-w-200" title="Tryb dotacji">
                <option value="apply" selected>Zastosuj (auto)</option>
                <option value="ignore">Nie stosuj</option>
              </select>
              <span class="muted">limit ≤ 50% kosztów kwalifikowanych (NETTO)</span>
            </div>
          </div>
          <div>
            <label class="title" for="notes">Uwagi do oferty</label>
            <textarea id="notes" placeholder="Warunki montażu, termin, uwagi techniczne…"></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Zapis / eksport -->
        <div class="row no-print">
          <input id="offerName" class="max-w-320" placeholder="Nazwa oferty (np. Kowalski 5kW)">
          <button id="btnSave" class="btn ok">Zapisz</button>
          <button id="btnLoad" class="btn ghost">Wczytaj</button>
          <button id="btnExportJSON" class="btn ghost">Eksport JSON</button>
          <button id="btnExportCSV" class="btn ghost">Eksport CSV</button>
          <button id="btnPrint" class="btn warn">Drukuj / PDF</button>
          <button id="btnReset" class="btn bad">Reset</button>
        </div>
      </div>
    </div>

    <!-- PRAWA: PODSUMOWANIE -->
    <div class="card sticky">
      <div class="stack">
        <div class="row justify-between">
          <span class="pill">Moc zestawu PV</span>
          <span id="pvKW" class="sum">0.00 kW</span>
        </div>

        <!-- DUŻE CENY -->
        <div class="priceBlock">
          <div class="priceLine">
            <span class="label">Cena NETTO (klient)</span>
            <span id="finalNet" class="value">0,00 zł</span>
          </div>
          <div class="priceLine">
            <span class="label">Cena BRUTTO (klient)</span>
            <span id="finalGross" class="value">0,00 zł</span>
          </div>

          <div class="subGrid">
            <div class="subCell">
              <div class="small">Cena kwalifikowana do dotacji (NETTO)</div>
              <div id="eligibleBase" class="big">0,00 zł</div>
            </div>
            <div class="subCell">
              <div class="small">Dotacja (NETTO)</div>
              <div id="subsidy" class="big">0,00 zł</div>
              <div id="subsidyCapLabel" class="small"></div>
            </div>
          </div>

          <div class="subGrid">
            <div class="subCell">
              <div class="small">Po dotacji — NETTO (informacyjnie)</div>
              <div id="afterSubsidyNet" class="big">0,00 zł</div>
            </div>
            <div class="subCell">
              <div class="small">Po dotacji — BRUTTO (informacyjnie)</div>
              <div id="afterSubsidyGross" class="big">0,00 zł</div>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr><th>Pozycja</th><th>Ilość</th><th>Netto</th></tr>
          </thead>
          <tbody id="lines"></tbody>
          <tfoot id="totals"></tfoot>
        </table>

        <div class="row justify-between hidden">
          <span class="pill">Benchmark</span>
          <span id="benchFinal" class="sum">— zł/kW</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Wbudowane CSV ===== -->
<script type="text/csv" id="csv_panels">
name;power (W);price
JINKO JKM445N-54HL4R-B Full Black;445;240
TRINA Vertex S+ 440 FB;440;200
LONGI LR7-54HTH-460M;460;225
JA SOLAR JAM60D41-500/LB Full Black;500;250
</script>

<script type="text/csv" id="csv_inverters">
name;power (kW);price;type
DEYE SUN-6K-SG04LP3-EU;6;4200;on-grid
HUAWEI SUN2000-10KTL-M1;10;3953;on-grid
SOFAR HYD 10KTL-3PH (hyb.);10;6227;hybrid
GOODWE GW10K-ET-20 (hyb.);10;4631;hybrid
</script>

<script type="text/csv" id="csv_batteries">
name;capacity (kWh);price
HUAWEI LUNA2000-5;5;12000
HUAWEI LUNA2000-10;10;22000
GOODWE Lynx Home F 9.6;9.6;23000
</script>

<script type="text/csv" id="csv_heat">
name;capacity (l);price
ARKON HeatTank 200;200;3000
ARKON HeatTank 300;300;3000
ARKON HeatTank 500;500;3000
</script>

<script>
(() => {
  // ===== Stawki i ukryty narzut firmy =====
  const COMPANY_MARGIN = 8000; // ukryty, doliczany do NETTO klienta (nie jako pozycja)
  const COST_OPT = 230;
  const COST_METER = 410;
  const COST_BOARD = 820;
  const COST_TRENCH = 2000;
  const COST_CABLE = 50;
  const MOUNT_FLAT = 500;
  const MOUNT_GROUND = 500;
  const COST_TRANSPORT = 450;

  // ===== Dane =====
  let PANELS = [], INVERTERS = [], BATTERIES = [], HEATS = [];
  let lastManualPick = { inverter: false, battery: false };

  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const PLN = v => (Math.round((+v || 0) * 100) / 100).toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' zł';
  const zloty = v => Math.round((+v || 0) * 100) / 100;

  function parseInlineCSV(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    const txt = el.textContent.trim();
    if (!txt) return null;
    const rows = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!rows.length) return null;
    const delim = rows[0].includes(';') ? ';' : ',';
    const head = rows[0].split(delim).map(h => h.trim().toLowerCase());
    return rows.slice(1).map(line => {
      const col = line.split(delim).map(c => c.replace(/^"|"$/g, '').trim());
      const o = {};
      head.forEach((h, i) => { o[h] = col[i] ?? ''; });
      return o;
    });
  }

  function loadEmbedded() {
    const P = parseInlineCSV('csv_panels') || [];
    PANELS = P.map(x => ({ name: x['name'], watt: +(x['power (w)'] || x['power'] || 0), price: +(x['price'] || 0) }))
      .filter(x => x.name && x.watt > 0);

    const I = parseInlineCSV('csv_inverters') || [];
    INVERTERS = I.map(x => {
      const name = x['name'];
      const kw = +(x['power (kw)'] || x['power'] || 0);
      const price = +(x['price'] || 0);
      const t = String(x['type'] || name || '').toLowerCase();
      const hybrid = /hyb/.test(t) || /hybrid/.test(t);
      return { name, kw, price, hybrid };
    }).filter(x => x.name && x.kw > 0);

    const B = parseInlineCSV('csv_batteries') || [];
    BATTERIES = B.map(x => ({ name: x['name'], kwh: +(x['capacity (kwh)'] || x['kwh'] || 0), price: +(x['price'] || 0) }))
      .filter(x => x.name && x.kwh > 0);

    const H = parseInlineCSV('csv_heat') || [];
    HEATS = H.map(x => ({ name: x['name'], l: +(x['capacity (l)'] || x['l'] || 0), price: +(x['price'] || 3000) }))
      .filter(x => x.name && x.l > 0);
  }

  function populateAll() {
    const selP = $('#panelSelect'); selP.innerHTML = '';
    PANELS.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = p.name + ' (' + p.watt + ' W)';
      selP.appendChild(o);
    });
    $('#panelWatt').textContent = PANELS[0] ? PANELS[0].watt : '—';

    const selI = $('#inverterSelect'); selI.innerHTML = '';
    INVERTERS.forEach((x, i) => {
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = x.name + ' (' + x.kw + ' kW' + (x.hybrid ? ' • hyb.' : '') + ')';
      selI.appendChild(o);
    });

    const selB = $('#batterySelect'); selB.innerHTML = '<option value="none">Brak</option>';
    BATTERIES.forEach((b, i) => {
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = b.name + ' (' + b.kwh + ' kWh)';
      selB.appendChild(o);
    });

    const selH = $('#heatSelect'); selH.innerHTML = '<option value="none">Brak</option>';
    HEATS.forEach((h, i) => {
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = h.name + ' (' + h.l + ' l)';
      selH.appendChild(o);
    });
  }

  function vatRate() {
    if ($('#investorType').value === 'company') return 0.23;
    const area = Math.max(0, +$('#area').value || 0);
    return (area <= 300) ? 0.08 : 0.23;
  }

  function autoPickInverter(pvKW, needHybrid) {
    if (lastManualPick.inverter) return;
    let best = -1, bestKW = Infinity;
    INVERTERS.forEach((inv, i) => {
      if (needHybrid && !inv.hybrid) return;
      if (!needHybrid && inv.hybrid) return;
      if (inv.kw >= pvKW && inv.kw < bestKW) { best = i; bestKW = inv.kw; }
    });
    if (best < 0) {
      let mx = -1, mxKW = -1;
      INVERTERS.forEach((inv, i) => {
        if (needHybrid && !inv.hybrid) return;
        if (!needHybrid && inv.hybrid) return;
        if (inv.kw > mxKW) { mx = i; mxKW = inv.kw; }
      });
      if (mx >= 0) best = mx; else best = 0;
    }
    $('#inverterSelect').value = String(best);
  }

  function autoPickBattery(pvKW) {
    if (lastManualPick.battery) return;
    let best = -1, bestK = Infinity;
    BATTERIES.forEach((b, i) => { if (b.kwh >= pvKW && b.kwh < bestK) { best = i; bestK = b.kwh; } });
    if (best < 0 && BATTERIES.length) best = BATTERIES.length - 1;
    if (best >= 0) { $('#batterySelect').value = String(best); }
  }

  function dcAcBadge(dcKW, acKW) {
    const textEl = $('#ratioText');
    const dotEl = $('#ratioBadge .dot');
    if (!acKW) { textEl.textContent = 'DC/AC —'; dotEl.className = 'dot'; return; }
    const r = (dcKW / acKW);
    let cls = 'warn'; if (r >= 0.8 && r <= 1.2) cls = 'ok'; if (r < 0.6 || r > 1.4) cls = 'bad';
    textEl.textContent = 'DC/AC ' + r.toFixed(2);
    dotEl.className = 'dot ' + cls;
  }

  // Pułap dotacji wg konfiguracji — SZTYWNE: 12/16/23/28 tys. (NETTO)
  function subsidyCap(flags) {
    if (flags.hasPV && flags.hasBat && flags.hasHeat) return 28000;
    if (flags.hasPV && flags.hasBat && !flags.hasHeat) return 23000;
    if (flags.hasPV && flags.hasHeat && !flags.hasBat) return 12000;
    if (!flags.hasPV && flags.hasBat) return 16000;
    return 0;
  }

  function recalc() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const setKW = +$('#setKW').value;
    const panel = PANELS[+$('#panelSelect').value] || null;

    // liczba paneli
    let qtyPanels = 0;
    if (mode === 'set') {
      qtyPanels = (panel && panel.watt > 0) ? Math.ceil(setKW * 1000 / panel.watt) : 0;
      $('#manualBlock').style.display = 'none';
    } else {
      qtyPanels = Math.max(0, +$('#panelCount').value || 0);
      $('#manualBlock').style.display = 'block';
    }
    const pvKW = panel ? (panel.watt * qtyPanels) / 1000 : 0;
    $('#pvKW').textContent = pvKW.toFixed(2) + ' kW';

    // info o panelu
    const benchKWEl = document.getElementById('benchKW');
    if (panel && panel.watt > 0) {
      if (benchKWEl) benchKWEl.textContent = PLN(panel.price * (1000 / panel.watt));
      document.getElementById('panelWatt').textContent = panel.watt;
    } else {
      if (benchKWEl) benchKWEl.textContent = '— zł/kW';
      document.getElementById('panelWatt').textContent = '—';
    }

    // bateria/auto
    const batVal = $('#batterySelect').value;
    const battery = (batVal === 'none') ? null : BATTERIES[+batVal];
    if (!lastManualPick.battery && $('#batterySelect').value !== 'none' && pvKW > 0) autoPickBattery(pvKW);

    // falownik
    const needHybrid = !!battery;
    autoPickInverter(pvKW, needHybrid);
    const inverter = INVERTERS[+$('#inverterSelect').value] || null;
    dcAcBadge(pvKW, inverter ? inverter.kw : 0);

    // montaż i pakiety
    const mount = $('#mountType').value;
    if (mount === 'ground' && !$('#trenchYes').checked) $('#trenchYes').checked = true;

    const pkgMeterBoard = $('#pkgMeterBoard').checked;
    const pkgOptAuto = $('#pkgOptAuto').checked;

    const optManual = $('#optManual').checked;
    const optQty = Math.max(0, +$('#optQty').value || 0);
    const meterYes = $('#meterYes').checked || pkgMeterBoard;
    const boardYes = $('#boardYes').checked || pkgMeterBoard;

    // ===== pozycje NETTO (bez prowizji i narzutu firmy) =====
    const lines = [];
    if (panel && qtyPanels > 0) lines.push({ name: 'Panele: ' + panel.name, qty: qtyPanels + ' szt.', net: zloty(panel.price * qtyPanels) });
    if (inverter && pvKW > 0) lines.push({ name: 'Falownik: ' + inverter.name, qty: '1 szt.', net: zloty(inverter.price) });
    if (battery) lines.push({ name: 'Magazyn energii: ' + battery.name, qty: '1 szt.', net: zloty(battery.price) });

    const heatVal = $('#heatSelect').value;
    if (heatVal !== 'none') { const ht = HEATS[+heatVal]; if (ht) lines.push({ name: 'Magazyn ciepła: ' + ht.name, qty: '1 szt.', net: zloty(ht.price) }); }

    if (mount === 'flat' && qtyPanels > 0) lines.push({ name: 'Montaż: dach płaski (dopłata)', qty: '1 kpl.', net: zloty(MOUNT_FLAT) });
    if (mount === 'ground' && qtyPanels > 0) lines.push({ name: 'Montaż: grunt (dopłata)', qty: '1 kpl.', net: zloty(MOUNT_GROUND) });
    if ($('#trenchYes').checked) lines.push({ name: 'Przekop instalacyjny (ryczałt)', qty: '1 kpl.', net: zloty(COST_TRENCH) });

    const cableExtra = Math.max(0, +$('#cableExtra').value || 0);
    if (cableExtra > 0) lines.push({ name: 'Dodatkowy kabel (ponad 20 m)', qty: cableExtra + ' m', net: zloty(cableExtra * COST_CABLE) });

    if (pkgOptAuto && qtyPanels > 0) lines.push({ name: 'Optymalizatory mocy (auto)', qty: qtyPanels + ' szt.', net: zloty(qtyPanels * COST_OPT) });
    if (optManual && optQty > 0) lines.push({ name: 'Optymalizatory mocy (ręcznie)', qty: optQty + ' szt.', net: zloty(optQty * COST_OPT) });

    if (meterYes) lines.push({ name: 'Licznik produkcji 3F', qty: '1 szt.', net: zloty(COST_METER) });
    if (boardYes) lines.push({ name: 'Rozdzielnia AC/DC', qty: '1 szt.', net: zloty(COST_BOARD) });

    if ($('#transportYes').checked) lines.push({ name: 'Transport i logistyka', qty: '1 kpl.', net: zloty(COST_TRANSPORT) });

    // sumy bazowe NETTO
    const netBase = lines.reduce((a, l) => a + l.net, 0);

    // rabat
    const dVal = Math.max(0, +$('#discountValue').value || 0);
    const dType = $('#discountType').value;
    const discount = dVal > 0 ? (dType === 'percent' ? zloty(netBase * (dVal / 100)) : zloty(dVal)) : 0;
    const netAfterDiscount = Math.max(0, zloty(netBase - discount));

    // prowizja (od NETTO po rabacie + narzut firmy)
    const commPct = Math.max(0, +$('#commissionPct').value || 0);
    const baseForCommission = zloty(netAfterDiscount + COMPANY_MARGIN);
    const commNet = zloty(baseForCommission * (commPct / 100));

    // NETTO klienta = po rabacie + narzut + prowizja
    const clientNet = zloty(netAfterDiscount + COMPANY_MARGIN + commNet);

    // VAT / BRUTTO
    const vatR = vatRate();
    const vatAmt = zloty(clientNet * vatR);
    const clientGross = zloty(clientNet + vatAmt);

    // ===== DOTACJA — tylko NETTO =====
    const flags = { hasPV: qtyPanels > 0, hasBat: !!battery, hasHeat: (heatVal !== 'none') };
    const cap = subsidyCap(flags);

    // Cena kwalifikowana = całe NETTO klienta
    const eligibleNet = zloty(clientNet);

    // Dotacja NETTO
    let subsidyNet = 0;
    if ($('#subsidyMode').value === 'apply') {
      if (flags.hasPV && !flags.hasBat && !flags.hasHeat) {
        subsidyNet = 0;
      } else {
        subsidyNet = Math.floor(Math.min(cap, eligibleNet * 0.5));
      }
    }

    // Po dotacji — NETTO i BRUTTO (BRUTTO liczone od NETTO po dotacji)
    const netAfterSubsidy   = Math.max(0, zloty(clientNet - subsidyNet));
    const grossAfterSubsidy = zloty(netAfterSubsidy * (1 + vatR));

    // benchmark (ukryte w UI)
    const benchFinal = (pvKW > 0) ? zloty(clientNet / pvKW) : 0;

    // ===== render: pozycje (bez paneli i falownika) =====
    const tbody = $('#lines'); 
    tbody.innerHTML = '';
    lines
      .filter(l => !/^Panele:|^Falownik:/.test(l.name))
      .forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + l.name + '</td><td>' + l.qty + '</td><td>' + PLN(l.net) + '</td>';
        tbody.appendChild(tr);
      });

    // ===== render: stopka (końcowe ceny) =====
    const tfoot = $('#totals'); tfoot.innerHTML = '';
    function add(label, val, bold = false) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<th class="' + (bold ? 'title' : '') + '">' + label + '</th><th></th><th class="' + (bold ? 'sum' : '') + '">' + PLN(val) + '</th>';
      tfoot.appendChild(tr);
    }
    add('RAZEM netto (pozycje)', netBase);
    if (discount > 0) add('Rabat (' + (dType === 'percent' ? dVal + '%' : 'kwotowy') + ')', zloty(-discount));
    if (commNet > 0) add('Prowizja handlowca (' + commPct.toFixed(1) + '%)', commNet);
    add('RAZEM netto (klient)', clientNet, true);
    add('VAT ' + Math.round(vatR * 100) + '%', vatAmt);
    add('RAZEM brutto (klient)', clientGross, true);
    const tr = document.createElement('tr');
    tr.innerHTML = '<th class="title">DO ZAPŁATY (po dotacji)</th><th></th><th class="sum">' + PLN(grossAfterSubsidy) + '</th>';
    tfoot.appendChild(tr);

    // ===== render: duże liczby + etykiety =====
    $('#finalNet').textContent = PLN(clientNet);
    $('#finalGross').textContent = PLN(clientGross);
    $('#eligibleBase').textContent      = PLN(eligibleNet);
    $('#subsidy').textContent           = PLN(subsidyNet);
    $('#afterSubsidyNet').textContent   = PLN(netAfterSubsidy);
    $('#afterSubsidyGross').textContent = PLN(grossAfterSubsidy);

    const benchFinalEl = document.getElementById('benchFinal');
    if (benchFinalEl) benchFinalEl.textContent = (pvKW > 0 ? PLN(benchFinal).replace(' zł', '') + ' /kW' : '— zł/kW');

    const capEl = document.getElementById('subsidyCapLabel');
    if (capEl) {
      if ($('#subsidyMode').value === 'apply' && cap > 0) {
        capEl.textContent = 'Pułap dla tej konfiguracji: ' + PLN(cap);
      } else if ($('#subsidyMode').value === 'apply') {
        capEl.textContent = 'Pułap dla tej konfiguracji: 0,00 zł';
      } else {
        capEl.textContent = '';
      }
    }
  }

  // ===== snapshot / zapisy =====
  function snapshot() {
    return {
      mode: document.querySelector('input[name="mode"]:checked').value,
      setKW: $('#setKW').value,
      panel: +$('#panelSelect').value,
      panelCount: +($('#panelCount').value || 0),
      inverter: +$('#inverterSelect').value,
      battery: $('#batterySelect').value,
      heat: $('#heatSelect').value,
      mount: $('#mountType').value,
      cableExtra: +($('#cableExtra').value || 0),
      pkgMeterBoard: $('#pkgMeterBoard').checked,
      pkgOptAuto: $('#pkgOptAuto').checked,
      optManual: $('#optManual').checked,
      optQty: +($('#optQty').value || 0),
      meterYes: $('#meterYes').checked,
      boardYes: $('#boardYes').checked,
      trenchYes: $('#trenchYes').checked,
      transportYes: $('#transportYes').checked,
      investorType: $('#investorType').value,
      area: +($('#area').value || 0),
      commissionPct: +($('#commissionPct').value || 0),
      commissionAssign: $('#commissionAssign').value,
      subsidyMode: $('#subsidyMode').value,
      discountValue: +($('#discountValue').value || 0),
      discountType: $('#discountType').value,
      notes: $('#notes').value
    };
  }

  function restore(state) {
    if (!state) return;
    const modeVal = state.mode || 'set';
    const sel = document.querySelector('input[name="mode"][value="' + modeVal + '"]');
    if (sel) sel.checked = true;
    $('#manualBlock').style.display = (state.mode === 'manual') ? 'block' : 'none';
    $('#setKW').value = state.setKW || '5.0';
    $('#panelSelect').value = String(state.panel || 0);
    $('#panelCount').value = state.panelCount || 0;
    $('#inverterSelect').value = String(state.inverter || 0);
    $('#batterySelect').value = state.battery || 'none';
    $('#heatSelect').value = state.heat || 'none';
    $('#mountType').value = state.mount || 'pitched';
    $('#cableExtra').value = state.cableExtra || 0;
    $('#pkgMeterBoard').checked = !!state.pkgMeterBoard;
    $('#pkgOptAuto').checked = !!state.pkgOptAuto;
    $('#optManual').checked = !!state.optManual;
    $('#optQty').value = state.optQty || 0;
    $('#meterYes').checked = !!state.meterYes;
    $('#boardYes').checked = !!state.boardYes;
    $('#trenchYes').checked = !!state.trenchYes;
    $('#transportYes').checked = !!state.transportYes;
    $('#investorType').value = state.investorType || 'private';
    $('#area').value = state.area || 120;
    $('#commissionPct').value = state.commissionPct || 0;
    $('#commissionAssign').value = state.commissionAssign || 'panels';
    $('#subsidyMode').value = state.subsidyMode || 'apply';
    $('#discountValue').value = state.discountValue || 0;
    $('#discountType').value = state.discountType || 'amount';
    $('#notes').value = state.notes || '';
    recalc();
  }

  function saveOffer() {
    const name = ($('#offerName').value || '').trim();
    if (!name) { alert('Podaj nazwę oferty.'); return; }
    const list = JSON.parse(localStorage.getItem('pv_offers') || '{}');
    list[name] = snapshot();
    localStorage.setItem('pv_offers', JSON.stringify(list));
    alert('Zapisano ofertę: ' + name);
  }

  function loadOffer() {
    const list = JSON.parse(localStorage.getItem('pv_offers') || '{}');
    const names = Object.keys(list);
    if (!names.length) { alert('Brak zapisanych ofert.'); return; }
    const name = prompt('Podaj nazwę oferty do wczytania:\n' + names.join('\n'));
    if (!name) return;
    if (!list[name]) { alert('Nie znaleziono: ' + name); return; }
    $('#offerName').value = name;
    restore(list[name]);
  }

  function exportJSON() {
    const name = ($('#offerName').value || 'oferta').replace(/\W+/g, '_');
    const blob = new Blob([JSON.stringify(snapshot(), null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name + '.json'; a.click(); URL.revokeObjectURL(a.href);
  }

  function exportCSV() {
    const s = snapshot();
    const rows = [
      ['pole', 'wartość'],
      ['tryb', s.mode],
      ['zestaw_kW', s.setKW],
      ['panel', PANELS[s.panel]?.name || ''],
      ['panel_watt', PANELS[s.panel]?.watt || ''],
      ['panele_szt', s.panelCount],
      ['inwerter', INVERTERS[s.inverter]?.name || ''],
      ['bateria', s.battery === 'none' ? 'brak' : (BATTERIES[+s.battery]?.name || '')],
      ['magazyn_ciepla', s.heat === 'none' ? 'brak' : (HEATS[+s.heat]?.name || '')],
      ['montaz', s.mount],
      ['kabel_extra_m', s.cableExtra],
      ['pakiet_licznik_rozdzielnia', s.pkgMeterBoard],
      ['pakiet_opt_auto', s.pkgOptAuto],
      ['opt_manual', s.optManual],
      ['opt_qty', s.optQty],
      ['licznik', s.meterYes],
      ['rozdzielnia', s.boardYes],
      ['przekop', s.trenchYes],
      ['transport', s.transportYes],
      ['inwestor', s.investorType],
      ['powierzchnia', s.area],
      ['prowizja_pct', s.commissionPct],
      ['przypisanie_prowizji', s.commissionAssign],
      ['dotacja_tryb', s.subsidyMode],
      ['rabat', s.discountValue + (s.discountType === 'percent' ? '%' : ' zł')],
      ['uwagi', (s.notes || '').replace(/\n/g, ' ')]
    ];
    const csv = rows.map(r => r.map(x => String(x).includes(';') ? ('"' + String(x).replace(/"/g, '""') + '"') : String(x)).join(';')).join('\n');
    const name = ($('#offerName').value || 'oferta').replace(/\W+/g, '_');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name + '.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // BINDY
  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener('change', () => { $('#manualBlock').style.display = (r.value === 'manual' && r.checked) ? 'block' : 'none'; recalc(); });
  });
  $('#panelSelect').addEventListener('change', () => { lastManualPick.inverter = false; lastManualPick.battery = false; recalc(); });
  $('#panelCount').addEventListener('input', recalc);
  $('#setKW').addEventListener('change', recalc);
  $('#inverterSelect').addEventListener('change', () => { lastManualPick.inverter = true; recalc(); });
  $('#batterySelect').addEventListener('change', () => { lastManualPick.battery = true; recalc(); });
  $('#heatSelect').addEventListener('change', recalc);
  $('#mountType').addEventListener('change', recalc);
  $('#cableExtra').addEventListener('input', recalc);
  $('#pkgMeterBoard').addEventListener('change', recalc);
  $('#pkgOptAuto').addEventListener('change', recalc);
  $('#pkgTrench').addEventListener('change', () => { $('#trenchYes').checked = $('#pkgTrench').checked; recalc(); });
  $('#optManual').addEventListener('change', recalc);
  $('#optQty').addEventListener('input', recalc);
  $('#meterYes').addEventListener('change', recalc);
  $('#boardYes').addEventListener('change', recalc);
  $('#trenchYes').addEventListener('change', recalc);
  $('#transportYes').addEventListener('change', recalc);

  $('#investorType').addEventListener('change', recalc);
  $('#area').addEventListener('input', recalc);
  $('#commissionPct').addEventListener('input', recalc);
  $('#commissionAssign').addEventListener('change', recalc);
  $('#subsidyMode').addEventListener('change', recalc);
  $('#discountValue').addEventListener('input', recalc);
  $('#discountType').addEventListener('change', recalc);

  // start
  loadEmbedded();
  populateAll();
  recalc();
})();
</script>
</body>
</html>
