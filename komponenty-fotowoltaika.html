
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON — Fotowoltaika • Kalkulator zestawu (pakiety + stopka)</title>
<meta name="description" content="Kalkulator PV od kWp: pakiety akcesoriów (STANDARD/FLAT/GRUNT), ryczałt za kWp, podłoże, metry do falownika, optymalizatory, licznik, rozdzielnia, SPD, VAT, produkcja, wydruk.">
<style>
  :root{
    --bg:#0a0f1e; --ink:#e8edff; --muted:#aeb8da; --line:#243059; --card:#0f1533; --card2:#121a34;
    --accent:#4cc9f0; --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px 16px 8px;background:#11183a;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  header h1{margin:0;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  .wrap{max-width:1200px;margin:auto;padding:14px}
  .card{background:linear-gradient(180deg,#0f1533,#121a34);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  @media(min-width:1080px){ .cols-2{grid-template-columns:1.2fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr} }
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  textarea{min-height:72px}
  label{display:block;margin-bottom:6px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.warn{background:#5a3c12;border-color:#c48a26}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid #243059;text-align:left;vertical-align:top}
  th{font-size:13px;color:#aeb8da;white-space:nowrap}
  .narrow{max-width:140px}
  .big{font-size:28px;font-weight:800}
  .bench{display:inline-block;padding:2px 8px;border-radius:8px;border:1px solid #2a3777}
  .bench.good{border-color:#2b8a57}
  .bench.ok{border-color:#c48a26}
  .bench.bad{border-color:#ff6b6b}
  .tag{display:inline-block;border:1px solid #2a3777;color:#cfe0ff;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
  .presets .btn{padding:6px 10px}
  .gear{margin-left:auto;opacity:.65}
  .gear:hover{opacity:1}
  .hidden{display:none!important}
  .nowrap{white-space:nowrap}
  footer{max-width:1200px;margin:16px auto 24px;color:#aeb8da;font-size:12px;padding:0 14px}
  .footbox{border-top:1px solid #243059;padding-top:10px;display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between}
  .footcol{opacity:.9}
  .no-print{display:inline}
  .print-only{display:none}
  @media print{
    .no-print{display:none!important}
    body{background:#fff;color:#000}
    header{background:#fff;border:none;padding:0}
    .card{border:none;padding:0}
    .wrap{max-width:100%;padding:0 0}
    .print-only{display:block}
    h1{color:#000}
    .muted{color:#333}
    .bench{border-color:#000}
    footer{color:#000}
    .footbox{border-top:1px solid #000}
  }
  /* moved inline styles to classes */
  .section-title{margin:0 0 8px}
  .presets{margin-bottom:6px}
  .span-full{grid-column:span 3}

  dialog::backdrop{background:rgba(0,0,0,.6)}
  dialog{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#0f1533,#121a34);color:var(--ink);max-width:720px;width:92%;padding:0}
  .dlg-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
  .dlg-body{padding:12px 14px}
  .dlg-foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
  .info{font-size:12px;color:#aeb8da}
</style>
<style>
/* utility classes moved from inline styles */
.span-2{grid-column:span 2}
.span-3{grid-column:span 3}
.mt-6{margin-top:6px}
.mt-8{margin-top:8px}
.mt-10{margin-top:10px}
.mt-12{margin-top:12px}
.my-8{margin:8px 0}
.h2-tight{margin:0 0 8px}
.h1-tight{margin:0 0 4px}
.w-100{width:100%}
.full-width{grid-column:1 / -1}
.print-pad{padding:12px}
.font-14{font-size:14px}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>Komponenty • Fotowoltaika — ARKON <span class="tag">kalkulator od zestawu</span></h1>
    <button id="btnSettings" class="btn ghost gear no-print" title="Ustawienia niestandardowe (⚙)">⚙</button>
  </div>
  <div class="muted">Liczymy od mocy zestawu (min 2,7 kWp). Pakiety akcesoriów, podłoże (dach/flat/grunt), dodatki, VAT/NETTO, produkcja. Ceny jednostkowe paneli/falowników nie są pokazywane.</div>
</header>

<div class="wrap grid cols-2">
  <!-- LEWA: FORMULARZ ZESTAWU -->
  <section class="card">
    <h2 class="section-title">1) Zestaw</h2>

    <!-- PRESETY + MODUŁ REF + KLIENT/ADRES -->
    <div class="row presets no-print">
      <span class="pill">Presety mocy:</span>
      <button class="btn ghost" data-preset="2.7">2.7 kWp</button>
      <button class="btn ghost" data-preset="3.6">3.6 kWp</button>
      <button class="btn ghost" data-preset="4.5">4.5 kWp</button>
      <button class="btn ghost" data-preset="5.4">5.4 kWp</button>
      <button class="btn ghost" data-preset="6.2">6.2 kWp</button>
      <button class="btn ghost" data-preset="7.4">7.4 kWp</button>
      <button class="btn ghost" data-preset="8.9">8.9 kWp</button>
      <button class="btn ghost" data-preset="10.0">10.0 kWp</button>
      <span class="pill">Moduł ref. (W): 
        <select id="refW" title="Moduł referencyjny (W)">
          <option>410</option><option>430</option><option selected>445</option><option>460</option><option>500</option>
        </select>
      </span>
    </div>

    <div class="grid cols-3">
      <div>
        <label for="kwp">Moc zestawu DC [kWp] (min 2.7)</label>
        <input id="kwp" type="number" min="2.7" step="0.1" value="2.7" class="narrow" title="Moc zestawu w kWp" placeholder="np. 3.6">
      </div>
      <div>
        <label for="withInv">Falownik</label>
        <select id="withInv" class="narrow" title="Falownik: z falownikiem / bez">
          <option value="YES" selected>z falownikiem</option>
          <option value="NO">bez falownika</option>
        </select>
      </div>
      <div>
        <label for="vat">VAT</label>
        <select id="vat" class="narrow" title="Stawka VAT">
          <option value="0.08" selected>8%</option>
          <option value="0.23">23%</option>
        </select>
      </div>

      <div>
        <label for="substrate">Podłoże</label>
        <select id="substrate" class="narrow" title="Podłoże instalacji">
          <option value="roof-metal" selected>blachodachówka</option>
          <option value="roof-flat">dach płaski (+500)</option>
          <option value="ground">grunt (+1500)</option>
        </select>
      </div>
      <div>
        <label>Okablowanie (m) × 50 zł</label>
        <input id="cable" type="number" min="0" step="1" value="0" class="narrow" placeholder="np. 20">
      </div>
      <div>
        <label for="trench">Przekop (+2000 zł)</label>
        <select id="trench" class="narrow" title="Przekop">
          <option value="NO" selected>nie</option>
          <option value="YES">tak</option>
        </select>
      </div>

      <!-- PAKIETY AKCESORIÓW (GOTOWE) -->
      <div class="cols-3 span-full">
        <label for="accPreset">Pakiet akcesoriów (gotowy zestaw)</label>
        <div class="row">
          <select id="accPreset" class="narrow" title="Pakiet akcesoriów">
            <option value="NONE" selected>— brak —</option>
            <option value="CORE">STANDARD (Licznik + Rozdzielnia + SPD DC/AC)</option>
            <option value="FLAT">DACH PŁASKI (STANDARD + podłoże FLAT)</option>
            <option value="GROUND">GRUNT (STANDARD + podłoże GRUNT + Przekop)</option>
          </select>
          <span id="presetInfo" class="info">Wybierz pakiet, a resztę uzupełnię automatycznie.</span>
        </div>
      </div>

      <div>
        <label for="optims">Optymalizatory (opcja)</label>
        <select id="optims" class="narrow" title="Optymalizatory">
          <option value="NONE" selected>brak</option>
          <option value="ALL">na każdy panel (230 zł/szt.)</option>
        </select>
      </div>
      <div class="nowrap">
        <label>Tryb wyświetlania</label>
        <div class="row">
          <label><input type="radio" name="mode" value="GROSS" checked> BRUTTO</label>
          <label><input type="radio" name="mode" value="NET"> NETTO</label>
        </div>
      </div>
      <div class="nowrap">
        <label>Presety szybkiego wypełniania</label>
        <div class="row">
          <button class="btn ghost" id="btnAskCable" type="button">Podaj metry do falownika</button>
          <button class="btn ghost" id="btnSet20" type="button">Okablowanie = 20 m</button>
          <button class="btn ghost" id="btnSet40" type="button">Okablowanie = 40 m</button>
        </div>
      </div>

      <div>
        <label for="region">Region</label>
        <select id="region" class="narrow" title="Region (kWh/kWp)">
          <option value="950">Północ (~950 kWh/kWp)</option>
          <option value="1000" selected>Centrum (~1000 kWh/kWp)</option>
          <option value="1050">Południe (~1050 kWh/kWp)</option>
        </select>
      </div>
      <div>
        <label for="orient">Kierunek</label>
        <select id="orient" class="narrow" title="Kierunek ustawienia paneli">
          <option value="S" selected>Południe</option>
          <option value="E">Wschód</option>
          <option value="W">Zachód</option>
        </select>
      </div>
      <div>
        <label>Kąt (°) / Straty (%)</label>
        <div class="row">
          <input id="tilt" type="number" min="0" max="60" step="1" value="30" class="narrow" title="Kąt (°)">
          <input id="loss" type="number" min="0" max="30" step="1" value="10" class="narrow" title="Straty (%)">
        </div>
      </div>

      <div>
        <label>Klient</label>
        <input id="client" placeholder="np. Jan Kowalski" class="narrow">
      </div>
      <div class="cols-2 span-2">
        <label>Adres instalacji</label>
        <input id="addr" placeholder="ul., miejscowość" class="w-100">
      </div>
      <div class="cols-3 span-3">
        <label>Uwagi do oferty (drukowane)</label>
        <textarea id="notes" placeholder="np. termin, zakres, uwagi techniczne"></textarea>
      </div>
    </div>

    <details class="mt-6">
      <summary>Zaawansowane: podmiana inwertera / magazynu (podpowiadane automatycznie)</summary>
      <div class="grid cols-3 mt-8">
        <div>
          <label>Falownik — sugerowana marka</label>
          <select id="i_brand"></select>
        </div>
        <div>
          <label>Falownik — sugerowany model</label>
          <select id="i_model"></select>
        </div>
        <div>
          <label>Magazyn energii — propozycja</label>
          <select id="bat">
            <option value="0" selected>bez magazynu</option>
            <option value="5">~5 kWh</option>
            <option value="10">~10 kWh</option>
            <option value="15">~15 kWh</option>
          </select>
        </div>
      </div>
    </details>

    <div class="muted mt-8" id="meta">—</div>

    <div class="row mt-12">
      <button class="btn ok" id="calc">Przelicz</button>
      <button class="btn ghost" id="print">Drukuj / PDF</button>
    </div>
  </section>

  <!-- PRAWA: WYNIKI -->
  <section class="card">
    <h2 class="h2-tight">2) Wyliczenie</h2>
    <table>
      <thead><tr><th>Pozycja</th><th>Wartość</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="grid mt-10">
      <div>zł/kWp (<span id="modeLabel">brutto</span>): <span id="bench" class="bench">—</span></div>
      <div>Szacowana produkcja: <b id="prod">—</b> kWh/rok</div>
    </div>

    <div class="grid mt-12">
      <div class="big" id="sum_main">—</div>
      <div class="muted" id="sum_aux">—</div>
    </div>
  </section>

  <!-- KATALOG (tylko inwertery i magazyny do podpowiedzi) -->
  <section class="card full-width">
    <h2 class="h2-tight">3) Katalog do podpowiedzi (bez cen dla klienta)</h2>
    <div class="muted">Zarządzasz tylko listą <b>falowników</b> i <b>magazynów</b>. Ceny jednostkowe służą jedynie wewnętrznym wyliczeniom.</div>
    <div class="row my-8">
      <button class="btn ghost" id="seed">Załaduj przykładowe</button>
      <button class="btn ghost" id="saveAll">Zapisz do LocalStorage</button>
      <button class="btn ghost" id="clearAll">Wyczyść LocalStorage</button>
      <span class="pill">Moduł ref.: 
        <select id="refWFoot" title="Moduł referencyjny (W)">
          <option>410</option><option>430</option><option selected>445</option><option>460</option><option>500</option>
        </select>
      </span>
      <span class="pill">Aktualny: <b id="refPanelInfo"></b></span>
    </div>
    <div class="grid cols-2">
      <div>
        <table>
          <thead><tr><th>Inwerter — marka</th><th>Model</th><th>AC [kW]</th><th class="muted">cena (ukryta)</th></tr></thead>
          <tbody id="tblI"></tbody>
        </table>
      </div>
      <div>
        <table>
          <thead><tr><th>Magazyn — marka</th><th>Model</th><th>kWh</th><th class="muted">cena (ukryta)</th></tr></thead>
          <tbody id="tblB"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- NAGŁÓWEK WYDRUKU -->
<div class="print-only print-pad">
  <h1 class="h1-tight">Oferta instalacji PV</h1>
  <div id="printHead" class="font-14"></div>
  <hr>
</div>

<!-- STOPKA -->
<footer>
  <div class="footbox">
    <div class="footcol">
      <strong>ARKON</strong><br>
      ul. …, 00-000 Miasto • NIP …<br>
      tel. … • e-mail: …
    </div>
    <div class="footcol">
      <div>Oferta ma charakter informacyjny i nie stanowi oferty handlowej w rozumieniu K.C.</div>
      <div>Ceny mogą ulec zmianie z uwagi na warunki montażowe i aktualne cenniki dostawców.</div>
    </div>
    <div class="footcol">
      <div>Wygenerowano: <span id="genDate"></span></div>
      <div>Wersja kalkulatora: <span id="appVer">1.3 (pakiety+stopka)</span></div>
    </div>
  </div>
</footer>

<!-- USTAWIENIA (ukryte) -->
<dialog id="dlgSettings">
  <div class="dlg-head">
    <strong>Ustawienia niestandardowe</strong>
  </div>
  <div class="dlg-body grid cols-3">
    <div>
      <label>PIN (opcjonalny)</label>
      <input id="pin" placeholder="zostaw puste lub ustaw">
    </div>
    <div>
      <label>Ryczałt za kWp (z fal.)</label>
      <input id="rateWith" type="number" min="0" step="50" value="3200">
    </div>
    <div>
      <label>Ryczałt za kWp (bez fal.)</label>
      <input id="rateNo" type="number" min="0" step="50" value="2600">
    </div>

    <div>
      <label>Opłata firmy (ukryta)</label>
      <input id="baseFee" type="number" min="0" step="100" value="8000">
    </div>
    <div>
      <label>Prowizja handlowca</label>
      <input id="commHidden" type="number" min="0" step="50" value="0">
    </div>
    <div>
      <label>Korekta optymalizatorów (zł/szt.)</label>
      <input id="optimPrice" type="number" min="0" step="10" value="230">
    </div>
  </div>
  <div class="dlg-foot">
    <button class="btn ghost" id="setClose">Zamknij</button>
    <button class="btn ok" id="setSave">Zapisz</button>
  </div>
</dialog>

<script>
'use strict';

/* ====== stałe i helpers ====== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT0 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const INT1 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:1});
const INT2 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:2});
const money = n => isFinite(+n)? INT0.format(Math.round(+n))+' zł' : '—';
const fmt = (n,dp=0)=> (isFinite(+n)? (dp===0?INT0:dp===1?INT1:INT2).format(+n) : '—');

const KS = {inverters:'arkon_inverters_v4', bat:'arkon_batt_v4', set:'arkon_settings_v1'};
let INVERTERS=[], BATTERIES=[];
let SETTINGS = {
  pin: '',
  rateWith: 3200, // zł/kWp dla wariantu z falownikiem
  rateNo:   2600, // zł/kWp dla wariantu bez falownika
  baseFee:  8000, // ukryta opłata firmy
  comm:     0,    // prowizja handlowca (ukryte)
  optimPrice: 230 // zł/szt
};

const PACKAGE_INFO = {
  NONE:   'Brak pakietu.',
  CORE:   'STANDARD: Licznik 3F, Rozdzielnia AC/DC IP65, SPD DC i SPD AC.',
  FLAT:   'DACH PŁASKI: STANDARD + podłoże „dach płaski” (+500 zł).',
  GROUND: 'GRUNT: STANDARD + podłoże „grunt” (+1500 zł) + przekop (+2000 zł).'
};

function loadLS(){
  try{ INVERTERS = JSON.parse(localStorage.getItem(KS.inverters)||'[]'); }catch{ INVERTERS=[]; }
  try{ BATTERIES = JSON.parse(localStorage.getItem(KS.bat)||'[]'); }catch{ BATTERIES=[]; }
  try{
    const s = JSON.parse(localStorage.getItem(KS.set)||'{}');
    SETTINGS = Object.assign(SETTINGS, s||{});
  }catch{}
}
function saveLS(){
  localStorage.setItem(KS.inverters, JSON.stringify(INVERTERS));
  localStorage.setItem(KS.bat, JSON.stringify(BATTERIES));
  localStorage.setItem(KS.set, JSON.stringify(SETTINGS));
}
function seed(){
  INVERTERS = [
    {brand:'HUAWEI', model:'SUN2000-6KTL-L1', ac_kw:6,  price:3600},
    {brand:'HUAWEI', model:'SUN2000-10KTL-M1',ac_kw:10, price:3953},
    {brand:'SOFAR',  model:'HYD 10KTL 3F',    ac_kw:10, price:6227},
    {brand:'GOODWE', model:'GW10K-ET-20',     ac_kw:10, price:4631}
  ];
  BATTERIES = [
    {brand:'HUAWEI', model:'LUNA2000-5', kwh:5,   price:11500},
    {brand:'BYD',    model:'HVM 11.0',   kwh:11,  price:28000},
    {brand:'FOXESS', model:'ECS 10.4',   kwh:10.4,price:21500}
  ];
  saveLS(); renderCatalog(); fillSelectors(); recalc();
}

/* ====== katalog (inwertery/magazyny) ====== */
function renderCatalog(){
  const ref = $('#refW').value || $('#refWFoot').value || '445';
  $('#refPanelInfo').textContent = ref+' W';
  $('#refWFoot').value = ref;

  const iT = $('#tblI'); iT.innerHTML='';
  INVERTERS.forEach(inv=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${inv.brand}"></td>
      <td><input value="${inv.model}"></td>
      <td><input type="number" step="0.1" value="${inv.ac_kw||0}" class="narrow"></td>
      <td>—</td>`;
    const [b,m,ac] = tr.querySelectorAll('input');
    b&&(b.oninput=()=>{ inv.brand=b.value.trim().toUpperCase(); });
    m&&(m.oninput=()=>{ inv.model=m.value.trim(); });
    ac&&(ac.oninput=()=>{ inv.ac_kw=+ac.value||0; });
    iT.appendChild(tr);
  });

  const bT = $('#tblB'); bT.innerHTML='';
  BATTERIES.forEach(bt=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${bt.brand}"></td>
      <td><input value="${bt.model}"></td>
      <td><input type="number" step="0.1" value="${bt.kwh||0}" class="narrow"></td>
      <td>—</td>`;
    const [b,m,k] = tr.querySelectorAll('input');
    b&&(b.oninput=()=>{ bt.brand=b.value.trim().toUpperCase(); });
    m&&(m.oninput=()=>{ bt.model=m.value.trim(); });
    k&&(k.oninput=()=>{ bt.kwh=+k.value||0; });
    bT.appendChild(tr);
  });
}

function fillSelectors(){
  const bI = $('#i_brand'), mI = $('#i_model');
  const brandsI = [...new Set(INVERTERS.map(x => x.brand))].sort();
  bI.innerHTML = brandsI.map(b => `<option>${b}</option>`).join('');
  function syncModelsI(){
    const list = INVERTERS.filter(x => x.brand === bI.value);
    mI.innerHTML = list.map(x => `<option>${x.model}</option>`).join('');
  }
  bI.onchange = syncModelsI; syncModelsI();
}

/* ====== pomocnicze ====== */
function estimatePanelQty(kwp){
  const refW = +($('#refW').value || $('#refWFoot').value || 445);
  return Math.max(1, Math.ceil((kwp*1000)/refW));
}
function suggestInverter(dc_kWp){
  if(!INVERTERS.length) return null;
  let best=null, bestDiff=1e9;
  INVERTERS.forEach(inv=>{
    const diff = Math.abs(inv.ac_kw - dc_kWp);
    if(inv.ac_kw>=0.8*dc_kWp && inv.ac_kw<=1.2*dc_kWp && diff<bestDiff){ best=inv; bestDiff=diff; }
  });
  if(!best){
    INVERTERS.forEach(inv=>{
      const diff = Math.abs(inv.ac_kw - dc_kWp);
      if(diff<bestDiff){ best=inv; bestDiff=diff; }
    });
  }
  return best;
}
function suggestBattery(dc_kWp){
  const want = Math.round(dc_kWp*0.8);
  if(want<=5) return 5;
  if(want<=10) return 10;
  return 15;
}
function tiltFactor(deg){
  const t = Math.max(0, Math.min(60, +deg||0));
  const peak=30, diff=Math.abs(t-peak);
  return Math.max(0.85, 1 - (diff/60)*0.15);
}
function orientFactor(code){ return code==='S'?1 : (code==='E'||code==='W'?0.90:0.95); }
function zlPerKwpBench(val, kwp){
  if(!kwp) return {text:'—', cls:''};
  const v=Math.round(val/kwp);
  let cls='ok'; if(v<=4500) cls='good'; else if(v>6500) cls='bad';
  return {text: v+' zł/kWp', cls};
}

/* ====== pakiety: logika i opis ====== */
function applyAccessoryPreset(preset, interactive=true){
  const info = PACKAGE_INFO[preset] || '';
  $('#presetInfo').textContent = info;

  if(preset==='NONE') return;

  // dopytaj o metry, jeśli 0
  if(interactive && (+$('#cable').value||0)===0){
    const m = prompt('Podaj przybliżoną długość okablowania (metry) do falownika:', '20');
    if(m!=null){
      const mv = Math.max(0, parseInt(m,10)||0);
      $('#cable').value = mv;
    }
  }

  // STANDARD (CORE)
  $('#meter').value='GENERIC';
  $('#board').value='PVBOX';
  $('#spd_dc').value='YES';
  $('#spd_ac').value='YES';

  if(preset==='FLAT'){
    $('#substrate').value='roof-flat';
  }
  if(preset==='GROUND'){
    $('#substrate').value='ground';
    $('#trench').value='YES';
    if((+$('#cable').value||0) < 40) $('#cable').value = 40; // rozsądne minimum przy gruncie
  }
}

/* ====== kalkulacja ====== */
function recalc(){
  const kwp = Math.max(2.7, +$('#kwp').value||2.7);
  const withInv = ($('#withInv').value==='YES');

  // szac. panele (do optymalizatorów)
  const pQty = estimatePanelQty(kwp);

  // podpowiedź inwertera
  let invBrand='—', invModel='—', invAC=0;
  if(withInv){
    const sug = suggestInverter(kwp);
    if(sug){
      invBrand=sug.brand; invModel=sug.model; invAC=+sug.ac_kw||0;
      $('#i_brand').value = sug.brand;
      const list = INVERTERS.filter(x => x.brand === sug.brand);
      $('#i_model').innerHTML = list.map(x => `<option>${x.model}</option>`).join('');
      $('#i_model').value = sug.model;
    }else{
      $('#i_brand').dispatchEvent(new Event('change'));
    }
  }

  // magazyn (autopropozycja jeśli 0)
  if($('#bat').value==='0'){
    const b = suggestBattery(kwp);
    $('#bat').value = String(b<=5?5:b<=10?10:15);
  }
  const batSel = +$('#bat').value || 0;
  const batPrice = batSel===0 ? 0 : (batSel<=5?12000:batSel<=10?22000:30000);

  // pakiet (od razu zastosowany, ale bez ponownego pytania o metry przy każdym „input”)
  const preset = $('#accPreset').value;
  if(!recalc._lastPreset) recalc._lastPreset = '';
  if(preset !== recalc._lastPreset){
    applyAccessoryPreset(preset, true);
    recalc._lastPreset = preset;
  } else {
    // utrzymuj opis
    $('#presetInfo').textContent = PACKAGE_INFO[preset] || '';
  }

  // dodatki
  const OPTIM_PRICE = +SETTINGS.optimPrice||230;
  const optChoice = $('#optims').value;
  const sumOptims = (optChoice==='ALL') ? (pQty * OPTIM_PRICE) : 0;

  const sumMeter = $('#meter').value==='GENERIC' ? 450 : 0;
  const sumBoard = $('#board').value==='PVBOX' ? 820 : 0;
  const sumSpdDc = $('#spd_dc').value==='YES' ? 280 : 0;
  const sumSpdAc = $('#spd_ac').value==='YES' ? 300 : 0;

  const cable = Math.max(0, +$('#cable').value||0);
  const sumCable = cable * 50; // zł/m
  const trench = ($('#trench').value==='YES') ? 2000 : 0;

  // podłoże
  let subLabel='blachodachówka', subFee=0;
  const sub = $('#substrate').value;
  if(sub==='roof-flat'){ subLabel='dach płaski'; subFee=500; }
  else if(sub==='ground'){ subLabel='grunt'; subFee=1500; }

  // ryczałt kWp (z falownikiem / bez)
  const rate = withInv ? (+SETTINGS.rateWith||0) : (+SETTINGS.rateNo||0);
  const baseSet = rate * kwp;

  // opłata firmy + prowizja (ukryte w ustawieniach)
  const baseFee = +SETTINGS.baseFee||0;
  const comm = +SETTINGS.comm||0;

  // suma netto
  const subtotal_net =
    baseSet
    + sumOptims + sumMeter + sumBoard + sumSpdDc + sumSpdAc
    + batPrice + sumCable + trench + subFee
    + baseFee + comm;

  // VAT
  const vat = +$('#vat').value || 0.08;
  const vat_amt = subtotal_net * vat;
  const gross = subtotal_net + vat_amt;

  // produkcja
  const base = +$('#region').value || 1000;
  const kTilt = tiltFactor($('#tilt').value);
  const kOrient = orientFactor($('#orient').value);
  const losses = Math.max(0, Math.min(0.3, (+$('#loss').value||10)/100));
  const prod = kwp * base * kTilt * kOrient * (1 - losses);

  // tabela
  const rows = [
    ['Zestaw', `${fmt(kwp,2)} kWp (ryczałt ${rate} zł/kWp, panele w zestawie)`],
    ['Falownik', withInv ? `${invBrand} ${invModel}` : 'brak'],
    ['Magazyn energii', batSel ? `${batSel} kWh` : 'brak'],
    ['Pakiet', (PACKAGE_INFO[preset] || '—').replace(/\s+/g,' ').trim()],
    ['Optymalizatory', (optChoice === 'ALL') ? `na każdy panel (~${estimatePanelQty(kwp)} × ${OPTIM_PRICE} zł)` : 'brak'],
    ['Licznik', sumMeter ? '3F Modbus (ok.)' : 'brak'],
    ['Rozdzielnia AC/DC', sumBoard ? 'IP65 (ok.)' : 'brak'],
    ['SPD DC / AC', (sumSpdDc || sumSpdAc) ? `${sumSpdDc ? 'DC T2' : ''}${(sumSpdDc && sumSpdAc) ? ' + ' : ''}${sumSpdAc ? 'AC T2' : ''}` : 'brak'],
    ['Okablowanie', `${cable} m × 50 zł`],
    ['Przekop', trench ? 'tak (2000 zł)' : 'nie'],
    ['Podłoże', subLabel + (subFee ? ` (+${subFee} zł)` : '')],
    ['VAT', (vat * 100).toFixed(0) + '%'],
    ['Uwagi', ($('#notes').value || '—').trim() || '—']
  ];
  $('#rows').innerHTML = rows.map(([k, v]) => `<tr><th>${k}</th><td>${v}</td></tr>`).join('');

  // tryb NET/BRUTTO + benchmark
  const mode = document.querySelector('input[name="mode"]:checked').value;
  $('#modeLabel').textContent = (mode==='GROSS'?'brutto':'netto');
  const main = (mode==='GROSS')? gross : subtotal_net;
  const bench = zlPerKwpBench(main, kwp);
  const benchEl = $('#bench'); benchEl.textContent = bench.text; benchEl.className = 'bench '+bench.cls;

  // sumy (w dwóch wersjach)
  $('#sum_main').textContent = 'Suma ' + (mode==='GROSS'?'brutto: ':'netto: ') + money(main);
  $('#sum_aux').textContent  = (mode==='GROSS'
    ? ('Netto: ' + money(subtotal_net) + ' • VAT: ' + money(vat_amt))
    : ('Brutto: ' + money(gross) + ' • VAT: ' + money(vat_amt)));

  // meta (DC/AC) + panele ref
  const ratio = invAC? (kwp/invAC) : 0;
  const refW = +($('#refW').value || $('#refWFoot').value || 445);
  $('#meta').innerHTML = withInv
    ? `Inwerter AC: <b>${fmt(invAC,1)} kW</b> • DC/AC: <b>${fmt(ratio,2)}</b> • Szac. liczba paneli: <b>~${estimatePanelQty(kwp)}</b> (ref. ${refW} W)`
    : `Bez inwertera • Szac. liczba paneli: <b>~${estimatePanelQty(kwp)}</b> (ref. ${refW} W)`;

  // nagłówek wydruku
  const client = ($('#client').value||'—').trim();
  const addr   = ($('#addr').value||'—').trim();
  $('#printHead').innerHTML = `
    Klient: <b>${client||'—'}</b> &nbsp;•&nbsp; Adres: <b>${addr||'—'}</b><br>
    Zestaw: <b>${fmt(kwp,2)} kWp</b> &nbsp;•&nbsp; VAT: <b>${(vat*100).toFixed(0)}%</b> &nbsp;•&nbsp;
    Pakiet: <b>${(PACKAGE_INFO[preset]||'—').replace('STANDARD: ','')}</b><br>
    Suma ${mode==='GROSS'?'brutto':'netto'}: <b>${money(main)}</b><br>
    Uwagi: ${(($('#notes').value||'—').trim())}
  `;
}

/* ====== zdarzenia ====== */
$('#calc').onclick = recalc;
$('#print').onclick = ()=>{ recalc(); window.print(); };

$$('[data-preset]').forEach(b=>{
  b.onclick = ()=>{ const v = +b.getAttribute('data-preset'); $('#kwp').value = v.toFixed(1); recalc._lastPreset=null; recalc(); };
});

['kwp','withInv','vat','substrate','cable','trench','optims','accPreset','meter','board','spd_dc','spd_ac','region','orient','tilt','loss','i_brand','i_model','bat','refW','refWFoot','client','addr','notes']
.forEach(id=>{
  const el = $('#'+id); if(!el) return;
  const evt = (el.tagName==='INPUT' || el.tagName==='TEXTAREA')? 'input' : 'change';
  el.addEventListener(evt, () => {
    // zmiana pakietu: zastosuj od razu, ale bez kolejnych promptów
    if (id === 'accPreset') { applyAccessoryPreset($('#accPreset').value, false); }
    if (id === 'refWFoot') { $('#refW').value = $('#refWFoot').value; }
    recalc();
  });
});

$$('input[name="mode"]').forEach(r=> r.addEventListener('change', recalc));

// skróty okablowania
$('#btnAskCable').onclick = ()=>{ const m = prompt('Podaj długość okablowania (m):', $('#cable').value||'20'); if(m!=null){ $('#cable').value = Math.max(0, parseInt(m,10)||0); recalc(); } };
$('#btnSet20').onclick = ()=>{ $('#cable').value = 20; recalc(); };
$('#btnSet40').onclick = ()=>{ $('#cable').value = 40; recalc(); };

/* ====== USTAWIENIA (ukryte) ====== */
const dlg = $('#dlgSettings');
$('#btnSettings').onclick = ()=>{
  // prosty „PIN” – jeśli ustawiony, zapytaj
  if(SETTINGS.pin){
    const got = prompt('Podaj PIN do ustawień:','');
    if(got!==SETTINGS.pin) return; // nie otwieraj
  }
  // wypełnij pola
  $('#pin').value = SETTINGS.pin||'';
  $('#rateWith').value = SETTINGS.rateWith||3200;
  $('#rateNo').value   = SETTINGS.rateNo||2600;
  $('#baseFee').value  = SETTINGS.baseFee||8000;
  $('#commHidden').value = SETTINGS.comm||0;
  $('#optimPrice').value = SETTINGS.optimPrice||230;
  dlg.showModal();
};
$('#setClose').onclick = ()=> dlg.close();
$('#setSave').onclick = ()=>{
  SETTINGS.pin = ($('#pin').value||'').trim();
  SETTINGS.rateWith = Math.max(0, +$('#rateWith').value||0);
  SETTINGS.rateNo   = Math.max(0, +$('#rateNo').value||0);
  SETTINGS.baseFee  = Math.max(0, +$('#baseFee').value||0);
  SETTINGS.comm     = Math.max(0, +$('#commHidden').value||0);
  SETTINGS.optimPrice = Math.max(0, +$('#optimPrice').value||0);
  saveLS(); dlg.close(); recalc();
};

/* ====== KATALOG ====== */
function fillSelectors(){
  const bI=$('#i_brand'), mI=$('#i_model');
  const brandsI=[...new Set(INVERTERS.map(x=>x.brand))].sort();
  bI.innerHTML = brandsI.map(b=><option>${b}</option>).join('');
  function syncModelsI(){
    const list = INVERTERS.filter(x=>x.brand===bI.value);
    mI.innerHTML = list.map(x=><option>${x.model}</option>).join('');
  }
  bI.onchange = syncModelsI; syncModelsI();
}

$('#seed').onclick = seed;
$('#saveAll').onclick = saveLS;
$('#clearAll').onclick = ()=>{ localStorage.removeItem(KS.inverters); localStorage.removeItem(KS.bat); loadLS(); renderCatalog(); fillSelectors(); recalc(); };

/* ====== start ====== */
(function boot(){
  loadLS();
  if(!INVERTERS.length) seed();
  renderCatalog();
  fillSelectors();
  recalc();
  // data w stopce
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  $('#genDate').textContent = pad(d.getDate()) + '.' + pad(d.getMonth() + 1) + '.' + d.getFullYear();
})();
</script>
</body>
</html>
