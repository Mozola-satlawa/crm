<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON — Fotowoltaika • Zestawy (kW) — panele, falownik, magazyn, VAT</title>
<meta name="description" content="Kalkulator PV od zestawu (kW): wybór paneli i inwertera, autodobór mocy, magazyn, dodatki, VAT 8%/23%, prowizja handlowca, wydruk.">
<style>
  :root{ --bg:#0a0f1e; --ink:#e8edff; --muted:#aeb8da; --line:#243059; --card:#0f1533; --card2:#121a34; --accent:#4cc9f0; --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px 16px 8px;background:#11183a;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  header h1{margin:0;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  .wrap{max-width:1200px;margin:auto;padding:14px}
  .card{background:linear-gradient(180deg,#0f1533,#121a34);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  @media(min-width:1080px){ .cols-2{grid-template-columns:1.1fr 0.9fr} .cols-3{grid-template-columns:1fr 1fr 1fr}}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  textarea{min-height:72px}
  label{display:block;margin-bottom:6px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid #243059;text-align:left;vertical-align:top}
  th{font-size:13px;color:#aeb8da;white-space:nowrap}
  .narrow{max-width:160px}
  .w100{width:100%}
  .big{font-size:28px;font-weight:800}
  .tag{display:inline-block;border:1px solid #2a3777;color:#cfe0ff;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
  .info{font-size:12px;color:#aeb8da}
  .nowrap{white-space:nowrap}
  footer{max-width:1200px;margin:16px auto 24px;color:#aeb8da;font-size:12px;padding:0 14px}
  .footbox{border-top:1px solid #243059;padding-top:10px;display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between}
  .footcol{opacity:.9}
  .print-only{display:none}
  @media print{
    .no-print{display:none!important}
    body{background:#fff;color:#000}
    header{background:#fff;border:none;padding:0}
    .card{border:none;padding:0}
    .wrap{max-width:100%;padding:0 0}
    .print-only{display:block}
    h1{color:#000}
    .muted{color:#333}
    footer{color:#000}
    .footbox{border-top:1px solid #000}
  }
  dialog::backdrop{background:rgba(0,0,0,.6)}
  dialog{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#0f1533,#121a34);color:var(--ink);max-width:720px;width:92%;padding:0}
  .dlg-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
  .dlg-body{padding:12px 14px}
  .dlg-foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>Komponenty • Fotowoltaika — ARKON <span class="tag">zestawy (kW)</span></h1>
    <button id="btnSettings" class="btn ghost no-print" title="Ustawienia (ukryte koszty)">⚙️</button>
  </div>
  <div class="muted">Wybierz panele i ilość — moc zestawu (kW) policzy się sama. Wariant z/bez falownika, autodobór falownika i magazynu, dodatki, VAT 8%/23%, prowizja handlowca. Ceny jednostkowe komponentów nie są pokazywane klientowi.</div>
</header>

<div class="wrap grid cols-2">
  <!-- LEWA: FORMULARZ -->
  <section class="card">
    <h2 style="margin:0 0 8px">1) Zestaw</h2>

    <div class="grid cols-3">
      <!-- PANELE -->
      <div>
        <label>Marka paneli</label>
        <select id="p_brand" class="narrow"></select>
      </div>
      <div>
        <label>Model paneli</label>
        <select id="p_model" class="narrow"></select>
      </div>
      <div>
        <label>Ilość paneli (szt.)</label>
        <input id="p_qty" type="number" min="1" step="1" value="14" class="narrow">
      </div>

      <!-- MOC ZESTAWU (auto) -->
      <div>
        <label>Moc zestawu (DC) [kW]</label>
        <input id="dc_kw" class="narrow" disabled>
      </div>
      <div>
        <label>Usytuowanie</label>
        <select id="orient" class="narrow">
          <option value="S" selected>Południe</option>
          <option value="E">Wschód</option>
          <option value="W">Zachód</option>
        </select>
      </div>
      <div>
        <label>Wariant</label>
        <select id="withInv" class="narrow">
          <option value="YES" selected>z falownikiem</option>
          <option value="NO">bez falownika</option>
        </select>
      </div>

      <!-- INWERTER (sugerowany, z możliwością podmiany) -->
      <div>
        <label>Marka falownika</label>
        <select id="i_brand" class="narrow"></select>
      </div>
      <div>
        <label>Model falownika</label>
        <select id="i_model" class="narrow"></select>
      </div>
      <div class="nowrap">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn ghost" id="btnSuggestInverter" type="button">Dobierz falownik</button>
        </div>
      </div>

      <!-- MAGAZYN (auto) -->
      <div>
        <label>Magazyn energii</label>
        <select id="bat" class="narrow">
          <option value="0" selected>bez magazynu</option>
          <option value="5">~5 kWh</option>
          <option value="10">~10 kWh</option>
          <option value="15">~15 kWh</option>
        </select>
      </div>
      <div class="nowrap">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn ghost" id="btnSuggestBattery" type="button">Dobierz magazyn</button>
        </div>
      </div>
      <div>
        <label>Prowizja handlowca (zł)</label>
        <input id="salesComm" type="number" min="0" step="50" value="0" class="narrow">
      </div>

      <!-- PODŁOŻE + KABEL + PRZEKOP -->
      <div>
        <label>Podłoże</label>
        <select id="substrate" class="narrow">
          <option value="roof-metal" selected>blachodachówka</option>
          <option value="roof-flat">dach płaski (+500)</option>
          <option value="ground">grunt (+1500)</option>
        </select>
      </div>
      <div>
        <label>Okablowanie (pierwsze 20 m w cenie; >20 m = 50 zł/m)</label>
        <input id="cable" type="number" min="0" step="1" value="20" class="narrow">
      </div>
      <div>
        <label>Przekop (+2000 zł)</label>
        <select id="trench" class="narrow">
          <option value="NO" selected>nie</option>
          <option value="YES">tak</option>
        </select>
      </div>

      <!-- AKCESORIA -->
      <div>
        <label>Optymalizatory (szt.) × <span id="optimPriceLabel">230</span> zł</label>
        <input id="optims" type="number" min="0" step="1" value="0" class="narrow">
      </div>
      <div>
        <label>Rozdzielnia AC/DC</label>
        <select id="board" class="narrow" title="Auto włącza się od 6 kW">
          <option value="AUTO" selected>AUTO (od 6 kW)</option>
          <option value="YES">Włącz</option>
          <option value="NO">Wyłącz</option>
        </select>
      </div>
      <div>
        <label>Licznik energii 3F</label>
        <select id="meter" class="narrow">
          <option value="NONE" selected>brak</option>
          <option value="GENERIC">3F Modbus</option>
        </select>
      </div>

      <!-- VAT: auto/override -->
      <div>
        <label>Typ inwestora</label>
        <select id="investor" class="narrow">
          <option value="PRIVATE" selected>Osoba prywatna</option>
          <option value="COMPANY">Firma</option>
        </select>
      </div>
      <div>
        <label>Typ lokalu</label>
        <select id="premise" class="narrow">
          <option value="HOUSE" selected>Dom jednorodzinny</option>
          <option value="FLAT">Lokal mieszkalny</option>
        </select>
      </div>
      <div>
        <label>Powierzchnia [m²]</label>
        <input id="area" type="number" min="1" step="1" value="120" class="narrow">
      </div>

      <div class="nowrap">
        <label>VAT</label>
        <div class="row">
          <span id="vatAutoLabel" class="pill">Auto: 8%</span>
          <select id="vatOverride" class="narrow" title="Opcjonalne nadpisanie">
            <option value="AUTO" selected>AUTO (wg przepisów)</option>
            <option value="0.08">Wymuś 8%</option>
            <option value="0.23">Wymuś 23%</option>
          </select>
        </div>
      </div>

      <!-- UWAGI + DRUK -->
      <div class="cols-3" style="grid-column:span 3">
        <label>Uwagi do oferty (drukowane)</label>
        <textarea id="notes" placeholder="np. termin, zakres, uwagi techniczne"></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn ok" id="calc">Przelicz</button>
      <button class="btn ghost" id="print">Drukuj / PDF</button>
      <button class="btn ghost" id="btnImport">Import katalogu (JSON)</button>
      <input id="inJSON" type="file" accept="application/json" hidden>
    </div>
  </section>

  <!-- PRAWA: WYNIKI -->
  <section class="card">
    <h2 style="margin:0 0 8px">2) Cena — na każdym etapie</h2>
    <table>
      <thead><tr><th>Pozycja</th><th>Wartość</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="grid" style="margin-top:10px">
      <div class="big" id="sum_main">—</div>
      <div class="muted" id="sum_aux">—</div>
    </div>
  </section>

  <!-- KATALOG edytowalny (bez pokazywania cen klientowi) -->
  <section class="card" style="grid-column:1 / -1">
    <h2 style="margin:0 0 8px">3) Katalog (ceny ukryte — do wewn.)</h2>
    <div class="row" style="margin:8px 0">
      <button class="btn ghost" id="seed">Załaduj przykładowe</button>
      <button class="btn ghost" id="saveAll">Zapisz katalog</button>
      <button class="btn ghost" id="clearAll">Wyczyść katalog</button>
      <span class="pill">Klient widzi wyłącznie sumy — nie ceny jednostkowe.</span>
    </div>

    <div class="grid cols-3">
      <div>
        <table>
          <thead><tr><th>Panele — marka</th><th>Model</th><th>W [W]</th><th class="muted">cena/szt. (ukryta)</th></tr></thead>
          <tbody id="tblP"></tbody>
        </table>
      </div>
      <div>
        <table>
          <thead><tr><th>Falownik — marka</th><th>Model</th><th>AC [kW]</th><th class="muted">cena (ukryta)</th></tr></thead>
          <tbody id="tblI"></tbody>
        </table>
      </div>
      <div>
        <table>
          <thead><tr><th>Magazyn — marka</th><th>Model</th><th>kWh</th><th class="muted">cena (ukryta)</th></tr></thead>
          <tbody id="tblB"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- STOPKA -->
<footer>
  <div class="footbox">
    <div class="footcol"><strong>ARKON</strong> • ul. … • tel. … • e-mail: …</div>
    <div class="footcol">Oferta informacyjna; ceny mogą się zmienić po wizji lokalnej i aktualnych cennikach.</div>
    <div class="footcol">Wygenerowano: <span id="genDate"></span> • Wersja: <span id="appVer">2.1</span></div>
  </div>
</footer>

<!-- USTAWIENIA (ukryta opłata firmy itd.) -->
<dialog id="dlgSettings">
  <div class="dlg-head"><strong>Ustawienia</strong></div>
  <div class="dlg-body grid cols-3">
    <div>
      <label>PIN (opcjonalny)</label>
      <input id="pin" placeholder="zostaw puste lub ustaw">
    </div>
    <div>
      <label>Opłata firmy (ukryta)</label>
      <input id="baseFee" type="number" min="0" step="100" value="8000">
    </div>
    <div>
      <label>Cena optymalizatora (zł/szt.)</label>
      <input id="optimPrice" type="number" min="0" step="10" value="230">
    </div>
  </div>
  <div class="dlg-foot">
    <button class="btn ghost" id="setClose">Zamknij</button>
    <button class="btn ok" id="setSave">Zapisz</button>
  </div>
</dialog>

<script>
'use strict';

/* ====== helpers ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const INT0=new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const money = n=> isFinite(+n)? INT0.format(Math.round(+n))+' zł':'—';
const KS={pan:'arkon_pan_v2', inv:'arkon_inv_v2', bat:'arkon_bat_v2', set:'arkon_set_v2'};
let PAN=[], INV=[], BAT=[];
let SETTINGS={ pin:'', baseFee:8000, optimPrice:230 };

function loadLS(){
  try{ PAN=JSON.parse(localStorage.getItem(KS.pan)||'[]'); }catch{ PAN=[]; }
  try{ INV=JSON.parse(localStorage.getItem(KS.inv)||'[]'); }catch{ INV=[]; }
  try{ BAT=JSON.parse(localStorage.getItem(KS.bat)||'[]'); }catch{ BAT=[]; }
  try{ SETTINGS=Object.assign(SETTINGS, JSON.parse(localStorage.getItem(KS.set)||'{}')||{}); }catch{}
}
function saveLS(){
  localStorage.setItem(KS.pan, JSON.stringify(PAN));
  localStorage.setItem(KS.inv, JSON.stringify(INV));
  localStorage.setItem(KS.bat, JSON.stringify(BAT));
  localStorage.setItem(KS.set, JSON.stringify(SETTINGS));
}

function readJSONFile(file){ return file.text().then(t=>JSON.parse(t)); }

/* ====== seed przykładowy (możesz zastąpić importem JSON) ====== */
function seed(){
  if(!PAN.length) PAN=[
    {brand:'JINKO', model:'JKM445N-54HL4R-B Full Black', watt:445, price:240},
    {brand:'TRINA', model:'Vertex S+ 440 FB', watt:440, price:200},
    {brand:'LONGI', model:'LR7-54HTH-460M', watt:460, price:225},
    {brand:'JA SOLAR', model:'JAM60D41-500/LB FB', watt:500, price:250},
    {brand:'HYUNDAI', model:'HiE-S410', watt:410, price:210}
  ];
  if(!INV.length) INV=[
    {brand:'DEYE',   model:'SUN-8K-SG04LP3-EU', ac_kw:8.0, price:5200},
    {brand:'HUAWEI', model:'SUN2000-10KTL-M1',  ac_kw:10,  price:3953},
    {brand:'SOFAR',  model:'HYD 10KTL 3F',      ac_kw:10,  price:6227},
    {brand:'GOODWE', model:'GW8K-ET',           ac_kw:8,   price:4300}
  ];
  if(!BAT.length) BAT=[
    {brand:'HUAWEI', model:'LUNA2000-5', kwh:5,  price:11500},
    {brand:'BYD',    model:'HVM 11.0',   kwh:11, price:28000},
    {brand:'FOXESS', model:'ECS 10.4',   kwh:10.4, price:21500},
    {brand:'DEYE',   model:'RW10',       kwh:10,  price:21000}
  ];
  saveLS(); renderCatalog(); fillSelectors(); recalc();
}

/* ====== katalog — edycja ====== */
function renderCatalog(){
  const tp=$('#tblP'); tp.innerHTML='';
  PAN.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input value="${p.brand}"></td><td><input value="${p.model}"></td>
    <td><input type="number" step="1" value="${p.watt||0}" class="narrow"></td><td>—</td>`;
    const [b,m,w]=tr.querySelectorAll('input');
    b.oninput=()=>p.brand=b.value.trim().toUpperCase();
    m.oninput=()=>p.model=m.value.trim();
    w.oninput=()=>p.watt=+w.value||0;
    tp.appendChild(tr);
  });
  const ti=$('#tblI'); ti.innerHTML='';
  INV.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input value="${i.brand}"></td><td><input value="${i.model}"></td>
    <td><input type="number" step="0.1" value="${i.ac_kw||0}" class="narrow"></td><td>—</td>`;
    const [b,m,a]=tr.querySelectorAll('input');
    b.oninput=()=>i.brand=b.value.trim().toUpperCase();
    m.oninput=()=>i.model=m.value.trim();
    a.oninput=()=>i.ac_kw=+a.value||0;
    ti.appendChild(tr);
  });
  const tb=$('#tblB'); tb.innerHTML='';
  BAT.forEach(b=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input value="${b.brand}"></td><td><input value="${b.model}"></td>
    <td><input type="number" step="0.1" value="${b.kwh||0}" class="narrow"></td><td>—</td>`;
    const [br,m,k]=tr.querySelectorAll('input');
    br.oninput=()=>b.brand=br.value.trim().toUpperCase();
    m.oninput=()=>b.model=m.value.trim();
    k.oninput=()=>b.kwh=+k.value||0;
    tb.appendChild(tr);
  });
}

/* ====== selektory (panele, inwerter) ====== */
function fillSelectors(){
  const pb=$('#p_brand'), pm=$('#p_model');
  const ib=$('#i_brand'), im=$('#i_model');

  const brandsP=[...new Set(PAN.map(x=>x.brand))].sort();
  pb.innerHTML=brandsP.map(b=>`<option>${b}</option>`).join('');
  function syncP(){ const list=PAN.filter(x=>x.brand===pb.value); pm.innerHTML=list.map(x=>`<option>${x.model}</option>`).join(''); }
  pb.onchange=()=>{ syncP(); suggestQtyAndPower(); recalc(); }; syncP();
  pm.onchange=()=>{ suggestQtyAndPower(); recalc(); };

  const brandsI=[...new Set(INV.map(x=>x.brand))].sort();
  ib.innerHTML=brandsI.map(b=>`<option>${b}</option>`).join('');
  function syncI(){ const list=INV.filter(x=>x.brand===ib.value); im.innerHTML=list.map(x=>`<option>${x.model}</option>`).join(''); }
  ib.onchange=()=>{ syncI(); recalc(); }; syncI();
  im.onchange=()=> recalc();
}

/* ====== kalkulacje ====== */
function findPanel(brand,model){ return PAN.find(x=>x.brand===brand && x.model===model); }
function findInverter(brand,model){ return INV.find(x=>x.brand===brand && x.model===model); }
function suggestInverter(dc){
  if(!INV.length) return null;
  let best=null, score=1e9;
  INV.forEach(i=>{
    const ratio = i.ac_kw? Math.abs((dc/i.ac_kw)-1):999;
    const pen = (i.ac_kw>=0.8*dc && i.ac_kw<=1.2*dc)?0:10;
    const s = ratio+pen;
    if(s<score){ score=s; best=i; }
  });
  return best;
}
function suggestBattery(dc){
  const want = Math.round(dc*0.8);
  if(want<=5) return 5;
  if(want<=10) return 10;
  return 15;
}
function vatAuto(investor,premise,area){
  if(investor==='COMPANY') return 0.23;
  const a=+area||0;
  if(premise==='HOUSE') return (a<=300?0.08:0.23);
  if(premise==='FLAT')  return (a<=150?0.08:0.23);
  return 0.23;
}

function panelPowerW(){ const p=findPanel($('#p_brand').value,$('#p_model').value); return p?.watt||0; }
function panelPrice(){ const p=findPanel($('#p_brand').value,$('#p_model').value); return +p?.price||0; }
function inverterPrice(){ const i=findInverter($('#i_brand').value,$('#i_model').value); return +i?.price||0; }
function inverterAC(){ const i=findInverter($('#i_brand').value,$('#i_model').value); return +i?.ac_kw||0; }
function batteryPriceFor(kwhSel){
  if(+kwhSel===0) return 0;
  const hit = BAT.find(b=>Math.round(b.kwh)==+kwhSel);
  if(hit) return +hit.price||0;
  return (+kwhSel<=5)?12000:(+kwhSel<=10?22000:30000);
}

function suggestQtyAndPower(){
  const pW=panelPowerW(); const qtyEl=$('#p_qty');
  let qty = Math.max(1, +qtyEl.value||14);
  const dc = (pW*qty)/1000;
  const roundedKW = Math.max(2.7, Math.round(dc*2)/2);
  const targetQty = Math.max(1, Math.round((roundedKW*1000)/pW));
  qtyEl.value = targetQty;
  $('#dc_kw').value = (pW*targetQty/1000).toFixed(2);
}

function recalc(){
  const pW=panelPowerW(); const qty=Math.max(1, +$('#p_qty').value||1);
  const dc = (pW*qty)/1000; $('#dc_kw').value = dc.toFixed(2);

  if($('#board').value==='AUTO'){ $('#board').dataset.auto = (dc>=6?'YES':'NO'); }
  const boardOn = ($('#board').value==='YES') || ($('#board').value==='AUTO' && $('#board').dataset.auto==='YES');

  if($('#withInv').value==='YES'){
    const invSel = findInverter($('#i_brand').value,$('#i_model').value);
    if(!invSel || !invSel.ac_kw || invSel.ac_kw<0.6*dc || invSel.ac_kw>1.6*dc){
      const sug=suggestInverter(dc); if(sug){ $('#i_brand').value=sug.brand; const list=INV.filter(x=>x.brand===sug.brand); $('#i_model').innerHTML=list.map(x=>`<option>${x.model}</option>`).join(''); $('#i_model').value=sug.model; }
    }
  }
  if(+$('#bat').value===0){ $('#bat').value = String(suggestBattery(dc)); }

  const sumPanels = panelPrice()*qty;
  const sumInv = ($('#withInv').value==='YES') ? inverterPrice() : 0;
  const sumBat = batteryPriceFor($('#bat').value);

  const cable = Math.max(0, +$('#cable').value||0);
  const over = Math.max(0, cable - 20);
  const sumCable = over * 50;
  const trench = ($('#trench').value==='YES') ? 2000 : 0;
  let subFee=0, subLabel='blachodachówka';
  const sub=$('#substrate').value;
  if(sub==='roof-flat'){subFee=500; subLabel='dach płaski';}
  if(sub==='ground'){subFee=1500; subLabel='grunt';}
  const sumOptims = Math.max(0, +$('#optims').value||0) * (+SETTINGS.optimPrice||230);
  const sumBoard = boardOn ? 820 : 0;
  const sumMeter = ($('#meter').value==='GENERIC') ? 450 : 0;

  const baseFee = +SETTINGS.baseFee||0;
  const salesComm = Math.max(0, +$('#salesComm').value||0);

  const subtotal_net =
      sumPanels + sumInv + sumBat
    + sumOptims + sumBoard + sumMeter
    + sumCable + trench + subFee
    + baseFee + salesComm;

  const investor=$('#investor').value, premise=$('#premise').value, area=$('#area').value;
  let vatAutoRate = vatAuto(investor,premise,area);
  $('#vatAutoLabel').textContent = 'Auto: '+Math.round(vatAutoRate*100)+'%';
  const override=$('#vatOverride').value;
  const vat = (override==='AUTO')? vatAutoRate : (+override||0.23);

  const vatAmt = subtotal_net*vat;
  const gross = subtotal_net + vatAmt;

  const rows = [
    ['Panele', `${$('#p_brand').value} • ${$('#p_model').value} × ${qty} — moc: ${dc.toFixed(2)} kW`],
    ['Falownik', ($('#withInv').value==='YES') ? `${$('#i_brand').value} • ${$('#i_model').value} (AC ${inverterAC().toFixed(1)} kW)` : 'brak'],
    ['Magazyn energii', (+$('#bat').value? `${$('#bat').value} kWh` : 'brak')],
    ['Optymalizatory', (+$('#optims').value||0)+' × '+(+SETTINGS.optimPrice||230)+' zł'],
    ['Licznik 3F', ($('#meter').value==='GENERIC')? 'tak' : 'brak'],
    ['Rozdzielnia AC/DC', boardOn? 'tak' : 'brak'],
    ['Okablowanie', `${cable} m (20 m w cenie, nadmiar: ${over} m × 50 zł)`],
    ['Przekop', trench? 'tak (2000 zł)' : 'nie'],
    ['Podłoże', subLabel + (subFee? ` (+${subFee} zł)`:'')],
    ['Prowizja handlowca', money(salesComm)],
    ['VAT', Math.round(vat*100)+'% (auto wg przepisów, można nadpisać)'],
    ['Uwagi', ($('#notes').value||'—').trim() || '—']
  ];
  $('#rows').innerHTML = rows.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');

  $('#sum_main').textContent = 'Suma brutto: '+money(gross);
  $('#sum_aux').textContent  = 'Netto: '+money(subtotal_net)+' • VAT: '+money(vatAmt);
}

/* ====== zdarzenia ====== */
$('#calc').onclick=recalc;
$('#print').onclick=()=>{ recalc(); window.print(); };
['p_brand','p_model','p_qty','withInv','i_brand','i_model','bat','substrate','cable','trench','optims','board','meter','investor','premise','area','vatOverride','salesComm','orient','notes'].forEach(id=>{
  const el=$('#'+id); if(!el) return;
  el.addEventListener((el.tagName==='INPUT'||el.tagName==='TEXTAREA')?'input':'change', recalc);
});
$('#btnSuggestInverter').onclick=()=>{ const sug=suggestInverter(+$('#dc_kw').value||0); if(sug){ $('#i_brand').value=sug.brand; const list=INV.filter(x=>x.brand===sug.brand); $('#i_model').innerHTML=list.map(x=>`<option>${x.model}</option>`).join(''); $('#i_model').value=sug.model; recalc(); } };
$('#btnSuggestBattery').onclick=()=>{ const b=suggestBattery(+$('#dc_kw').value||0); $('#bat').value=String(b); recalc(); };

// Ustawienia
const dlg=$('#dlgSettings');
$('#btnSettings').onclick=()=>{
  if(SETTINGS.pin){ const got=prompt('PIN do ustawień:',''); if(got!==SETTINGS.pin) return; }
  $('#pin').value=SETTINGS.pin||''; $('#baseFee').value=SETTINGS.baseFee||8000; $('#optimPrice').value=SETTINGS.optimPrice||230;
  dlg.showModal();
};
$('#setClose').onclick=()=>dlg.close();
$('#setSave').onclick=()=>{ SETTINGS.pin=($('#pin').value||'').trim(); SETTINGS.baseFee=Math.max(0,+$('#baseFee').value||0); SETTINGS.optimPrice=Math.max(0,+$('#optimPrice').value||0); saveLS(); dlg.close(); recalc(); };

// Import JSON
$('#btnImport').onclick=()=>$('#inJSON').click();
$('#inJSON').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=await readJSONFile(f);
    if(data.panels) PAN=data.panels;
    if(data.inverters) INV=data.inverters;
    if(data.batteries) BAT=data.batteries;
    saveLS(); renderCatalog(); fillSelectors(); suggestQtyAndPower(); recalc();
    alert('Załadowano katalog z pliku JSON.');
  }catch(err){ alert('Błąd importu: '+(err.message||err)); }
  e.target.value='';
});

/* ====== Katalog: przyciski ====== */
$('#seed').onclick=seed;
$('#saveAll').onclick=saveLS;
$('#clearAll').onclick=()=>{ localStorage.removeItem(KS.pan); localStorage.removeItem(KS.inv); localStorage.removeItem(KS.bat); loadLS(); renderCatalog(); fillSelectors(); recalc(); };

/* ====== start ====== */
(function boot(){
  loadLS(); if(!PAN.length||!INV.length) seed(); renderCatalog(); fillSelectors();
  const d=new Date(); const pad=n=>String(n).padStart(2,'0'); document.getElementById('genDate').textContent=`${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  document.getElementById('optimPriceLabel').textContent = String(SETTINGS.optimPrice||230);
  suggestQtyAndPower(); recalc();
})();
</script>
</body>
</html>
