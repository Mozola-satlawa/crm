
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komponenty: Fotowoltaika (z ofertƒÖ dla klienta)</title>
<meta name="description" content="Komponenty PV: modu≈Çy, falowniki, akcesoria, zestawy. Edycja, filtry, eksport. Oferta dla klienta z ukrytym narzutem firmy.">
<style>
  :root{
    --bg:#0a0f1e; --ink:#e8edff; --muted:#aeb8da; --line:#243059; --card:#0f1533; --card2:#121a34;
    --accent:#4cc9f0; --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .muted{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.warn{background:#5a3c12;border-color:#c48a26}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:13px;color:var(--muted);white-space:nowrap}
  .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .card.no-pad{padding:0}
  .card-info{padding:10px 12px}
  .subtabs{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .subtabs button{padding:8px 12px;border-radius:999px;border:1px solid #2a3a75;background:#0d1530;color:#cfe1ff;cursor:pointer}
  .subtabs button[aria-selected="true"]{background:#1b2550;border-color:#67a1ff}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff;font-size:13px}
  .right{display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .small{font-size:12px;color:#aeb8da}
  .scroll{overflow:auto}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{display:inline-block;border:1px solid #7b3341;color:#ffb4b4;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
  .search{min-width:340px}
  .two-cols{grid-template-columns:1fr 1fr}
  .full-col{grid-column:1 / -1}
  .full{width:100%}
  .mt-10{margin-top:10px}
  .mt-12{margin-top:12px}
  .mt-8{margin-top:8px}
  .w-100{width:100%}
  .narrow{max-width:120px}
  @media print{ nav,.toolbar,.subtabs,.right,.filters, .no-print{display:none!important} .offer{margin:0} }
  /* Modal (oferta dla klienta) */
  dialog::backdrop{background:rgba(0,0,0,.6)}
  dialog{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#0f1533,#121a34);color:var(--ink);max-width:900px;width:90%}
  .offer{padding:12px}
  .offer h2{margin:0 0 8px 0;font-size:20px}
  .grid{display:grid;gap:10px}
  @media(min-width:900px){ .cols-2{grid-template-columns:1.1fr 1fr} }
  .big{font-size:28px;font-weight:800}
</style>
</head>
<body>
<header>
  <h1>Komponenty ‚Ä¢ Fotowoltaika ‚Äî ARKON</h1>
    <div class="subtabs no-print" role="tablist" aria-label="Kategorie PV">
      <button role="tab" tabindex="0" class="sb" data-k="sets" aria-selected="true">Zestawy</button>
      <button role="tab" tabindex="0" class="sb" data-k="modules" aria-selected="false">Modu≈Çy</button>
      <button role="tab" tabindex="0" class="sb" data-k="inverters" aria-selected="false">Falowniki</button>
      <button role="tab" tabindex="0" class="sb" data-k="acc" aria-selected="false">Akcesoria</button>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar no-print">
      <input id="q" class="search" placeholder="üîé Szukaj‚Ä¶ (marka, model, opis)">
      <span id="dynFilters" class="row filters"></span>
      <button id="btnAdd" class="btn ok">+ Dodaj pozycjƒô</button>
      <button id="btnCSV" class="btn ghost">CSV eksport</button>
      <button id="btnJSON" class="btn ghost">JSON eksport</button>
      <label class="btn ghost">JSON import <input id="inJSON" type="file" accept="application/json" hidden></label>
      <span class="pill">Widocznych: <b id="countVis">0</b></span>
      <span class="pill">≈ÅƒÖcznie: <b id="countAll">0</b></span>
      <span class="pill">Sort: <b id="sortLabel">marka‚Üímodel</b></span>
    </div>

    <!-- TABLE -->
    <div class="card no-pad">
      <div class="scroll">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="small muted no-print card-info">
        Edytuj w kom√≥rkach. Usu≈Ñ/duplikuj z kolumny ‚ÄûAkcje‚Äù. Zmiany zapisujƒÖ siƒô automatycznie.
        Skr√≥ty: <span class="kbd">/</span> fokus na wyszukiwaniu ‚Ä¢ <span class="kbd">Alt+N</span> nowa pozycja ‚Ä¢ klik nag≈Ç√≥wka = sortowanie.
      </div>
    </div>
</header>

<!-- MODAL: OFERTA DLA KLIENTA -->
<dialog id="offerModal">
  <div class="offer grid cols-2">
    <section>
      <h2>Oferta dla klienta</h2>
      <div class="muted">Wybierz modele (z katalogu), ilo≈õƒá modu≈Ç√≥w i prowizjƒô (opcjonalnie). Narzut firmy jest doliczany automatycznie i niewidoczny w rozbiciu.</div>
      <div class="grid two-cols">
        <div>
          <label>Marka paneli</label>
          <select id="of_brandP"></select>
        </div>
        <div>
          <label>Model paneli</label>
          <select id="of_modelP"></select>
        </div>
        <div>
          <label>Marka inwertera</label>
          <select id="of_brandI"></select>
        </div>
        <div>
          <label>Model inwertera</label>
          <select id="of_modelI"></select>
        </div>
        <div class="full-col">
          <label>Akcesoria (multi-select, Ctrl/Cmd)</label>
          <select id="of_acc" multiple size="6" class="full"></select>
        </div>
        <div>
          <label>Ilo≈õƒá paneli (szt.)</label>
          <input id="of_qty" type="number" min="1" step="1" value="10">
        </div>
        <div>
          <label>Prowizja handlowca (opcjonalnie)</label>
          <input id="of_comm" type="number" min="0" step="1" value="0">
        </div>
      </div>
      <div class="row mt-10">
        <button class="btn ok" id="of_calc">Przelicz</button>
        <button class="btn ghost" id="of_print">Drukuj / PDF</button>
        <button class="btn bad" id="of_close">Zamknij</button>
      </div>
    </section>
    <section>
      <table class="w-100"><thead><tr><th>Pozycja</th><th>Warto≈õƒá</th></tr></thead><tbody id="of_rows"></tbody></table>
      <div class="right mt-12"><div class="big" id="of_sum">‚Äî</div></div>
      <div class="muted mt-8">Uwaga: ukryty narzut firmy 8000 z≈Ç jest ju≈º doliczony w cenie ko≈Ñcowej, nie jest wyszczeg√≥lniony w tabeli.</div>
    </section>
  </div>
</dialog>

<script>
'use strict';

/* === sta≈Çe i helpers === */
const ALLOWED = {
  panels: ['Q-CELLS','HYUNDAI','JA SOLAR','JOLYWOOD','LONGI','TRINA','JINKO','AIKO'],
  inverters: ['DEYE','HUAWEI','SOLAREDGE','SOFAR','FOXESS','GOODWE','GROWATT','SOLAX','FELICITY'],
  accessories: ['SOLAREDGE','HUAWEI','SOFAR','FOXESS','GROWATT','TIGO','DEYE','CHINT','FRONIUS','EASTRON']
};
const BASE_PROFIT_PLN = 8000; // ukryty narzut firmy per instalacja
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT0 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const INT1 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:1});
const INT2 = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:2});
const fmt = (n,dp=0)=> (isFinite(+n)? (dp===0?INT0:dp===1?INT1:INT2).format(+n) : '‚Äî');
const money = n => isFinite(+n)? INT0.format(Math.round(+n))+' z≈Ç' : '‚Äî';
const uid = ()=> 'PV_'+Math.random().toString(36).slice(2)+'_'+Date.now().toString(36);
const esc = s => (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
const norm = s => String(s||'').trim().toUpperCase();

/* === storage keys === */
const KS = {
  sets:'arkon_pv_sets_v2',
  modules:'arkon_pv_modules_v2',
  inverters:'arkon_pv_inverters_v2',
  acc:'arkon_pv_acc_v2'
};

/* === state & filters === */
const state = {
  tab:'sets',
  q:'',
  sort:{key:'brand_model',dir:1},
  filters:{
    modules:{tech:'', pMin:'', pMax:'', effMin:'', bif:''},
    inverters:{phase:'', hybrid:'', acMin:'', acMax:'', mppt:''},
    acc:{brand:'', priceMin:'', priceMax:''},
    sets:{kwpMin:'', kwpMax:'', phase:'', storage:''}
  },
  data:{ sets:[], modules:[], inverters:[], acc:[] }
};

/* === load/save === */
function loadAll(){
  Object.keys(state.data).forEach(k=>{
    try{ state.data[k] = JSON.parse(localStorage.getItem(KS[k])||'[]'); }catch{ state.data[k]=[]; }
  });
  // odfiltruj dozwolone marki (nie niszcz danych w LS ‚Äî ale zapisujemy przefiltrowane z powrotem)
  state.data.modules   = (state.data.modules||[]).filter(x=>ALLOWED.panels.includes(norm(x.brand)));
  state.data.inverters = (state.data.inverters||[]).filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
  state.data.acc       = (state.data.acc||[]).filter(x=>ALLOWED.accessories.includes(norm(x.brand||x.cat||'')));
  localStorage.setItem(KS.modules, JSON.stringify(state.data.modules||[]));
  localStorage.setItem(KS.inverters, JSON.stringify(state.data.inverters||[]));
  localStorage.setItem(KS.acc, JSON.stringify(state.data.acc||[]));
}
function saveTab(){
  if(state.tab==='modules')   state.data.modules   = (state.data.modules||[]).filter(x=>ALLOWED.panels.includes(norm(x.brand)));
  if(state.tab==='inverters') state.data.inverters = (state.data.inverters||[]).filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
  if(state.tab==='acc')       state.data.acc       = (state.data.acc||[]).filter(x=>ALLOWED.accessories.includes(norm(x.brand||x.cat||'')));
  localStorage.setItem(KS[state.tab], JSON.stringify(state.data[state.tab]||[]));
  render();
}

/* === seed minimalny je≈õli pusto === */
function seedIfEmpty(){
  if(!(state.data.modules||[]).length){
    state.data.modules = [
      {id:uid(),brand:'JINKO',model:'JKM445N-54HL4R-B Full black',tech:'TopCon N',bifacial:'NIE',watt:445,eff:21.5,size:'1762x1134x30',temp:'-0.30',warr_prod:15,warr_perf:30,price:240,note:''},
      {id:uid(),brand:'TRINA',model:'Vertex S+ 440 FB',tech:'TopCon N',bifacial:'NIE',watt:440,eff:21.7,size:'1762x1134x30',temp:'-0.30',warr_prod:25,warr_perf:30,price:200,note:''},
      {id:uid(),brand:'LONGI',model:'LR7-54HTH-460M',tech:'HPBC',bifacial:'NIE',watt:460,eff:21.9,size:'1903x1134x30',temp:'-0.29',warr_prod:15,warr_perf:25,price:225,note:''},
      {id:uid(),brand:'JA SOLAR',model:'JAM60D41-500/LB Full Black (bif.)',tech:'TopCon N',bifacial:'TAK',watt:500,eff:22.0,size:'1903x1134x30',temp:'-0.29',warr_prod:15,warr_perf:30,price:250,note:''}
    ];
  }
  if(!(state.data.inverters||[]).length){
    state.data.inverters = [
      {id:uid(),brand:'HUAWEI',model:'SUN2000-10KTL-M1-HC',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:2,max_v:1080,eff:98.6,price:3953,note:''},
      {id:uid(),brand:'SOFAR',model:'HYD 10KTL 3F',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:2,max_v:1100,eff:98.2,price:6227,note:''},
      {id:uid(),brand:'GOODWE',model:'GW10K-ET-20',phase:'3F',hybrid:'TAK',ac_kw:10,mppt:3,max_v:1000,eff:98.0,price:4631,note:''}
    ];
  }
  if(!(state.data.acc||[]).length){
    state.data.acc = [
      {id:uid(),brand:'HUAWEI',cat:'AC',name:'DTSU666-H 3F 250A',spec:'licznik',price:497,note:''},
      {id:uid(),brand:'SOLAREDGE',cat:'DC',name:'Optymalizator S500',spec:'700W',price:176,note:''},
      {id:uid(),brand:'SOFAR',cat:'AC',name:'DTSD422-D 3F',spec:'licznik',price:426,note:''},
      {id:uid(),brand:'EASTRON',cat:'AC',name:'SDM630MCT 3F (DEYE)',spec:'licznik',price:410,note:''}
    ];
  }
  if(!(state.data.sets||[]).length){
    state.data.sets = [
      {id:uid(),title:'6.2 kWp ‚Ä¢ Trina 440 + Huawei M1',kwp:6.16,phase:'3F',storage:'opcjonalnie',items:'Modu≈Çy: 14√ó TRINA Vertex S+ 440 FB; Falownik: HUAWEI SUN2000-10KTL-M1-HC; Akcesoria: DTSU666-H',price:36900,note:'DC/AC‚âà0.61'},
      {id:uid(),title:'8.9 kWp ‚Ä¢ Jinko 445 + Sofar HYD 10 (hybryda)',kwp:8.90,phase:'3F',storage:'TAK',items:'Modu≈Çy: 20√ó JINKO JKM445N-54HL4R-B; Falownik: SOFAR HYD 10KTL 3F; Akcesoria: Optymalizatory S500',price:51200,note:'HV ready'}
    ];
  }
}

/* === kolumny === */
const COLS = {
  sets:[
    {k:'title',lbl:'Nazwa zestawu',w:280},
    {k:'kwp',lbl:'Moc [kWp]',num:1},
    {k:'phase',lbl:'Fazy',sel:['1F','3F']},
    {k:'storage',lbl:'Magazyn',sel:['NIE','opcjonalnie','TAK']},
    {k:'items',lbl:'Sk≈Çad',w:420},
    {k:'price',lbl:'Cena (bazowa) [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:220}
  ],
  modules:[
    {k:'brand',lbl:'Marka (dozwolone: panele)'},
    {k:'model',lbl:'Model',w:220},
    {k:'tech',lbl:'Technologia',sel:['Mono PERC','TopCon N','HJT','HPBC','IBC','Inna']},
    {k:'bifacial',lbl:'Bifacial',sel:['NIE','TAK']},
    {k:'watt',lbl:'Moc [W]',num:0},
    {k:'eff',lbl:'Sprawno≈õƒá [%]',num:2},
    {k:'size',lbl:'Wymiar [mm]',w:150},
    {k:'temp',lbl:'Coeff. [%/¬∞C]'},
    {k:'warr_prod',lbl:'Gwarancja prod. [l]',num:0},
    {k:'warr_perf',lbl:'Gwarancja perf. [l]',num:0},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:180}
  ],
  inverters:[
    {k:'brand',lbl:'Marka (dozwolone: inwertery)'},
    {k:'model',lbl:'Model',w:220},
    {k:'phase',lbl:'Fazy',sel:['1F','3F']},
    {k:'hybrid',lbl:'Hybryda',sel:['NIE','TAK']},
    {k:'ac_kw',lbl:'Moc AC [kW]',num:1},
    {k:'mppt',lbl:'MPPT',num:0},
    {k:'max_v',lbl:'V max [V]',num:0},
    {k:'eff',lbl:'Sprawno≈õƒá [%]',num:1},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:200}
  ],
  acc:[
    {k:'brand',lbl:'Marka (dozwolone: akcesoria)'},
    {k:'cat',lbl:'Kategoria',sel:['DC','AC','Okablowanie','Z≈ÇƒÖcza','Bezpieczniki','Rozdzielnica','Pomiar','Inne']},
    {k:'name',lbl:'Nazwa',w:240},
    {k:'spec',lbl:'Specyfikacja',w:160},
    {k:'price',lbl:'Cena [z≈Ç]',num:0},
    {k:'note',lbl:'Uwagi',w:220}
  ]
};

/* === render filtr√≥w === */
function renderDynamicFilters(){
  const box = $('#dynFilters'); box.innerHTML='';
  if(state.tab==='modules'){
    box.innerHTML = `
      <select id="f_tech"><option value="">Technologia (wszystkie)</option>${['Mono PERC','TopCon N','HJT','HPBC','IBC','Inna'].map(t=>`<option>${esc(t)}</option>`).join('')}</select>
      <input id="f_pmin" class="narrow" type="number" placeholder="Moc min [W]">
      <input id="f_pmax" class="narrow" type="number" placeholder="Moc max [W]">
      <input id="f_eff" type="number" step="0.1" placeholder="Sprawno≈õƒá min [%]">
      <select id="f_bif"><option value="">Bifacial?</option><option>TAK</option><option>NIE</option></select>`;
    ['f_tech','f_pmin','f_pmax','f_eff','f_bif'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='inverters'){
    box.innerHTML = `
      <select id="f_phase"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
      <select id="f_hyb"><option value="">Hybryda?</option><option>TAK</option><option>NIE</option></select>
      <input id="f_acmin" class="narrow" type="number" step="0.1" placeholder="AC kW min">
      <input id="f_acmax" class="narrow" type="number" step="0.1" placeholder="AC kW max">
      <input id="f_mppt" type="number" placeholder="MPPT ‚â•">`;
    ['f_phase','f_hyb','f_acmin','f_acmax','f_mppt'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }else if(state.tab==='acc'){
    box.innerHTML = `
      <input id="f_abrand" placeholder="Marka (np. HUAWEI)">
      <input id="f_apmin" class="narrow" type="number" placeholder="Cena min">
      <input id="f_apmax" class="narrow" type="number" placeholder="Cena max">`;
    ['f_abrand','f_apmin','f_apmax'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); });
  }else if(state.tab==='sets'){
    box.innerHTML = `
      <input id="f_kwpmin" class="narrow" type="number" step="0.1" placeholder="kWp min">
      <input id="f_kwpmax" class="narrow" type="number" step="0.1" placeholder="kWp max">
      <select id="f_phase_s"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
      <select id="f_store"><option value="">Magazyn</option><option>NIE</option><option>opcjonalnie</option><option>TAK</option></select>`;
    ['f_kwpmin','f_kwpmax','f_phase_s','f_store'].forEach(id=>{ $('#'+id).addEventListener('input',applyFilters); $('#'+id).addEventListener('change',applyFilters); });
  }
}
function applyFilters(){
  if(state.tab==='modules'){
    state.filters.modules={tech:$('#f_tech').value,pMin:$('#f_pmin').value,pMax:$('#f_pmax').value,effMin:$('#f_eff').value,bif:$('#f_bif').value};
  }else if(state.tab==='inverters'){
    state.filters.inverters={phase:$('#f_phase').value,hybrid:$('#f_hyb').value,acMin:$('#f_acmin').value,acMax:$('#f_acmax').value,mppt:$('#f_mppt').value};
  }else if(state.tab==='acc'){
    state.filters.acc={brand:$('#f_abrand').value,priceMin:$('#f_apmin').value,priceMax:$('#f_apmax').value};
  }else if(state.tab==='sets'){
    state.filters.sets={kwpMin:$('#f_kwpmin').value,kwpMax:$('#f_kwpmax').value,phase:$('#f_phase_s').value,storage:$('#f_store').value};
  }
  render();
}

/* === sort === */
function toggleSort(key){
  if(state.sort.key===key){ state.sort.dir*=-1; } else { state.sort.key=key; state.sort.dir=1; }
  render();
}
function sortFn(a,b){
  const k=state.sort.key, d=state.sort.dir;
  const va = String(a[k]??'').toLowerCase();
  const vb = String(b[k]??'').toLowerCase();
  if(!isNaN(+a[k]) && !isNaN(+b[k])) return d*(+a[k]-+b[k]);
  return d*va.localeCompare(vb,'pl',{sensitivity:'base'});
}

/* === render === */
function renderHead(){
  const cols = COLS[state.tab];
  const ths = ['<th>Akcje</th>'].concat(cols.map(c=>`<th>${esc(c.lbl)}</th>`));
  $('#thead').innerHTML = `<tr>${ths.join('')}</tr>`;
  // sort
  Array.from($('#thead').querySelectorAll('th')).forEach((th,i)=>{
    if(i===0) return;
    const col = cols[i-1];
    th.style.cursor='pointer';
    th.title = 'Kliknij aby sortowaƒá';
    th.addEventListener('click',()=>{ toggleSort(col.k); $('#sortLabel').textContent = col.lbl; });
  });
}
function render(){
  renderHead();
  renderDynamicFilters();

  const cols = COLS[state.tab];
  let rows = (state.data[state.tab]||[]).slice();

  // search
  const q = ($('#q').value||'').toLowerCase();
  if(q){ rows = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(q) ); }

  // enforce allowed (na etapie widoku te≈º)
  if(state.tab==='modules')   rows = rows.filter(x=>ALLOWED.panels.includes(norm(x.brand)));
  if(state.tab==='inverters') rows = rows.filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
  if(state.tab==='acc')       rows = rows.filter(x=>ALLOWED.accessories.includes(norm(x.brand||x.cat||'')));

  // per-tab filters
  if(state.tab==='modules'){
    const f=state.filters.modules;
    if(f.tech) rows=rows.filter(r=>r.tech===f.tech);
    if(f.bif) rows=rows.filter(r=>String(r.bifacial).toUpperCase()===f.bif.toUpperCase());
    if(+f.pMin) rows=rows.filter(r=>+r.watt >= +f.pMin);
    if(+f.pMax) rows=rows.filter(r=>+r.watt <= +f.pMax);
    if(+f.effMin) rows=rows.filter(r=>+r.eff >= +f.effMin);
  }else if(state.tab==='inverters'){
    const f=state.filters.inverters;
    if(f.phase) rows=rows.filter(r=>r.phase===f.phase);
    if(f.hybrid) rows=rows.filter(r=>r.hybrid===f.hybrid);
    if(+f.acMin) rows=rows.filter(r=>+r.ac_kw >= +f.acMin);
    if(+f.acMax) rows=rows.filter(r=>+r.ac_kw <= +f.acMax);
    if(+f.mppt) rows=rows.filter(r=>+r.mppt >= +f.mppt);
  }else if(state.tab==='acc'){
    const f=state.filters.acc;
    if(f.brand) rows=rows.filter(r=>norm(r.brand||r.cat||'').includes(norm(f.brand)));
    if(+f.priceMin) rows=rows.filter(r=>+r.price >= +f.priceMin);
    if(+f.priceMax) rows=rows.filter(r=>+r.price <= +f.priceMax);
  }else if(state.tab==='sets'){
    const f=state.filters.sets;
    if(+f.kwpMin) rows=rows.filter(r=>+r.kwp >= +f.kwpMin);
    if(+f.kwpMax) rows=rows.filter(r=>+r.kwp <= +f.kwpMax);
    if(f.phase) rows=rows.filter(r=>r.phase===f.phase);
    if(f.storage) rows=rows.filter(r=>r.storage===f.storage);
  }

  // sort
  if(state.sort.key==='brand_model'){
    rows.sort((a,b)=>{
      const a1=(a.brand||'')+' '+(a.model||'');
      const b1=(b.brand||'')+' '+(b.model||'');
      return state.sort.dir * a1.localeCompare(b1,'pl',{sensitivity:'base'});
    });
  }else{
    rows.sort(sortFn);
  }

  $('#countAll').textContent = (state.data[state.tab]||[]).length;
  $('#countVis').textContent = rows.length;

  const tb = $('#tbody'); tb.innerHTML='';
  rows.forEach((r)=>{
    const tr=document.createElement('tr');
    // actions
    const act = document.createElement('td');
    act.innerHTML = `
      <div class="row">
        ${state.tab==='sets'? `<button class="btn warn" data-act="offer" data-id="${r.id}">Oferta dla klienta</button>` : ''}
        <button class="btn ghost" data-act="dup" data-id="${r.id}">Duplikuj</button>
        <button class="btn bad" data-act="del" data-id="${r.id}">Usu≈Ñ</button>
      </div>`;
    tr.appendChild(act);

    cols.forEach(col=>{
      const td=document.createElement('td');
      let v = r[col.k];
      const id = r.id+''+col.k;
      if(col.sel){
        td.innerHTML = `<select id="${id}">${col.sel.map(o=>`<option ${o==v?'selected':''}>${esc(o)}</option>`).join('')}</select>`;
      }else if(col.num!=null){
        td.innerHTML = `<input id="${id}" type="number" class="narrow" step="${col.num===0?1:(col.num===1?0.1:0.01)}" value="${v??''}">`;
      }else{
        td.innerHTML = `<input id="${id}" value="${v==null?'':esc(v)}">`;
      }
      tr.appendChild(td);
      const el = td.querySelector('#'+CSS.escape(id));
      if(col.w && el) el.style.minWidth = col.w+'px';
      if(el){
        el.addEventListener('input', ()=> editCell(r.id, col.k, (col.num!=null? (el.value===''? '' : +el.value) : el.value)) );
        el.addEventListener('change', ()=> editCell(r.id, col.k, (col.num!=null? (el.value===''? '' : +el.value) : el.value)) );
      }
    });

    tb.appendChild(tr);
  });

  // bind actions
  tb.querySelectorAll('[data-act="del"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id;
    state.data[state.tab] = (state.data[state.tab]||[]).filter(x=>x.id!==id);
    saveTab();
  }));
  tb.querySelectorAll('[data-act="dup"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id;
    const src = (state.data[state.tab]||[]).find(x=>x.id===id);
    if(!src) return;
    const copy = JSON.parse(JSON.stringify(src)); copy.id=uid();
    if(copy.title) copy.title = copy.title + ' (kopia)';
    state.data[state.tab].unshift(copy);
    saveTab();
  }));
  tb.querySelectorAll('[data-act="offer"]').forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.id;
    const set = (state.data.sets||[]).find(x=>x.id===id) || {};
    openOffer(set);
  }));
}
function editCell(id,key,val){
  const arr = state.data[state.tab]||[];
  const it = arr.find(x=>x.id===id); if(!it) return;
  if(state.tab==='modules' && key==='brand' && !ALLOWED.panels.includes(norm(val||''))) return render();
  if(state.tab==='inverters' && key==='brand' && !ALLOWED.inverters.includes(norm(val||''))) return render();
  if(state.tab==='acc' && key==='brand' && !ALLOWED.accessories.includes(norm(val||''))) return render();
  it[key]=val;
  saveTab();
}

/* === UI binds === */
// switch tab
$$('.sb').forEach(b=>b.addEventListener('click',()=>{
  $$('.sb').forEach(x=>x.setAttribute('aria-selected','false'));
  b.setAttribute('aria-selected','true');
  state.tab = b.dataset.k;
  state.sort = {key:'brand_model',dir:1}; // reset sort
  render();
}));

// search & shortcuts
$('#q').addEventListener('input', e=>{ state.q = e.target.value.trim(); render(); });
window.addEventListener('keydown', e=>{ if(e.key==='/' && document.activeElement && !/^(INPUT|SELECT|TEXTAREA)$/.test(document.activeElement.tagName)){ e.preventDefault(); $('#q').focus(); } });
window.addEventListener('keydown', e=>{ if(e.altKey && /n/i.test(e.key)) addRow(); });

// add / export / import
$('#btnAdd').addEventListener('click', addRow);
$('#btnCSV').addEventListener('click', ()=>{
  const cols = COLS[state.tab].map(c=>c.k);
  toCSV(state.data[state.tab]||[], cols);
});
$('#btnJSON').addEventListener('click', ()=> saveJSON(state.data[state.tab]||[]) );
$('#inJSON').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const arr=await readJSON(f);
    if(!Array.isArray(arr)) throw new Error('Z≈Çy plik JSON (oczekujƒô tablicy).');
    let cleaned=arr;
    if(state.tab==='modules')   cleaned=arr.filter(x=>ALLOWED.panels.includes(norm(x.brand)));
    if(state.tab==='inverters') cleaned=arr.filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
    if(state.tab==='acc')       cleaned=arr.filter(x=>ALLOWED.accessories.includes(norm(x.brand||x.cat||'')));
    state.data[state.tab]=cleaned;
    saveTab();
  }catch(err){ alert('B≈ÇƒÖd importu: '+(err.message||err)); }
  e.target.value='';
});

function toCSV(rows, cols){
  const escCsv = v => { let s=(v==null?'':String(v)); if(/[;\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; };
  const out = [cols.join(';')].concat(rows.map(r=>cols.map(c=>escCsv(r[c])).join(';')));
  const blob = new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_'+state.tab+'.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function saveJSON(data){
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_'+state.tab+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function readJSON(f){ return f.text().then(t=>JSON.parse(t)); }

function addRow(){
  const def = (tab)=>{
    switch(tab){
      case 'modules': return {id:uid(),brand:'JINKO',model:'',tech:'Mono PERC',bifacial:'NIE',watt:450,eff:21,size:'',temp:'-0.35',warr_prod:12,warr_perf:25,price:0,note:''};
      case 'inverters': return {id:uid(),brand:'HUAWEI',model:'',phase:'3F',hybrid:'NIE',ac_kw:10,mppt:2,max_v:1000,eff:98,price:0,note:''};
      case 'acc': return {id:uid(),brand:'HUAWEI',cat:'AC',name:'',spec:'',price:0,note:''};
      case 'sets': return {id:uid(),title:'Nowy zestaw',kwp:5.0,phase:'3F',storage:'NIE',items:'',price:0,note:''};
    }
  };
  state.data[state.tab].unshift(def(state.tab));
  saveTab();
}

/* === OFERTA (modal kalkulator-kliencki, bez u≈ºycia og√≥lnego kalkulatora) === */
function openOffer(set){
  // z katalogu podajemy tylko dozwolone marki
  const catalog = {
    panels:   (state.data.modules||[]).map(x=>({brand:norm(x.brand),model:x.model,price:+x.price||0})),
    inverters:(state.data.inverters||[]).map(x=>({brand:norm(x.brand),model:x.model,price:+x.price||0})),
    acc:      (state.data.acc||[]).map(x=>({brand:norm(x.brand||x.cat||''),name:(x.name||x.model||x.spec||''),price:+x.price||0}))
  };
  // wype≈Çnij selecty
  const bP = $('#of_brandP'), mP=$('#of_modelP'), bI=$('#of_brandI'), mI=$('#of_modelI'), A=$('#of_acc');
  // marki (unikalne)
  const brandsP=[...new Set(catalog.panels.map(x=>x.brand))].sort();
  const brandsI=[...new Set(catalog.inverters.map(x=>x.brand))].sort();
  bP.innerHTML = brandsP.map(b=>`<option>${esc(b)}</option>`).join('');
  bI.innerHTML = brandsI.map(b=>`<option>${esc(b)}</option>`).join('');
  function syncModels(kind){
    if(kind==='P'){
      const models=catalog.panels.filter(x=>x.brand===bP.value);
      mP.innerHTML=models.map(m=>`<option value="${esc(m.model)}">${esc(m.model)} (${money(m.price)})</option>`).join('');
    }else{
      const models=catalog.inverters.filter(x=>x.brand===bI.value);
      mI.innerHTML=models.map(m=>`<option value="${esc(m.model)}">${esc(m.model)} (${money(m.price)})</option>`).join('');
    }
  }
  bP.onchange=()=>syncModels('P'); bI.onchange=()=>syncModels('I');
  bP.dispatchEvent(new Event('change')); bI.dispatchEvent(new Event('change'));
  // akcesoria
  const accSorted=catalog.acc.slice().sort((a,b)=>(a.brand+a.name).localeCompare(b.brand+b.name,'pl'));
  A.innerHTML = accSorted.map(a=>`<option value="${esc(a.brand)}||${esc(a.name)}">${esc(a.brand)} ‚Äî ${esc(a.name)} (${money(a.price)})</option>`).join('');

  // spr√≥buj ‚Äûprefill‚Äù z opisu zestawu
  const items=String(set.items||'');
  const mQty=items.match(/(\d+)\s*[√óxX]/); if(mQty) $('#of_qty').value = +mQty[1];
  const pBrand = ALLOWED.panels.find(b=> new RegExp('\\b'+b+'\\b','i').test(items));
  if(pBrand){
    bP.value=pBrand; bP.dispatchEvent(new Event('change'));
    const m=new RegExp(pBrand+'\\s+([^;]+?)(?:;|Falownik|,|$)','i').exec(items);
    if(m){
      const wanted=m[1].trim();
      const hit = catalog.panels.find(x=>x.brand===pBrand && new RegExp(wanted.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i').test(x.model));
      if(hit) mP.value=hit.model;
    }
  }
  const iBrand = ALLOWED.inverters.find(b=> new RegExp('\\b'+b+'\\b','i').test(items));
  if(iBrand){
    bI.value=iBrand; bI.dispatchEvent(new Event('change'));
    const m=new RegExp(iBrand+'\\s+([^;]+?)(?:;|Magazyn|,|$)','i').exec(items);
    if(m){
      const wanted=m[1].trim();
      const hit = catalog.inverters.find(x=>x.brand===iBrand && new RegExp(wanted.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i').test(x.model));
      if(hit) mI.value=hit.model;
    }
  }
  if(/DTSU|DTSD|SDM|licznik/i.test(items)){
    Array.from(A.options).forEach(o=>{ if(/DTSU|DTSD|SDM/i.test(o.textContent)) o.selected=true; });
  }
  if(/optymali[zs]ator|S500|TIGO|TS4/i.test(items)){
    Array.from(A.options).forEach(o=>{ if(/Optymalizator|TIGO|TS4/i.test(o.textContent)) o.selected=true; });
  }

  // liczenie
  function pricePanel(brand,model){ const hit=catalog.panels.find(x=>x.brand===brand && x.model===model); return hit?.price||0; }
  function priceInv(brand,model){ const hit=catalog.inverters.find(x=>x.brand===brand && x.model===model); return hit?.price||0; }
  function priceAcc(brand,name){ const hit=catalog.acc.find(x=>x.brand===brand && x.name===name); return hit?.price||0; }
  function recalc(){
    const qty = Math.max(1, +$('#of_qty').value||0);
    const bp=bP.value, mp=mP.value, bi=bI.value, mi=mI.value;
    const pPanel = pricePanel(bp,mp);
    const pInv   = priceInv(bi,mi);
    const selAcc = Array.from(A.selectedOptions).map(o=>o.value.split('||'));
    const sumPanels=pPanel*qty;
    const sumAcc = selAcc.reduce((a,[b,n])=>a+priceAcc(b,n),0);
    const comm = Math.max(0, +$('#of_comm').value||0);
    const subtotal = sumPanels + pInv + sumAcc;
    const grand = subtotal + BASE_PROFIT_PLN + comm;
    const rows = [
      ['Panele', `${bp} ‚Ä¢ ${mp} √ó ${qty} = ${money(sumPanels)}`],
      ['Inwerter', `${bi} ‚Ä¢ ${mi} = ${money(pInv)}`],
      ['Akcesoria', selAcc.length ? selAcc.map(([b,n])=>`${b} ${n}`).join(', ') + ' = ' + money(sumAcc) : '‚Äî'],
      ['Prowizja handlowca (opc.)', money(comm)]
    ];
    $('#of_rows').innerHTML = rows.map(([k,v])=>`<tr><th>${esc(k)}</th><td>${esc(v)}</td></tr>`).join('');
    $('#of_sum').textContent = money(grand);
  }
  $('#of_calc').onclick = recalc;
  $('#of_print').onclick = ()=>{ recalc(); window.print(); };
  $('#of_close').onclick = ()=> $('#offerModal').close();

  recalc();
  $('#offerModal').showModal();
}

/* === boot === */
loadAll();
seedIfEmpty();
// jeszcze raz zapisz przefiltrowane
state.data.modules   = (state.data.modules||[]).filter(x=>ALLOWED.panels.includes(norm(x.brand)));
state.data.inverters = (state.data.inverters||[]).filter(x=>ALLOWED.inverters.includes(norm(x.brand)));
state.data.acc       = (state.data.acc||[]).filter(x=>ALLOWED.accessories.includes(norm(x.brand||x.cat||'')));
localStorage.setItem(KS.modules, JSON.stringify(state.data.modules||[]));
localStorage.setItem(KS.inverters, JSON.stringify(state.data.inverters||[]));
localStorage.setItem(KS.acc, JSON.stringify(state.data.acc||[]));
render();
</script>
</body>
</html>
