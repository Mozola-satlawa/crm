<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kalkulator Czyste Powietrze – ARKON</title>
<meta name="description" content="Kalkulator dotacji Czyste Powietrze 2025: źródło ciepła, ocieplenie, stolarka, dodatki (mb), limity dotacji na m2/mb, VAT 8/23%, zapis, CSV, DRUK z podsumowaniem i danymi klienta.">
<style>
  :root{ --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2b8a57; --grid:#243059; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e); color:var(--ink); font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{max-width:1200px;margin:auto;padding:24px 16px 120px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:22px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid #1c2750;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px #0006}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.cols-3{grid-template-columns:1fr 1fr 1fr}.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,button{font:500 15px/1.2 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
  input,select{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:10px;outline:none}
  input:focus,select:focus{border-color:#3b4fa0;box-shadow:0 0 0 3px #3b4fa033}
  input.num{text-align:right}
  button{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
  button.ghost{background:transparent;border:1px dashed #3a4ca3}
  button.ok{background:#194d34;border-color:var(--ok)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab-btn[aria-selected="true"]{background:#1b2550;border-color:#67a1ff;box-shadow:0 0 0 2px #67a1ff44}
  .tab-btn{background:#233261;border:1px solid #3a4ca3;border-radius:999px;padding:10px 14px}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:8px 10px;margin:4px 8px 0 0;font-size:13px;color:#aeb8da}
  .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .hidden{display:none}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--grid);text-align:left;vertical-align:middle}
  th.num,td.num{text-align:right}
  .num{font-variant-numeric:tabular-nums}
  [aria-live="polite"]{outline:none}
  .cap-badge{display:inline-block;margin-left:8px;padding:2px 8px;border:1px solid #ff7b7b;border-radius:999px;font-size:11px;color:#ffdada;background:#3a0e14}
  .dim{opacity:.6}
  .backlink{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid #3950a5;background:#243468;text-decoration:none;color:#fff}

  /* FOOTER */
  .site-footer{max-width:1200px;margin:16px auto 24px; color:#a9b6e6}
  .site-footer .inner{display:flex;gap:16px;align-items:center;padding:12px 16px;border:1px solid #1c2750;border-radius:12px;background:linear-gradient(180deg,#0e1740,#0f1a4a)}
  .site-footer .f-text{font-size:13px;line-height:1.35}
  .site-footer .f-text b{color:#dfe6ff}

  /* BLOK DO DRUKU */
  #printSummary{display:none;background:#fff;color:#000;border:1px solid #bbb;border-radius:8px;padding:12px;margin:10px 0}
  #printSummary h2{margin:0 0 8px 0;font-size:16px}
  #printSummary table{width:100%;border-collapse:collapse}
  #printSummary th,#printSummary td{border-bottom:1px solid #bbb;padding:6px 8px;font-size:12px;text-align:left}
  #printSummary .row{display:flex;gap:16px;flex-wrap:wrap;margin:8px 0}
  #printSummary .cell{flex:1 1 260px;border:1px dashed #999;padding:8px;border-radius:6px}

  /* UTILITY CLASSES (moved from inline styles) */
  .heading-sub{ margin:0 0 8px 0; }
  .muted-block{ display:block; margin-bottom:6px; }
  .ml-10{ margin-left:10px; display:inline-block; }
  .section-title{ margin:12px 0 6px 0; }
  .right-mt10{ margin-top:10px; }
  .muted-mb8{ margin-bottom:8px; }
  .right-mb6{ margin-bottom:6px; }
  .overflow-auto{ overflow:auto; }
  .row-mt12{ margin-top:12px; }
  .flex-gap40-mt24{ display:flex; gap:40px; margin-top:24px; }
  .signature{ flex:1; border-top:1px solid #333; padding-top:6px; text-align:center; font-size:12px; }

  /* PRINT */
  @media print{
    @page{ size:A4 landscape; margin:10mm; }
    html,body{-webkit-print-color-adjust:exact; print-color-adjust:exact; background:#fff}
    body{color:#000;font:11px/1.3 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:none;margin:0;padding:0}
    header{margin:0 0 6px 0}
    h1{font-size:16px}
    .muted{color:#000;font-size:11px}
    .panel{box-shadow:none;border:1px solid #888;background:#fff;margin:6px 0;padding:8px}
    .tabs,.right button,.tab-btn,.backlink{display:none!important}
    .pill{border-color:#888;color:#000;background:#fff;font-size:10px;padding:4px 8px}
    table{table-layout:fixed; width:100%}
    th,td{border-bottom:1px solid #bbb;padding:5px 6px}
    thead th{font-size:10px}
    tbody td{font-size:10px}
    .num{font-variant-numeric:tabular-nums}
    #tab-main th:nth-child(1), #tab-env th:nth-child(1){width:24px}
    #tab-main th:nth-child(2){width:210px}
    #tab-main th:nth-child(3){width:90px}
    #tab-main th:nth-child(4){width:90px}
    #tab-main th:nth-child(5){width:95px}
    #tab-main th:nth-child(6){width:95px}
    #tab-main th:nth-child(7){width:90px}
    #tab-main th:nth-child(8){width:90px}
    #tab-main th:nth-child(9){width:95px}
    #tab-env th:nth-child(2){width:210px}
    #tab-env th:nth-child(3){width:90px}
    #tab-env th:nth-child(4){width:140px}
    #tab-env th:nth-child(5){width:130px}
    #tab-env th:nth-child(6){width:95px}
    #tab-env th:nth-child(7){width:95px}
    #tab-env th:nth-child(8){width:95px}
    #tab-env th:nth-child(9){width:95px}
    th,td{word-wrap:break-word;overflow-wrap:anywhere}
    tr{page-break-inside:avoid}
    #tbodyMain tr:not(.is-selected), #tbodyEnv tr:not(.is-selected){display:none}
    input, select {border:0;background:transparent;padding:0}
    .site-footer{color:#000}
    .site-footer .inner{background:#fff;border-color:#bbb}
    .print-signs{display:block}
    #printSummary{display:block}
  }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div>
    <h2 id="metryczkaTitle" class="muted heading-sub">Metryczka</h2>
    <div class="grid cols-3">
      <div>
        <label for="typ">Typ gospodarstwa</label>
        <select id="typ"><option value="">— wybierz —</option><option>JEDNO</option><option>WIELO</option></select>
      </div>
      <div>
        <label for="doch_mies">Miesięczny dochód na osobę [zł]</label>
        <input id="doch_mies" inputmode="decimal" placeholder="np. 2100">
      </div>
      <div>
        <label for="doch_roczny">Roczny dochód wnioskodawcy [zł]</label>
        <input id="doch_roczny" inputmode="decimal" placeholder="np. 120000">
      </div>
      <div>
        <label for="swiadczenia">Świadczenia (MOPS/GOPS)</label>
        <select id="swiadczenia"><option value="">— wybierz —</option><option>TAK</option><option>NIE</option></select>
      </div>
      <div>
        <span class="muted muted-block">Tryb cen, które wpisuję</span>
        <div class="pill" role="radiogroup" aria-label="Tryb cen">
          <label><input type="radio" name="pm" value="NETTO" checked> NETTO</label>
          <label class="ml-10"><input type="radio" name="pm" value="BRUTTO"> BRUTTO (VAT <span id="vatRadio">8</span>%)</label>
        </div>
      </div>
      <div>
        <label for="vatSel">VAT (dla kwot BRUTTO)</label>
        <select id="vatSel">
          <option value="0.08" selected>8% (mieszkaniowe)</option>
          <option value="0.23">23% (inne)</option>
        </select>
      </div>
      <div class="pill">Poziom: <b id="poziom">—</b></div>
      <div class="pill">Procent: <b id="procent">—</b></div>
    </div>

    <h3 class="muted section-title">Dane do wydruku</h3>
    <div class="grid cols-3">
      <div><label for="klient_nazwa">Klient – imię i nazwisko / firma</label><input id="klient_nazwa" placeholder="np. Jan Kowalski"></div>
      <div><label for="klient_adres">Adres inwestycji</label><input id="klient_adres" placeholder="ul. ... , miejscowość"></div>
      <div><label for="klient_tel">Telefon</label><input id="klient_tel" placeholder="+48 ..."></div>
      <div><label for="klient_email">E-mail</label><input id="klient_email" placeholder="email@..."></div>
      <div><label for="handlowiec">Handlowiec</label><input id="handlowiec" placeholder="imię i nazwisko"></div>
      <div><label for="data_oferty">Data</label><input id="data_oferty" type="date"></div>
    </div>
    </div>
  </header>

  <!-- PODSUMOWANIE + DRUK -->
  <section class="panel" aria-labelledby="sumTitle">
    <h2 id="sumTitle" class="muted heading-sub">Podsumowanie</h2>
    <div aria-live="polite">
      <span class="pill">Wybrane (źródło): <b id="selCountMain">0</b></span>
      <span class="pill">Wybrane (ocieplenie): <b id="selCountEnv">0</b></span>
      <span class="pill">Suma dotacji: <b id="sumGrantAll">0</b> zł</span>
      <span class="pill">Min. wymagany wydatek (netto): <b id="sumNeedAll">—</b> zł</span>
      <span class="pill">Suma dopłaty (brutto): <b id="sumCopayAll">0</b> zł</span>
      <span class="pill">Limit globalny: <b id="globalCap">—</b> zł</span>
      <span class="pill">Limit użyty? <b id="globalCapUsed">—</b></span>
      <span class="pill">Limit ocieplenie/stolarka: <b id="envCap">—</b> zł</span>
      <span class="pill">Limit O/S użyty? <b id="envCapUsed">—</b></span>
    </div>
    <div class="right right-mt10">
      <button id="btnSave" class="ghost" type="button">Zapisz</button>
      <button id="btnLoad" class="ghost" type="button">Wczytaj</button>
      <button id="btnPrint" class="ok" type="button">Drukuj</button>
      <button id="btnCSVAll" class="ghost" type="button">CSV (łączny)</button>
    </div>
  </section>

  <!-- ŹRÓDŁO CIEPŁA -->
  <section id="tab-main" role="tabpanel" aria-labelledby="tabbtn-main">
    <section class="panel">
      <div class="muted muted-mb8">
        Dotacja = min(koszt NETTO × % , limit dla aktywnego poziomu). Dopuszczalne tylko jedno źródło ciepła – wybranie innego odznacza poprzednie.
      </div>
      <div class="right right-mb6">
        <button id="btnPresetMain" class="ghost" type="button">Przywróć domyślne</button>
        <button id="btnAutoNeedMain" class="ghost" type="button">Auto: 100% limitu</button>
        <button id="btnCSVMain" class="ghost" type="button">CSV (główne)</button>
      </div>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr>
              <th scope="col">Wybierz</th>
              <th scope="col">Komponent / Wariant</th>
              <th scope="col" class="num">Koszt (Twoja kwota)</th>
              <th scope="col" class="num">Limit (aktywny)</th>
              <th scope="col" class="num">Min. wydatek (netto)</th>
              <th scope="col" class="num">Min. wydatek (brutto)</th>
              <th scope="col" class="num">Dotacja</th>
              <th scope="col" class="num">Koszt brutto</th>
              <th scope="col" class="num">Dopłata (brutto)</th>
            </tr>
          </thead>
          <tbody id="tbodyMain"></tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="num"><b>SUMA (główne)</b></td>
              <td class="num" id="sumMain">0</td>
              <td class="num" id="sumMainGross">0</td>
              <td class="num" id="sumMainCopay">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>

  <!-- OCIEPLENIE / STOLARKA / DODATKI -->
  <section id="tab-env" class="hidden" role="tabpanel" aria-labelledby="tabbtn-env">
    <section class="panel">
      <div class="muted">Dotacja = min( koszt NETTO × % , ilość × stawka_dotacji_netto_na_jednostkę ). Jednostka: m² lub mb. Ceny brutto liczone z VAT <span id="vatLive2">8</span>%.</div>
    </section>
    <section class="panel">
      <div class="right right-mb6">
        <button id="btnPresetEnv" class="ghost" type="button">Przywróć domyślne</button>
        <button id="btnAutoNeedEnv" class="ghost" type="button">Auto: 100% stawki</button>
        <button id="btnCSVEnv" class="ghost" type="button">CSV (ocieplenie)</button>
      </div>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr>
              <th scope="col">Wybierz</th>
              <th scope="col">Pozycja</th>
              <th scope="col" class="num">Ilość [m²/mb]</th>
              <th scope="col" class="num">Twoja cena / m² / mb (NETTO/BRUTTO)</th>
              <th scope="col" class="num">Maks. dotacja / m² / mb (NETTO)</th>
              <th scope="col" class="num">Koszt NETTO</th>
              <th scope="col" class="num">Limit z ilości</th>
              <th scope="col" class="num">Dotacja</th>
              <th scope="col" class="num">Koszt BRUTTO</th>
              <th scope="col" class="num">Dopłata (brutto)</th>
            </tr>
          </thead>
          <tbody id="tbodyEnv"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="num"><b>SUMA (ocieplenie/stolarka + dodatki)</b></td>
              <td class="num" id="sumEnvGrant">0</td>
              <td class="num" id="sumEnvGross">0</td>
              <td class="num" id="sumEnvCopay">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>

  <!-- BLOK PODSUMOWANIA DO DRUKU -->
  <section id="printSummary" aria-hidden="true">
    <h2>Podsumowanie oferty – Czyste Powietrze</h2>
    <div class="row">
      <div class="cell">
        <b>Dane klienta</b>
        <div id="ps_client"></div>
      </div>
      <div class="cell">
        <b>Parametry programu</b>
        <div id="ps_program"></div>
      </div>
      <div class="cell">
        <b>Kwoty (całość inwestycji)</b>
        <div id="ps_totals"></div>
      </div>
    </div>
    <h3>Wybrane komponenty</h3>
    <table id="ps_table">
      <thead><tr><th>Sekcja</th><th>Nazwa</th><th>Opis</th><th class="num">Netto [zł]</th><th class="num">Brutto [zł]</th><th class="num">Dotacja [zł]</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row row-mt12">
      <div class="cell"><b>Handlowiec:</b> <span id="ps_handlowiec"></span></div>
      <div class="cell"><b>Data:</b> <span id="ps_data"></span></div>
    </div>
  <div class="flex-gap40-mt24">
      <div class="signature">Podpis klienta</div>
      <div class="signature">Podpis przedstawiciela ARKON</div>
    </div>
  </section>
</div>

<footer class="site-footer" aria-label="Dane firmy">
  <div class="inner">
    <div class="f-text">
      <b>ARKON – Przedsiębiorstwo Wielobranżowe</b><br>
      59-170 Przemków • ul. Fabryczna 12 C • NIP: 5020038830 • KRS: 0000255361<br>
      tel. 76 831 90 30 • e-mail: biuro@arkon.com.pl
    </div>
  </div>
</footer>

<script>
'use strict';

/* ===== helpers ===== */
function q(s){ return document.querySelector(s); }
function qa(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
var INT = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
function fmt(n){ return isFinite(n) ? INT.format(Math.round(n)) : '—'; }
function toNum(v){
  if (typeof v !== 'string') return Number(v) || 0;
  var s = v.replace(/\u00A0/g,' ').replace(/\s+/g,'').replace(/\./g,'').replace(',', '.');
  var n = parseFloat(s); return isFinite(n) ? n : 0;
}
function debounce(fn,ms){ var t; ms=ms||180; return function(){ var a=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,a); },ms); }; }
function todayStr(){ return new Date().toISOString().slice(0,10); }

/* ===== VAT – przełączanie 8%/23% ===== */
var VAT = 0.08;
function setVAT(v){
  VAT = Number(v) || 0.08;
  q('#vatLive').textContent = Math.round(VAT*100);
  q('#vatLive2').textContent = Math.round(VAT*100);
  q('#vatRadio').textContent = Math.round(VAT*100);
  recomputeAllRows();
  updateAggregates();
  autosave();
}
q('#vatSel').addEventListener('change', function(){ setVAT(this.value); });

/* Główna formuła */
function calcGrant(net, pct, limit){
  var pctGrant = net * (pct || 0);
  var cap = limit || 0;
  var grant = Math.min(pctGrant, cap);
  var gross = net * (1 + VAT);
  var copay = Math.max(0, gross - grant);
  var hit = pctGrant > cap + 1e-9;
  return {grant:grant, gross:gross, copay:copay, hit:hit};
}

/* ===== level / state ===== */
var state = { level:{name:'BRAK', pct:0}, priceMode:'NETTO', mainRows:[], envRows:[] };

function calcLevel(o){
  var t=(o.typ||'').toUpperCase();
  var ben=(o.swiadczenia||'').toUpperCase()==='TAK';
  var m=toNum(o.mies), r=toNum(o.roczny);
  if (ben || (t==='JEDNO' && m>0 && m<=1800) || (t==='WIELO' && m>0 && m<=1300)) return {name:'NAJWYŻSZY', pct:1};
  if ((t==='JEDNO' && m>0 && m<=3150) || (t==='WIELO' && m>0 && m<=2250)) return {name:'PODWYŻSZONY', pct:0.7};
  if (r>0 && r<=135000) return {name:'PODSTAWOWY', pct:0.4};
  return {name:'BRAK', pct:0};
}
function refreshLevel(){
  state.level = calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });
  q('#poziom').textContent=state.level.name;
  q('#procent').textContent=state.level.pct? String((state.level.pct*100).toFixed(0))+'%' : '—';
  recomputeAllRows();
  updateAggregates();
  autosave();
}
var debRefreshLevel = debounce(refreshLevel, 180);
['#typ','#doch_mies','#doch_roczny','#swiadczenia'].forEach(function(sel){
  q(sel).addEventListener('input', debRefreshLevel);
  q(sel).addEventListener('change', refreshLevel);
});
qa('input[name="pm"]').forEach(function(r){
  r.addEventListener('change', function(){
    state.priceMode=r.value;
    recomputeAllRows();
    updateAggregates();
    autosave();
  });
});
/* ===== dane GŁÓWNE ===== */
var DATA_MAIN = [
  {id:'PC',  name:'Pompa ciepła', heat:true, globalCat:null, variants:[
    {label:'powietrze/woda – standard',     lim:{P:12600,M:22000,T:31500}, globalCat:'pc_air'},
    {label:'powietrze/woda – wyższa klasa', lim:{P:14080,M:24640,T:35200}, globalCat:'pc_air'},
    {label:'powietrze/powietrze',           lim:{P: 4480,M: 7840,T:11200}, globalCat:'pc_air'},
    {label:'gruntowa – wyższa klasa',       lim:{P:18000,M:31500,T:45000}, globalCat:'pc_ground'},
    {label:'dolne źródło (odwierty)',       lim:{P: 8000,M:14000,T:20000}, globalCat:'pc_ground'}
  ]},
  {id:'SIEC',name:'Podłączenie do sieci ciepłowniczej (z przyłączem)', heat:true, variants:[
    {label:'standard', lim:{P:9800,M:15575,T:22250}, globalCat:'piec'}
  ]},
  {id:'GAZ', name:'Kocioł zgazowujący drewno (podw. standard)', heat:true, variants:[
    {label:'standard', lim:{P:8200,M:14350,T:20500}, globalCat:'piec'}
  ]},
  {id:'PEL', name:'Kocioł na pellet (podw. standard)', heat:true, variants:[
    {label:'standard', lim:{P:8200,M:14350,T:20500}, globalCat:'piec'}
  ]},
  {id:'ELE', name:'Ogrzewanie elektryczne', heat:true, variants:[
    {label:'standard', lim:{P:4480,M:7840,T:11200}, globalCat:'piec'}
  ]},
  {id:'INST',name:'Instalacja CO + CWU', heat:false, variants:[
    {label:'standard', lim:{P:8200,M:14350,T:20500}}
  ]},
  {id:'PLUK',name:'Płukanie instalacji', heat:false, variants:[
    {label:'standard', lim:{P:2000,M:2000,T:2000}}
  ]},
  {id:'AUD', name:'Audyt energetyczny', heat:false, variants:[{label:'standard', lim:{P:480,M:840,T:1200}}]},
  {id:'SCH', name:'Świadectwo charakterystyki', heat:false, variants:[{label:'standard', lim:{P:160,M:280,T:400}}]},
  {id:'REC', name:'Rekuperacja (zestaw)', heat:false, variants:[{label:'zestaw', lim:{P:6680,M:11690,T:16700}}]}
];
function limActive(lim){
  if (state.level.name==='PODSTAWOWY') return lim.P || 0;
  if (state.level.name==='PODWYŻSZONY') return lim.M || 0;
  if (state.level.name==='NAJWYŻSZY')   return lim.T || 0;
  return 0;
}
function buildMain(){
  var tb=q('#tbodyMain'); tb.innerHTML=''; state.mainRows=[];
  DATA_MAIN.forEach(function(comp, idx){
    var tr=document.createElement('tr');
    var row={compIdx:idx, heat:comp.heat, sel:false, vIdx:0, costInput:0, _costNet:0,_grant:0,_gross:0,_copay:0,_need:0,_needGross:0, _hit:false, els:{}, tr:tr};
    var tdSel=document.createElement('td'); var sel=document.createElement('input'); sel.type='checkbox'; tdSel.appendChild(sel);
    var tdName=document.createElement('td');
    var title=document.createElement('div'); title.textContent=comp.name;
    var selVar=document.createElement('select');
    comp.variants.forEach(function(v,i){ var o=document.createElement('option'); o.value=i; o.textContent=v.label; selVar.appendChild(o); });
    tdName.appendChild(title); tdName.appendChild(selVar);
    var tdCost=document.createElement('td'); tdCost.className='num';
    var cost=document.createElement('input'); cost.className='num'; cost.inputMode='decimal'; cost.placeholder='0'; tdCost.appendChild(cost);
    var tdLim=document.createElement('td'); tdLim.className='num';
    var tdNeed=document.createElement('td'); tdNeed.className='num';
    var tdNeedGross=document.createElement('td'); tdNeedGross.className='num';
    var tdGrant=document.createElement('td'); tdGrant.className='num';
    var tdGross=document.createElement('td'); tdGross.className='num';
    var tdCopay=document.createElement('td'); tdCopay.className='num';
    tr.appendChild(tdSel); tr.appendChild(tdName); tr.appendChild(tdCost); tr.appendChild(tdLim); tr.appendChild(tdNeed); tr.appendChild(tdNeedGross); tr.appendChild(tdGrant); tr.appendChild(tdGross); tr.appendChild(tdCopay);
    tb.appendChild(tr);
    row.els={sel:sel,selVar:selVar,cost:cost,tdLim:tdLim,tdNeed:tdNeed,tdNeedGross:tdNeedGross,tdGrant:tdGrant,tdGross:tdGross,tdCopay:tdCopay};
    state.mainRows.push(row);
    function syncSelectedClass(){ tr.classList.toggle('is-selected', row.sel); }
    sel.addEventListener('change', function(){
      row.sel=sel.checked; syncSelectedClass();
      if (row.sel && comp.heat){
        state.mainRows.forEach(function(r,j){ if(j!==idx && DATA_MAIN[r.compIdx].heat){ r.sel=false; r.els.sel.checked=false; r.tr.classList.remove('is-selected'); recalcMainRow(j); } });
      }
      recalcMainRow(idx); updateAggregates(); autosave();
    });
    selVar.addEventListener('change', function(){ row.vIdx=Number(selVar.value); recalcMainRow(idx); updateAggregates(); autosave(); });
    cost.addEventListener('input', function(){ row.costInput=toNum(cost.value); debRecalcMainRow(idx)(); debUpdateAggregates(); });
    cost.addEventListener('change', autosave);
  });
}
function debRecalcMainRow(i){ return debounce(function(){ recalcMainRow(i); },140); }

/* ===== OCIEPLENIE / STOLARKA / DODATKI ===== */
var RATES_PER = {
  sciany:  { unit:'m2', P:180, M:210, T:250 },
  strop:   { unit:'m2', P: 80, M:140, T:200 },
  podloga: { unit:'m2', P: 80, M:100, T:150 },
  okna:    { unit:'m2', P:650, M:1050, T:1500 },
  drzwi:   { unit:'m2', P:2000,M:2500, T:3000 },
  bramy:   { unit:'m2', P: 600,M:1050, T:1500 },
  parapety:{ unit:'mb', P:120, M:120, T:120 },
  skuwanie:{ unit:'mb', P:  0, M:  0, T:  0 },
  rynny:   { unit:'mb', P:  0, M:  0, T:  0 }
};
function unitForKey(key){ return (RATES_PER[key]||{}).unit || 'm2'; }
function rateForKey(key){
  var k=RATES_PER[key]||{};
  if (state.level.name==='PODSTAWOWY') return k.P||0;
  if (state.level.name==='PODWYŻSZONY') return k.M||0;
  if (state.level.name==='NAJWYŻSZY')   return k.T||0;
  return 0;
}
var DATA_ENV = [
  {key:'sciany',   name:'Ocieplenie ścian zewnętrznych'},
  {key:'strop',    name:'Ocieplenie dachu / stropodachu'},
  {key:'podloga',  name:'Ocieplenie podłogi na gruncie'},
  {key:'okna',     name:'Stolarka okienna'},
  {key:'drzwi',    name:'Drzwi zewnętrzne'},
  {key:'bramy',    name:'Brama garażowa'},
  {key:'parapety', name:'Parapety zewnętrzne (mb) – limit 120 zł/mb'},
  {key:'skuwanie', name:'Skuwanie parapetów (mb) – bez dotacji'},
  {key:'rynny',    name:'Opierzenie / rynny (mb) – bez dotacji'}
];
function buildEnv(){
  var tb=q('#tbodyEnv'); tb.innerHTML=''; state.envRows=[];
  DATA_ENV.forEach(function(it,idx){
    var tr=document.createElement('tr');
    var r={ key:it.key, unit:unitForKey(it.key), sel:false, qty:0, ownRate:0, costNet:0, _grant:0,_gross:0,_copay:0,_hit:false, els:{}, tr:tr };
    var tdSel=document.createElement('td'); var sel=document.createElement('input'); sel.type='checkbox'; tdSel.appendChild(sel);
    var tdName=document.createElement('td'); tdName.textContent=it.name;
    var tdQty=document.createElement('td'); tdQty.className='num';
    var qty=document.createElement('input'); qty.className='num'; qty.inputMode='decimal'; qty.placeholder='0'; qty.setAttribute('aria-label', r.unit==='mb'?'Długość [mb]':'Powierzchnia [m2]'); tdQty.appendChild(qty);
    var tdOwn=document.createElement('td'); tdOwn.className='num';
    var own=document.createElement('input'); own.className='num'; own.inputMode='decimal'; own.placeholder='0'; own.setAttribute('aria-label', r.unit==='mb'?'Twoja cena / mb':'Twoja cena / m2'); tdOwn.appendChild(own);
    var tdRate=document.createElement('td'); tdRate.className='num';
    var tdCost=document.createElement('td'); tdCost.className='num';
    var tdCap=document.createElement('td'); tdCap.className='num';
    var tdGrant=document.createElement('td'); tdGrant.className='num';
    var tdGross=document.createElement('td'); tdGross.className='num';
    var tdCopay=document.createElement('td'); tdCopay.className='num';
    tr.appendChild(tdSel); tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdOwn); tr.appendChild(tdRate); tr.appendChild(tdCost); tr.appendChild(tdCap); tr.appendChild(tdGrant); tr.appendChild(tdGross); tr.appendChild(tdCopay);
    tb.appendChild(tr);
    r.els={sel:sel,qty:qty,ownRate:own,tdRateMax:tdRate,tdCostNet:tdCost,tdLimit:tdCap,tdGrant:tdGrant,tdGross:tdGross,tdCopay:tdCopay};
    state.envRows.push(r);
    function syncSelectedClass(){ tr.classList.toggle('is-selected', r.sel); }
    sel.addEventListener('change', function(){ r.sel=sel.checked; syncSelectedClass(); recalcEnvRow(idx); updateAggregates(); autosave(); });
    qty.addEventListener('input', function(){ r.qty=toNum(qty.value); debRecalcEnvRow(idx)(); debUpdateAggregates(); });
    own.addEventListener('input', function(){ r.ownRate=toNum(own.value); debRecalcEnvRow(idx)(); debUpdateAggregates(); });
    qty.addEventListener('change', autosave); own.addEventListener('change', autosave);
  });
}
function debRecalcEnvRow(i){ return debounce(function(){ recalcEnvRow(i); },140); }

/* ===== row recalcs ===== */
function setGrantCell(td, value, hit){ td.innerHTML = fmt(value) + (hit ? ' <span class="cap-badge">LIMIT</span>' : ''); }
function recalcMainRow(i){
  var r=state.mainRows[i]; if(!r) return;
  var comp=DATA_MAIN[r.compIdx]; var v=comp.variants[r.vIdx]; var lim = limActive(v.lim);
  r.els.tdLim.textContent = fmt(lim);
  var net = state.priceMode==='BRUTTO' ? (r.costInput/(1+VAT)) : r.costInput;
  var need  = state.level.pct>0 ? Math.ceil(lim/state.level.pct) : 0;
  var needGross = need ? need*(1+VAT) : 0;
  var res = calcGrant(net, state.level.pct, lim);
  r._costNet=net; r._grant=res.grant; r._gross=res.gross; r._copay=res.copay; r._need=need; r._needGross=needGross; r._hit=res.hit;
  if (!r.sel){ r.els.tdNeed.textContent='—'; r.els.tdNeedGross.textContent='—'; r.els.tdGrant.innerHTML='—'; r.els.tdGross.textContent='—'; r.els.tdCopay.textContent='—'; }
  else { r.els.tdNeed.textContent=need?fmt(need):'—'; r.els.tdNeedGross.textContent=need?fmt(needGross):'—'; setGrantCell(r.els.tdGrant,res.grant,res.hit); r.els.tdGross.textContent=fmt(res.gross); r.els.tdCopay.textContent=fmt(res.copay); }
}
function recalcEnvRow(i){
  var r=state.envRows[i]; if(!r) return;
  var per = rateForKey(r.key) || 0;
  r.els.tdRateMax.textContent = fmt(per);
  var ownNet = state.priceMode==='BRUTTO' ? (r.ownRate/(1+VAT)) : r.ownRate;
  var costNet = (r.qty||0) * (ownNet||0);
  var cap = (r.qty||0) * per;
  var res = calcGrant(costNet, state.level.pct, cap);
  r.costNet=costNet; r._grant=res.grant; r._gross=res.gross; r._copay=res.copay; r._hit=res.hit;
  if (!r.sel){ r.els.tdCostNet.textContent='—'; r.els.tdLimit.textContent=fmt(cap); r.els.tdGrant.innerHTML='—'; r.els.tdGross.textContent='—'; r.els.tdCopay.textContent='—'; }
  else { r.els.tdCostNet.textContent=fmt(costNet); r.els.tdLimit.textContent=fmt(cap); setGrantCell(r.els.tdGrant,res.grant,res.hit); r.els.tdGross.textContent=fmt(res.gross); r.els.tdCopay.textContent=fmt(res.copay); }
}

/* ===== totals / summary ===== */
function getTotalsMain(){
  var sumGrant=0,sumGross=0,sumCopay=0,countSel=0;
  state.mainRows.forEach(function(r){ if(r.sel){ sumGrant+=r._grant||0; sumGross+=r._gross||0; sumCopay+=r._copay||0; countSel++; } });
  return {sumGrant:sumGrant,sumGross:sumGross,sumCopay:sumCopay,countSel:countSel};
}
function getTotalsEnv(){
  var sumGrant=0,sumGross=0,sumCopay=0,countSel=0;
  state.envRows.forEach(function(r){ if(r.sel){ sumGrant+=r._grant||0; sumGross+=r._gross||0; sumCopay+=r._copay||0; countSel++; } });
  return {sumGrant:sumGrant,sumGross:sumGross,sumCopay:sumCopay,countSel:countSel};
}

/* ===== limity: globalne + Ocieplenie/Stolarka/Dodatki ===== */
var GLOBAL_CAPS = { piec:125600, pc_air:140300, pc_ground:170000 };
function currentGlobalCategory(){
  for (var i=0;i<state.mainRows.length;i++){
    var r=state.mainRows[i]; if(!r.sel) continue;
    var comp=DATA_MAIN[r.compIdx]; if(!comp.heat) continue;
    var v=comp.variants[r.vIdx]||{}; return v.globalCat || comp.globalCat || 'piec';
  }
  return null;
}
var ENV_CAPS = { 'NAJWYŻSZY':83000, 'PODWYŻSZONY':58100, 'PODSTAWOWY':33200 };

function renderTotals(){
  var m=getTotalsMain(), e=getTotalsEnv();
  q('#sumMain').textContent=fmt(m.sumGrant);
  q('#sumMainGross').textContent=fmt(m.sumGross);
  q('#sumMainCopay').textContent=fmt(m.sumCopay);
  q('#selCountMain').textContent=m.countSel;
  q('#sumEnvGrant').textContent=fmt(e.sumGrant);
  q('#sumEnvGross').textContent=fmt(e.sumGross);
  q('#sumEnvCopay').textContent=fmt(e.sumCopay);
  q('#selCountEnv').textContent=e.countSel;
}
function renderSummary(){
  var m = getTotalsMain();
  var e = getTotalsEnv();
  var envRawGrant = e.sumGrant || 0;
  var envCap      = ENV_CAPS[state.level.name] || 0;
  var envGrant    = envCap ? Math.min(envRawGrant, envCap) : envRawGrant;
  if (q('#envCap'))     q('#envCap').textContent = envCap ? fmt(envCap) : '—';
  if (q('#envCapUsed')) q('#envCapUsed').textContent = envCap ? (envRawGrant > envCap ? 'TAK' : 'NIE') : '—';
  if (q('#sumEnvGrant')) q('#sumEnvGrant').textContent = fmt(envGrant);
  var envCopayCapped = (e.sumGross || 0) - envGrant;
  if (q('#sumEnvCopay')) q('#sumEnvCopay').textContent = fmt(envCopayCapped);
  var subtotalGrant = (m.sumGrant || 0) + envGrant;
  var cat   = currentGlobalCategory();
  var gCap  = cat ? (GLOBAL_CAPS[cat] || 0) : 0;
  var totalGrant = gCap ? Math.min(subtotalGrant, gCap) : subtotalGrant;
  var capUsed = gCap > 0 && subtotalGrant > gCap;
  var totalGross = (m.sumGross || 0) + (e.sumGross || 0);
  var totalCopay = Math.max(0, totalGross - totalGrant);
  var need = 0;
  state.mainRows.forEach(function(r){
    if(r.sel && state.level.pct>0){
      var lim = limActive(DATA_MAIN[r.compIdx].variants[r.vIdx].lim);
      need += Math.ceil(lim/state.level.pct);
    }
  });
  state.envRows.forEach(function(r){
    if(r.sel && state.level.pct>0){
      var capRow = (r.qty||0) * (rateForKey(r.key)||0);
      need += Math.ceil(capRow/state.level.pct);
    }
  });
  if (q('#sumGrantAll'))  q('#sumGrantAll').textContent = fmt(totalGrant);
  if (q('#sumCopayAll'))  q('#sumCopayAll').textContent = fmt(totalCopay);
  if (q('#sumNeedAll'))   q('#sumNeedAll').textContent  = state.level.pct ? fmt(need) : '—';
  if (q('#globalCap'))     q('#globalCap').textContent = gCap ? fmt(gCap) : '—';
  if (q('#globalCapUsed')) q('#globalCapUsed').textContent = gCap ? (capUsed ? 'TAK' : 'NIE') : '—';
}

/* ===== sumy i podsumowanie ===== */
function updateAggregates(){ renderTotals(); renderSummary(); }
var debUpdateAggregates = debounce(updateAggregates, 160);
function recomputeAllRows(){
  state.mainRows.forEach(function(_,i){ recalcMainRow(i); });
  state.envRows.forEach(function(_,i){ recalcEnvRow(i); });
}

/* ===== preset / auto ===== */
function presetMain(){
  state.mainRows.forEach(function(r,i){
    r.sel=false; r.els.sel.checked=false; r.tr.classList.remove('is-selected');
    r.vIdx=0; r.els.selVar.value='0';
    r.costInput=0; r.els.cost.value='';
    recalcMainRow(i);
  });
  updateAggregates(); autosave();
}
function presetEnv(){
  state.envRows.forEach(function(r,i){
    r.sel=false; r.els.sel.checked=false; r.tr.classList.remove('is-selected');
    r.qty=0; r.els.qty.value='';
    r.ownRate=0; r.els.ownRate.value='';
    recalcEnvRow(i);
  });
  updateAggregates(); autosave();
}
function autoNeedMain(){
  state.mainRows.forEach(function(r,i){
    if(!r.sel) return;
    var lim = limActive(DATA_MAIN[r.compIdx].variants[r.vIdx].lim);
    if(state.level.pct>0){
      var needNet = Math.ceil(lim/state.level.pct);
      r.costInput = state.priceMode==='BRUTTO' ? needNet*(1+VAT) : needNet;
      r.els.cost.value = String(Math.round(r.costInput));
      recalcMainRow(i);
    }
  });
  updateAggregates(); autosave();
}
function autoNeedEnv(){
  state.envRows.forEach(function(r,i){
    if(!r.sel) return;
    var per = rateForKey(r.key)||0;
    if(state.level.pct>0 && per>0){
      var needPerUnitNet = per/(state.level.pct||1);
      r.ownRate = Math.round(state.priceMode==='BRUTTO' ? needPerUnitNet*(1+VAT) : needPerUnitNet);
      r.els.ownRate.value = String(r.ownRate);
      recalcEnvRow(i);
    }
  });
  updateAggregates(); autosave();
}

/* ===== CSV ===== */
function csvEscape(v){ var s=String(v==null ? '' : v); return /[",;\n]/.test(s)? '"' + s.replace(/"/g,'""') + '"' : s; }
function downloadCSV(name, rows){
  var csv = rows.map(function(r){ return r.map(csvEscape).join(';'); }).join('\n');
  var blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
  var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name.endsWith('.csv') ? name : (name + '.csv'); a.click(); URL.revokeObjectURL(a.href);
}
function exportCSVMain(){
  var out=[['Wybrany','Komponent','Wariant','Koszt netto','Limit (aktywny)','Min. wydatek netto','Min. wydatek brutto','Dotacja','Koszt brutto (VAT '+Math.round(VAT*100)+'%)','Dopłata','Limit użyty?']];
  state.mainRows.forEach(function(r){
    var comp=DATA_MAIN[r.compIdx], v=comp.variants[r.vIdx], lim=limActive(v.lim);
    out.push([ r.sel?'TAK':'NIE', comp.name, v.label, Math.round(r._costNet||0), lim, r.sel?(r._need||''):'', r.sel?Math.round(r._needGross||0):'', Math.round(r._grant||0), Math.round(r._gross||0), Math.round(r._copay||0), r._hit?'TAK':'NIE' ]);
  });
  downloadCSV('cp2025_glowne_'+todayStr(), out);
}
function exportCSVEnv(){
  var out=[['Wybrany','Pozycja','Ilość x cena_jedn.','Koszt netto','Limit z ilości','Dotacja','Koszt brutto (VAT '+Math.round(VAT*100)+'%)','Dopłata','Limit użyty?']];
  state.envRows.forEach(function(r,i){
    var base=DATA_ENV[i]; var per=rateForKey(r.key)||0; var cap=Math.round((r.qty||0)*per); var unit=unitForKey(r.key);
    out.push([ r.sel?'TAK':'NIE', base.name, String(r.qty||0)+' '+unit+' x '+String(r.ownRate||0)+' zł/'+unit, Math.round(r.costNet||0), cap, Math.round(r._grant||0), Math.round(r._gross||0), Math.round(r._copay||0), r._hit?'TAK':'NIE' ]);
  });
  downloadCSV('cp2025_ocieplenie_'+todayStr(), out);
}
function exportCSVAll(){
  var out=[['Sekcja','Nazwa','Opis','Koszt netto','Limit (aktywny)','Dotacja','Koszt brutto (VAT '+Math.round(VAT*100)+'%)','Dopłata','Limit użyty?']];
  state.mainRows.forEach(function(r){
    var comp=DATA_MAIN[r.compIdx], v=comp.variants[r.vIdx], lim=limActive(v.lim);
    out.push(['Glowne', comp.name, v.label, Math.round(r._costNet||0), lim, Math.round(r._grant||0), Math.round(r._gross||0), Math.round(r._copay||0), r._hit?'TAK':'NIE']);
  });
  state.envRows.forEach(function(r,i){
    var base=DATA_ENV[i], per=rateForKey(r.key)||0, cap=Math.round((r.qty||0)*per), unit=unitForKey(r.key);
    out.push(['Ocieplenie', base.name, String(r.qty||0)+' '+unit+' x '+String(r.ownRate||0)+' zł/'+unit, Math.round(r.costNet||0), cap, Math.round(r._grant||0), Math.round(r._gross||0), Math.round(r._copay||0), r._hit?'TAK':'NIE']);
  });
  downloadCSV('cp2025_laczny_'+todayStr(), out);
}

/* ===== SAVE / LOAD ===== */
function saveAll(){
  var data={
    typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiad:q('#swiadczenia').value,
    pm:state.priceMode, vat:VAT,
    klient:{ nazwa:q('#klient_nazwa').value, adres:q('#klient_adres').value, tel:q('#klient_tel').value, email:q('#klient_email').value, handlowiec:q('#handlowiec').value, data:q('#data_oferty').value },
    main: state.mainRows.map(function(r){ return {sel:r.sel, vIdx:r.vIdx, cost:r.costInput}; }),
    env:  state.envRows.map(function(r){ return {sel:r.sel, qty:r.qty, ownRate:r.ownRate, key:r.key}; })
  };
  localStorage.setItem('cp2025_arkon', JSON.stringify(data));
}
function loadAll(){
  var raw=localStorage.getItem('cp2025_arkon'); if(!raw){ alert('Brak zapisu'); return; }
  var d; try{ d=JSON.parse(raw); }catch(e){ alert('Nieprawidłowy zapis.'); return; }
  q('#typ').value=d.typ||''; q('#doch_mies').value=d.mies||''; q('#doch_roczny').value=d.roczny||''; q('#swiadczenia').value=d.swiad||'';
  state.priceMode = d.pm==='BRUTTO' ? 'BRUTTO' : 'NETTO';
  qa('input[name="pm"]').forEach(function(r){ r.checked=(r.value===state.priceMode); });
  if (typeof d.vat!=='undefined'){ setVAT(d.vat); q('#vatSel').value=String(d.vat); }
  var k=d.klient||{};
  q('#klient_nazwa').value=k.nazwa||''; q('#klient_adres').value=k.adres||''; q('#klient_tel').value=k.tel||''; q('#klient_email').value=k.email||''; q('#handlowiec').value=k.handlowiec||''; q('#data_oferty').value=k.data||'';
  if (d.main && d.main.forEach) {
    d.main.forEach(function(m,i){
      var r=state.mainRows[i]; if(!r) return;
      r.sel=!!m.sel; r.els.sel.checked=r.sel; r.tr.classList.toggle('is-selected', r.sel);
      r.vIdx=Number(m.vIdx||0); r.els.selVar.value=String(r.vIdx);
      r.costInput=toNum(m.cost); r.els.cost.value=r.costInput?String(r.costInput):'';
      recalcMainRow(i);
    });
  }
  if (d.env && d.env.forEach) {
    d.env.forEach(function(e){
      var idx = state.envRows.findIndex(function(x){ return x && x.key===e.key; });
      var r=state.envRows[idx]; if(!r) return;
      r.sel=!!e.sel; r.els.sel.checked=r.sel; r.tr.classList.toggle('is-selected', r.sel);
      r.qty=toNum(e.qty); r.els.qty.value=r.qty?String(r.qty):'';
      r.ownRate=toNum(e.ownRate); r.els.ownRate.value=r.ownRate?String(r.ownRate):'';
      recalcEnvRow(idx);
    });
  }
  refreshLevel();
}
var autosave = debounce(saveAll, 250);

/* ===== DRUK: budowa podsumowania i druk ===== */
function buildPrintSummary(){
  // Kwoty globalne
  var m = getTotalsMain();
  var e = getTotalsEnv();
  var envRawGrant = e.sumGrant || 0;
  var envCap      = ENV_CAPS[state.level.name] || 0;
  var envGrant    = envCap ? Math.min(envRawGrant, envCap) : envRawGrant;
  var subtotalGrant = (m.sumGrant || 0) + envGrant;
  var cat   = currentGlobalCategory();
  var gCap  = cat ? (GLOBAL_CAPS[cat] || 0) : 0;
  var totalGrant = gCap ? Math.min(subtotalGrant, gCap) : subtotalGrant;
  var totalGross = (m.sumGross || 0) + (e.sumGross || 0);
  var totalNet   = Math.round(totalGross/(1+VAT));

  // Dane klienta / program
  q('#ps_client').innerHTML =
    '<div><b>'+ (q('#klient_nazwa').value||'—') + '</b></div>' +
    '<div>'+ (q('#klient_adres').value||'—') + '</div>' +
    '<div>tel: '+ (q('#klient_tel').value||'—') + ', e-mail: '+ (q('#klient_email').value||'—') +'</div>';
  q('#ps_program').innerHTML =
    'Poziom: <b>'+state.level.name+'</b><br>'+
    'Procent dotacji: <b>'+ (state.level.pct? (state.level.pct*100).toFixed(0)+'%' : '—') +'</b><br>'+
    'VAT: <b>'+Math.round(VAT*100)+'%</b>';
  q('#ps_totals').innerHTML =
    'NETTO: <b>'+fmt(totalNet)+'</b> zł<br>'+
    'BRUTTO: <b>'+fmt(totalGross)+'</b> zł<br>'+
    'DOTACJA: <b>'+fmt(totalGrant)+'</b> zł<br>'+
    'DOPŁATA: <b>'+fmt(Math.max(0,totalGross-totalGrant))+'</b> zł';
  q('#ps_handlowiec').textContent = q('#handlowiec').value || '—';
  q('#ps_data').textContent = q('#data_oferty').value || todayStr();

  // Tabela pozycji (tylko zaznaczone)
  var tb = q('#ps_table tbody'); tb.innerHTML='';
  state.mainRows.forEach(function(r){
    if(!r.sel) return;
    var comp=DATA_MAIN[r.compIdx], v=comp.variants[r.vIdx];
    var tr=document.createElement('tr');
    tr.innerHTML='<td>Główne</td><td>'+comp.name+'</td><td>'+v.label+'</td>'+
      '<td class="num">'+fmt(r._costNet||0)+'</td>'+
      '<td class="num">'+fmt(r._gross||0)+'</td>'+
      '<td class="num">'+fmt(r._grant||0)+'</td>';
    tb.appendChild(tr);
  });
  state.envRows.forEach(function(r,i){
    if(!r.sel) return;
    var base=DATA_ENV[i]; var unit=unitForKey(r.key);
    var tr=document.createElement('tr');
    tr.innerHTML='<td>Ocieplenie</td><td>'+base.name+'</td><td>'+fmt(r.qty||0)+' '+unit+' × '+fmt(r.ownRate||0)+' zł/'+unit+'</td>'+
      '<td class="num">'+fmt(r.costNet||0)+'</td>'+
      '<td class="num">'+fmt(r._gross||0)+'</td>'+
      '<td class="num">'+fmt(r._grant||0)+'</td>';
    tb.appendChild(tr);
  });
}
function printAll(){ buildPrintSummary(); window.print(); }

/* ===== init & UI events ===== */
function init(){
  if(!q('#data_oferty').value) q('#data_oferty').value=todayStr();
  setVAT(q('#vatSel').value);
  qa('.tab-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      qa('.tab-btn').forEach(function(b){ b.setAttribute('aria-selected','false'); });
      btn.setAttribute('aria-selected','true');
      var tab=btn.id==='tabbtn-main'?'main':'env';
      q('#tab-main').classList.toggle('hidden', tab!=='main');
      q('#tab-env').classList.toggle('hidden', tab!=='env');
    });
  });
  buildMain(); buildEnv(); refreshLevel();
  q('#btnPresetMain').addEventListener('click', presetMain);
  q('#btnAutoNeedMain').addEventListener('click', autoNeedMain);
  q('#btnCSVMain').addEventListener('click', exportCSVMain);
  q('#btnPresetEnv').addEventListener('click', presetEnv);
  q('#btnAutoNeedEnv').addEventListener('click', autoNeedEnv);
  q('#btnCSVEnv').addEventListener('click', exportCSVEnv);
  q('#btnCSVAll').addEventListener('click', exportCSVAll);
  q('#btnSave').addEventListener('click', saveAll);
  q('#btnLoad').addEventListener('click', loadAll);
  q('#btnPrint').addEventListener('click', printAll);

  // autosave na zmianę pól klienta
  ['#klient_nazwa','#klient_adres','#klient_tel','#klient_email','#handlowiec','#data_oferty'].forEach(function(sel){
    var el=q(sel); el && el.addEventListener('input', autosave);
    el && el.addEventListener('change', autosave);
  });
}
init();
</script>
</body>
</html>
