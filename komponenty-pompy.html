<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Komponenty ‚Ä¢ Pompy ciep≈Ça ‚Äî Midea, Panasonic & Galmet (proporcjonalna wycena)</title>
<style>
  :root{--bg:#0b1020;--p1:#121a34;--p2:#172142;--ink:#e8edff;--muted:#aeb8da;--accent:#4cc9f0;--ok:#2fbf71;--warn:#ffb84d;--bad:#ff6b6b;--grid:#243059;--card:#0f1533;--line:#1c2750}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  .wrap{max-width:1500px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){.cols-2{grid-template-columns:1.55fr 1fr}}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto;display:flex;gap:8px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .btn.warn{background:#3a2a19;border-color:#9d7a33}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .tiny{font-size:12px}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:#ink;font:inherit;color:var(--ink)}
  input::placeholder{color:#aeb8da99}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid #243059;vertical-align:top;text-align:left}
  th{font-size:12px;color:#aeb8da;position:sticky;top:0;background:#151d46;z-index:1}
  tbody tr:hover{background:#0d153033}
  .small{font-size:12px;color:#aeb8da}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .sep{height:1px;background:#243059;margin:10px 0}
  .okline{padding:8px;border-radius:10px;background:#0f2a22;border:1px solid #155a41;color:#b4ffdd}
</style>
</head>
<body>
<header>
  <h1>Komponenty ‚Ä¢ Pompy ciep≈Ça ‚Äî Midea, Panasonic & Galmet</h1>
  <div class="muted">Model wyceny <b>proporcjonalny</b>: najta≈Ñszy pakiet (HP + bufor min + CWU min + must‚Äëhave) = <b>38‚ÄØ000 PLN netto</b>. Ka≈ºda dro≈ºsza pompa / wiƒôkszy bufor / wiƒôkszy CWU podnosi cenƒô o <b>r√≥≈ºnicƒô</b>. Opcjonalne akcesoria doliczane 1:1. ‚ÄûSama pompa‚Äù = <b>cena urzƒÖdzenia + 4‚ÄØ000 PLN</b>. Dane cenowe: Midea, Panasonic (rozszerzone), Galmet (PRIMA).</div>
</header>

<div class="wrap grid cols-2">
  <!-- LEWA: Katalog + filtry -->
  <section class="grid">
    <div class="card">
      <div class="row">
        <input id="q" placeholder="üîé Szukaj: marka, model, czynnik‚Ä¶" style="min-width:240px">
        <select id="fBrand"><option value="">Marka (wszystkie)</option></select>
        <select id="fType"><option value="">Typ</option><option>monoblok</option><option>split</option><option>all-in-one</option></select>
        <select id="fRef"><option value="">Czynnik</option><option>R32</option><option>R290</option></select>
        <select id="fPhase"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
        <select id="sort">
          <option value="brand.asc">Sort: Marka ‚Üë</option>
          <option value="brand.desc">Sort: Marka ‚Üì</option>
          <option value="p.asc">Sort: Moc ‚Üë</option>
          <option value="p.desc">Sort: Moc ‚Üì</option>
          <option value="price.asc">Sort: Cena urzƒÖdzenia ‚Üë</option>
          <option value="price.desc">Sort: Cena urzƒÖdzenia ‚Üì</option>
        </select>
        <button id="btnClear" class="btn ghost">Wyczy≈õƒá</button>
        <span class="pill">≈ÅƒÖcznie: <b id="cntAll">0</b></span>
        <span class="pill">Widocznych: <b id="cntVis">0</b></span>
      </div>
    </div>

    <div class="card" style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Akcje</th>
            <th>Marka / Model</th>
            <th>Typ</th>
            <th>Moc A7 [kW]</th>
            <th>SCOP</th>
            <th>Czynnik</th>
            <th>Fazy</th>
            <th>Ha≈Ças [dB(A)]</th>
            <th>Cena urzƒÖdzenia [PLN]</th>
            <th>Uwagi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- PRAWA: Konfigurator -->
  <aside class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Konfigurator zestawu</b>
        <div class="right">
          <button id="btnAddPack" class="btn ok">+ Dodaj ZESTAW</button>
          <button id="btnAddHp" class="btn warn">+ Sama pompa (+4‚ÄØ000)</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label class="small">Model pompy</label>
          <select id="selHp"></select>
        </div>
        <div>
          <label class="small">Bufor [l]</label>
          <select id="selBufor"></select>
        </div>
        <div>
          <label class="small">Zasobnik CWU [l]</label>
          <select id="selCwu"></select>
        </div>
        <div>
          <label class="small">VAT</label>
          <select id="selVat"><option value="0.08">8%</option><option value="0.23">23%</option></select>
        </div>
        <div>
          <label class="small">Grzejniki (monta≈º)</label>
          <input id="inpRads" type="number" value="0" min="0" style="width:110px">
          <div class="small muted">750 PLN/szt.</div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label class="small">Zaw√≥r 3‚Äëdrogowy</label>
          <select id="selV3d"><option value="0">w zestawie</option><option value="450">+450</option></select>
        </div>
        <div>
          <label class="small">Grupa bezpiecze≈Ñstwa</label>
          <select id="selSafety"><option value="0">w zestawie</option><option value="390">+390</option></select>
        </div>
        <div>
          <label class="small">Hydraulika (rozdzielacze)</label>
          <select id="selHydro"><option value="0">podstawowa</option><option value="1800">+1 obieg (1800)</option><option value="3200">dwa obiegi (3200)</option></select>
        </div>
        <div>
          <label class="small">Glikol (monoblok)</label>
          <select id="selGlycol"><option value="0">nie</option><option value="600">30 l (600)</option><option value="900">50 l (900)</option></select>
        </div>
      </div>

      <div class="sep"></div>
      <div class="row">
        <div style="flex:1">
          <div class="muted">Cena zestawu (netto) wg modelu proporcjonalnego</div>
          <div id="pricePreview" style="font-weight:800;font-size:18px">‚Äî</div>
          <div id="typeHint" class="okline" style="display:none;margin-top:6px"></div>
        </div>
        <div style="min-width:240px">
          <label class="small">Prowizja handlowca</label>
          <div class="row">
            <input id="provPct" type="number" min="0" step="0.1" placeholder="%" style="width:80px">
            <input id="provAbs" type="number" min="0" step="1" placeholder="PLN" style="width:130px">
          </div>
          <div class="small muted">Mo≈ºesz wpisaƒá % i/lub PLN (sumujƒÖ siƒô).</div>
        </div>
      </div>
    </div>

    <div class="card">
      <b>Sk≈Çad zestawu (must‚Äëhave)</b>
      <div id="mustHave" class="muted" style="margin-top:6px">Wybierz pompƒô, bufor i zasobnik ‚Äî poka≈ºƒô sk≈Çad.</div>
    </div>

    <div class="card">
      <b>Koszyk</b>
      <table id="basket" style="margin-top:8px">
        <thead><tr><th>Pozycja</th><th>Ilo≈õƒá</th><th class="right">Cena [PLN]</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row">
        <div><span class="muted">Suma netto</span><div id="sumNet" style="font-weight:800;font-size:18px"></div></div>
        <div><span class="muted">Prowizja</span><div id="sumProv" style="font-weight:800;font-size:18px"></div></div>
        <div><span class="muted">Brutto (z VAT)</span><div id="sumGross" style="font-weight:800;font-size:18px"></div></div>
        <div class="right">
          <button id="btnCopy" class="btn ghost">Kopiuj ofertƒô</button>
          <button id="btnPrint" class="btn ghost">Drukuj / PDF</button>
          <button id="btnXlsx" class="btn ghost">Eksport XLSX</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
'use strict';

/* ====== Dane urzƒÖdze≈Ñ ======
   price = cena NETTO samego urzƒÖdzenia (bez dop≈Çaty 4k)
   Uwaga: ceny orientacyjne (najni≈ºsze oferty brutto / 1,23). */
const HEATPUMPS = [
  // ===== MIDEA: M-THERMAL / ARCTIC (R32 / R290) =====
  {brand:'Midea', model:'M‚ÄëThermal Arctic 4.5 kW Monoblok MHC‚ÄëV4WD2N7‚ÄëE30 (R290)', kind:'monoblok', phase:'1F', pA7:4.5, scop:5.0, ref:'R290', noise:55, price:10686, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 6 kW Monoblok',                       kind:'monoblok', phase:'1F', pA7:6.0, scop:4.9, ref:'R32', noise:55, price:12276, tags:['PRO','R32']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 8.4 kW Monoblok MHC‚ÄëV8W/D2N8‚ÄëBE30', kind:'monoblok', phase:'1F', pA7:8.4, scop:4.9, ref:'R290', noise:55, price:9350,  tags:['Arctic','R290','WiFi']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 8 kW Split',                           kind:'split',    phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:54, price:14500, tags:['PRO','split']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 8 kW Monoblok',                        kind:'monoblok', phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:55, price:9349,  tags:['PRO','monoblok']},
  {brand:'Midea', model:'M‚ÄëThermal 9 kW Monoblok (R32)',                      kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15000, tags:['R32']},
  {brand:'Midea', model:'M‚ÄëThermal 10 kW Monoblok MHC‚ÄëV10W/D2N8‚ÄëB',          kind:'monoblok', phase:'1F', pA7:10.0,scop:4.8, ref:'R32', noise:56, price:16080, tags:['WiFi']},
  {brand:'Midea', model:'M‚ÄëThermal 12 kW Monoblok (R32)',                     kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R32', noise:56, price:13170, tags:['R32']},
  {brand:'Midea', model:'M‚ÄëThermal 12 kW Monoblok 3F',                        kind:'monoblok', phase:'3F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:14873, tags:['3F']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 12 kW Monoblok MHC‚ÄëV12WD2RN7‚ÄëE30',  kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R290', noise:56, price:15438, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 14 kW Monoblok MHC‚ÄëV14WD2RN7‚ÄëE30',  kind:'monoblok', phase:'3F', pA7:14.0,scop:4.7, ref:'R290', noise:56, price:16260, tags:['Arctic','R290','3F']},
  {brand:'Midea', model:'M‚ÄëThermal 16 kW Monoblok (R32) M‚ÄëThermal‚Äë16W/D2N8‚ÄëBE30', kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:57, price:20516, tags:['3F']},
  {brand:'Midea', model:'M‚ÄëThermal 26 kW Monoblok MHC‚ÄëV26W/D2RN8‚ÄëB',          kind:'monoblok', phase:'3F', pA7:26.0,scop:4.3, ref:'R32', noise:60, price:20320, tags:['wysoka moc','3F']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 14 kW Monoblok (premium)',             kind:'monoblok', phase:'3F', pA7:14.0,scop:4.8, ref:'R32', noise:56, price:36350, tags:['premium']},

  // ===== PANASONIC: AQUAREA (R32) =====
  {brand:'Panasonic', model:'Aquarea Monoblok 5 kW WH‚ÄëMDC05J3E5',            kind:'monoblok', phase:'1F', pA7:5.0, scop:5.0, ref:'R32', noise:53, price:20745, tags:['J‚Äëgen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 7 kW WH‚ÄëMDC07J3E5',            kind:'monoblok', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:54, price:11370, tags:['J‚Äëgen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH‚ÄëMXC09J3E5 (T‚ÄëCAP)',    kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15300, tags:['T‚ÄëCAP']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH‚ÄëMDC09H3E5',            kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:14459, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Monoblok 12 kW WH‚ÄëMDC12H6E5',           kind:'monoblok', phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:13090, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Split 7 kW KIT‚ÄëADC07K3E5 (All‚Äëin‚ÄëOne)',  kind:'all-in-one', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:53, price:19041, tags:['AIO']},
  {brand:'Panasonic', model:'Aquarea Split 9 kW KIT‚ÄëWC09K3E5',               kind:'split',    phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:14930, tags:['split']},
  {brand:'Panasonic', model:'Aquarea All‚Äëin‚ÄëOne 9 kW 3F',                    kind:'all-in-one', phase:'3F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:22764, tags:['AIO','3F']},
  {brand:'Panasonic', model:'Aquarea Split 12 kW 1F',                        kind:'split',    phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:18600, tags:['split']},
  {brand:'Panasonic', model:'Aquarea T‚ÄëCAP 16 kW 3F Quiet',                  kind:'split',    phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:56, price:28455, tags:['T‚ÄëCAP','3F']},

  // ===== GALMET PRIMA (R32) ‚Äî orientacyjnie =====
  {brand:'Galmet', model:'PRIMA 6GT Monoblok',            kind:'monoblok', phase:'1F', pA7:6.0,  scop:4.8, ref:'R32', noise:55, price:22000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 8GT Monoblok',            kind:'monoblok', phase:'1F', pA7:8.0,  scop:4.8, ref:'R32', noise:55, price:24000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 10GT Monoblok',           kind:'monoblok', phase:'1F', pA7:10.0, scop:4.7, ref:'R32', noise:56, price:26000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 12GT Monoblok 3F',        kind:'monoblok', phase:'3F', pA7:12.0, scop:4.7, ref:'R32', noise:56, price:32000, tags:['PRIMA','GT','3F']}
];

// Bufory / CWU ‚Äî ceny NETTO (bazowe)
const BUFFERS = { '50':1200, '80':1450, '100':1650, '150':2200, '200':2600, '300':3600 };
const TANKS   = { '150':2450, '200':2900, '250':3400, '300':3800 };

// Monta≈º i zasady
const RAD_PRICE           = 750;     // monta≈º grzejnika / szt.
const ONLY_HP_SURCHARGE   = 4000;    // sama pompa = cena urzƒÖdzenia + 4k
const PACK_BASE_TARGETNET = 38000;   // najta≈Ñszy pakiet = 38k netto

/* ====== State ====== */
const state = {
  vat:0.08, rads:0, v3d:0, safety:0, hydro:0, glycol:0,
  basket:[],
  selectedHp:null, selectedBuf:'100', selectedTank:'200',
  provPct:0, provAbs:0,
};

/* ====== Helpers ====== */
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
const INT  = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
const INT0 = new Intl.NumberFormat('pl-PL');
const fmt = n => INT.format(Number(n)||0);

function cheapest(obj){ return Math.min(...Object.values(obj).map(Number)); }
function cheapestPumpPrice(){ return Math.min(...HEATPUMPS.map(h=>Number(h.price)||0)); }
function computeBaseOffset(){ return PACK_BASE_TARGETNET - (cheapestPumpPrice() + cheapest(BUFFERS) + cheapest(TANKS)); }
let BASE_OFFSET = computeBaseOffset();

function soloPrice(hp){ return (Number(hp.price)||0) + ONLY_HP_SURCHARGE; }

function pricePack(hpPrice, bufPrice, tankPrice, extras){
  const core = (Number(hpPrice)||0) + (Number(bufPrice)||0) + (Number(tankPrice)||0);
  return BASE_OFFSET + core + (Number(extras)||0);
}

function activeHp(){ return state.selectedHp; }

/* ====== Katalog ====== */
function fillFilters(){
  const brands=[...new Set(HEATPUMPS.map(x=>x.brand))].sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
  $('#fBrand').innerHTML = '<option value="">Marka (wszystkie)</option>' + brands.map(b=><option>${b}</option>).join('');
}
function renderTable(){
  const q=($('#q').value||'').toLowerCase(); const brand=$('#fBrand').value; const kind=$('#fType').value; const ref=$('#fRef').value; const ph=$('#fPhase').value; let rows=HEATPUMPS.filter(p=>{
    if(q){ const hit=[p.brand,p.model,p.ref,(p.tags||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(q)); if(!hit) return false; }
    if(brand && p.brand!==brand) return false; if(kind && p.kind!==kind) return false; if(ref && p.ref!==ref) return false; if(ph && p.phase!==ph) return false; return true; });
  switch($('#sort').value){
    case 'brand.asc': rows.sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7); break;
    case 'brand.desc': rows.sort((a,b)=> (b.brand.localeCompare(a.brand,'pl')) || a.pA7-b.pA7); break;
    case 'p.asc': rows.sort((a,b)=>a.pA7-b.pA7); break; case 'p.desc': rows.sort((a,b)=>b.pA7-a.pA7); break;
    case 'price.asc': rows.sort((a,b)=>a.price-b.price); break; case 'price.desc': rows.sort((a,b)=>b.price-a.price); break;
  }
  $('#cntAll').textContent = HEATPUMPS.length; $('#cntVis').textContent = rows.length;
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><button class=\"btn tiny\" data-pick=\"${p.brand}|${p.model}\">Wybierz</button></td>
      <td><b>${p.brand}</b><div class=\"small\">${p.model}</div></td>
      <td>${p.kind}</td>
      <td>${p.pA7}</td>
      <td>${p.scop||''}</td>
      <td>${p.ref||''}</td>
      <td>${p.phase||''}</td>
      <td>${p.noise||''}</td>
      <td>${INT0.format(p.price)} PLN</td>
      <td>${(p.tags||[]).map(t=><span class=\"tag\">${t}</span>).join('')}</td>`;
    tb.appendChild(tr);
  });
}

/* ====== Konfigurator ====== */
function fillSelects(){
  const s=$('#selHp'); const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7);
  s.innerHTML = sorted.map((x,i)=><option value=\"${i}\">${x.brand} ${x.model} ‚Ä¢ ${x.kind} ‚Ä¢ A7 ${x.pA7} kW ‚Ä¢ ${INT0.format(x.price)} PLN</option>).join('');
  state.selectedHp = sorted[0];
  const b=$('#selBufor'); b.innerHTML = Object.keys(BUFFERS).map(v=><option value=\"${v}\">${v} l ‚Ä¢ ${INT0.format(BUFFERS[v])} PLN</option>).join(''); b.value='100'; state.selectedBuf='100';
  const t=$('#selCwu');   t.innerHTML = Object.keys(TANKS).map(v=><option value=\"${v}\">${v} l ‚Ä¢ ${INT0.format(TANKS[v])} PLN</option>).join(''); t.value='200'; state.selectedTank='200';
  applyHpToUi();
}
function applyHpToUi(){ renderPreview(); renderMustHave(); }

function renderPreview(){
  const b=activeHp(); if(!b){ $('#pricePreview').textContent='‚Äî'; return; }
  const bufKey=state.selectedBuf, tankKey=state.selectedTank;
  const bufCost = BUFFERS[bufKey]||0; const tankCost = (b.kind==='all-in-one') ? 0 : (TANKS[tankKey]||0);
  const extras = Number(state.v3d||0) + Number(state.safety||0) + Number(state.hydro||0) + Number(state.glycol||0) + (Number(state.rads)||0)*750;
  const sum = pricePack(b.price, bufCost, tankCost, extras);
  $('#pricePreview').textContent = ${fmt(sum)} PLN netto (brutto: ${fmt(sum*(1+state.vat))} PLN);
  const hint=$('#typeHint'); hint.style.display='block';
  if(b.kind==='monoblok') hint.textContent='Monoblok: glikol/ochrona na odcinku zewnƒôtrznym (je≈õli potrzebny).';
  else if(b.kind==='all-in-one') hint.textContent='All‚Äëin‚ÄëOne: wbudowany zasobnik CWU ‚Äî dodatkowy zwykle zbƒôdny.';
  else hint.textContent='Split: glikol nie dotyczy (obieg ch≈Çodniczy).';
}

function renderMustHave(){
  const b=activeHp(); const buf=state.selectedBuf; const t=state.selectedTank; const box=$('#mustHave');
  if(!b||!buf||!t){ box.textContent='Wybierz pompƒô, bufor i zasobnik ‚Äî poka≈ºƒô sk≈Çad.'; return; }
  const items=[];
  items.push(Pompa ciep≈Ça ‚Äî ${b.brand} ${b.model} (${b.kind}, ${b.phase||'1F'}));
  items.push(Bufor ‚Äî ${buf} l);
  items.push(b.kind==='all-in-one' ? 'Zasobnik CWU ‚Äî AIO (wbudowany)' : Zasobnik CWU ‚Äî ${t} l);
  items.push('Armatura: zaw√≥r 3D, grupa bezpiecze≈Ñstwa, zawory serwisowe');
  if(Number(state.glycol)>0 && b.kind==='monoblok') items.push('Glikol do obiegu zewnƒôtrznego (monoblok)');
  items.push('Rozdzielacz(e) / hydraulika wg wyboru');
  const r = Number(state.rads)||0; if(r>0) items.push(Monta≈º grzejnik√≥w: ${r} √ó ${INT0.format(750)} PLN);
  items.push('Monta≈º, uruchomienie, konfiguracja sterowania, szkolenie u≈ºytkownika');
  box.innerHTML = '<ul class="small" style="margin:6px 0 0 18px">' + items.map(t=><li>${t}</li>).join('') + '</ul>';
}

/* ====== Koszyk ====== */
function addToBasket(name, price, qty=1){ const i=state.basket.findIndex(x=>x.name===name && Math.abs(x.price-price)<0.01); if(i>=0) state.basket[i].qty += qty; else state.basket.push({name, price, qty}); renderBasket(); }
function renderBasket(){
  const tb=$('#basket tbody'); tb.innerHTML=''; let sumNet=0;
  state.basket.forEach((it,i)=>{ sumNet += it.price*it.qty; const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td><input type=\"number\" min=\"1\" value=\"${it.qty}\" data-qty=\"${i}\" style=\"width:70px;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:6px 8px;color:#e8edff\"></td>
      <td class=\"right\">${fmt(it.price)} PLN</td>
      <td class=\"right\"><button class=\"btn bad tiny\" data-del=\"${i}\">Usu≈Ñ</button></td>`;
    tb.appendChild(tr);
  });
  const prov = sumNet*(Number(state.provPct)||0)/100 + (Number(state.provAbs)||0);
  $('#sumNet').textContent   = fmt(sumNet) + ' PLN';
  $('#sumProv').textContent  = fmt(prov)   + ' PLN';
  $('#sumGross').textContent = fmt( (sumNet+prov) * (1+state.vat) ) + ' PLN';
}

/* ====== Events ====== */
['q','fBrand','fType','fRef','fPhase','sort'].forEach(id=>{
  const el=document.getElementById(id); el.addEventListener('input', renderTable); el.addEventListener('change', renderTable);
});
$('#btnClear').addEventListener('click', ()=>{ ['q','fBrand','fType','fRef','fPhase'].forEach(id=>document.getElementById(id).value=''); $('#sort').value='brand.asc'; renderTable(); });

document.addEventListener('click', (e)=>{
  const pick=e.target.getAttribute('data-pick'); if(pick){ const [brand,model]=pick.split('|'); const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7 ); const idx=sorted.findIndex(x=>x.brand===brand && x.model===model); if(idx>=0){ $('#selHp').value=String(idx); state.selectedHp=sorted[idx]; applyHpToUi(); window.scrollTo({top:0,behavior:'smooth'});} }
  const del=e.target.getAttribute('data-del'); if(del!=null){ state.basket.splice(Number(del),1); renderBasket(); }
});

$('#selHp').addEventListener('change', ()=>{ const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7 ); state.selectedHp = sorted[Number($('#selHp').value)||0]; applyHpToUi(); });
['selBufor','selCwu','selVat'].forEach(id=>document.getElementById(id).addEventListener('change', (e)=>{ if(e.target.id==='selBufor') state.selectedBuf=e.target.value; if(e.target.id==='selCwu') state.selectedTank=e.target.value; if(e.target.id==='selVat') state.vat=Number(e.target.value)||0.08; renderPreview(); renderBasket(); renderMustHave(); }));
['selV3d','selSafety','selHydro','selGlycol'].forEach(id=>document.getElementById(id).addEventListener('change', (e)=>{ state[e.target.id.replace('sel','').toLowerCase()] = Number(e.target.value)||0; renderPreview(); renderMustHave(); }));
$('#inpRads').addEventListener('input', e=>{ state.rads=Math.max(0,Number(e.target.value)||0); renderPreview(); renderMustHave(); });
['provPct','provAbs'].forEach(id=>document.getElementById(id).addEventListener('input', ()=>{ state.provPct=Number($('#provPct').value)||0; state.provAbs=Number($('#provAbs').value)||0; renderBasket(); }));

$('#btnAddPack').addEventListener('click', ()=>{
  const b=activeHp(); if(!b){ alert('Wybierz pompƒô.'); return; }
  const bufKey=state.selectedBuf, tankKey=state.selectedTank;
  const bufCost = BUFFERS[bufKey]||0; const tankCost = (b.kind==='all-in-one')? 0 : (TANKS[tankKey]||0);
  const extras = Number(state.v3d||0) + Number(state.safety||0) + Number(state.hydro||0) + Number(state.glycol||0) + (Number(state.rads)||0)*750;
  const price = pricePack(b.price, bufCost, tankCost, extras);
  const labels=[]; if(Number(state.v3d)>0) labels.push('zaw√≥r 3D'); if(Number(state.safety)>0) labels.push('gr. bezp.'); if(Number(state.hydro)>0) labels.push('hydraulika+'); if(Number(state.glycol)>0 && b.kind==='monoblok') labels.push('glikol'); const rlabel = state.rads? ` + grzejniki x${state.rads}` : ''; const elabel = labels.length? ` + ${labels.join(', ')}` : '';
  addToBasket(Zestaw: ${b.brand} ${b.model} + bufor ${bufKey} l + ${(b.kind==='all-in-one' ? 'AIO CWU' : ('CWU '+tankKey+' l'))}${rlabel}${elabel}, price, 1);
});

$('#btnAddHp').addEventListener('click', ()=>{ const b=activeHp(); if(!b){ alert('Wybierz pompƒô.'); return; } addToBasket(Pompa ciep≈Ça: ${b.brand} ${b.model} ‚Äî tylko urzƒÖdzenie, soloPrice(b), 1); });

// ilo≈õci w koszyku / usuwanie
 document.addEventListener('input', (e)=>{ if(e.target.matches('[data-qty]')){ const i=Number(e.target.getAttribute('data-qty')); state.basket[i].qty=Math.max(1,Number(e.target.value)||1); renderBasket(); } });

$('#btnCopy').addEventListener('click', ()=>{
  const sum = state.basket.reduce((a,b)=>a+b.price*b.qty,0); const prov = sum*(Number(state.provPct)||0)/100 + (Number(state.provAbs)||0);
  let txt='Oferta ‚Äî Pompy ciep≈Ça (zestaw)

'; state.basket.forEach(it=>{ txt += `‚Ä¢ ${it.name} √ó ${it.qty} | ${fmt(it.price)} PLN
`; });
  txt += `
Suma netto: ${fmt(sum)} PLN`; txt += `
Prowizja: ${fmt(prov)} PLN`; txt += `
Razem brutto (VAT ${Math.round(state.vat*100)}%): ${fmt((sum+prov)*(1+state.vat))} PLN`;
  navigator.clipboard.writeText(txt).then(()=>alert('Skopiowano do schowka')).catch(()=>{});
});
$('#btnPrint').addEventListener('click', ()=> window.print());
$('#btnXlsx').addEventListener('click', ()=>{
  const rows = state.basket.map(it=>({ Pozycja: it.name, Ilosc: it.qty, Cena_PLN: it.price }));
  const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Koszyk');
  XLSX.writeFile(wb, 'Koszyk_PompyCiepla_rozszerzony.xlsx');
});

/* ====== Init ====== */
function init(){ fillFilters(); renderTable(); fillSelects(); renderBasket(); }
init();
</script>
</body>
</html>