<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komponenty: Pompy ciep≈Ça</title>
<meta name="description" content="Baza pomp ciep≈Ça: marki, modele, parametry, akcesoria. Filtrowanie, sortowanie, import/eksport, edycja.">
<style>
  :root{ --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2fbf71; --warn:#ffb84d; --bad:#ff6b6b; --grid:#243059; --card:#0f1533; --line:#1c2750;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:1.6fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:#2f9762}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--grid);vertical-align:top;text-align:left}
  th{font-size:12px;color:var(--muted);position:sticky;top:0;background:#151d46;z-index:1}
  tbody tr:hover{background:#0d153033}
  .small{font-size:12px;color:#aeb8da}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .tab{padding:6px 10px;border:1px solid #2a3a75;border-radius:999px;cursor:pointer}
  .tab.active{background:#223160}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:900px){ .grid-2{grid-template-columns:1fr} }
  .drawer{position:fixed;right:0;top:0;height:100%;width:560px;max-width:100%;background:linear-gradient(180deg,#0e1433,#0e173d);border-left:1px solid #2b3a77;box-shadow:-20px 0 60px #0008;transform:translateX(100%);transition:.25s;z-index:50;overflow:auto}
  .drawer.open{transform:none}
  .drawer .hd{position:sticky;top:0;background:#101a45;border-bottom:1px solid #2b3a77;padding:12px}
  .drawer .bd{padding:12px}
  .drawer h3{margin:0 0 6px 0}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
  .kv label{font-size:13px;color:#aeb8da}
  .kv input,.kv select,.kv textarea{width:100%}
  details > summary{cursor:pointer;margin:8px 0;color:#cfe1ff}
  .warnbox{border:1px dashed #9d7a33;padding:10px;border-radius:8px;background:#2b230c}
  @media print{ nav,.btn,.drawer,.tabs{display:none!important} th{top:auto} }
</style>
</head>
<body>

<header>
  <h1>Komponenty ‚Ä¢ Pompy ciep≈Ça</h1>
  <div class="muted">Obszerna baza urzƒÖdze≈Ñ i akcesori√≥w: marki, modele, parametry, ceny, kompatybilno≈õƒá. Zapis lokalny, import/eksport CSV/JSON.</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="komponenty.html">Komponenty ‚Äî Hub</a>
  <a href="komponenty-pompy.html" style="background:#223160">Pompy</a>
  <a href="komponenty-piece.html">Piece</a>
  <a href="komponenty-fotowoltaika.html">Fotowoltaika</a>
  <a href="komponenty-ocieplenie.html">Ocieplenie</a>
  <a href="komponenty-stolarka.html">Stolarka</a>
  <a href="komponenty-hydraulika.html">Hydraulika</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWA: Lista + filtry -->
  <section class="grid">
    <div class="card">
      <div class="row">
        <input id="q" placeholder="üîé Szukaj: marka, model, czynnik, uwagi‚Ä¶" style="min-width:260px">
        <select id="fBrand"><option value="">Marka (wszystkie)</option></select>
        <select id="fType">
          <option value="">Typ (wszystkie)</option>
          <option value="split">Split</option>
          <option value="monoblok">Monoblok</option>
          <option value="gruntowa">Gruntowa</option>
        </select>
        <select id="fRefrig">
          <option value="">Czynnik (wszystkie)</option>
          <option>R32</option><option>R290</option><option>R410A</option><option>CO2</option>
        </select>
        <select id="fPhase">
          <option value="">Fazy</option>
          <option>1~</option><option>3~</option>
        </select>
        <select id="fUse">
          <option value="">Zastosowanie</option>
          <option value="dom">Dom jednorodzinny</option>
          <option value="mdu">Wielorodzinny / komercyjne</option>
          <option value="basen">Basen</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="fPowerMin" type="number" placeholder="Moc min [kW]" style="width:130px">
        <input id="fPowerMax" type="number" placeholder="Moc max [kW]" style="width:130px">
        <input id="fPriceMax" type="number" placeholder="Cena ‚â§ [PLN]" style="width:160px">
        <select id="sort">
          <option value="brand.asc">Sort: Marka ‚Üë</option>
          <option value="brand.desc">Sort: Marka ‚Üì</option>
          <option value="power.asc">Sort: Moc ‚Üë</option>
          <option value="power.desc">Sort: Moc ‚Üì</option>
          <option value="price.asc">Sort: Cena ‚Üë</option>
          <option value="price.desc">Sort: Cena ‚Üì</option>
          <option value="scop.desc">Sort: SCOP ‚Üì</option>
        </select>
        <button id="btnClear" class="btn ghost">Wyczy≈õƒá filtry</button>
        <span class="pill">≈ÅƒÖcznie: <b id="cntAll">0</b></span>
        <span class="pill">Widocznych: <b id="cntVis">0</b></span>
      </div>
    </div>

    <div class="card" style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Akcje</th>
            <th>Marka / Model</th>
            <th>Typ</th>
            <th>Moc [kW]</th>
            <th>SCOP</th>
            <th>Czynnik</th>
            <th>Fazy</th>
            <th>Praca niskie T</th>
            <th>Ha≈Ças [dB(A)]</th>
            <th>CWU</th>
            <th>Cena [PLN]</th>
            <th>Uwagi / tagi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- PRAWA: Akcje, akcesoria -->
  <aside class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Operacje</b>
        <div class="right">
          <button id="btnAdd" class="btn ok">+ Dodaj pompƒô</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnExportJSON" class="btn">Eksport JSON</button>
        <label class="btn ghost">Import JSON<input id="importJSON" type="file" accept="application/json" hidden></label>
        <button id="btnCSV" class="btn ghost">CSV</button>
        <button id="btnPrint" class="btn ghost">Drukuj</button>
      </div>
      <details style="margin-top:8px">
        <summary>üéØ Wskaz√≥wki doboru</summary>
        <div class="small" style="margin-top:6px">
          ‚Ä¢ R290 = wy≈ºsze T zasilania (grzejniki), zwykle lepsza praca na mrozie.<br>
          ‚Ä¢ Split: jednostka wewnƒôtrzna + zewnƒôtrzna; Monoblok: ca≈Ço≈õƒá na zewnƒÖtrz (prostsza instalacja wodna).<br>
          ‚Ä¢ Zapas mocy 10‚Äì20% wzglƒôdem OZC, zw≈Çaszcza dla CWU / rozmro≈ºe≈Ñ.<br>
          ‚Ä¢ SCOP‚â•4 dla pod≈Çog√≥wki; sprawdzaj krzywe grzewcze i moc przy -7/-15 ¬∞C.
        </div>
      </details>
    </div>

    <div class="card">
      <b>Akcesoria i hydraulika (do zestawu)</b>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <div class="muted">Bufory / sprzƒôg≈Ça</div>
          <ul class="small">
            <li>Bufor 50/100/200/300 l (izolowany, kr√≥ƒáce 1")</li>
            <li>Sprzƒôg≈Ço hydrauliczne 25/32/40</li>
          </ul>
          <div class="muted" style="margin-top:6px">Zasobniki CWU</div>
          <ul class="small">
            <li>200/250/300/400 l, wƒô≈ºownica XXL</li>
            <li>Zasobnik biwalentny (PV/solary + PC)</li>
          </ul>
          <div class="muted" style="margin-top:6px">Zawory</div>
          <ul class="small">
            <li>3-drogowy prze≈ÇƒÖczajƒÖcy CWU/CO (DN20‚ÄìDN32)</li>
            <li>Antyzamro≈ºeniowy, bezpiecze≈Ñstwa 3 bar</li>
          </ul>
        </div>
        <div>
          <div class="muted">Pompy obiegowe</div>
          <ul class="small">
            <li>Grundfos Alpha2, Magna3</li>
            <li>Wilo Yonos PARA, Stratos MAXO</li>
          </ul>
          <div class="muted" style="margin-top:6px">Armatura</div>
          <ul class="small">
            <li>Filtr siatkowy + magnetyt (MagnaClean)</li>
            <li>Odpowietrzniki autom., rotametry, mieszacze</li>
            <li>Naczynie przeponowe 12/18/25/35 l</li>
          </ul>
          <div class="muted" style="margin-top:6px">Inne</div>
          <ul class="small">
            <li>Glikol -15/-25 ¬∞C, izolacje kauczukowe</li>
            <li>Tace ociekowe, grza≈Çki tacy, ramy monta≈ºowe</li>
          </ul>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Drawer Edycji -->
<aside id="drawer" class="drawer" aria-label="Edycja pompy">
  <div class="hd">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Edycja pompy</h3>
      <div class="right">
        <button id="btnClose" class="btn ghost" type="button">Zamknij</button>
        <button id="btnDel" class="btn bad" type="button">Usu≈Ñ</button>
        <button id="btnDup" class="btn" type="button">Duplikuj</button>
      </div>
    </div>
  </div>
  <div class="bd">
    <div class="kv">
      <label>Marka</label><input id="e_brand" placeholder="np. Panasonic">
      <label>Model</label><input id="e_model" placeholder="np. Aquarea T-CAP 9 kW">
      <label>Typ</label>
      <select id="e_type"><option>split</option><option>monoblok</option><option>gruntowa</option></select>
      <label>Moc nominalna [kW]</label><input id="e_power" type="number" step="0.1" placeholder="np. 9">
      <label>SCOP</label><input id="e_scop" type="number" step="0.01" placeholder="np. 4.5">
      <label>Czynnik</label><select id="e_refrig"><option>R32</option><option>R290</option><option>R410A</option><option>CO2</option></select>
      <label>Fazy</label><select id="e_phase"><option>1~</option><option>3~</option></select>
      <label>Praca przy -25 ¬∞C</label><select id="e_lowtemp"><option>tak</option><option>nie</option></select>
      <label>Ha≈Ças [dB(A)]</label><input id="e_noise" type="number" step="1" placeholder="np. 52">
      <label>Wbud. zasobnik CWU</label><select id="e_cwu"><option>brak</option><option>180 l</option><option>200 l</option><option>250 l</option></select>
      <label>Cena katalogowa [PLN]</label><input id="e_price" type="number" step="1" placeholder="np. 32000">
      <label>Tagi (przecinki)</label><input id="e_tags" placeholder="np. T-CAP, -25C, PV-ready">
      <label>Uwagi</label><textarea id="e_notes" placeholder="np. Zestaw z buforem 100 l, zaw√≥r 3D, pompa Yonos"></textarea>
      <label>Kompatybilne akcesoria</label><textarea id="e_acc" placeholder="np. Bufor 100l; Zaw√≥r 3D DN25; Grundfos Alpha2"></textarea>
      <label>Link producenta</label><input id="e_link" placeholder="https://‚Ä¶">
    </div>
  </div>
</aside>

<script>
'use strict';

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL');
function fmt(n){ return INT.format(Math.round(Number(n)||0)); }
function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

/* ===== storage ===== */
const LS_KEY = 'arkon_cmp_pumps_v1';
let pumps = load(LS_KEY, []);
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(pumps)); render(); fillBrands(); }

/* ===== seed (je≈õli pusto) ===== */
if(!pumps.length){
  pumps = [
    // Panasonic
    {id:uid(),brand:'Panasonic',model:'Aquarea T‚ÄëCAP 9kW',type:'split',power:9,scop:4.6,refrig:'R32',phase:'1~',lowtemp:'tak',noise:52,cwu:'brak',price:32000,tags:['T-CAP','-20C'],notes:'Wysoka moc na mrozie, dobry do grzejnik√≥w niskotemp.',acc:'Bufor 100l; Zaw√≥r 3D DN25; Grundfos Alpha2',link:''},
    {id:uid(),brand:'Panasonic',model:'Aquarea All‚Äëin‚ÄëOne 200l 7kW',type:'split',power:7,scop:4.8,refrig:'R32',phase:'1~',lowtemp:'tak',noise:50,cwu:'200 l',price:36000,tags:['AIO','pod≈Çog√≥wka'],notes:'Zintegrowany zasobnik 200 l',acc:'Zaw√≥r 3D DN20; Wilo Yonos PARA',link:''},
    // Daikin
    {id:uid(),brand:'Daikin',model:'Altherma 3 8kW',type:'split',power:8,scop:4.7,refrig:'R32',phase:'1~',lowtemp:'tak',noise:48,cwu:'brak',price:34500,tags:['Quiet'],notes:'Cicha jednostka, COP wysoki przy +7 ¬∞C',acc:'Bufor 50l; Grundfos Alpha2',link:''},
    {id:uid(),brand:'Daikin',model:'Altherma 3 H HT 14kW',type:'split',power:14,scop:4.2,refrig:'R32',phase:'3~',lowtemp:'tak',noise:54,cwu:'brak',price:48000,tags:['wysoka temp'],notes:'Do modernizacji z grzejnikami',acc:'Bufor 100l; Zaw√≥r 3D DN32',link:''},
    // Mitsubishi
    {id:uid(),brand:'Mitsubishi',model:'Ecodan 8.5kW',type:'split',power:8.5,scop:4.6,refrig:'R32',phase:'1~',lowtemp:'tak',noise:49,cwu:'brak',price:35500,tags:['Zubadan'],notes:'Stabilna moc na mrozie (Zubadan)',acc:'Sprzƒôg≈Ço 25; Wilo Yonos',link:''},
    // LG
    {id:uid(),brand:'LG',model:'Therma V 9kW Monoblok',type:'monoblok',power:9,scop:4.5,refrig:'R32',phase:'1~',lowtemp:'tak',noise:53,cwu:'brak',price:31500,tags:['monoblok'],notes:'Prosta instalacja wodna',acc:'Bufor 50l; Naczynie 18l',link:''},
    // Samsung
    {id:uid(),brand:'Samsung',model:'EHS Mono 12kW',type:'monoblok',power:12,scop:4.4,refrig:'R32',phase:'3~',lowtemp:'tak',noise:55,cwu:'brak',price:33500,tags:['PV-ready'],notes:'Dobra integracja z PV',acc:'Zaw√≥r 3D DN25; Alpha2',link:''},
    // Vaillant R290
    {id:uid(),brand:'Vaillant',model:'aroTHERM plus 7kW',type:'monoblok',power:7,scop:4.8,refrig:'R290',phase:'1~',lowtemp:'tak',noise:48,cwu:'brak',price:39900,tags:['R290','wysoka temp'],notes:'Do grzejnik√≥w: do 75 ¬∞C',acc:'Bufor 100l; Sprzƒôg≈Ço 25',link:''},
    // Viessmann
    {id:uid(),brand:'Viessmann',model:'Vitocal 150‚ÄëA 10kW',type:'monoblok',power:10,scop:4.7,refrig:'R290',phase:'3~',lowtemp:'tak',noise:50,cwu:'brak',price:44500,tags:['R290'],notes:'Nowa generacja na propanie',acc:'Zaw√≥r 3D; Grundfos Alpha3',link:''},
    // Bosch
    {id:uid(),brand:'Bosch',model:'Compress 7000i AW 9kW',type:'split',power:9,scop:4.6,refrig:'R32',phase:'1~',lowtemp:'tak',noise:51,cwu:'brak',price:33800,tags:['7000i'],notes:'Sterownik zdalny, aplikacja',acc:'Bufor 50l; Wilo',link:''},
    // NIBE
    {id:uid(),brand:'NIBE',model:'S2125‚Äë12',type:'monoblok',power:12,scop:4.9,refrig:'R290',phase:'3~',lowtemp:'tak',noise:53,cwu:'brak',price:52000,tags:['premium','R290'],notes:'Top sprawno≈õƒá, rozbudowana automatyka',acc:'Bufor 100l; Stratos MAXO',link:''},
    // Atlantic
    {id:uid(),brand:'Atlantic',model:'Extensa AI 8kW',type:'split',power:8,scop:4.5,refrig:'R32',phase:'1~',lowtemp:'tak',noise:50,cwu:'brak',price:28900,tags:['bud≈ºet'],notes:'Ekonomiczna',acc:'Filtr + magnetyt',link:''},
    // Gree
    {id:uid(),brand:'Gree',model:'Versati 10kW',type:'split',power:10,scop:4.3,refrig:'R32',phase:'1~',lowtemp:'tak',noise:54,cwu:'brak',price:26500,tags:['value'],notes:'Dobry stosunek cena/jako≈õƒá',acc:'Bufor 50l',link:''},
    // Midea
    {id:uid(),brand:'Midea',model:'M‚ÄëThermal 12kW',type:'monoblok',power:12,scop:4.4,refrig:'R32',phase:'3~',lowtemp:'tak',noise:55,cwu:'brak',price:25900,tags:['monoblok'],notes:'Popularna w zestawach OEM',acc:'Zaw√≥r 3D',link:''},
    // Haier
    {id:uid(),brand:'Haier',model:'Super Aqua 8kW',type:'split',power:8,scop:4.4,refrig:'R32',phase:'1~',lowtemp:'tak',noise:52,cwu:'brak',price:24800,tags:['ekonomia'],notes:'Aplikacja mobilna',acc:'Grundfos Alpha2',link:''},
    // Hitachi
    {id:uid(),brand:'Hitachi',model:'Yutaki S 11kW',type:'split',power:11,scop:4.5,refrig:'R32',phase:'3~',lowtemp:'tak',noise:52,cwu:'brak',price:39900,tags:['japo≈Ñska'],notes:'Szeroka modulacja',acc:'Bufor 100l',link:''},
    // Stiebel
    {id:uid(),brand:'Stiebel Eltron',model:'WPL 09 ACS classic',type:'monoblok',power:9,scop:4.6,refrig:'R32',phase:'1~',lowtemp:'tak',noise:47,cwu:'brak',price:51200,tags:['premium','cicha'],notes:'Bardzo niski ha≈Ças',acc:'Sprzƒôg≈Ço 25',link:''},
    // Buderus
    {id:uid(),brand:'Buderus',model:'Logatherm WSW 8 (gruntowa)',type:'gruntowa',power:8,scop:5.0,refrig:'R410A',phase:'3~',lowtemp:'tak',noise:43,cwu:'brak',price:62000,tags:['gruntowa'],notes:'Sonde / kolektor poziomy',acc:'Solanka; wymiennik',link:''},
    // Toshiba
    {id:uid(),brand:'Toshiba',model:'Estia 8kW',type:'split',power:8,scop:4.5,refrig:'R32',phase:'1~',lowtemp:'tak',noise:49,cwu:'brak',price:32900,tags:['sprawdzone'],notes:'Dobra praca czƒô≈õciowa',acc:'Alpha2; bufor 50l',link:''},
  ];
  save();
}

/* ===== UI state ===== */
let openId = null;

/* ===== filters ===== */
const filter = { q:'', brand:'', type:'', refrig:'', phase:'', use:'', pmin:'', pmax:'', priceMax:'', sort:'brand.asc' };

$('#q').addEventListener('input', e=>{ filter.q=e.target.value.trim(); render(); });
$('#fBrand').addEventListener('change', e=>{ filter.brand=e.target.value; render(); });
$('#fType').addEventListener('change', e=>{ filter.type=e.target.value; render(); });
$('#fRefrig').addEventListener('change', e=>{ filter.refrig=e.target.value; render(); });
$('#fPhase').addEventListener('change', e=>{ filter.phase=e.target.value; render(); });
$('#fUse').addEventListener('change', e=>{ filter.use=e.target.value; render(); });
$('#fPowerMin').addEventListener('input', e=>{ filter.pmin=Number(e.target.value)||''; render(); });
$('#fPowerMax').addEventListener('input', e=>{ filter.pmax=Number(e.target.value)||''; render(); });
$('#fPriceMax').addEventListener('input', e=>{ filter.priceMax=Number(e.target.value)||''; render(); });
$('#sort').addEventListener('change', e=>{ filter.sort=e.target.value; render(); });
$('#btnClear').addEventListener('click', ()=>{
  $('#q').value=''; $('#fBrand').value=''; $('#fType').value=''; $('#fRefrig').value=''; $('#fPhase').value=''; $('#fUse').value='';
  $('#fPowerMin').value=''; $('#fPowerMax').value=''; $('#fPriceMax').value=''; $('#sort').value='brand.asc';
  Object.assign(filter, {q:'',brand:'',type:'',refrig:'',phase:'',use:'',pmin:'',pmax:'',priceMax:'',sort:'brand.asc'});
  render();
});

/* ===== table render ===== */
function render(){
  const tb = $('#tbody'); tb.innerHTML='';
  let rows = pumps.slice();

  // filter
  rows = rows.filter(p=>{
    if(filter.q){
      const q=filter.q.toLowerCase();
      const hit = [p.brand,p.model,p.refrig,p.notes,(p.tags||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(q));
      if(!hit) return false;
    }
    if(filter.brand && p.brand!==filter.brand) return false;
    if(filter.type && p.type!==filter.type) return false;
    if(filter.refrig && p.refrig!==filter.refrig) return false;
    if(filter.phase && p.phase!==filter.phase) return false;
    if(filter.pmin!=='' && (Number(p.power)||0) < filter.pmin) return false;
    if(filter.pmax!=='' && (Number(p.power)||0) > filter.pmax) return false;
    if(filter.priceMax!=='' && (Number(p.price)||0) > filter.priceMax) return false;
    if(filter.use){
      // prosta heurystyka: dom<=12 kW, mdu>12, basen tag 'basen'
      if(filter.use==='dom' && (Number(p.power)||0)>12) return false;
      if(filter.use==='mdu' && (Number(p.power)||0)<=12) return false;
      if(filter.use==='basen' && !(p.tags||[]).join(' ').toLowerCase().includes('basen')) return false;
    }
    return true;
  });

  // sort
  rows.sort((a,b)=>{
    switch(filter.sort){
      case 'brand.asc': return (a.brand||'').localeCompare(b.brand||'', 'pl',{sensitivity:'base'}) || (a.model||'').localeCompare(b.model||'', 'pl');
      case 'brand.desc': return (b.brand||'').localeCompare(a.brand||'', 'pl',{sensitivity:'base'}) || (b.model||'').localeCompare(a.model||'', 'pl');
      case 'power.asc': return (a.power||0)-(b.power||0);
      case 'power.desc': return (b.power||0)-(a.power||0);
      case 'price.asc': return (a.price||0)-(b.price||0);
      case 'price.desc': return (b.price||0)-(a.price||0);
      case 'scop.desc': return (b.scop||0)-(a.scop||0);
      default: return 0;
    }
  });

  $('#cntAll').textContent = pumps.length;
  $('#cntVis').textContent = rows.length;

  rows.forEach(p=>{
    const tr=document.createElement('tr');
    const tags = (p.tags||[]).map(t=>'<span class="tag">'+escapeHtml(t)+'</span>').join('');
    tr.innerHTML = `
      <td>
        <button class="btn ghost open" data-id="${p.id}" title="Edytuj" type="button">‚úèÔ∏è</button>
      </td>
      <td><b>${escapeHtml(p.brand||'')}</b><div class="small">${escapeHtml(p.model||'')}</div></td>
      <td>${escapeHtml(p.type||'')}</td>
      <td>${p.power??''}</td>
      <td>${p.scop??''}</td>
      <td>${escapeHtml(p.refrig||'')}</td>
      <td>${escapeHtml(p.phase||'')}</td>
      <td>${escapeHtml(p.lowtemp||'')}</td>
      <td>${p.noise??''}</td>
      <td>${escapeHtml(p.cwu||'')}</td>
      <td>${fmt(p.price||0)}</td>
      <td>${tags}<div class="small">${escapeHtml(p.notes||'')}</div></td>`;
    tr.addEventListener('dblclick', ()=> openDrawer(p.id));
    tb.appendChild(tr);
  });

  tb.querySelectorAll('.open').forEach(b=>b.addEventListener('click',(e)=>{ e.stopPropagation(); openDrawer(b.dataset.id); }));
}

/* ===== brand filter fill ===== */
function fillBrands(){
  const sel = $('#fBrand'); const cur = sel.value;
  const brands = Array.from(new Set(pumps.map(p=>p.brand))).sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
  sel.innerHTML = '<option value="">Marka (wszystkie)</option>' + brands.map(b=>`<option${b===cur?' selected':''}>${escapeHtml(b)}</option>`).join('');
}
fillBrands();

/* ===== CRUD ===== */
$('#btnAdd').addEventListener('click', ()=>{
  const p = { id:uid(), brand:'', model:'', type:'split', power:8, scop:4.5, refrig:'R32', phase:'1~', lowtemp:'tak', noise:52, cwu:'brak', price:30000, tags:[], notes:'', acc:'', link:'' };
  pumps.unshift(p); save(); openDrawer(p.id);
});
function removePump(id){ const i=pumps.findIndex(x=>x.id===id); if(i>=0){ pumps.splice(i,1); save(); closeDrawer(); } }
function duplicatePump(id){
  const src = pumps.find(x=>x.id===id); if(!src) return;
  const copy = JSON.parse(JSON.stringify(src)); copy.id=uid(); copy.model = (src.model||'') + ' (kopia)';
  pumps.unshift(copy); save(); openDrawer(copy.id);
}

/* ===== Drawer ===== */
const drawer = $('#drawer');
$('#btnClose').addEventListener('click', closeDrawer);
$('#btnDel').addEventListener('click', ()=>{ if(openId && confirm('UsunƒÖƒá pompƒô?')) removePump(openId); });
$('#btnDup').addEventListener('click', ()=>{ if(openId) duplicatePump(openId); });

function openDrawer(id){
  openId = id;
  const p = pumps.find(x=>x.id===id); if(!p) return;
  drawer.classList.add('open');

  $('#e_brand').value = p.brand||'';
  $('#e_model').value = p.model||'';
  $('#e_type').value  = p.type||'split';
  $('#e_power').value = p.power??'';
  $('#e_scop').value  = p.scop??'';
  $('#e_refrig').value= p.refrig||'R32';
  $('#e_phase').value = p.phase||'1~';
  $('#e_lowtemp').value = p.lowtemp||'tak';
  $('#e_noise').value = p.noise??'';
  $('#e_cwu').value = p.cwu||'brak';
  $('#e_price').value = p.price??'';
  $('#e_tags').value = (p.tags||[]).join(', ');
  $('#e_notes').value = p.notes||'';
  $('#e_acc').value = p.acc||'';
  $('#e_link').value = p.link||'';

  bindEditorHandlers();
}
function closeDrawer(){ drawer.classList.remove('open'); openId=null; }

function bindEditorHandlers(){
  ['#e_brand','#e_model','#e_power','#e_scop','#e_noise','#e_price','#e_tags','#e_notes','#e_acc','#e_link'].forEach(sel=>{
    $(sel).oninput = debounce(saveEditor, 160);
  });
  ['#e_type','#e_refrig','#e_phase','#e_lowtemp','#e_cwu'].forEach(sel=>{
    $(sel).onchange = saveEditor;
  });
}
function saveEditor(){
  if(!openId) return;
  const p = pumps.find(x=>x.id===openId); if(!p) return;
  p.brand = $('#e_brand').value.trim();
  p.model = $('#e_model').value.trim();
  p.type  = $('#e_type').value;
  p.power = Number($('#e_power').value)||0;
  p.scop  = Number($('#e_scop').value)||0;
  p.refrig= $('#e_refrig').value;
  p.phase = $('#e_phase').value;
  p.lowtemp = $('#e_lowtemp').value;
  p.noise = Number($('#e_noise').value)||0;
  p.cwu   = $('#e_cwu').value;
  p.price = Number($('#e_price').value)||0;
  p.tags  = $('#e_tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  p.notes = $('#e_notes').value;
  p.acc   = $('#e_acc').value;
  p.link  = $('#e_link').value;
  save();
}

/* ===== import/export ===== */
$('#btnExportJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(pumps,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'arkon_pompy.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#importJSON').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const data = JSON.parse(txt);
    if(!Array.isArray(data)) throw new Error('Z≈Çy format.');
    pumps = data; save(); alert('Zaimportowano.');
  }catch(err){ alert('B≈ÇƒÖd importu: '+err.message); }
  e.target.value='';
});
$('#btnCSV').addEventListener('click', ()=>{
  const cols = ['brand','model','type','power','scop','refrig','phase','lowtemp','noise','cwu','price','tags','notes','acc','link'];
  const rows = [cols.join(';')];
  pumps.forEach(p=>{
    const r = cols.map(k=>{
      let v = (k==='tags') ? (p.tags||[]).join('|') : (p[k]??'');
      v = String(v);
      if(/[;\n"]/.test(v)) v = '"'+v.replace(/"/g,'""')+'"';
      return v;
    });
    rows.push(r.join(';'));
  });
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'arkon_pompy.csv'; a.click(); URL.revokeObjectURL(a.href);
});
$('#btnPrint').addEventListener('click', ()=> window.print());

/* ===== debounce ===== */
function debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms||180); }; }

/* ===== boot ===== */
render();

</script>
</body>
</html>
