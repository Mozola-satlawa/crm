<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Komponenty ‚Ä¢ Pompy ciep≈Ça ‚Äî Midea, Panasonic & Galmet (proporcjonalna wycena ‚Äî ceny na sztywno)</title>
<style>
  :root{--bg:#0b1020;--p1:#121a34;--p2:#172142;--ink:#e8edff;--muted:#aeb8da;--accent:#4cc9f0;--ok:#2fbf71;--warn:#ffb84d;--bad:#ff6b6b;--grid:#243059;--card:#0f1533;--line:#1c2750}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  .wrap{max-width:1500px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){.cols-2{grid-template-columns:1.55fr 1fr}}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto;display:flex;gap:8px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .btn.warn{background:#3a2a19;border-color:#9d7a33}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .tiny{font-size:12px}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;font:inherit;color:#e8edff}
  input::placeholder{color:#aeb8da99}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid #243059;vertical-align:top;text-align:left}
  th{font-size:12px;color:#aeb8da;position:sticky;top:0;background:#151d46;z-index:1}
  tbody tr:hover{background:#0d153033}
  .small{font-size:12px;color:#aeb8da}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .sep{height:1px;background:#243059;margin:10px 0}
  .okline{padding:8px;border-radius:10px;background:#0f2a22;border:1px solid #155a41;color:#b4ffdd}

  /* helper classes moved from inline styles */
  .search { min-width:240px; }
  .card.scroll { overflow:auto; }
  .row.spaced { justify-content:space-between; }
  .mt8 { margin-top:8px; }
  .mt6 { margin-top:6px; }
  .w110 { width:110px; }
  .w80 { width:80px; }
  .w130 { width:130px; }
  .flex-1 { flex:1; }
  .price-preview { font-weight:800; font-size:18px; }
    .type-hint { display:none; margin-top:6px; }
  </style>
  </head>
  <body>
  <div class="wrap">
  <div class="grid cols-2">
  <section>
          <input id="q" class="search" placeholder="üîé Szukaj: marka, model, czynnik‚Ä¶" aria-label="Szukaj" />
          <select id="fBrand"><option value="">Marka (wszystkie)</option></select>
          <select id="fType"><option value="">Typ</option><option>monoblok</option><option>split</option><option>all-in-one</option></select>
          <select id="fRef"><option value="">Czynnik</option><option>R32</option><option>R290</option></select>
          <select id="fPhase"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
          <select id="sort">
            <option value="brand.asc">Sort: Marka ‚Üë</option>
            <option value="brand.desc">Sort: Marka ‚Üì</option>
            <option value="p.asc">Sort: Moc ‚Üë</option>
            <option value="p.desc">Sort: Moc ‚Üì</option>
            <option value="price.asc">Sort: Cena urzƒÖdzenia ‚Üë</option>
            <option value="price.desc">Sort: Cena urzƒÖdzenia ‚Üì</option>
          </select>
          <button id="btnClear" class="btn ghost">Wyczy≈õƒá</button>
          <span class="pill">≈ÅƒÖcznie: <b id="cntAll">0</b></span>
          <span class="pill">Widocznych: <b id="cntVis">0</b></span>
  
      <div class="card scroll">
      <table>
        <thead>
          <tr>
            <th>Akcje</th>
            <th>Marka / Model</th>
            <th>Typ</th>
            <th>Moc A7 [kW]</th>
            <th>SCOP</th>
            <th>Czynnik</th>
            <th>Fazy</th>
            <th>Ha≈Ças [dB(A)]</th>
            <th>Cena urzƒÖdzenia [PLN]</th>
            <th>Uwagi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- PRAWA: Konfigurator -->
  <aside class="grid">
    <div class="card">
      <div class="row spaced">
        <b>Konfigurator zestawu</b>
        <div class="right">
          <button id="btnAddPack" class="btn ok">+ Dodaj ZESTAW</button>
          <button id="btnAddHp" class="btn warn">+ Sama pompa (+4‚ÄØ000)</button>
        </div>
      </div>

      <div class="row mt8">
        <div>
          <label class="small">Model pompy</label>
          <select id="selHp"></select>
        </div>
        <div>
          <label class="small">Bufor [l]</label>
          <select id="selBufor"></select>
        </div>
        <div>
          <label class="small">Zasobnik CWU [l]</label>
          <select id="selCwu"></select>
        </div>
        <div>
          <label class="small">VAT</label>
          <select id="selVat"><option value="0.08">8%</option><option value="0.23">23%</option></select>
        </div>
        <div>
          <label class="small" for="inpRads">Grzejniki (monta≈º)</label>
          <input id="inpRads" type="number" value="0" min="0" class="w110" placeholder="0" aria-label="Ilo≈õƒá grzejnik√≥w" />
          <div class="small muted">750 PLN/szt.</div>
        </div>
      </div>

      <div class="row mt8">
        <div>
          <label class="small">Zaw√≥r 3‚Äëdrogowy</label>
          <select id="selV3d"><option value="0">w zestawie</option><option value="450">+450</option></select>
        </div>
        <div>
          <label class="small">Grupa bezpiecze≈Ñstwa</label>
          <select id="selSafety"><option value="0">w zestawie</option><option value="390">+390</option></select>
        </div>
        <div>
          <label class="small">Hydraulika (rozdzielacze)</label>
          <select id="selHydro"><option value="0">podstawowa</option><option value="1800">+1 obieg (1800)</option><option value="3200">dwa obiegi (3200)</option></select>
        </div>
        <div>
          <label class="small">Glikol (monoblok)</label>
          <select id="selGlycol"><option value="0">nie</option><option value="600">30 l (600)</option><option value="900">50 l (900)</option></select>
        </div>
      </div>

      <div class="sep"></div>
      <div class="row">
        <div class="flex-1">
          <div class="muted">Cena zestawu (netto) wg modelu proporcjonalnego</div>
          <div id="pricePreview" class="price-preview">‚Äî</div>
          <div id="typeHint" class="okline type-hint"></div>
        </div>
        <div class="minw240">
          <label class="small">Prowizja handlowca</label>
          <div class="row">
            <input id="provPct" type="number" min="0" step="0.1" placeholder="%" class="w80" aria-label="Prowizja procentowa">
            <input id="provAbs" type="number" min="0" step="1" placeholder="PLN" class="w130" aria-label="Prowizja kwotowa">
          </div>
          <div class="small muted">Mo≈ºesz wpisaƒá % i/lub PLN (sumujƒÖ siƒô).</div>
        </div>
      </div>
    </div>

    <div class="card">
      <b>Sk≈Çad zestawu (must‚Äëhave)</b>
      <div id="mustHave" class="muted mt6">Wybierz pompƒô, bufor i zasobnik ‚Äî poka≈ºƒô sk≈Çad.</div>
    </div>

    <div class="card">
      <b>Koszyk</b>
      <table id="basket" class="mt8">
        <thead><tr><th>Pozycja</th><th>Ilo≈õƒá</th><th class="right">Cena [PLN]</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row">
        <div><span class="muted">Suma netto</span><div id="sumNet" class="summary-value"></div></div>
        <div><span class="muted">Prowizja</span><div id="sumProv" class="summary-value"></div></div>
        <div><span class="muted">Brutto (z VAT)</span><div id="sumGross" class="summary-value"></div></div>
        <div class="right">
          <button id="btnCopy" class="btn ghost">Kopiuj ofertƒô</button>
          <button id="btnPrint" class="btn ghost">Drukuj / PDF</button>
          <button id="btnXlsx" class="btn ghost">Eksport XLSX</button>
        </div>
      </div>
    </div>
  </aside>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
'use strict';

/* ====== CENY NA SZTYWNO ======
   Wszystkie warto≈õci poni≈ºej sƒÖ wpisane rƒôcznie i u≈ºywane 1:1. */
const HEATPUMPS = [
  // MIDEA ‚Äî M‚ÄëThermal / Arctic
  {brand:'Midea', model:'M‚ÄëThermal Arctic 4.5 kW Monoblok MHC‚ÄëV4WD2N7‚ÄëE30 (R290)', kind:'monoblok', phase:'1F', pA7:4.5, scop:5.0, ref:'R290', noise:55, price:10686, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 6 kW Monoblok',                            kind:'monoblok', phase:'1F', pA7:6.0, scop:4.9, ref:'R32', noise:55, price:12276, tags:['PRO','R32']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 8.4 kW Monoblok MHC‚ÄëV8W/D2N8‚ÄëBE30',      kind:'monoblok', phase:'1F', pA7:8.4, scop:4.9, ref:'R290', noise:55, price:9350,  tags:['Arctic','R290','WiFi']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 8 kW Split',                                kind:'split',    phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:54, price:14500, tags:['PRO','split']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 8 kW Monoblok',                             kind:'monoblok', phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:55, price:9349,  tags:['PRO','monoblok']},
  {brand:'Midea', model:'M‚ÄëThermal 9 kW Monoblok (R32)',                           kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15000, tags:['R32']},
  {brand:'Midea', model:'M‚ÄëThermal 10 kW Monoblok MHC‚ÄëV10W/D2N8‚ÄëB',                kind:'monoblok', phase:'1F', pA7:10.0,scop:4.8, ref:'R32', noise:56, price:16080, tags:['WiFi']},
  {brand:'Midea', model:'M‚ÄëThermal 12 kW Monoblok (R32)',                          kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R32', noise:56, price:13170, tags:['R32']},
  {brand:'Midea', model:'M‚ÄëThermal 12 kW Monoblok 3F',                             kind:'monoblok', phase:'3F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:14873, tags:['3F']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 12 kW Monoblok MHC‚ÄëV12WD2RN7‚ÄëE30',       kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R290', noise:56, price:15438, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 14 kW Monoblok MHC‚ÄëV14WD2RN7‚ÄëE30',       kind:'monoblok', phase:'3F', pA7:14.0,scop:4.7, ref:'R290', noise:56, price:16260, tags:['Arctic','R290','3F']},
  {brand:'Midea', model:'M‚ÄëThermal 16 kW Monoblok (R32) M‚ÄëThermal‚Äë16W/D2N8‚ÄëBE30',  kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:57, price:20516, tags:['3F']},
  {brand:'Midea', model:'M‚ÄëThermal 26 kW Monoblok MHC‚ÄëV26W/D2RN8‚ÄëB',               kind:'monoblok', phase:'3F', pA7:26.0,scop:4.3, ref:'R32', noise:60, price:20320, tags:['wysoka moc','3F']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 14 kW Monoblok (premium)',             kind:'monoblok', phase:'3F', pA7:14.0,scop:4.8, ref:'R32', noise:56, price:36350, tags:['premium']},
  // ===== DODATKOWE MIDEA (rozszerzenie) =====
  {brand:'Midea', model:'M‚ÄëThermal Arctic 6.3 kW Monoblok MHC‚ÄëV6W/D2N8‚ÄëE30', kind:'monoblok', phase:'1F', pA7:6.3, scop:5.0, ref:'R290', noise:55, price:11890, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal Arctic 10 kW Monoblok MHC‚ÄëV10WD2RN7‚ÄëE30',  kind:'monoblok', phase:'1F', pA7:10.0,scop:4.9, ref:'R290', noise:56, price:13990, tags:['Arctic','R290']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 10 kW Split',                          kind:'split',     phase:'1F', pA7:10.0,scop:4.9, ref:'R32',  noise:54, price:16980, tags:['PRO','split']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 12 kW Split 3F',                        kind:'split',     phase:'3F', pA7:12.0,scop:4.8, ref:'R32',  noise:55, price:18950, tags:['PRO','split','3F']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 14 kW Split 3F',                        kind:'split',     phase:'3F', pA7:14.0,scop:4.7, ref:'R32',  noise:56, price:21990, tags:['PRO','split','3F']},
  {brand:'Midea', model:'M‚ÄëThermal PRO 16 kW Monoblok 3F',                     kind:'monoblok',  phase:'3F', pA7:16.0,scop:4.6, ref:'R32',  noise:57, price:23490, tags:['PRO','3F']},
  {brand:'Midea', model:'M‚ÄëThermal All‚Äëin‚ÄëOne 8 kW (R32)',                     kind:'all-in-one',phase:'1F', pA7:8.0, scop:4.8, ref:'R32',  noise:53, price:18490, tags:['AIO']},
  {brand:'Midea', model:'M‚ÄëThermal All‚Äëin‚ÄëOne 12 kW 3F (R32)',                 kind:'all-in-one',phase:'3F', pA7:12.0,scop:4.7, ref:'R32',  noise:54, price:22990, tags:['AIO','3F']},

  // PANASONIC ‚Äî Aquarea
  {brand:'Panasonic', model:'Aquarea Monoblok 5 kW WH‚ÄëMDC05J3E5',                  kind:'monoblok', phase:'1F', pA7:5.0, scop:5.0, ref:'R32', noise:53, price:20745, tags:['J‚Äëgen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 7 kW WH‚ÄëMDC07J3E5',                  kind:'monoblok', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:54, price:11370, tags:['J‚Äëgen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH‚ÄëMXC09J3E5 (T‚ÄëCAP)',          kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15300, tags:['T‚ÄëCAP']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH‚ÄëMDC09H3E5',                  kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:14459, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Monoblok 12 kW WH‚ÄëMDC12H6E5',                 kind:'monoblok', phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:13090, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Split 7 kW KIT‚ÄëADC07K3E5 (All‚Äëin‚ÄëOne)',       kind:'all-in-one', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:53, price:19041, tags:['AIO']},
  {brand:'Panasonic', model:'Aquarea Split 9 kW KIT‚ÄëWC09K3E5',                     kind:'split',    phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:14930, tags:['split']},
  {brand:'Panasonic', model:'Aquarea All‚Äëin‚ÄëOne 9 kW 3F',                          kind:'all-in-one', phase:'3F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:22764, tags:['AIO','3F']},
  {brand:'Panasonic', model:'Aquarea Split 12 kW 1F',                              kind:'split',    phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:18600, tags:['split']},
  {brand:'Panasonic', model:'Aquarea T‚ÄëCAP 16 kW 3F Quiet',                  kind:'split',    phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:56, price:28455, tags:['T‚ÄëCAP','3F']},
  // ===== DODATKOWE PANASONIC (rozszerzenie) =====
  {brand:'Panasonic', model:'Aquarea High Performance 5 kW KIT‚ÄëWC05J3E5',    kind:'split',    phase:'1F', pA7:5.0, scop:5.0, ref:'R32', noise:52, price:13250, tags:['High Perf.','split']},
  {brand:'Panasonic', model:'Aquarea High Performance 12 kW KIT‚ÄëWC12J3E5',   kind:'split',    phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:19890, tags:['High Perf.','split']},
  {brand:'Panasonic', model:'Aquarea T‚ÄëCAP 9 kW Split Quiet',                 kind:'split',    phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:21490, tags:['T‚ÄëCAP','Quiet']},
  {brand:'Panasonic', model:'Aquarea T‚ÄëCAP 12 kW Split 3F',                   kind:'split',    phase:'3F', pA7:12.0,scop:4.7, ref:'R32', noise:55, price:25490, tags:['T‚ÄëCAP','3F']},
  {brand:'Panasonic', model:'Aquarea T‚ÄëCAP 9 kW Monoblok WH‚ÄëMXC09H3E5',       kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:21990, tags:['T‚ÄëCAP','monoblok']},
  {brand:'Panasonic', model:'Aquarea K‚ÄëGeneration 7 kW All‚Äëin‚ÄëOne 1F',        kind:'all-in-one',phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:52, price:20990, tags:['K‚Äëgen','AIO']},
  {brand:'Panasonic', model:'Aquarea K‚ÄëGeneration 12 kW All‚Äëin‚ÄëOne 3F',       kind:'all-in-one',phase:'3F', pA7:12.0,scop:4.8, ref:'R32', noise:53, price:28990, tags:['K‚Äëgen','AIO','3F']},
  {brand:'Panasonic', model:'Aquarea Monoblok 16 kW WH‚ÄëMXC16J9E8 3F',         kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:58, price:27990, tags:['monoblok','3F']},

  // GALMET ‚Äî PRIMA (orientacyjnie ‚Äî na sztywno)
  {brand:'Galmet', model:'PRIMA 6GT Monoblok',            kind:'monoblok', phase:'1F', pA7:6.0,  scop:4.8, ref:'R32', noise:55, price:22000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 8GT Monoblok',            kind:'monoblok', phase:'1F', pA7:8.0,  scop:4.8, ref:'R32', noise:55, price:24000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 10GT Monoblok',           kind:'monoblok', phase:'1F', pA7:10.0, scop:4.7, ref:'R32', noise:56, price:26000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 12GT Monoblok 3F',        kind:'monoblok', phase:'3F', pA7:12.0, scop:4.7, ref:'R32', noise:56, price:32000, tags:['PRIMA','GT','3F']},
];

// Bufory / CWU ‚Äî ceny NETTO (na sztywno)
const BUFFERS = { '50':1200, '80':1450, '100':1650, '150':2200, '200':2600, '300':3600 };
const TANKS   = { '150':2450, '200':2900, '250':3400, '300':3800 };

// Zasady monta≈ºu i kalkulacji
const RAD_PRICE           = 750;     // monta≈º grzejnika / szt.
const ONLY_HP_SURCHARGE   = 4000;    // sama pompa = cena urzƒÖdzenia + 4k
const PACK_BASE_TARGETNET = 38000;   // najta≈Ñszy pakiet = 38k netto

/* ====== State ====== */
const state = {
  vat:0.08, rads:0, v3d:0, safety:0, hydro:0, glycol:0,
  basket:[],
  selectedHp:null, selectedBuf:'100', selectedTank:'200',
  provPct:0, provAbs:0,
};

/* ====== Helpers ====== */
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
const INT  = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
const INT0 = new Intl.NumberFormat('pl-PL');
const fmt = n => INT.format(Number(n)||0);

function cheapest(obj){ return Math.min(...Object.values(obj).map(Number)); }
function cheapestPumpPrice(){ return Math.min(...HEATPUMPS.map(h=>Number(h.price)||0)); }
function computeBaseOffset(){ return PACK_BASE_TARGETNET - (cheapestPumpPrice() + cheapest(BUFFERS) + cheapest(TANKS)); }
let BASE_OFFSET = computeBaseOffset();

function soloPrice(hp){ return (Number(hp.price)||0) + ONLY_HP_SURCHARGE; }
function pricePack(hpPrice, bufPrice, tankPrice, extras) {
  const core = (+hpPrice || 0) + (+bufPrice || 0) + (+tankPrice || 0);
  return BASE_OFFSET + core + (+extras || 0);
}
function activeHp(){ return state.selectedHp; }

/* ====== Katalog ====== */
function fillFilters(){
  const brands=[...new Set(HEATPUMPS.map(x=>x.brand))].sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
  $('#fBrand').innerHTML = '<option value="">Marka (wszystkie)</option>' + brands.map(b=>`<option>${b}</option>`).join('');
}
function renderTable(){
  const q=($('#q').value||'').toLowerCase(); const brand=$('#fBrand').value; const kind=$('#fType').value; const ref=$('#fRef').value; const ph=$('#fPhase').value;
  let rows=HEATPUMPS.filter(p=>{
    if(q){ const hit=[p.brand,p.model,p.ref,(p.tags||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(q)); if(!hit) return false; }
    if(brand && p.brand!==brand) return false; if(kind && p.kind!==kind) return false; if(ref && p.ref!==ref) return false; if(ph && p.phase!==ph) return false; return true;
  });
  switch($('#sort').value){
    case 'brand.asc': rows.sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7); break;
    case 'brand.desc': rows.sort((a,b)=> (b.brand.localeCompare(a.brand,'pl')) || a.pA7-b.pA7); break;
    case 'p.asc': rows.sort((a,b)=>a.pA7-b.pA7); break; case 'p.desc': rows.sort((a,b)=>b.pA7-a.pA7); break;
    case 'price.asc': rows.sort((a,b)=>a.price-b.price); break; case 'price.desc': rows.sort((a,b)=>b.price-a.price); break;
  }
  $('#cntAll').textContent = HEATPUMPS.length; $('#cntVis').textContent = rows.length;
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><button class="btn tiny" data-pick="${p.brand}|${p.model}">Wybierz</button></td>
      <td><b>${p.brand}</b><div class="small">${p.model}</div></td>
      <td>${p.kind}</td>
      <td>${p.pA7}</td>
      <td>${p.scop||''}</td>
      <td>${p.ref||''}</td>
      <td>${p.phase||''}</td>
      <td>${p.noise||''}</td>
      <td>${INT0.format(p.price)} PLN</td>
      <td>${(p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</td>`;
    tb.appendChild(tr);
  });
}

/* ====== Konfigurator ====== */
function fillSelects(){
  const s=$('#selHp'); const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7);
  s.innerHTML = sorted.map((x,i)=>`<option value="${i}">${x.brand} ${x.model} ‚Ä¢ ${x.kind} ‚Ä¢ A7 ${x.pA7} kW ‚Ä¢ ${INT0.format(x.price)} PLN</option>`).join('');
  state.selectedHp = sorted[0];
  const b=$('#selBufor'); b.innerHTML = Object.keys(BUFFERS).map(v=>`<option value="${v}">${v} l ‚Ä¢ ${INT0.format(BUFFERS[v])} PLN</option>`).join(''); b.value='100'; state.selectedBuf='100';
  const t=$('#selCwu');   t.innerHTML = Object.keys(TANKS).map(v=>`<option value="${v}">${v} l ‚Ä¢ ${INT0.format(TANKS[v])} PLN</option>`).join(''); t.value='200'; state.selectedTank='200';
  applyHpToUi();
}
function applyHpToUi(){ renderPreview(); renderMustHave(); }

function renderPreview(){
  const b=activeHp(); if(!b){ $('#pricePreview').textContent='‚Äî'; return; }
  const bufKey=state.selectedBuf, tankKey=state.selectedTank; const bufCost = BUFFERS[bufKey]||0; const tankCost = (b.kind==='all-in-one') ? 0 : (TANKS[tankKey]||0);
  const extras = Number(state.v3d||0) + Number(state.safety||0) + Number(state.hydro||0) + Number(state.glycol||0) + (Number(state.rads)||0)*RAD_PRICE;
  const sum = pricePack(b.price, bufCost, tankCost, extras);
  $('#pricePreview').textContent = `${fmt(sum)} PLN netto (brutto: ${fmt(sum*(1+state.vat))} PLN)`;
  const hint=$('#typeHint'); hint.style.display='block';
  if(b.kind==='monoblok') hint.textContent='Monoblok: pamiƒôtaj o ochronie p/zimie (glikol) na odcinku zewnƒôtrznym ‚Äî je≈õli potrzebny.';
  else if(b.kind==='all-in-one') hint.textContent='All‚Äëin‚ÄëOne: wbudowany zasobnik CWU ‚Äî dodatkowy zwykle zbƒôdny.';
  else hint.textContent='Split: glikol nie dotyczy (obieg ch≈Çodniczy).';
}

function renderMustHave(){
  const b=activeHp(); const buf=state.selectedBuf; const t=state.selectedTank; const box=$('#mustHave');
  if(!b||!buf||!t){ box.textContent='Wybierz pompƒô, bufor i zasobnik ‚Äî poka≈ºƒô sk≈Çad.'; return; }
  const items=[];
  items.push(`Pompa ciep≈Ça ‚Äî ${b.brand} ${b.model} (${b.kind}, ${b.phase||'1F'})`);
  items.push(`Bufor ‚Äî ${buf} l`);
  items.push(b.kind==='all-in-one' ? 'Zasobnik CWU ‚Äî AIO (wbudowany)' : `Zasobnik CWU ‚Äî ${t} l`);
  items.push('Armatura: zaw√≥r 3D, grupa bezpiecze≈Ñstwa, zawory serwisowe');
  if(Number(state.glycol)>0 && b.kind==='monoblok') items.push('Glikol do obiegu zewnƒôtrznego (monoblok)');
  items.push('Rozdzielacz(e) / hydraulika wg wyboru');
  const r = Number(state.rads)||0; if(r>0) items.push(`Monta≈º grzejnik√≥w: ${r} √ó ${INT0.format(RAD_PRICE)} PLN`);
  items.push('Monta≈º, uruchomienie, konfiguracja sterowania, szkolenie u≈ºytkownika');
  box.innerHTML = '<ul class="small" style="margin:6px 0 0 18px">' + items.map(tt=>`<li>${tt}</li>`).join('') + '</ul>';
}

/* ====== Koszyk ====== */
function addToBasket(name, price, qty=1){ const i=state.basket.findIndex(x=>x.name===name && Math.abs(x.price-price)<0.01); if(i>=0) state.basket[i].qty += qty; else state.basket.push({name, price, qty}); renderBasket(); }
function renderBasket(){
  const tb=$('#basket tbody'); tb.innerHTML=''; let sumNet=0;
  state.basket.forEach((it,i)=>{ sumNet += it.price*it.qty; const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td><input type="number" min="1" value="${it.qty}" data-qty="${i}" style="width:70px;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:6px 8px;color:#e8edff"></td>
      <td class="right">${fmt(it.price)} PLN</td>
      <td class="right"><button class="btn bad tiny" data-del="${i}">Usu≈Ñ</button></td>`;
    tb.appendChild(tr);
  });
  const prov = sumNet*(Number(state.provPct)||0)/100 + (Number(state.provAbs)||0);
  $('#sumNet').textContent   = fmt(sumNet) + ' PLN';
  $('#sumProv').textContent  = fmt(prov)   + ' PLN';
  $('#sumGross').textContent = fmt( (sumNet+prov) * (1+state.vat) ) + ' PLN';
}

/* ====== Events ====== */
['q','fBrand','fType','fRef','fPhase','sort'].forEach(id=>{
  const el=document.getElementById(id); el.addEventListener('input', renderTable); el.addEventListener('change', renderTable);
});
$('#btnClear').addEventListener('click', ()=>{ ['q','fBrand','fType','fRef','fPhase'].forEach(id=>document.getElementById(id).value=''); $('#sort').value='brand.asc'; renderTable(); });

document.addEventListener('click', (e)=>{
  const pick=e.target.getAttribute('data-pick'); if(pick){ const [brand,model]=pick.split('|'); const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7 ); const idx=sorted.findIndex(x=>x.brand===brand && x.model===model); if(idx>=0){ $('#selHp').value=String(idx); state.selectedHp=sorted[idx]; applyHpToUi(); window.scrollTo({top:0,behavior:'smooth'});} }
  const del=e.target.getAttribute('data-del'); if(del!=null){ state.basket.splice(Number(del),1); renderBasket(); }
});

$('#selHp').addEventListener('change', ()=>{ const sorted=HEATPUMPS.slice().sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7 ); state.selectedHp = sorted[Number($('#selHp').value)||0]; applyHpToUi(); });
['selBufor','selCwu','selVat'].forEach(id=>document.getElementById(id).addEventListener('change', (e)=>{ if(e.target.id==='selBufor') state.selectedBuf=e.target.value; if(e.target.id==='selCwu') state.selectedTank=e.target.value; if(e.target.id==='selVat') state.vat=Number(e.target.value)||0.08; renderPreview(); renderBasket(); renderMustHave(); }));
['selV3d','selSafety','selHydro','selGlycol'].forEach(id=>document.getElementById(id).addEventListener('change', (e)=>{ state[e.target.id.replace('sel','').toLowerCase()] = Number(e.target.value)||0; renderPreview(); renderMustHave(); }));
$('#inpRads').addEventListener('input', e=>{ state.rads=Math.max(0,Number(e.target.value)||0); renderPreview(); renderMustHave(); });
['provPct','provAbs'].forEach(id=>document.getElementById(id).addEventListener('input', ()=>{ state.provPct=Number($('#provPct').value)||0; state.provAbs=Number($('#provAbs').value)||0; renderBasket(); }));

$('#btnAddPack').addEventListener('click', ()=>{
  const b=activeHp(); if(!b){ alert('Wybierz pompƒô.'); return; }
  const bufKey=state.selectedBuf, tankKey=state.selectedTank; const bufCost = BUFFERS[bufKey]||0; const tankCost = (b.kind==='all-in-one')? 0 : (TANKS[tankKey]||0);
  const extras = Number(state.v3d||0) + Number(state.safety||0) + Number(state.hydro||0) + Number(state.glycol||0) + (Number(state.rads)||0)*RAD_PRICE;
  const price = pricePack(b.price, bufCost, tankCost, extras);
  const labels=[]; if(Number(state.v3d)>0) labels.push('zaw√≥r 3D'); if(Number(state.safety)>0) labels.push('gr. bezp.'); if(Number(state.hydro)>0) labels.push('hydraulika+'); if(Number(state.glycol)>0 && b.kind==='monoblok') labels.push('glikol'); const rlabel = state.rads? ` + grzejniki x${state.rads}` : ''; const elabel = labels.length? ` + ${labels.join(', ')}` : '';
  addToBasket(`Zestaw: ${b.brand} ${b.model} + bufor ${bufKey} l + ${(b.kind==='all-in-one' ? 'AIO CWU' : ('CWU '+tankKey+' l'))}${rlabel}${elabel}`, price, 1);
});

$('#btnAddHp').addEventListener('click', ()=>{ const b=activeHp(); if(!b){ alert('Wybierz pompƒô.'); return; } addToBasket(`Pompa ciep≈Ça: ${b.brand} ${b.model} ‚Äî tylko urzƒÖdzenie`, soloPrice(b), 1); });

// ilo≈õci w koszyku / usuwanie
 document.addEventListener('input', (e)=>{ if(e.target.matches('[data-qty]')){ const i=Number(e.target.getAttribute('data-qty')); state.basket[i].qty=Math.max(1,Number(e.target.value)||1); renderBasket(); } });

$('#btnCopy').addEventListener('click', ()=>{
  const sum = state.basket.reduce((a,b)=>a+b.price*b.qty,0); const prov = sum*(Number(state.provPct)||0)/100 + (Number(state.provAbs)||0);
  let txt = 'Oferta ‚Äî Pompy ciep≈Ça (zestaw)\n\n';
  state.basket.forEach(it=>{ txt += `‚Ä¢ ${it.name} √ó ${it.qty} | ${fmt(it.price)} PLN\n`; });
  txt += `\nSuma netto: ${fmt(sum)} PLN\n`;
  txt += `Prowizja: ${fmt(prov)} PLN\n`;
  txt += `Razem brutto (VAT ${Math.round(state.vat*100)}%): ${fmt((sum+prov)*(1+state.vat))} PLN`;
  navigator.clipboard.writeText(txt).then(()=>alert('Skopiowano do schowka')).catch(()=>{});
});
$('#btnPrint').addEventListener('click', ()=> window.print());
$('#btnXlsx').addEventListener('click', ()=>{
  const rows = state.basket.map(it=>({ Pozycja: it.name, Ilosc: it.qty, Cena_PLN: it.price }));
  const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Koszyk');
  XLSX.writeFile(wb, 'Koszyk_PompyCiepla_rozszerzony.xlsx');
});
</script>
</body>
</html>