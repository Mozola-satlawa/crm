<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Komponenty • Pompy ciepła — katalog + konfigurator + umowa</title>
<meta name="description" content="Katalog pomp (Midea, Panasonic, Galmet), bufory i CWU, konfigurator zestawu, dobór mocy, koszyk, klient i podgląd umowy w jednej stronie.">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230f1533'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='40' fill='%234cc9f0' font-family='Segoe UI,Arial,sans-serif'%3EP%3C/text%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0b1020;--p1:#121a34;--p2:#172142;--ink:#e8edff;--muted:#aeb8da;--accent:#4cc9f0;
    --ok:#2fbf71;--warn:#ffb84d;--bad:#ff6b6b;--grid:#243059;--card:#0f1533;--line:#1c2750
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe0ff;text-decoration:none}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:#0e1534;position:sticky;top:0;z-index:9}
  header h1{margin:0;font-size:22px}
  header .muted{color:var(--muted);font-size:13px}
  #site-nav{background:#121a44;border-bottom:1px solid var(--line)}
  .wrap{max-width:1500px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1200px){ .cols-2{grid-template-columns:1.55fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row.spaced{justify-content:space-between}
  .right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .tiny{font-size:12px}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border-style:dashed}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .btn.warn{background:#3a2a19;border-color:#9d7a33}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;font:inherit;color:#e8edff}
  input::placeholder{color:#aeb8da99}
  .search{min-width:260px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:9px;border-bottom:1px solid var(--grid);vertical-align:top;text-align:left}
  th{font-size:12px;color:#aeb8da;position:sticky;top:0;background:#151d46;z-index:1}
  tbody tr:hover{background:#0d153033}
  .small{font-size:12px;color:#aeb8da}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{-webkit-user-select:none;user-select:none;border:1px solid #3a4ca3;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;background:#0d1530}
  .chip.active{background:#233261}
  .sep{height:1px;background:#243059;margin:10px 0}
  .okline{padding:8px;border-radius:10px;background:#0f2a22;border:1px solid #155a41;color:#b4ffdd}
  .warnline{padding:8px;border-radius:10px;background:#3a2a19;border:1px dashed #9d7a33;color:#ffdda1}
  .hide{display:none}
  .right-align{text-align:right}
  .summary-value{font-weight:800;font-size:18px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .kpi .box{background:#0d1530;border:1px solid #28356c;border-radius:12px;padding:10px}
  .kpi .val{font-weight:800;font-size:18px}
  .panel{background:linear-gradient(180deg,#0e1740,#101d4a);border:1px solid #1c2750;border-radius:12px;padding:12px}
  .doc{background:#0f1636;border:1px solid #2a3a75;border-radius:12px;padding:14px}

  /* utility classes moved from inline styles */
  .ml-auto{margin-left:auto}
  .mt-8{margin-top:8px}
  .mt-6{margin-top:6px}
  .min-w-380{min-width:380px}
  .min-w-240{min-width:240px}
  .min-w-220{min-width:220px}
  .min-w-160{min-width:160px}
  .min-w-280{min-width:280px}
  .w-100{width:100px}
  .w-120{width:120px}
  .w-80{width:80px}
  .w-140{width:140px}
  .card-scroll{overflow:auto;max-height:70vh}
  .flex-grow{flex:1 1 auto}
  .no-margin{margin:0}

  @media print{
    header,#site-nav,.no-print{display:none!important}
    body{background:#fff;color:#000}
    .wrap{max-width:none}
    .card,.doc,.panel{background:#fff;border:1px solid #000}
    th{background:#eee;color:#000}
  }
</style>
<!-- XLSX (eksport koszyka) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<!-- (Opcjonalnie) globalna nawigacja z nav.html -->
<div id="site-nav"></div>

<header class="row spaced">
  <div>
    <h1>Komponenty • Pompy ciepła</h1>
    <div class="muted tiny">Katalog + konfigurator + umowa (w jednej stronie). Zapis lokalny w przeglądarce.</div>
  </div>
  <div class="right no-print">
    <a class="btn ghost" href="index.html">← Pulpit</a>
    <a class="btn ghost" href="komponenty.html">Komponenty • Hub</a>
    <a class="btn ghost" href="kalkulator.html">Kalkulator</a>
  </div>
</header>

<main class="wrap grid cols-2">
  <!-- LEWA: KATALOG + FILTRY -->
  <section class="grid">
    <div class="card">
        <label class="tiny ml-auto"><input type="checkbox" id="tagsAll"> dopasuj <b>wszystkie</b> tagi</label>
        <input id="q" class="search" placeholder="Szukaj: marka, model, tag… lub moc: 10 / 8-12 / >=9">
        <select id="fBrand"><option value="">Marka (wszystkie)</option></select>
        <select id="fType"><option value="">Typ</option><option>monoblok</option><option>split</option><option>all-in-one</option></select>
        <select id="fRef"><option value="">Czynnik</option><option>R32</option><option>R290</option></select>
        <select id="fPhase"><option value="">Fazy</option><option>1F</option><option>3F</option></select>
      <div id="recQuick" class="okline hide mt-8"></div>

        <select id="sort" class="min-w-160">
          <option value="brand.asc">Marka ↑</option>
          <option value="brand.desc">Marka ↓</option>
          <option value="p.asc">Moc A7 ↑</option>
          <option value="p.desc">Moc A7 ↓</option>
          <option value="price.asc">Cena ↑</option>
          <option value="price.desc">Cena ↓</option>
        </select>
        <button id="btnClear" class="btn ghost">Wyczyść</button>
      </div>
      <div class="row">
        <div class="chips" id="chips"></div>
      </div>
      <div class="row">
        <span class="pill">Łącznie: <b id="cntAll">0</b></span>
        <span class="pill">Widocznych: <b id="cntVis">0</b></span>
      </div>
      <div id="recQuickUI" class="okline hide mt-8"></div>

    <div class="card card-scroll">
      <table>
        <thead>
          <tr>
            <th>Akcje</th>
            <th>Marka / Model</th>
            <th>Typ</th>
            <th>Moc A7 [kW]</th>
            <th>SCOP</th>
            <th>Czynnik</th>
            <th>Fazy</th>
            <th>Hałas [dB(A)]</th>
            <th>Tagi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="small mt-8 muted">Ceny urządzeń widoczne w konfiguratorze; tabela służy do wyboru modelu.</div>
    </div>
  </section>

  <!-- PRAWA: KONFIGURATOR + KOSZYK + KLIENT + UMOWA -->
  <aside class="grid">
    <!-- KONFIGURATOR -->
    <div class="card">
      <div class="row spaced">
        <b>Konfigurator zestawu</b>
        <div class="right">
          <button id="btnAddPack" class="btn ok">+ Dodaj ZESTAW</button>
          <button id="btnAddHp" class="btn warn">+ Tylko pompa</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label class="tiny">Model pompy</label>
          <select id="selHp" class="min-w-380"></select>
        </div>
        <div>
          <label class="tiny">Bufor</label>
          <select id="selBufor"></select>
        </div>
        <div>
          <label class="tiny">Typ zasobnika CWU</label>
          <select id="selCwuType">
            <option value="single" selected>pojedyncza wężownica</option>
            <option value="dual">dwuwężownicowy</option>
          </select>
        </div>
        <div>
          <label class="tiny">Zasobnik CWU</label>
          <select id="selCwu"></select>
        </div>
        <div>
          <label class="tiny">Użytkowanie CWU</label>
          <select id="selCwuUse">
            <option value="2-3">2–3 osoby (200–250 l)</option>
            <option value="4-5" selected>4–5 osób (250–300 l)</option>
            <option value="6+">6+ osób (300 l +)</option>
          </select>
        </div>
        <div>
          <label class="tiny">VAT</label>
          <select id="selVat">
            <option value="0.08" selected>8%</option>
            <option value="0.23">23%</option>
          </select>
        </div>
      </div>

      <div class="row">
          <input id="inpRads" title="Ilość grzejników" type="number" min="0" step="1" value="0" class="w-100">
          <label class="tiny">Zawór 3-drogowy</label>
          <select id="selV3d"><option value="0">w zestawie</option><option value="450">+450</option></select>
        <div>
          <label class="tiny">Grupa bezpieczeństwa</label>
          <select id="selSafety"><option value="0">w zestawie</option><option value="390">+390</option></select>
        </div>
        <div>
          <select id="selHydro"><option value="0">podstawowa</option><option value="1800">+1 obieg (1800)</option><option value="3200">dwa obiegi (3200)</option></select>
        </div>
        <div>
          <label class="tiny">Glikol (monoblok)</label>
          <select id="selGlycol"><option value="0">nie</option><option value="600">30 l (600)</option><option value="900">50 l (900)</option></select>
        </div>
        <div>
          <label class="tiny">Grzejniki (szt.)</label>
          <input id="inpRadsDuplicate" type="number" min="0" step="1" value="0" class="w-100" title="Liczba grzejników (szt.)" placeholder="Ilość">
        </div>
      </div>

      <div class="sep"></div>
      <b>Dobór mocy — wariant szybki</b>
      <div class="row">
        <div>
          <label class="tiny">Powierzchnia domu [m²]</label>
          <input id="inpArea" title="Powierzchnia domu w m²" type="number" min="0" step="1" value="0" class="w-120">
        </div>
          <input id="outHeatKw" title="Proponowana moc w kW" type="text" value="0.00" readonly class="w-120">
          <label class="tiny">Straty ciepła [W/m²]</label>
          <select id="selWperm2" title="Wybierz standard">
            <option value="35">Nowy/NZEB — 35</option>
            <option value="50" selected>Modernizacja — 50</option>
            <option value="60">Starszy — 60</option>
            <option value="70">Bardzo stary — 70</option>
            <option value="80">~80</option>
            <option value="90">~90</option>
            <option value="100">~100</option>
          </select>
          <input id="areaAdv" title="Powierzchnia (advanced) [m²]" type="number" min="20" step="1" value="120" class="w-120">
          <input id="lossWm2" title="Straty W/m²" type="number" min="10" max="129" step="1" value="70" class="w-120">
        <div>
          <label class="tiny">Proponowana moc [kW]</label>
          <input id="outHeatKwPreview" type="text" value="0.00" readonly class="w-120" title="Proponowana moc (podgląd)">
          <div class="tiny muted">m² × W/m² ÷ 1000 × 1.10</div>
        </div>
      </div>

      <div class="sep"></div>
      <b>Dobór mocy — wariant rozbudowany</b>
      <div id="lossWarn" class="warnline hide mt-8">Uwaga: &gt; 140 W/m² — niezalecane; rozważ audyt/ocieplenie.</div>

      <div class="kpi mt-8">
          <label class="tiny">Powierzchnia [m²]</label>
          <!-- advanced area input is defined above (id="areaAdv"); show a readonly preview here to avoid duplicate id -->
          <div class="flex-grow">
            <label for="areaAdvPreview" class="tiny">Powierzchnia (podgląd) [m²]</label>
            <input id="areaAdvPreview" type="number" min="20" step="1" value="120" class="w-120" disabled title="Podgląd powierzchni w m²" placeholder="m²">
          </div>
        </div>

      <div>
        <!-- single recSummary/typeHint elements (unique ids) -->
      </div>

      <div>
          <label class="tiny">Standard (skrót)</label>
        <div class="flex-grow">
          <select id="selStd">
            <option value="35">Nowy/NZEB (~35)</option>
            <option value="50" selected>Modernizacja (~50)</option>
            <option value="80">Stary (~80)</option>
          </select>
        </div>
      </div>

      <div class="row mt-6">
        <input id="provPct" title="Prowizja procentowa" type="number" min="0" step="0.1" placeholder="%" class="w-80">
        <input id="provAbs" title="Prowizja w PLN" type="number" min="0" step="1" placeholder="PLN" class="w-120">
      </div>

      <div class="row mt-8">
        <div class="box"><div class="tiny muted">Obciążenie projektowe</div><div id="heatLoad" class="val">—</div></div>
        <div class="box"><div class="tiny muted">Zapas 15%</div><div id="heatTarget" class="val">—</div></div>
        <div class="box"><div class="tiny muted">Pow. pokrywana wybraną pompą</div><div id="areaByHp" class="val">—</div></div>
      </div>

      <div id="recSummary" class="okline hide mt-8"></div>
      <div id="typeHint" class="okline hide mt-8"></div>

      <div class="sep"></div>
      <div class="row">
        <div class="muted tiny mt-6">Wybierz pompę, bufor i CWU — pokażę skład.</div>
        <div class="muted tiny">Cena zestawu (netto) wg modelu proporcjonalnego</div>
        <div id="pricePreview" class="summary-value">—</div>
      </div>

      <div class="tiny muted">Uwaga: „tylko pompa” zawiera wewnętrzny narzut instalacyjny (nie pokazujemy go klientowi).</div>
    </div>

    <!-- MUST-HAVE -->
    <div class="card">
      <b>Skład zestawu (must-have)</b>
      <div id="mustHave" class="muted tiny mt-6">Wybierz pompę, bufor i CWU — pokażę skład.</div>
    </div>

    <!-- KOSZYK -->
    <div class="card">
      <b>Koszyk</b>
      <table id="basket" class="mt-8">
        <thead><tr><th>Pozycja</th><th class="right">Ilość</th><th class="right">Cena [PLN]</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row mt-6">
        <!-- local inputs here are non-identifying to avoid duplicate ids; real client fields live in the 'Dane klienta' card below -->
        <input placeholder="Imię i nazwisko / Firma" class="min-w-240">
        <input placeholder="E-mail" class="min-w-220">
        <input placeholder="Telefon" class="min-w-160">
        <input placeholder="NIP" class="w-140">
        <input id="clAddr" placeholder="Adres montażu" class="min-w-280">
      </div>
      <div class="row mt-6">
        <button id="btnPrint" class="btn ghost">Drukuj ofertę</button>
        <button id="btnXlsx" class="btn ghost">Eksport XLSX</button>
        <button id="btnExportJson" class="btn ghost">Eksport JSON</button>
        <button id="btnImportJson" class="btn ghost">Import JSON</button>
      </div>
    </div>

    <!-- KLIENT + UMOWA -->
    <div class="card">
      <b>Dane klienta</b>
        <h3 class="no-margin">Umowa — podgląd</h3>
        <input id="clName"  placeholder="Imię i nazwisko / Firma" class="min-w-240">
        <input id="clEmail" placeholder="E-mail" class="min-w-220">
        <input id="clPhone" placeholder="Telefon" class="min-w-160">
        <input id="clNip"   placeholder="NIP" class="w-140">
      <div class="contractBody tiny mt-8"></div>
      <div class="row mt-6">
        <button id="btnSaveClient" class="btn ok">Zapisz klienta</button>
        <button id="btnToContract" class="btn">Wyślij do umowy (auto)</button>
        <button id="btnMailTo" class="btn ghost">Wyślij ofertę e-mailem</button>
      </div>
      <div class="tiny muted">Po dodaniu ZESTAWU, draft umowy zapisuje się automatycznie. Poniżej masz podgląd umowy do druku.</div>
    </div>

    <!-- PODGLĄD UMOWY (W TEJ SAMEJ STRONIE) -->
    <div class="panel doc">
      <div class="row spaced">
        <h3 class="no-margin">Umowa — podgląd</h3>
        <div class="right no-print">
          <button id="btnPrintContract" class="btn ghost">Drukuj umowę</button>
        </div>
      </div>
      <div class="contractBody tiny mt-8"></div>
    </div>
  </aside>
</main>

<script>
'use strict';

/* ===== (opcjonalnie) nawigacja z nav.html ===== */
(function () {
  const mount = document.getElementById('site-nav');
  if (!mount) return;
  fetch('nav.html', { cache: 'no-cache' })
    .then(r => r.ok ? r.text() : Promise.reject())
    .then(html => {
      const wrap = document.createElement('div'); wrap.innerHTML = html.trim();
      const nav = wrap.firstElementChild;
      if (!nav) return;
      try {
        const here = location.pathname.split('/').pop() || 'index.html';
        nav.querySelectorAll('a[href]').forEach(a => {
          if ((a.getAttribute('href') || '').split('?')[0] === here) a.style.outline = '2px solid #4cc9f0';
        });
      } catch {}
      mount.appendChild(nav);
    })
    .catch(()=>{});
})();

/* ===================== DANE / KONFIG ===================== */
const HEATPUMPS = [
  // ===== MIDEA =====
  {brand:'Midea', model:'M-Thermal Arctic 4.5 kW Monoblok MHC-V4WD2N7-E30', kind:'monoblok', phase:'1F', pA7:4.5, scop:5.0, ref:'R290', noise:55, price:10686, tags:['Arctic','R290']},
  {brand:'Midea', model:'M-Thermal PRO 6 kW Monoblok',                        kind:'monoblok', phase:'1F', pA7:6.0, scop:4.9, ref:'R32', noise:55, price:12276, tags:['PRO','R32']},
  {brand:'Midea', model:'M-Thermal Arctic 6.3 kW Monoblok MHC-V6W/D2N8-E30',  kind:'monoblok', phase:'1F', pA7:6.3, scop:5.0, ref:'R290', noise:55, price:11890, tags:['Arctic','R290']},
  {brand:'Midea', model:'M-Thermal Arctic 8.4 kW Monoblok MHC-V8W/D2N8-BE30', kind:'monoblok', phase:'1F', pA7:8.4, scop:4.9, ref:'R290', noise:55, price:13950, tags:['Arctic','R290','WiFi']},
  {brand:'Midea', model:'M-Thermal PRO 8 kW Split',                           kind:'split',    phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:54, price:14500, tags:['PRO','split']},
  {brand:'Midea', model:'M-Thermal PRO 8 kW Monoblok',                        kind:'monoblok', phase:'1F', pA7:8.0, scop:4.9, ref:'R32', noise:55, price:13290, tags:['PRO','monoblok']},
  {brand:'Midea', model:'M-Thermal 9 kW Monoblok (R32)',                      kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15000, tags:['R32']},
  {brand:'Midea', model:'M-Thermal 10 kW Monoblok MHC-V10W/D2N8-B',           kind:'monoblok', phase:'1F', pA7:10.0,scop:4.8, ref:'R32', noise:56, price:16080, tags:['WiFi']},
  {brand:'Midea', model:'M-Thermal Arctic 10 kW Monoblok MHC-V10WD2RN7-E30',  kind:'monoblok', phase:'1F', pA7:10.0,scop:4.9, ref:'R290', noise:56, price:14990, tags:['Arctic','R290']},
  {brand:'Midea', model:'M-Thermal 12 kW Monoblok (R32)',                     kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R32', noise:56, price:13170, tags:['R32']},
  {brand:'Midea', model:'M-Thermal 12 kW Monoblok 3F',                        kind:'monoblok', phase:'3F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:14873, tags:['3F']},
  {brand:'Midea', model:'M-Thermal Arctic 12 kW Monoblok MHC-V12WD2RN7-E30',  kind:'monoblok', phase:'1F', pA7:12.0,scop:4.8, ref:'R290', noise:56, price:15438, tags:['Arctic','R290']},
  {brand:'Midea', model:'M-Thermal Arctic 14 kW Monoblok MHC-V14WD2RN7-E30',  kind:'monoblok', phase:'3F', pA7:14.0,scop:4.7, ref:'R290', noise:56, price:16260, tags:['Arctic','R290','3F']},
  {brand:'Midea', model:'M-Thermal PRO 10 kW Split',                          kind:'split',    phase:'1F', pA7:10.0,scop:4.9, ref:'R32', noise:54, price:16980, tags:['PRO','split']},
  {brand:'Midea', model:'M-Thermal PRO 12 kW Split 3F',                       kind:'split',    phase:'3F', pA7:12.0,scop:4.8, ref:'R32', noise:55, price:18950, tags:['PRO','split','3F']},
  {brand:'Midea', model:'M-Thermal PRO 14 kW Split 3F',                       kind:'split',    phase:'3F', pA7:14.0,scop:4.7, ref:'R32', noise:56, price:21990, tags:['PRO','split','3F']},
  {brand:'Midea', model:'M-Thermal 16 kW Monoblok (R32) M-Thermal-16W/D2N8-BE30', kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:57, price:20516, tags:['3F']},
  {brand:'Midea', model:'M-Thermal PRO 16 kW Monoblok 3F',                    kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:57, price:23490, tags:['PRO','3F']},
  {brand:'Midea', model:'M-Thermal 26 kW Monoblok MHC-V26W/D2RN8-B',          kind:'monoblok', phase:'3F', pA7:26.0,scop:4.3, ref:'R32', noise:60, price:28900, tags:['wysoka moc','3F']},
  {brand:'Midea', model:'M-Thermal All-in-One 8 kW (R32)',                    kind:'all-in-one', phase:'1F', pA7:8.0, scop:4.8, ref:'R32', noise:53, price:18490, tags:['AIO']},
  {brand:'Midea', model:'M-Thermal All-in-One 12 kW 3F (R32)',                kind:'all-in-one', phase:'3F', pA7:12.0,scop:4.7, ref:'R32', noise:54, price:22990, tags:['AIO','3F']},
  {brand:'Midea', model:'M-Thermal PRO 14 kW Monoblok (premium)',             kind:'monoblok', phase:'3F', pA7:14.0,scop:4.8, ref:'R32', noise:56, price:36350, tags:['premium']},

  // ===== PANASONIC =====
  {brand:'Panasonic', model:'Aquarea Monoblok 5 kW WH-MDC05J3E5',            kind:'monoblok', phase:'1F', pA7:5.0, scop:5.0, ref:'R32', noise:53, price:20745, tags:['J-gen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 7 kW WH-MDC07J3E5',            kind:'monoblok', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:54, price:11370, tags:['J-gen']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH-MXC09J3E5 (T-CAP)',    kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:15300, tags:['T-CAP']},
  {brand:'Panasonic', model:'Aquarea Monoblok 9 kW WH-MDC09H3E5',            kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:14459, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Monoblok 12 kW WH-MDC12H6E5',           kind:'monoblok', phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:13090, tags:['High Perf.']},
  {brand:'Panasonic', model:'Aquarea Split 7 kW KIT-ADC07K3E5 (All-in-One)',  kind:'all-in-one', phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:53, price:19041, tags:['AIO']},
  {brand:'Panasonic', model:'Aquarea Split 9 kW KIT-WC09K3E5',               kind:'split',    phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:14930, tags:['split']},
  {brand:'Panasonic', model:'Aquarea All-in-One 9 kW 3F',                    kind:'all-in-one', phase:'3F', pA7:9.0, scop:4.8, ref:'R32', noise:54, price:22764, tags:['AIO','3F']},
  {brand:'Panasonic', model:'Aquarea Split 12 kW 1F',                        kind:'split',    phase:'1F', pA7:12.0,scop:4.7, ref:'R32', noise:56, price:18600, tags:['split']},
  {brand:'Panasonic', model:'Aquarea T-CAP 16 kW 3F Quiet',                  kind:'split',    phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:56, price:28455, tags:['T-CAP','3F']},
  {brand:'Panasonic', model:'Aquarea T-CAP 9 kW Monoblok WH-MXC09H3E5',      kind:'monoblok', phase:'1F', pA7:9.0, scop:4.8, ref:'R32', noise:55, price:21990, tags:['T-CAP','monoblok']},
  {brand:'Panasonic', model:'Aquarea K-Generation 7 kW All-in-One 1F',       kind:'all-in-one',phase:'1F', pA7:7.0, scop:4.9, ref:'R32', noise:52, price:20990, tags:['K-gen','AIO']},
  {brand:'Panasonic', model:'Aquarea K-Generation 12 kW All-in-One 3F',      kind:'all-in-one',phase:'3F', pA7:12.0,scop:4.8, ref:'R32', noise:53, price:28990, tags:['K-gen','AIO','3F']},
  {brand:'Panasonic', model:'Aquarea Monoblok 16 kW WH-MXC16J9E8 3F',        kind:'monoblok', phase:'3F', pA7:16.0,scop:4.6, ref:'R32', noise:58, price:27990, tags:['monoblok','3F']},

  // ===== GALMET (orientacyjnie) =====
  {brand:'Galmet', model:'PRIMA 6GT Monoblok',     kind:'monoblok', phase:'1F', pA7:6.0,  scop:4.8, ref:'R32', noise:55, price:22000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 8GT Monoblok',     kind:'monoblok', phase:'1F', pA7:8.0,  scop:4.8, ref:'R32', noise:55, price:24000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 10GT Monoblok',    kind:'monoblok', phase:'1F', pA7:10.0, scop:4.7, ref:'R32', noise:56, price:26000, tags:['PRIMA','GT']},
  {brand:'Galmet', model:'PRIMA 12GT Monoblok 3F', kind:'monoblok', phase:'3F', pA7:12.0, scop:4.7, ref:'R32', noise:56, price:32000, tags:['PRIMA','GT','3F']},
  {brand:'Galmet', model:'PRIMA 16GT Monoblok 3F', kind:'monoblok', phase:'3F', pA7:16.0, scop:4.6, ref:'R32', noise:57, price:36000, tags:['PRIMA','GT','3F']},
  {brand:'Galmet', model:'PRIMA S 6GT Split',      kind:'split',    phase:'1F', pA7:6.0,  scop:4.8, ref:'R32', noise:54, price:22000, tags:['PRIMA','GT','SPLIT']},
  {brand:'Galmet', model:'PRIMA S 8GT Split',      kind:'split',    phase:'1F', pA7:8.0,  scop:4.8, ref:'R32', noise:54, price:24000, tags:['PRIMA','GT','SPLIT']},
  {brand:'Galmet', model:'PRIMA S 10GT Split',     kind:'split',    phase:'1F', pA7:10.0, scop:4.7, ref:'R32', noise:55, price:26000, tags:['PRIMA','GT','SPLIT']},
  {brand:'Galmet', model:'PRIMA S 12GT Split 3F',  kind:'split',    phase:'3F', pA7:12.0, scop:4.7, ref:'R32', noise:55, price:32000, tags:['PRIMA','GT','SPLIT','3F']},
  {brand:'Galmet', model:'PRIMA S 16GT Split 3F',  kind:'split',    phase:'3F', pA7:16.0, scop:4.6, ref:'R32', noise:56, price:36000, tags:['PRIMA','GT','SPLIT','3F']},
];

const QUICK_TAGS = [
  'R290','R32','monoblok','split','all-in-one','1F','3F','WiFi','premium',
  'T-CAP','High Perf.','PRIMA','AIO','K-gen','wysoka moc'
];

/* Bufory – rozszerzone */
const BUFFERS = {
  'B-EM-50' : {vol:50,  type:'emalia', label:'Bufor 50 l — emalia',          price:  950},
  'B-EM-80' : {vol:80,  type:'emalia', label:'Bufor 80 l — emalia',          price: 1200},
  'B-EM-100': {vol:100, type:'emalia', label:'Bufor 100 l — emalia',         price: 1450},
  'B-EM-150': {vol:150, type:'emalia', label:'Bufor 150 l — emalia',         price: 1850},
  'B-EM-200': {vol:200, type:'emalia', label:'Bufor 200 l — emalia',         price: 2250},
  'B-EM-300': {vol:300, type:'emalia', label:'Bufor 300 l — emalia',         price: 3050},

  'B-INOX-80' : {vol:80,  type:'inox', label:'Bufor 80 l — INOX',             price: 1650},
  'B-INOX-100': {vol:100, type:'inox', label:'Bufor 100 l — INOX',            price: 1990},
  'B-INOX-200': {vol:200, type:'inox', label:'Bufor 200 l — INOX',            price: 2850},
  'B-INOX-300': {vol:300, type:'inox', label:'Bufor 300 l — INOX',            price: 3790},

  'B-WEZ-100': {vol:100, type:'wez',  coil:1.0, label:'Bufor 100 l z wężownicą (1.0 m²)', price: 2150},
  'B-WEZ-200': {vol:200, type:'wez',  coil:1.5, label:'Bufor 200 l z wężownicą (1.5 m²)', price: 2890},
  'B-WEZ-300': {vol:300, type:'wez',  coil:2.2, label:'Bufor 300 l z wężownicą (2.2 m²)', price: 3690},

  'B-COMBO-200': {vol:200, type:'combo', cwu:100, label:'Combo 200 l (bufor+CWU 100 l)', price: 4490},
  'B-COMBO-300': {vol:300, type:'combo', cwu:120, label:'Combo 300 l (bufor+CWU 120 l)', price: 5290},
};

/* CWU – SINGLE */
const TANKS_SINGLE = {
  'S-150-1.0': {vol:150, coil:1.0, label:'150 l • 1.0 m²', price: 2450},
  'S-200-1.2': {vol:200, coil:1.2, label:'200 l • 1.2 m²', price: 2920},
  'S-250-1.6': {vol:250, coil:1.6, label:'250 l • 1.6 m²', price: 3390},
  'S-300-2.0': {vol:300, coil:2.0, label:'300 l • 2.0 m²', price: 3850},
};
/* CWU – DUAL */
const TANKS_DUAL = {
  'D-200-2x1.0': {vol:200, coil:'2×1.0', label:'200 l • 2×1.0 m²', price: 3490},
  'D-250-2x1.2': {vol:250, coil:'2×1.2', label:'250 l • 2×1.2 m²', price: 3990},
  'D-300-2x1.5': {vol:300, coil:'2×1.5', label:'300 l • 2×1.5 m²', price: 4490},
};

const RAD_PRICE = 750;
const ONLY_HP_SURCHARGE = 4000;
const PACK_BASE_TARGETNET = 38000;

/* ===================== STAN ===================== */
const state = {
  vat: 0.08, v3d:0, safety:0, hydro:0, glycol:0, rads:0,
  selectedHp: null, selectedBuf: 'B-EM-100', selectedTankType: 'single', selectedTank: 'S-200-1.2',
  provPct:0, provAbs:0,
  chipsActive: new Set(), tagsAll:false,
  basket: [],
  client: { name:'', email:'', phone:'', nip:'', addr:'' }
};

const INTmoney = new Intl.NumberFormat('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
const INTint   = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmt = n => INTmoney.format(+n||0);
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ===================== HELPERY ===================== */
function sortedHp(){ return HEATPUMPS.slice().sort((a,b)=> a.brand.localeCompare(b.brand,'pl') || a.pA7-b.pA7); }
function cheapest(obj){
  const vals = Object.values(obj).map(v => typeof v === 'number' ? v : (v?.price||Infinity));
  return Math.min(...vals);
}
function cheapestPumpPrice(){ return Math.min(...HEATPUMPS.map(h=>+h.price||0)); }
function computeBaseOffset(){ return PACK_BASE_TARGETNET - (cheapestPumpPrice() + cheapest(BUFFERS) + cheapest(TANKS_SINGLE)); }
let BASE_OFFSET = computeBaseOffset();
function soloPrice(hp){ return (+hp.price||0) + ONLY_HP_SURCHARGE; }
function activeHp(){ return state.selectedHp; }

/* ===================== FILTRY / LISTA ===================== */
function makeChips(){
  const box = $('#chips'); box.innerHTML = '';
  QUICK_TAGS.forEach(t=>{
    const el = document.createElement('div'); el.className='chip'; el.textContent=t; el.dataset.tag=t;
    if (state.chipsActive.has(t)) el.classList.add('active');
    el.addEventListener('click', ()=>{
      if (state.chipsActive.has(t)) state.chipsActive.delete(t); else state.chipsActive.add(t);
      el.classList.toggle('active');
      renderTable(); persist();
    });
    box.appendChild(el);
  });
}
function fillFilters(){
  const brands = [...new Set(HEATPUMPS.map(x=>x.brand))].sort((a,b)=>a.localeCompare(b,'pl',{sensitivity:'base'}));
  $('#fBrand').innerHTML = '<option value="">Marka (wszystkie)</option>' + brands.map(b=>`<option>${b}</option>`).join('');
}
function parsePowerQuery(q){
  if(!q) return null; q = String(q).trim();
  const cmp = q.match(/^([<>]=?)\s*([0-9]+(?:\.[0-9]+)?)/i);
  if (cmp){ const op = cmp[1], val = parseFloat(cmp[2]);
    if(op==='>=') return p=>p>=val; if(op==='<=') return p=>p<=val; if(op==='>') return p=>p>val; if(op==='<') return p=>p<val; }
  const range = q.match(/^([0-9]+(?:\.[0-9]+)?)\s*-\s*([0-9]+(?:\.[0-9]+)?)/);
  if (range){ const a=parseFloat(range[1]), b=parseFloat(range[2]); const lo=Math.min(a,b), hi=Math.max(a,b); return p=>p>=lo && p<=hi; }
  const eq = q.match(/^([0-9]+(?:\.[0-9]+)?)/);
  if (eq){ const v=parseFloat(eq[1]), tol=0.6; return p=>Math.abs(p - v) <= tol; }
  return null;
}
function applyFiltersSort(rows){
  const q = ($('#q')?.value||'').toLowerCase().trim();
  const brand=$('#fBrand')?.value, kind=$('#fType')?.value, ref=$('#fRef')?.value, ph=$('#fPhase')?.value;
  const powerPredicate = parsePowerQuery(q);

  rows = rows.filter(p=>{
    if (brand && p.brand!==brand) return false;
    if (kind && p.kind!==kind) return false;
    if (ref && p.ref!==ref) return false;
    if (ph && p.phase!==ph) return false;

    if (state.chipsActive.size){
      const tags = new Set([p.kind, p.phase, p.ref, ...(p.tags||[])].filter(Boolean));
      const hits = [...state.chipsActive].map(t=>tags.has(t));
      if (state.tagsAll ? hits.some(x=>!x) : !hits.some(Boolean)) return false;
    }
    if (q){
      const textHit = [p.brand,p.model,p.ref,p.kind,p.phase,(p.tags||[]).join(' ')].some(v=>(v||'').toLowerCase().includes(q));
      if (powerPredicate) return textHit || powerPredicate(p.pA7);
      return textHit;
    }
    return true;
  });

  switch($('#sort')?.value){
    case 'brand.asc':  rows.sort((a,b)=> (a.brand.localeCompare(b.brand,'pl')) || a.pA7-b.pA7); break;
    case 'brand.desc': rows.sort((a,b)=> (b.brand.localeCompare(a.brand,'pl')) || a.pA7-b.pA7); break;
    case 'p.asc':      rows.sort((a,b)=>a.pA7-b.pA7); break;
    case 'p.desc':     rows.sort((a,b)=>b.pA7-a.pA7); break;
    case 'price.asc':  rows.sort((a,b)=>a.price-b.price); break;
    case 'price.desc': rows.sort((a,b)=>b.price-a.price); break;
  }
  return rows;
}
function optionsForTanks(){
  const src = state.selectedTankType === 'dual' ? TANKS_DUAL : TANKS_SINGLE;
  return Object.keys(src);
}

function fillSelects(){
  // POMPY
  const arr = sortedHp();
  const s = $('#selHp');
  s.innerHTML = arr.map((x,i)=>`<option value="${i}">${x.brand} ${x.model} • ${x.kind} • A7 ${x.pA7} kW</option>`).join('');
  state.selectedHp = state.selectedHp || arr[0] || null;
  // ensure select reflects selectedHp if present
  const selIndex = arr.indexOf(state.selectedHp);
  if (selIndex >= 0) s.value = String(selIndex);

  // BUFOR
  const b = $('#selBufor');
  b.innerHTML = Object.entries(BUFFERS).map(([code,obj])=>`<option value="${code}">${obj.label} • ${INTint.format(obj.price)} PLN</option>`).join('');
  if (!BUFFERS[state.selectedBuf]) state.selectedBuf = 'B-EM-100';
  b.value = state.selectedBuf;

  // CWU
  const t = $('#selCwu');
  const src = state.selectedTankType === 'dual' ? TANKS_DUAL : TANKS_SINGLE;
  t.innerHTML = Object.entries(src).map(([code,obj])=>`<option value="${code}">${obj.label} • ${INTint.format(obj.price)} PLN</option>`).join('');
  if (!src[state.selectedTank]) state.selectedTank = Object.keys(src)[0];
  t.value = state.selectedTank;

  applyHpToUi();
}

function renderTable(){
  const rows = applyFiltersSort(HEATPUMPS.slice());
  $('#cntAll').textContent = HEATPUMPS.length;
  $('#cntVis').textContent = rows.length;
  const tb = $('#tbody'); tb.innerHTML = '';

  // render rows
  rows.forEach(p => {
    const tr = document.createElement('tr');
    const tags = (p.tags || []).join(', ');
    tr.innerHTML = `
      <td><button class="btn tiny" data-pick="${p.brand}|${p.model}">Wybierz</button></td>
      <td>${p.brand} <b>${p.model}</b></td>
      <td>${p.kind || ''}</td>
      <td>${p.pA7 != null ? p.pA7 : ''}</td>
      <td>${p.scop != null ? p.scop : ''}</td>
      <td>${p.ref || ''}</td>
      <td>${p.phase || ''}</td>
      <td>${p.noise != null ? p.noise : ''}</td>
      <td class="small">${tags}</td>
    `;
    tb.appendChild(tr);
  });
}
function renderPreview(){
  const hp=activeHp(); if(!hp){ $('#pricePreview').textContent='—'; return; }
  const bufObj = BUFFERS[state.selectedBuf];
  const bufCost = bufObj ? +bufObj.price : 0;

  const tankSrc = state.selectedTankType==='dual' ? TANKS_DUAL : TANKS_SINGLE;
  const tankObj = tankSrc[state.selectedTank];
  const tankCost = (hp.kind==='all-in-one' || bufObj?.type==='combo') ? 0 : (tankObj ? +tankObj.price : 0);

  const extras=(+state.v3d||0)+(+state.safety||0)+(+state.hydro||0)+(+state.glycol||0)+((+state.rads||0)*RAD_PRICE);
  const sum=pricePack(hp.price,bufCost,tankCost,extras);
  $('#pricePreview').textContent = `${fmt(sum)} PLN netto (brutto: ${fmt(sum*(1+state.vat))} PLN)`;

  const hint=$('#typeHint'); hint.classList.remove('hide');
  if(hp.kind==='monoblok') hint.textContent='Monoblok: przy ryzyku zamarzania przewidź glikol na odcinku zewnętrznym.';
  else if(hp.kind==='all-in-one') hint.textContent='All-in-One: zasobnik CWU wbudowany — zewnętrzny zwykle zbędny.';
  else hint.textContent='Split: glikol nie dotyczy (obieg chłodniczy).';

  const stdW = +($('#selStd')?.value||50);
  const margin=1.15;
  const areaCover = Math.floor((hp.pA7*1000)/(stdW*margin));
  $('#areaByHp').textContent = areaCover>0 ? (areaCover + ' m²') : '—';
}
function renderMustHave(){
  const hp=activeHp(); const box=$('#mustHave');
  const bufObj = BUFFERS[state.selectedBuf];
  const tankSrc = state.selectedTankType==='dual' ? TANKS_DUAL : TANKS_SINGLE;
  const tankObj = tankSrc[state.selectedTank];

  if(!hp || !bufObj || (!tankObj && hp.kind!=='all-in-one' && bufObj?.type!=='combo')){
    box.textContent='Wybierz pompę, bufor i CWU — pokażę skład.'; return;
  }

  const items=[];
  items.push(`Pompa ciepła — ${hp.brand} ${hp.model} (${hp.kind}, ${hp.phase||'1F'})`);
  items.push(`Bufor — ${bufObj.label}`);
  if(hp.kind==='all-in-one') items.push('Zasobnik CWU — AIO (wbudowany)');
  else if(bufObj?.type==='combo') items.push(`Zasobnik CWU — w pakiecie combo (${bufObj.cwu} l)`);
  else items.push(`Zasobnik CWU — ${tankObj?.label||'-'}`);
  items.push('Armatura: zawór 3D, grupa bezpieczeństwa, zawory serwisowe');
  if((+state.glycol)>0 && hp.kind==='monoblok') items.push('Glikol do obiegu zewnętrznego (monoblok)');
  items.push('Rozdzielacze / hydraulika wg wyboru');
  const r=+state.rads||0; if(r>0) items.push(`Montaż grzejników: ${r} × ${INTint.format(RAD_PRICE)} PLN`);
  items.push('Montaż, uruchomienie, konfiguracja, szkolenie użytkownika');
  box.innerHTML = '<ul class="small" style="margin:6px 0 0 18px">' + items.map(t=>`<li>${t}</li>`).join('') + '</ul>';
}
function applyHpToUi(){ renderPreview(); renderMustHave(); renderBasket(); persist(); }

function quickSuggest(){
  const area = +($('#inpArea')?.value||0);
  const wpm2 = +($('#selWperm2')?.value||0);
  const kw = (area>0 && wpm2>0) ? (area*wpm2)/1000 * 1.10 : 0;
  $('#outHeatKw').value = kw.toFixed(2);

  const v = kw || 0;
  const box = $('#recQuick');
  const box2 = $('#recQuickUI');
  if (!v){ box.classList.add('hide'); box.textContent=''; box2.classList.add('hide'); box2.textContent=''; return; }

  const candidates = HEATPUMPS
    .slice().sort((a,b)=> Math.abs(a.pA7 - v) - Math.abs(b.pA7 - v))
    .filter(h => h.pA7 >= v*0.9).slice(0,3);

  if (!candidates.length){
    box.innerHTML = `<span class="tiny">Brak oczywistego dopasowania dla ~${v.toFixed(2)} kW.</span>`;
    box.classList.remove('hide');
    box2.classList.add('hide');
    return;
  }
  box.innerHTML = 'Propozycje (szybkie): ' + candidates.map(h=>`${h.brand} <b>${h.model}</b> <span class="tiny">(A7 ${h.pA7} kW, ${h.kind}, ${h.phase||'1F'})</span>`).join(' • ');
  box.classList.remove('hide');

  box2.innerHTML = candidates.map(h=>
    `<div class="row"><div style="flex:1 1 auto">${h.brand} <b>${h.model}</b> <span class="tiny">(A7 ${h.pA7} kW)</span></div><button class="btn tiny" data-pick="${h.brand}|${h.model}">Wybierz</button></div>`
  ).join('');
  box2.classList.remove('hide');
}
function recomputeAdvanced(){
  const area = +($('#areaAdv')?.value||0);
  const wpm2 = +($('#lossWm2')?.value||0);
  $('#lossWarn').classList.toggle('hide', !(wpm2>140));
  if(area<=0 || wpm2<=0){
    $('#heatLoad').textContent='—'; $('#heatTarget').textContent='—'; $('#recSummary').classList.add('hide'); return;
  }
  const req_kw = (area*wpm2)/1000;
  const target = req_kw*1.15;
  $('#heatLoad').textContent = req_kw.toFixed(2) + ' kW';
  $('#heatTarget').textContent = target.toFixed(2) + ' kW';

  const candidates = HEATPUMPS.filter(h=>h.pA7>=target*0.9)
    .slice().sort((a,b)=>Math.abs(a.pA7-target)-Math.abs(b.pA7-target)).slice(0,3);
  const parts = [
    `Szac. obciążenie: <b>${req_kw.toFixed(2)} kW</b>`,
    `Z zapasem 15%: <b>${target.toFixed(2)} kW</b>`
  ];
  parts.push(candidates.length
    ? ('Propozycje: ' + candidates.map(h=>`${h.brand} ${h.model} <span class="tiny">(A7 ${h.pA7} kW)</span>`).join(' • '))
    : '<span class="tiny" style="color:#ff9">Brak oczywistego dopasowania — rozważ wyższą moc lub inny model.</span>');
  const box=$('#recSummary'); box.innerHTML = parts.join('<br>'); box.classList.remove('hide');
}

/* ===================== KOSZYK ===================== */
function addToBasket(name, price, qty=1){
  const i=state.basket.findIndex(x=>x.name===name && Math.abs(x.price-price)<0.01);
  if(i>=0) state.basket[i].qty += qty;
  else state.basket.push({name, price, qty});
  renderBasket(); persist(); updateContractPreview();
}
function renderBasket(){
  const tb=$('#basket tbody'); tb.innerHTML='';
  let sumNet=0;
  state.basket.forEach((it,i)=>{
    sumNet += it.price*it.qty;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td class="right"><input type="number" min="1" value="${it.qty}" data-qty="${i}" style="width:80px"></td>
      <td class="right">${fmt(it.price)} PLN</td>
      <td class="right"><button class="btn bad tiny" data-del="${i}">Usuń</button></td>`;
    tb.appendChild(tr);
  });
  const prov = sumNet*(+state.provPct||0)/100 + (+state.provAbs||0);
  $('#sumNet').textContent = fmt(sumNet) + ' PLN';
  $('#sumProv').textContent = fmt(prov) + ' PLN';
  $('#sumGross').textContent = fmt( (sumNet+prov) * (1+state.vat) ) + ' PLN';
}

/* ===================== KLIENT / KONTRAKT ===================== */
function buildOfferSummary(){
  const sum = state.basket.reduce((a,b)=>a+b.price*b.qty,0);
  const prov = sum*(+state.provPct||0)/100 + (+state.provAbs||0);
  const gross = (sum+prov)*(1+state.vat);
  const lines = state.basket.map(it=>'• ' + it.name + ' × ' + it.qty + ' | ' + fmt(it.price) + ' PLN');
  return {sum, prov, gross, lines};
}
function collectClient(){
  state.client = {
    name: $('#clName')?.value.trim() || '',
    email: $('#clEmail')?.value.trim() || '',
    phone: $('#clPhone')?.value.trim() || '',
    nip: $('#clNip')?.value.trim() || '',
    addr: $('#clAddr')?.value.trim() || '',
  };
}
function pushContractDraft(){
  collectClient();
  const hp = activeHp();
  const {sum, prov, gross} = buildOfferSummary();
  const payload = {
    createdAt: new Date().toISOString(),
    client: state.client,
    selection: {
      pump: hp ? {brand:hp.brand, model:hp.model, kind:hp.kind, phase:hp.phase, pA7:hp.pA7, ref:hp.ref} : null,
      buffer: state.selectedBuf,
      tank: { type: state.selectedTankType, vol: state.selectedTank },
      extras: { v3d: state.v3d, safety: state.safety, hydro: state.hydro, glycol: state.glycol, rads: state.rads },
      vat: state.vat
    },
    sizing: {
      quickKw: $('#outHeatKw')?.value || '',
      std: $('#selStd')?.value || '',
      areaAdv: $('#areaAdv')?.value || '',
      lossWm2: $('#lossWm2')?.value || '',
      heatLoad: $('#heatLoad')?.textContent || '',
      heatTarget: $('#heatTarget')?.textContent || '',
      areaByHp: $('#areaByHp')?.textContent || ''
    },
    basket: state.basket,
    totals: { sum, prov, gross }
  };
  try{
    sessionStorage.setItem('contract_draft', JSON.stringify(payload));
  }catch(e){}
  return payload;
}
function updateContractPreview(){
  const p = pushContractDraft();
  const els = document.querySelectorAll('.contractBody');
  const itemsHtml = (p.basket||[]).map(i =>
    `<tr><td>${i.name}</td><td class="right">${i.qty}</td><td class="right">${fmt(i.price)} PLN</td><td class="right">${fmt(i.price*i.qty)} PLN</td></tr>`
  ).join('') || '<tr><td colspan="4" class="tiny muted">Koszyk pusty.</td></tr>';
  const html = `
    <div class="row"><div><b>Klient:</b> ${p.client?.name||'—'} ${p.client?.nip ? ('• NIP: ' + p.client.nip) : ''}<br><b>Adres montażu:</b> ${p.client?.addr||'—'}<br><b>Kontakt:</b> ${p.client?.email||''} ${p.client?.phone ? ('• ' + p.client.phone) : ''}</div><div class="right"><b>Data:</b> ${(new Date(p.createdAt)).toLocaleString('pl-PL')}</div></div>
    <div class="sep"></div>
    <table><thead><tr><th>Pozycja</th><th class="right">Ilość</th><th class="right">Cena NETTO</th><th class="right">Wartość NETTO</th></tr></thead><tbody>${itemsHtml}</tbody></table>
    <div class="row" style="margin-top:8px">
      <div class="pill">Suma netto: <b>${fmt(p.totals.sum)} PLN</b></div>
      <div class="pill">Prowizja: <b>${fmt(p.totals.prov)} PLN</b></div>
      <div class="pill">VAT: <b>${Math.round((p.selection?.vat||0)*100)}%</b></div>
      <div class="pill">Razem brutto: <b>${fmt(p.totals.gross)} PLN</b></div>
    </div>
    <div class="tiny muted" style="margin-top:6px">Dobór mocy: szybki ~${p.sizing.quickKw||'-'} kW; obciążenie: ${p.sizing.heatLoad||'-'} (zapas: ${p.sizing.heatTarget||'-'}); pokrywana pow.: ${p.sizing.areaByHp||'-'}.</div>
  `;
  els.forEach(el => { el.innerHTML = html; });
}

/* ===================== PERSIST ===================== */
const SAVE_KEY='kp_state_v3';
function persist(){
  try{
    const st = {...state, chipsActive: Array.from(state.chipsActive)};
    localStorage.setItem(SAVE_KEY, JSON.stringify(st));
  }catch(e){}
}
function restore(){
  try{
    const raw = localStorage.getItem(SAVE_KEY); if(!raw) return;
    const d = JSON.parse(raw); if (!d) return;
    state.vat = d.vat ?? state.vat;
    state.v3d = d.v3d||0; state.safety=d.safety||0; state.hydro=d.hydro||0; state.glycol=d.glycol||0; state.rads=d.rads||0;
    state.selectedBuf = d.selectedBuf||state.selectedBuf;
    state.selectedTankType = d.selectedTankType||state.selectedTankType;
    state.selectedTank = d.selectedTank||state.selectedTank;
    state.provPct=d.provPct||0; state.provAbs=d.provAbs||0;
    state.tagsAll=!!d.tagsAll;
    state.basket = Array.isArray(d.basket) ? d.basket : [];
    state.client = d.client || state.client;
    state.chipsActive = new Set(Array.isArray(d.chipsActive)? d.chipsActive : []);
  }catch(e){}
}

/* ===================== ZDARZENIA UI ===================== */
// Filtry
['q','fBrand','fType','fRef','fPhase','sort'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{ renderTable(); });
  document.getElementById(id).addEventListener('change', ()=>{ renderTable(); });
});
$('#tagsAll').addEventListener('change', e=>{ state.tagsAll = e.target.checked; renderTable(); persist(); });
$('#btnClear').addEventListener('click', ()=>{
  ['q','fBrand','fType','fRef','fPhase'].forEach(id=>document.getElementById(id).value='');
  state.chipsActive.clear(); $('#chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  $('#sort').value='brand.asc'; $('#tagsAll').checked=false; state.tagsAll=false;
  renderTable(); persist();
});
// wybór z tabeli
document.addEventListener('click', e=>{
  const pick = e.target.getAttribute && e.target.getAttribute('data-pick');
  if (pick){
    const [brand,model]=pick.split('|');
    const arr=sortedHp(); const idx=arr.findIndex(x=>x.brand===brand && x.model===model);
    if(idx>=0){ $('#selHp').value=String(idx); state.selectedHp=arr[idx]; applyHpToUi(); window.scrollTo({top:0,behavior:'smooth'}); }
  }
});

// Selecty konfiguratora
$('#selHp').addEventListener('change', ()=>{ const arr=sortedHp(); state.selectedHp = arr[+$('#selHp').value||0]; applyHpToUi(); });
$('#selCwuType').addEventListener('change', e=>{
  state.selectedTankType = e.target.value;
  const t=$('#selCwu'); const src = state.selectedTankType==='dual'? TANKS_DUAL : TANKS_SINGLE;
  t.innerHTML = Object.entries(src).map(([code,obj])=>`<option value="${code}">${obj.label} • ${INTint.format(obj.price)} PLN</option>`).join('');
  if (!src[state.selectedTank]) state.selectedTank = Object.keys(src)[0];
  t.value = state.selectedTank;
  renderPreview(); renderMustHave(); persist();
});
$('#selCwu').addEventListener('change', e=>{ state.selectedTank=e.target.value; renderPreview(); renderMustHave(); persist(); });
$('#selVat').addEventListener('change', e=>{ state.vat=Number(e.target.value)||0.08; renderPreview(); renderBasket(); updateContractPreview(); persist(); });
['selV3d','selSafety','selHydro','selGlycol'].forEach(id=>{
  document.getElementById(id).addEventListener('change', (e)=>{
    state[e.target.id.replace('sel','').toLowerCase()] = Number(e.target.value)||0;
    renderPreview(); renderMustHave(); persist();
  });
});
$('#inpRads').addEventListener('input', e=>{ state.rads=Math.max(0,Number(e.target.value)||0); renderPreview(); renderMustHave(); persist(); });

// Dobór mocy
$('#inpArea').addEventListener('input', quickSuggest);
$('#selWperm2').addEventListener('change', quickSuggest);
['selStd','areaAdv','lossWm2','selCwuUse'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{ recomputeAdvanced(); renderPreview(); });
  document.getElementById(id).addEventListener('change', ()=>{ recomputeAdvanced(); renderPreview(); });
});

$('#btnAddPack').addEventListener('click', ()=>{
  const hp = activeHp(); if(!hp){ alert('Wybierz pompę.'); return; }

  const bufObj = BUFFERS[state.selectedBuf];
  const bufCost = bufObj ? +bufObj.price : 0;

  const src = state.selectedTankType==='dual' ? TANKS_DUAL : TANKS_SINGLE;
  const tankObj = src[state.selectedTank];
  const tankCost = (hp.kind==='all-in-one' || bufObj?.type==='combo') ? 0 : (tankObj ? +tankObj.price : 0);

  const extras = (+state.v3d||0) + (+state.safety||0) + (+state.hydro||0) + (+state.glycol||0) + ((+state.rads||0)*RAD_PRICE);
  const price = pricePack(hp.price, bufCost, tankCost, extras);

  const labels=[]; if(+state.v3d>0) labels.push('zawór 3D'); if(+state.safety>0) labels.push('gr. bezp.'); if(+state.hydro>0) labels.push('hydraulika+'); if(+state.glycol>0 && hp.kind==='monoblok') labels.push('glikol');
  const rlabel = state.rads? ` + grzejniki x${state.rads}` : ''; const elabel = labels.length? ` + ${labels.join(', ')}` : '';

  let cwuLabel = '';
  if(hp.kind==='all-in-one') cwuLabel = 'AIO CWU';
  else if(bufObj?.type==='combo') cwuLabel = `CWU w combo (${bufObj.cwu} l)`;
  else cwuLabel = (tankObj?.label ? `CWU ${tankObj.label}` : 'CWU — dobór na miejscu');

  const name = `Zestaw: ${hp.brand} ${hp.model} + ${bufObj?.label||'bufor'} + ${cwuLabel}${rlabel}${elabel}`;
  addToBasket(name, price, 1);
  addToBasket(name, price, 1);
});
$('#btnAddHp').addEventListener('click', ()=>{
  const hp=activeHp(); if(!hp){ alert('Wybierz pompę.'); return; }
  addToBasket(`Pompa ciepła: ${hp.brand} ${hp.model} — tylko urządzenie`, soloPrice(hp), 1);
});
document.addEventListener('input', e=>{
  if(e.target && e.target.matches && e.target.matches('[data-qty]')){
    const i=Number(e.target.getAttribute('data-qty'));
    state.basket[i].qty=Math.max(1,Number(e.target.value)||1);
    renderBasket(); persist(); updateContractPreview();
  }
});
document.addEventListener('click', e=>{
  const del = e.target.getAttribute && e.target.getAttribute('data-del');
  if(del!=null){ state.basket.splice(Number(del),1); renderBasket(); persist(); updateContractPreview(); }
});

// Prowizje
['provPct','provAbs'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    state.provPct=Number($('#provPct').value)||0; state.provAbs=Number($('#provAbs').value)||0;
    renderBasket(); persist(); updateContractPreview();
  });
});

// Eksporty / druk / mail
$('#btnCopy').addEventListener('click', ()=>{
  const {sum, prov, gross, lines} = buildOfferSummary();
  let txt = 'Oferta — Pompy ciepła (zestaw)\n\n' + lines.join('\n');
  txt += '\n\nSuma netto: ' + fmt(sum) + ' PLN';
  txt += '\nProwizja: ' + fmt(prov) + ' PLN';
  txt += '\nRazem brutto (z VAT): ' + fmt(gross) + ' PLN';
  navigator.clipboard.writeText(txt).then(()=>alert('Skopiowano do schowka')).catch(()=>{});
});
$('#btnPrint').addEventListener('click', ()=> window.print());
$('#btnXlsx').addEventListener('click', ()=>{
  const rows = state.basket.map(it=>({ Pozycja: it.name, Ilosc: it.qty, Cena_PLN: it.price, Wartosc_PLN: it.price*it.qty }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Koszyk'); XLSX.writeFile(wb, 'Koszyk_PompyCiepla.xlsx');
});
$('#btnExportJson').addEventListener('click', ()=>{
  const data = JSON.stringify(state.basket, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='koszyk-pompy.json'; a.click(); URL.revokeObjectURL(url);
});
$('#btnImportJson').addEventListener('click', ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const arr=JSON.parse(reader.result);
        if(Array.isArray(arr)){ state.basket = arr; renderBasket(); persist(); updateContractPreview(); }
      }catch(err){ alert('Nieprawidłowy plik JSON.'); }
    };
    reader.readAsText(file);
  };
  inp.click();
});

// Klient & kontrakt
$('#btnSaveClient').addEventListener('click', ()=>{ collectClient(); persist(); updateContractPreview(); alert('Zapisano dane klienta.'); });
$('#btnToContract').addEventListener('click', ()=>{ updateContractPreview(); alert('Zapisano do umowy (draft).'); });
$('#btnMailTo').addEventListener('click', ()=>{
  collectClient();
  const {sum, prov, gross, lines} = buildOfferSummary();
  const subject = 'Oferta – pompa ciepła / zestaw';
  const body = [
    'Dzień dobry,', '', 'Poniżej podsumowanie oferty:', ...lines, '',
    'Suma netto: ' + fmt(sum) + ' PLN',
    'Prowizja: ' + fmt(prov) + ' PLN',
    'Razem brutto (VAT ' + Math.round(state.vat*100) + '%): ' + fmt(gross) + ' PLN', '',
    'Pozdrawiam'
  ].join('\n');
  const mail = 'mailto:' + encodeURIComponent(state.client.email||'') + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
  location.href = mail;
});
$('#btnPrintContract').addEventListener('click', ()=> window.print());

/* ===================== INIT ===================== */
function boot(){
  restore();
  makeChips(); fillFilters(); renderTable(); fillSelects(); renderBasket();
  // odtwórz klienta
  $('#clName').value=state.client.name||''; $('#clEmail').value=state.client.email||''; $('#clPhone').value=state.client.phone||'';
  $('#clNip').value=state.client.nip||''; $('#clAddr').value=state.client.addr||'';
  // VAT/prowizje
  $('#selVat').value=String(state.vat||0.08);
  $('#provPct').value=state.provPct||''; $('#provAbs').value=state.provAbs||'';
  $('#tagsAll').checked = !!state.tagsAll;
  // szybki/adv dobór
  quickSuggest(); recomputeAdvanced();
  // kontrakt podgląd
  updateContractPreview();
}
boot();
</script>
</body>
</html>
